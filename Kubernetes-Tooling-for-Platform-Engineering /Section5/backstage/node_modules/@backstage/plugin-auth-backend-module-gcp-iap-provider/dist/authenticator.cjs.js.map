{"version":3,"file":"authenticator.cjs.js","sources":["../src/authenticator.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AuthenticationError } from '@backstage/errors';\nimport { createProxyAuthenticator } from '@backstage/plugin-auth-node';\nimport { createTokenValidator } from './helpers';\nimport { GcpIapResult } from './types';\n\n/**\n * The header name used by the IAP.\n */\nconst DEFAULT_IAP_JWT_HEADER = 'x-goog-iap-jwt-assertion';\n\n/** @public */\nexport const gcpIapAuthenticator = createProxyAuthenticator({\n  defaultProfileTransform: async (result: GcpIapResult) => {\n    return { profile: { email: result.iapToken.email } };\n  },\n  initialize({ config }) {\n    const audience = config.getString('audience');\n    const jwtHeader =\n      config.getOptionalString('jwtHeader') ?? DEFAULT_IAP_JWT_HEADER;\n\n    const tokenValidator = createTokenValidator(audience);\n\n    return { jwtHeader, tokenValidator };\n  },\n  async authenticate({ req }, { jwtHeader, tokenValidator }) {\n    const token = req.header(jwtHeader);\n\n    if (!token || typeof token !== 'string') {\n      throw new AuthenticationError('Missing Google IAP header');\n    }\n\n    const iapToken = await tokenValidator(token);\n\n    return {\n      result: { iapToken },\n      providerInfo: { iapToken },\n    };\n  },\n});\n"],"names":["createProxyAuthenticator","createTokenValidator","AuthenticationError"],"mappings":";;;;;;AAwBA,MAAM,sBAAyB,GAAA,0BAAA;AAGxB,MAAM,sBAAsBA,uCAAyB,CAAA;AAAA,EAC1D,uBAAA,EAAyB,OAAO,MAAyB,KAAA;AACvD,IAAA,OAAO,EAAE,OAAS,EAAA,EAAE,OAAO,MAAO,CAAA,QAAA,CAAS,OAAQ,EAAA;AAAA,GACrD;AAAA,EACA,UAAA,CAAW,EAAE,MAAA,EAAU,EAAA;AACrB,IAAM,MAAA,QAAA,GAAW,MAAO,CAAA,SAAA,CAAU,UAAU,CAAA;AAC5C,IAAA,MAAM,SACJ,GAAA,MAAA,CAAO,iBAAkB,CAAA,WAAW,CAAK,IAAA,sBAAA;AAE3C,IAAM,MAAA,cAAA,GAAiBC,6BAAqB,QAAQ,CAAA;AAEpD,IAAO,OAAA,EAAE,WAAW,cAAe,EAAA;AAAA,GACrC;AAAA,EACA,MAAM,aAAa,EAAE,GAAA,IAAO,EAAE,SAAA,EAAW,gBAAkB,EAAA;AACzD,IAAM,MAAA,KAAA,GAAQ,GAAI,CAAA,MAAA,CAAO,SAAS,CAAA;AAElC,IAAA,IAAI,CAAC,KAAA,IAAS,OAAO,KAAA,KAAU,QAAU,EAAA;AACvC,MAAM,MAAA,IAAIC,2BAAoB,2BAA2B,CAAA;AAAA;AAG3D,IAAM,MAAA,QAAA,GAAW,MAAM,cAAA,CAAe,KAAK,CAAA;AAE3C,IAAO,OAAA;AAAA,MACL,MAAA,EAAQ,EAAE,QAAS,EAAA;AAAA,MACnB,YAAA,EAAc,EAAE,QAAS;AAAA,KAC3B;AAAA;AAEJ,CAAC;;;;"}