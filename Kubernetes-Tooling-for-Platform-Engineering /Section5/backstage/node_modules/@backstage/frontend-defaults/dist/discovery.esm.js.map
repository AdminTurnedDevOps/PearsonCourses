{"version":3,"file":"discovery.esm.js","sources":["../src/discovery.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config, ConfigReader } from '@backstage/config';\nimport { FrontendFeature } from '@backstage/frontend-app-api';\n\ninterface DiscoveryGlobal {\n  modules: Array<{ name: string; export?: string; default: unknown }>;\n}\n\nfunction readPackageDetectionConfig(config: Config) {\n  const packages = config.getOptional('app.experimental.packages');\n  if (packages === undefined || packages === null) {\n    return undefined;\n  }\n\n  if (typeof packages === 'string') {\n    if (packages !== 'all') {\n      throw new Error(\n        `Invalid app.experimental.packages mode, got '${packages}', expected 'all'`,\n      );\n    }\n    return {};\n  }\n\n  if (typeof packages !== 'object' || Array.isArray(packages)) {\n    throw new Error(\n      \"Invalid config at 'app.experimental.packages', expected object\",\n    );\n  }\n  const packagesConfig = new ConfigReader(\n    packages,\n    'app.experimental.packages',\n  );\n\n  return {\n    include: packagesConfig.getOptionalStringArray('include'),\n    exclude: packagesConfig.getOptionalStringArray('exclude'),\n  };\n}\n\n/**\n * @internal\n */\nexport function getAvailableFeatures(config: Config): FrontendFeature[] {\n  const discovered = (\n    window as { '__@backstage/discovered__'?: DiscoveryGlobal }\n  )['__@backstage/discovered__'];\n\n  const detection = readPackageDetectionConfig(config);\n  if (!detection) {\n    return [];\n  }\n\n  return (\n    discovered?.modules\n      .filter(({ name }) => {\n        if (detection.exclude?.includes(name)) {\n          return false;\n        }\n        if (detection.include && !detection.include.includes(name)) {\n          return false;\n        }\n        return true;\n      })\n      .map(m => m.default)\n      .filter(isBackstageFeature) ?? []\n  );\n}\n\nfunction isBackstageFeature(obj: unknown): obj is FrontendFeature {\n  if (obj !== null && typeof obj === 'object' && '$$type' in obj) {\n    return (\n      obj.$$type === '@backstage/FrontendPlugin' ||\n      obj.$$type === '@backstage/FrontendModule' ||\n      // TODO: Remove this once the old plugin type and extension overrides\n      // are no longer supported\n      obj.$$type === '@backstage/BackstagePlugin' ||\n      obj.$$type === '@backstage/ExtensionOverrides'\n    );\n  }\n  return false;\n}\n"],"names":[],"mappings":";;AAuBA,SAAS,2BAA2B,MAAgB,EAAA;AAClD,EAAM,MAAA,QAAA,GAAW,MAAO,CAAA,WAAA,CAAY,2BAA2B,CAAA;AAC/D,EAAI,IAAA,QAAA,KAAa,KAAa,CAAA,IAAA,QAAA,KAAa,IAAM,EAAA;AAC/C,IAAO,OAAA,KAAA,CAAA;AAAA;AAGT,EAAI,IAAA,OAAO,aAAa,QAAU,EAAA;AAChC,IAAA,IAAI,aAAa,KAAO,EAAA;AACtB,MAAA,MAAM,IAAI,KAAA;AAAA,QACR,gDAAgD,QAAQ,CAAA,iBAAA;AAAA,OAC1D;AAAA;AAEF,IAAA,OAAO,EAAC;AAAA;AAGV,EAAA,IAAI,OAAO,QAAa,KAAA,QAAA,IAAY,KAAM,CAAA,OAAA,CAAQ,QAAQ,CAAG,EAAA;AAC3D,IAAA,MAAM,IAAI,KAAA;AAAA,MACR;AAAA,KACF;AAAA;AAEF,EAAA,MAAM,iBAAiB,IAAI,YAAA;AAAA,IACzB,QAAA;AAAA,IACA;AAAA,GACF;AAEA,EAAO,OAAA;AAAA,IACL,OAAA,EAAS,cAAe,CAAA,sBAAA,CAAuB,SAAS,CAAA;AAAA,IACxD,OAAA,EAAS,cAAe,CAAA,sBAAA,CAAuB,SAAS;AAAA,GAC1D;AACF;AAKO,SAAS,qBAAqB,MAAmC,EAAA;AACtE,EAAM,MAAA,UAAA,GACJ,OACA,2BAA2B,CAAA;AAE7B,EAAM,MAAA,SAAA,GAAY,2BAA2B,MAAM,CAAA;AACnD,EAAA,IAAI,CAAC,SAAW,EAAA;AACd,IAAA,OAAO,EAAC;AAAA;AAGV,EAAA,OACE,YAAY,OACT,CAAA,MAAA,CAAO,CAAC,EAAE,MAAW,KAAA;AACpB,IAAA,IAAI,SAAU,CAAA,OAAA,EAAS,QAAS,CAAA,IAAI,CAAG,EAAA;AACrC,MAAO,OAAA,KAAA;AAAA;AAET,IAAA,IAAI,UAAU,OAAW,IAAA,CAAC,UAAU,OAAQ,CAAA,QAAA,CAAS,IAAI,CAAG,EAAA;AAC1D,MAAO,OAAA,KAAA;AAAA;AAET,IAAO,OAAA,IAAA;AAAA,GACR,CACA,CAAA,GAAA,CAAI,CAAK,CAAA,KAAA,CAAA,CAAE,OAAO,CAClB,CAAA,MAAA,CAAO,kBAAkB,CAAA,IAAK,EAAC;AAEtC;AAEA,SAAS,mBAAmB,GAAsC,EAAA;AAChE,EAAA,IAAI,QAAQ,IAAQ,IAAA,OAAO,GAAQ,KAAA,QAAA,IAAY,YAAY,GAAK,EAAA;AAC9D,IAAA,OACE,GAAI,CAAA,MAAA,KAAW,2BACf,IAAA,GAAA,CAAI,MAAW,KAAA,2BAAA;AAAA;AAAA,IAGf,GAAI,CAAA,MAAA,KAAW,4BACf,IAAA,GAAA,CAAI,MAAW,KAAA,+BAAA;AAAA;AAGnB,EAAO,OAAA,KAAA;AACT;;;;"}