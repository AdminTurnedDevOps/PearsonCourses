{"version":3,"file":"createPublicSignInApp.esm.js","sources":["../src/createPublicSignInApp.tsx"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  coreExtensionData,\n  createFrontendModule,\n  identityApiRef,\n  useApi,\n} from '@backstage/frontend-plugin-api';\nimport React from 'react';\nimport { useAsync, useMountEffect } from '@react-hookz/web';\nimport { CreateAppOptions, createApp } from './createApp';\nimport appPlugin from '@backstage/plugin-app';\n\n// This is a copy of the CookieAuthRedirect component from the auth-react\n// plugin, to avoid a dependency on that package. Long-term we want this to be\n// the only implementation and remove the one in auth-react once the old frontend system is gone.\n\n// TODO(Rugvip): Should this be part of the app plugin instead? since it owns the backend part of it.\n\n/** @internal */\nexport function InternalCookieAuthRedirect() {\n  const identityApi = useApi(identityApiRef);\n\n  const [state, actions] = useAsync(async () => {\n    const { token } = await identityApi.getCredentials();\n    if (!token) {\n      throw new Error('Expected Backstage token in sign-in response');\n    }\n    return token;\n  });\n\n  useMountEffect(actions.execute);\n\n  if (state.status === 'error' && state.error) {\n    return <>An error occurred: {state.error.message}</>;\n  }\n\n  if (state.status === 'success' && state.result) {\n    return (\n      <form\n        ref={form => form?.submit()}\n        action={window.location.href}\n        method=\"POST\"\n        style={{ visibility: 'hidden' }}\n      >\n        <input type=\"hidden\" name=\"type\" value=\"sign-in\" />\n        <input type=\"hidden\" name=\"token\" value={state.result} />\n        <input type=\"submit\" value=\"Continue\" />\n      </form>\n    );\n  }\n\n  return null;\n}\n\n/**\n * Creates an app that is suitable for the public sign-in page, for use in the `index-public-experimental.tsx` file.\n *\n * @remarks\n *\n * This app has an override for the `app/layout` extension, which means that\n * most extension typically installed in an app will be ignored. However, you\n * can still for example install API and root element extensions.\n *\n * A typical setup of this app will only install a custom sign-in page.\n *\n * @example\n * ```ts\n * const app = createPublicSignInApp({\n *   features: [signInPageModule],\n * });\n * ```\n *\n * @public\n */\nexport function createPublicSignInApp(options?: CreateAppOptions) {\n  return createApp({\n    ...options,\n    features: [\n      ...(options?.features ?? []),\n      // This is a rather than app plugin override in order for it to take precedence over any supplied app plugin override\n      createFrontendModule({\n        pluginId: 'app',\n        extensions: [\n          appPlugin.getExtension('app/layout').override({\n            factory: () => [\n              coreExtensionData.reactElement(<InternalCookieAuthRedirect />),\n            ],\n          }),\n        ],\n      }),\n    ],\n  });\n}\n"],"names":[],"mappings":";;;;;;AAkCO,SAAS,0BAA6B,GAAA;AAC3C,EAAM,MAAA,WAAA,GAAc,OAAO,cAAc,CAAA;AAEzC,EAAA,MAAM,CAAC,KAAA,EAAO,OAAO,CAAA,GAAI,SAAS,YAAY;AAC5C,IAAA,MAAM,EAAE,KAAA,EAAU,GAAA,MAAM,YAAY,cAAe,EAAA;AACnD,IAAA,IAAI,CAAC,KAAO,EAAA;AACV,MAAM,MAAA,IAAI,MAAM,8CAA8C,CAAA;AAAA;AAEhE,IAAO,OAAA,KAAA;AAAA,GACR,CAAA;AAED,EAAA,cAAA,CAAe,QAAQ,OAAO,CAAA;AAE9B,EAAA,IAAI,KAAM,CAAA,MAAA,KAAW,OAAW,IAAA,KAAA,CAAM,KAAO,EAAA;AAC3C,IAAA,uBAAS,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,QAAA,EAAA,IAAA,EAAA,qBAAA,EAAoB,KAAM,CAAA,KAAA,CAAM,OAAQ,CAAA;AAAA;AAGnD,EAAA,IAAI,KAAM,CAAA,MAAA,KAAW,SAAa,IAAA,KAAA,CAAM,MAAQ,EAAA;AAC9C,IACE,uBAAA,KAAA,CAAA,aAAA;AAAA,MAAC,MAAA;AAAA,MAAA;AAAA,QACC,GAAA,EAAK,CAAQ,IAAA,KAAA,IAAA,EAAM,MAAO,EAAA;AAAA,QAC1B,MAAA,EAAQ,OAAO,QAAS,CAAA,IAAA;AAAA,QACxB,MAAO,EAAA,MAAA;AAAA,QACP,KAAA,EAAO,EAAE,UAAA,EAAY,QAAS;AAAA,OAAA;AAAA,0CAE7B,OAAM,EAAA,EAAA,IAAA,EAAK,UAAS,IAAK,EAAA,MAAA,EAAO,OAAM,SAAU,EAAA,CAAA;AAAA,sBACjD,KAAA,CAAA,aAAA,CAAC,WAAM,IAAK,EAAA,QAAA,EAAS,MAAK,OAAQ,EAAA,KAAA,EAAO,MAAM,MAAQ,EAAA,CAAA;AAAA,sBACtD,KAAA,CAAA,aAAA,CAAA,OAAA,EAAA,EAAM,IAAK,EAAA,QAAA,EAAS,OAAM,UAAW,EAAA;AAAA,KACxC;AAAA;AAIJ,EAAO,OAAA,IAAA;AACT;AAsBO,SAAS,sBAAsB,OAA4B,EAAA;AAChE,EAAA,OAAO,SAAU,CAAA;AAAA,IACf,GAAG,OAAA;AAAA,IACH,QAAU,EAAA;AAAA,MACR,GAAI,OAAS,EAAA,QAAA,IAAY,EAAC;AAAA;AAAA,MAE1B,oBAAqB,CAAA;AAAA,QACnB,QAAU,EAAA,KAAA;AAAA,QACV,UAAY,EAAA;AAAA,UACV,SAAU,CAAA,YAAA,CAAa,YAAY,CAAA,CAAE,QAAS,CAAA;AAAA,YAC5C,SAAS,MAAM;AAAA,cACb,iBAAkB,CAAA,YAAA,iBAAc,KAAA,CAAA,aAAA,CAAA,0BAAA,EAAA,IAA2B,CAAE;AAAA;AAC/D,WACD;AAAA;AACH,OACD;AAAA;AACH,GACD,CAAA;AACH;;;;"}