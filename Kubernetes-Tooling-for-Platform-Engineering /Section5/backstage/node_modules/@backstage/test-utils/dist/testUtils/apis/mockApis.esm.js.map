{"version":3,"file":"mockApis.esm.js","sources":["../../../src/testUtils/apis/mockApis.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ConfigReader } from '@backstage/config';\nimport {\n  AnalyticsApi,\n  ApiFactory,\n  ApiRef,\n  ConfigApi,\n  DiscoveryApi,\n  IdentityApi,\n  StorageApi,\n  analyticsApiRef,\n  configApiRef,\n  createApiFactory,\n  discoveryApiRef,\n  identityApiRef,\n  storageApiRef,\n} from '@backstage/core-plugin-api';\nimport {\n  TranslationApi,\n  translationApiRef,\n} from '@backstage/core-plugin-api/alpha';\nimport {\n  AuthorizeResult,\n  EvaluatePermissionRequest,\n} from '@backstage/plugin-permission-common';\nimport {\n  PermissionApi,\n  permissionApiRef,\n} from '@backstage/plugin-permission-react';\nimport { JsonObject } from '@backstage/types';\nimport { ApiMock } from './ApiMock';\nimport { MockPermissionApi } from './PermissionApi';\nimport { MockStorageApi } from './StorageApi';\nimport { MockTranslationApi } from './TranslationApi';\n\n/** @internal */\nfunction simpleFactory<TApi, TArgs extends unknown[]>(\n  ref: ApiRef<TApi>,\n  factory: (...args: TArgs) => TApi,\n): (...args: TArgs) => ApiFactory<TApi, TApi, {}> {\n  return (...args) =>\n    createApiFactory({\n      api: ref,\n      deps: {},\n      factory: () => factory(...args),\n    });\n}\n\n/** @internal */\nfunction simpleMock<TApi>(\n  ref: ApiRef<TApi>,\n  mockFactory: () => jest.Mocked<TApi>,\n): (partialImpl?: Partial<TApi>) => ApiMock<TApi> {\n  return partialImpl => {\n    const mock = mockFactory();\n    if (partialImpl) {\n      for (const [key, impl] of Object.entries(partialImpl)) {\n        if (typeof impl === 'function') {\n          (mock as any)[key].mockImplementation(impl);\n        } else {\n          (mock as any)[key] = impl;\n        }\n      }\n    }\n    return Object.assign(mock, {\n      factory: createApiFactory({\n        api: ref,\n        deps: {},\n        factory: () => mock,\n      }),\n    }) as ApiMock<TApi>;\n  };\n}\n\n/**\n * Mock implementations of the core utility APIs, to be used in tests.\n *\n * @public\n * @remarks\n *\n * There are some variations among the APIs depending on what needs tests\n * might have, but overall there are three main usage patterns:\n *\n * 1: Creating an actual fake API instance, often with a simplified version\n * of functionality, by calling the mock API itself as a function.\n *\n * ```ts\n * // The function often accepts parameters that control its behavior\n * const foo = mockApis.foo();\n * ```\n *\n * 2: Creating a mock API, where all methods are replaced with jest mocks, by\n * calling the API's `mock` function.\n *\n * ```ts\n * // You can optionally supply a subset of its methods to implement\n * const foo = mockApis.foo.mock({\n *   someMethod: () => 'mocked result',\n * });\n * // After exercising your test, you can make assertions on the mock:\n * expect(foo.someMethod).toHaveBeenCalledTimes(2);\n * expect(foo.otherMethod).toHaveBeenCalledWith(testData);\n * ```\n *\n * 3: Creating an API factory that behaves similarly to the mock as per above.\n *\n * ```ts\n * const factory = mockApis.foo.factory({\n *   someMethod: () => 'mocked result',\n * });\n * ```\n */\nexport namespace mockApis {\n  const analyticsMockSkeleton = (): jest.Mocked<AnalyticsApi> => ({\n    captureEvent: jest.fn(),\n  });\n  /**\n   * Mock implementation of {@link @backstage/core-plugin-api#AnalyticsApi}.\n   *\n   * @public\n   */\n  export function analytics(): AnalyticsApi {\n    return analyticsMockSkeleton();\n  }\n  /**\n   * Mock implementations of {@link @backstage/core-plugin-api#AnalyticsApi}.\n   *\n   * @public\n   */\n  export namespace analytics {\n    export const factory = simpleFactory(analyticsApiRef, analytics);\n    export const mock = simpleMock(analyticsApiRef, analyticsMockSkeleton);\n  }\n\n  /**\n   * Fake implementation of {@link @backstage/core-plugin-api#ConfigApi}\n   * with optional data supplied.\n   *\n   * @public\n   * @example\n   *\n   * ```tsx\n   * const config = mockApis.config({\n   *   data: { app: { baseUrl: 'https://example.com' } },\n   * });\n   *\n   * await renderInTestApp(\n   *   <TestApiProvider apis={[[configApiRef, config]]}>\n   *     <MyTestedComponent />\n   *   </TestApiProvider>,\n   * );\n   * ```\n   */\n  export function config(options?: { data?: JsonObject }): ConfigApi {\n    return new ConfigReader(options?.data, 'mock-config');\n  }\n  /**\n   * Mock helpers for {@link @backstage/core-plugin-api#ConfigApi}.\n   *\n   * @see {@link @backstage/core-plugin-api#mockApis.config}\n   * @public\n   */\n  export namespace config {\n    /**\n     * Creates a factory for a fake implementation of\n     * {@link @backstage/core-plugin-api#ConfigApi} with optional\n     * configuration data supplied.\n     *\n     * @public\n     */\n    export const factory = simpleFactory(configApiRef, config);\n    /**\n     * Creates a mock implementation of\n     * {@link @backstage/core-plugin-api#ConfigApi}. All methods are\n     * replaced with jest mock functions, and you can optionally pass in a\n     * subset of methods with an explicit implementation.\n     *\n     * @public\n     */\n    export const mock = simpleMock(configApiRef, () => ({\n      has: jest.fn(),\n      keys: jest.fn(),\n      get: jest.fn(),\n      getOptional: jest.fn(),\n      getConfig: jest.fn(),\n      getOptionalConfig: jest.fn(),\n      getConfigArray: jest.fn(),\n      getOptionalConfigArray: jest.fn(),\n      getNumber: jest.fn(),\n      getOptionalNumber: jest.fn(),\n      getBoolean: jest.fn(),\n      getOptionalBoolean: jest.fn(),\n      getString: jest.fn(),\n      getOptionalString: jest.fn(),\n      getStringArray: jest.fn(),\n      getOptionalStringArray: jest.fn(),\n    }));\n  }\n\n  /**\n   * Fake implementation of {@link @backstage/core-plugin-api#DiscoveryApi}. By\n   * default returns URLs on the form `http://example.com/api/<pluginIs>`.\n   *\n   * @public\n   */\n  export function discovery(options?: { baseUrl?: string }): DiscoveryApi {\n    const baseUrl = options?.baseUrl ?? 'http://example.com';\n    return {\n      async getBaseUrl(pluginId: string) {\n        return `${baseUrl}/api/${pluginId}`;\n      },\n    };\n  }\n  /**\n   * Mock implementations of {@link @backstage/core-plugin-api#DiscoveryApi}.\n   *\n   * @public\n   */\n  export namespace discovery {\n    export const factory = simpleFactory(discoveryApiRef, discovery);\n    export const mock = simpleMock(discoveryApiRef, () => ({\n      getBaseUrl: jest.fn(),\n    }));\n  }\n\n  /**\n   * Fake implementation of {@link @backstage/core-plugin-api#IdentityApi}. By\n   * default returns no token or profile info, and the user `user:default/test`.\n   *\n   * @public\n   */\n  export function identity(options?: {\n    userEntityRef?: string;\n    ownershipEntityRefs?: string[];\n    token?: string;\n    email?: string;\n    displayName?: string;\n    picture?: string;\n  }): IdentityApi {\n    const {\n      userEntityRef = 'user:default/test',\n      ownershipEntityRefs = ['user:default/test'],\n      token,\n      email,\n      displayName,\n      picture,\n    } = options ?? {};\n    return {\n      async getBackstageIdentity() {\n        return { type: 'user', ownershipEntityRefs, userEntityRef };\n      },\n      async getCredentials() {\n        return { token };\n      },\n      async getProfileInfo() {\n        return { email, displayName, picture };\n      },\n      async signOut() {},\n    };\n  }\n  /**\n   * Mock implementations of {@link @backstage/core-plugin-api#IdentityApi}.\n   *\n   * @public\n   */\n  export namespace identity {\n    export const factory = simpleFactory(identityApiRef, identity);\n    export const mock = simpleMock(\n      identityApiRef,\n      (): jest.Mocked<IdentityApi> => ({\n        getBackstageIdentity: jest.fn(),\n        getCredentials: jest.fn(),\n        getProfileInfo: jest.fn(),\n        signOut: jest.fn(),\n      }),\n    );\n  }\n\n  /**\n   * Fake implementation of\n   * {@link @backstage/plugin-permission-react#PermissionApi}. By default allows\n   * all actions.\n   *\n   * @public\n   */\n  export function permission(options?: {\n    authorize?:\n      | AuthorizeResult.ALLOW\n      | AuthorizeResult.DENY\n      | ((\n          request: EvaluatePermissionRequest,\n        ) => AuthorizeResult.ALLOW | AuthorizeResult.DENY);\n  }): PermissionApi {\n    const authorizeInput = options?.authorize;\n    let authorize: (\n      request: EvaluatePermissionRequest,\n    ) => AuthorizeResult.ALLOW | AuthorizeResult.DENY;\n    if (authorizeInput === undefined) {\n      authorize = () => AuthorizeResult.ALLOW;\n    } else if (typeof authorizeInput === 'function') {\n      authorize = authorizeInput;\n    } else {\n      authorize = () => authorizeInput;\n    }\n    return new MockPermissionApi(authorize);\n  }\n  /**\n   * Mock implementation of\n   * {@link @backstage/plugin-permission-react#PermissionApi}.\n   *\n   * @public\n   */\n  export namespace permission {\n    export const factory = simpleFactory(permissionApiRef, permission);\n    export const mock = simpleMock(permissionApiRef, () => ({\n      authorize: jest.fn(),\n    }));\n  }\n\n  /**\n   * Fake implementation of {@link @backstage/core-plugin-api#StorageApi}.\n   * Stores data temporarily in memory.\n   *\n   * @public\n   */\n  export function storage(options?: { data?: JsonObject }): StorageApi {\n    return MockStorageApi.create(options?.data);\n  }\n  /**\n   * Mock implementations of {@link @backstage/core-plugin-api#StorageApi}.\n   *\n   * @public\n   */\n  export namespace storage {\n    export const factory = simpleFactory(storageApiRef, storage);\n    export const mock = simpleMock(storageApiRef, () => ({\n      forBucket: jest.fn(),\n      set: jest.fn(),\n      remove: jest.fn(),\n      observe$: jest.fn(),\n      snapshot: jest.fn(),\n    }));\n  }\n\n  /**\n   * Fake implementation of {@link @backstage/core-plugin-api/alpha#TranslationApi}.\n   * By default returns the default translation.\n   *\n   * @public\n   */\n  export function translation(): TranslationApi {\n    return MockTranslationApi.create();\n  }\n  /**\n   * Mock implementations of {@link @backstage/core-plugin-api/alpha#TranslationApi}.\n   *\n   * @public\n   */\n  export namespace translation {\n    export const factory = simpleFactory(translationApiRef, translation);\n    export const mock = simpleMock(translationApiRef, () => ({\n      getTranslation: jest.fn(),\n      translation$: jest.fn(),\n    }));\n  }\n}\n"],"names":["mockApis","analytics","config","discovery","identity","permission","storage","translation"],"mappings":"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"}