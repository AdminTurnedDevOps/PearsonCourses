{"version":3,"file":"PluginProtocolResolverFetchMiddleware.esm.js","sources":["../../../../../../../../../packages/core-app-api/src/apis/implementations/FetchApi/PluginProtocolResolverFetchMiddleware.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { DiscoveryApi } from '@backstage/core-plugin-api';\nimport { FetchMiddleware } from './types';\n\nfunction join(left: string, right: string): string {\n  if (!right || right === '/') {\n    return left;\n  }\n\n  return `${left.replace(/\\/$/, '')}/${right.replace(/^\\//, '')}`;\n}\n\n/**\n * Handles translation from plugin://some-plugin-id/<path> to concrete http(s)\n * URLs.\n */\nexport class PluginProtocolResolverFetchMiddleware implements FetchMiddleware {\n  constructor(private readonly discoveryApi: DiscoveryApi) {}\n\n  apply(next: typeof fetch): typeof fetch {\n    return async (input, init) => {\n      // NOTE(freben): The \"as any\" casts here and below are because of subtle\n      // undici type differences that happened in a node types bump. Those are\n      // immaterial to the code at hand at runtime, as the global fetch and\n      // Request are always taken from the same place.\n      const request = new Request(input as any, init);\n      const prefix = 'plugin://';\n\n      if (!request.url.startsWith(prefix)) {\n        return next(input as any, init);\n      }\n\n      // Switch to a known protocol, since browser URL parsing misbehaves wildly\n      // on foreign protocols\n      const { hostname, pathname, search, hash, username, password } = new URL(\n        `http://${request.url.substring(prefix.length)}`,\n      );\n\n      let base = await this.discoveryApi.getBaseUrl(hostname);\n      if (username || password) {\n        const baseUrl = new URL(base);\n        const authority = `${username}${password ? `:${password}` : ''}@`;\n        base = `${baseUrl.protocol}//${authority}${baseUrl.host}${baseUrl.pathname}`;\n      }\n\n      const target = `${join(base, pathname)}${search}${hash}`;\n      return next(\n        target,\n        typeof input === 'string' || isUrl(input) ? init : (input as any),\n      );\n    };\n  }\n}\n\nfunction isUrl(a: unknown): a is URL {\n  return typeof a === 'object' && a?.constructor === URL;\n}\n"],"names":[],"mappings":"AAmBA,SAAS,IAAA,CAAK,MAAc,KAAuB,EAAA;AACjD,EAAI,IAAA,CAAC,KAAS,IAAA,KAAA,KAAU,GAAK,EAAA;AAC3B,IAAO,OAAA,IAAA;AAAA;AAGT,EAAO,OAAA,CAAA,EAAG,IAAK,CAAA,OAAA,CAAQ,KAAO,EAAA,EAAE,CAAC,CAAA,CAAA,EAAI,KAAM,CAAA,OAAA,CAAQ,KAAO,EAAA,EAAE,CAAC,CAAA,CAAA;AAC/D;AAMO,MAAM,qCAAiE,CAAA;AAAA,EAC5E,YAA6B,YAA4B,EAAA;AAA5B,IAAA,IAAA,CAAA,YAAA,GAAA,YAAA;AAAA;AAA6B,EAE1D,MAAM,IAAkC,EAAA;AACtC,IAAO,OAAA,OAAO,OAAO,IAAS,KAAA;AAK5B,MAAA,MAAM,OAAU,GAAA,IAAI,OAAQ,CAAA,KAAA,EAAc,IAAI,CAAA;AAC9C,MAAA,MAAM,MAAS,GAAA,WAAA;AAEf,MAAA,IAAI,CAAC,OAAA,CAAQ,GAAI,CAAA,UAAA,CAAW,MAAM,CAAG,EAAA;AACnC,QAAO,OAAA,IAAA,CAAK,OAAc,IAAI,CAAA;AAAA;AAKhC,MAAM,MAAA,EAAE,UAAU,QAAU,EAAA,MAAA,EAAQ,MAAM,QAAU,EAAA,QAAA,KAAa,IAAI,GAAA;AAAA,QACnE,UAAU,OAAQ,CAAA,GAAA,CAAI,SAAU,CAAA,MAAA,CAAO,MAAM,CAAC,CAAA;AAAA,OAChD;AAEA,MAAA,IAAI,IAAO,GAAA,MAAM,IAAK,CAAA,YAAA,CAAa,WAAW,QAAQ,CAAA;AACtD,MAAA,IAAI,YAAY,QAAU,EAAA;AACxB,QAAM,MAAA,OAAA,GAAU,IAAI,GAAA,CAAI,IAAI,CAAA;AAC5B,QAAM,MAAA,SAAA,GAAY,GAAG,QAAQ,CAAA,EAAG,WAAW,CAAI,CAAA,EAAA,QAAQ,KAAK,EAAE,CAAA,CAAA,CAAA;AAC9D,QAAO,IAAA,GAAA,CAAA,EAAG,OAAQ,CAAA,QAAQ,CAAK,EAAA,EAAA,SAAS,GAAG,OAAQ,CAAA,IAAI,CAAG,EAAA,OAAA,CAAQ,QAAQ,CAAA,CAAA;AAAA;AAG5E,MAAM,MAAA,MAAA,GAAS,GAAG,IAAK,CAAA,IAAA,EAAM,QAAQ,CAAC,CAAA,EAAG,MAAM,CAAA,EAAG,IAAI,CAAA,CAAA;AACtD,MAAO,OAAA,IAAA;AAAA,QACL,MAAA;AAAA,QACA,OAAO,KAAU,KAAA,QAAA,IAAY,KAAM,CAAA,KAAK,IAAI,IAAQ,GAAA;AAAA,OACtD;AAAA,KACF;AAAA;AAEJ;AAEA,SAAS,MAAM,CAAsB,EAAA;AACnC,EAAA,OAAO,OAAO,CAAA,KAAM,QAAY,IAAA,CAAA,EAAG,WAAgB,KAAA,GAAA;AACrD;;;;"}