{"version":3,"file":"OAuth2.esm.js","sources":["../../../../../../../../../../packages/core-app-api/src/apis/implementations/auth/oauth2/OAuth2.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  DefaultAuthConnector,\n  PopupOptions,\n} from '../../../../lib/AuthConnector';\nimport { RefreshingAuthSessionManager } from '../../../../lib/AuthSessionManager';\nimport { SessionManager } from '../../../../lib/AuthSessionManager/types';\nimport {\n  AuthRequestOptions,\n  BackstageIdentityResponse,\n  OAuthApi,\n  OpenIdConnectApi,\n  ProfileInfo,\n  ProfileInfoApi,\n  SessionState,\n  SessionApi,\n  BackstageIdentityApi,\n  BackstageUserIdentity,\n} from '@backstage/core-plugin-api';\nimport { Observable } from '@backstage/types';\nimport { OAuth2Session } from './types';\nimport { OAuthApiCreateOptions } from '../types';\n\n/**\n * OAuth2 create options.\n * @public\n */\nexport type OAuth2CreateOptions = OAuthApiCreateOptions & {\n  scopeTransform?: (scopes: string[]) => string[];\n  popupOptions?: PopupOptions;\n};\n\nexport type OAuth2Response = {\n  providerInfo: {\n    accessToken: string;\n    idToken: string;\n    scope: string;\n    expiresInSeconds?: number;\n  };\n  profile: ProfileInfo;\n  backstageIdentity: {\n    token: string;\n    expiresInSeconds?: number;\n    identity: BackstageUserIdentity;\n  };\n};\n\nconst DEFAULT_PROVIDER = {\n  id: 'oauth2',\n  title: 'Your Identity Provider',\n  icon: () => null,\n};\n\n/**\n * Implements a generic OAuth2 flow for auth.\n *\n * @public\n */\nexport default class OAuth2\n  implements\n    OAuthApi,\n    OpenIdConnectApi,\n    ProfileInfoApi,\n    BackstageIdentityApi,\n    SessionApi\n{\n  static create(options: OAuth2CreateOptions) {\n    const {\n      configApi,\n      discoveryApi,\n      environment = 'development',\n      provider = DEFAULT_PROVIDER,\n      oauthRequestApi,\n      defaultScopes = [],\n      scopeTransform = x => x,\n      popupOptions,\n    } = options;\n\n    const connector = new DefaultAuthConnector({\n      configApi,\n      discoveryApi,\n      environment,\n      provider,\n      oauthRequestApi: oauthRequestApi,\n      sessionTransform({\n        backstageIdentity,\n        ...res\n      }: OAuth2Response): OAuth2Session {\n        const session: OAuth2Session = {\n          ...res,\n          providerInfo: {\n            idToken: res.providerInfo.idToken,\n            accessToken: res.providerInfo.accessToken,\n            scopes: OAuth2.normalizeScopes(\n              scopeTransform,\n              res.providerInfo.scope,\n            ),\n            expiresAt: res.providerInfo.expiresInSeconds\n              ? new Date(Date.now() + res.providerInfo.expiresInSeconds * 1000)\n              : undefined,\n          },\n        };\n        if (backstageIdentity) {\n          session.backstageIdentity = {\n            token: backstageIdentity.token,\n            identity: backstageIdentity.identity,\n            expiresAt: backstageIdentity.expiresInSeconds\n              ? new Date(Date.now() + backstageIdentity.expiresInSeconds * 1000)\n              : undefined,\n          };\n        }\n        return session;\n      },\n      popupOptions,\n    });\n\n    const sessionManager = new RefreshingAuthSessionManager({\n      connector,\n      defaultScopes: new Set(defaultScopes),\n      sessionScopes: (session: OAuth2Session) => session.providerInfo.scopes,\n      sessionShouldRefresh: (session: OAuth2Session) => {\n        // TODO(Rugvip): Optimize to use separate checks for provider vs backstage session expiration\n        let min = Infinity;\n        if (session.providerInfo?.expiresAt) {\n          min = Math.min(\n            min,\n            (session.providerInfo.expiresAt.getTime() - Date.now()) / 1000,\n          );\n        }\n        if (session.backstageIdentity?.expiresAt) {\n          min = Math.min(\n            min,\n            (session.backstageIdentity.expiresAt.getTime() - Date.now()) / 1000,\n          );\n        }\n        return min < 60 * 3;\n      },\n    });\n\n    return new OAuth2({ sessionManager, scopeTransform });\n  }\n\n  private readonly sessionManager: SessionManager<OAuth2Session>;\n  private readonly scopeTransform: (scopes: string[]) => string[];\n\n  private constructor(options: {\n    sessionManager: SessionManager<OAuth2Session>;\n    scopeTransform: (scopes: string[]) => string[];\n  }) {\n    this.sessionManager = options.sessionManager;\n    this.scopeTransform = options.scopeTransform;\n  }\n\n  async signIn() {\n    await this.getAccessToken();\n  }\n\n  async signOut() {\n    await this.sessionManager.removeSession();\n  }\n\n  sessionState$(): Observable<SessionState> {\n    return this.sessionManager.sessionState$();\n  }\n\n  async getAccessToken(\n    scope?: string | string[],\n    options?: AuthRequestOptions,\n  ) {\n    const normalizedScopes = OAuth2.normalizeScopes(this.scopeTransform, scope);\n    const session = await this.sessionManager.getSession({\n      ...options,\n      scopes: normalizedScopes,\n    });\n    return session?.providerInfo.accessToken ?? '';\n  }\n\n  async getIdToken(options: AuthRequestOptions = {}) {\n    const session = await this.sessionManager.getSession({\n      ...options,\n      scopes: new Set(['openid']),\n    });\n    return session?.providerInfo.idToken ?? '';\n  }\n\n  async getBackstageIdentity(\n    options: AuthRequestOptions = {},\n  ): Promise<BackstageIdentityResponse | undefined> {\n    const session = await this.sessionManager.getSession(options);\n    return session?.backstageIdentity;\n  }\n\n  async getProfile(options: AuthRequestOptions = {}) {\n    const session = await this.sessionManager.getSession(options);\n    return session?.profile;\n  }\n\n  private static normalizeScopes(\n    scopeTransform: (scopes: string[]) => string[],\n    scopes?: string | string[],\n  ): Set<string> {\n    if (!scopes) {\n      return new Set();\n    }\n\n    const scopeList = Array.isArray(scopes)\n      ? scopes\n      : scopes.split(/[\\s|,]/).filter(Boolean);\n\n    return new Set(scopeTransform(scopeList));\n  }\n}\n"],"names":[],"mappings":"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"}