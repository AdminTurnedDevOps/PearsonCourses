{"version":3,"file":"AppRoot.esm.js","sources":["../../src/extensions/AppRoot.tsx"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, {\n  ComponentType,\n  PropsWithChildren,\n  ReactNode,\n  useState,\n} from 'react';\nimport {\n  AppRootWrapperBlueprint,\n  RouterBlueprint,\n  SignInPageBlueprint,\n  coreExtensionData,\n  discoveryApiRef,\n  fetchApiRef,\n  errorApiRef,\n  createExtension,\n  createExtensionInput,\n  routeResolutionApiRef,\n} from '@backstage/frontend-plugin-api';\nimport {\n  DiscoveryApi,\n  ErrorApi,\n  FetchApi,\n  IdentityApi,\n  ProfileInfo,\n  SignInPageProps,\n  configApiRef,\n  identityApiRef,\n  useApi,\n} from '@backstage/core-plugin-api';\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { isProtectedApp } from '../../../../packages/core-app-api/src/app/isProtectedApp';\nimport { BrowserRouter } from 'react-router-dom';\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { RouteTracker } from '../../../../packages/frontend-app-api/src/routing/RouteTracker';\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { getBasePath } from '../../../../packages/frontend-app-api/src/routing/getBasePath';\n\nexport const AppRoot = createExtension({\n  name: 'root',\n  attachTo: { id: 'app', input: 'root' },\n  inputs: {\n    router: createExtensionInput([RouterBlueprint.dataRefs.component], {\n      singleton: true,\n      optional: true,\n    }),\n    signInPage: createExtensionInput([SignInPageBlueprint.dataRefs.component], {\n      singleton: true,\n      optional: true,\n    }),\n    children: createExtensionInput([coreExtensionData.reactElement], {\n      singleton: true,\n    }),\n    elements: createExtensionInput([coreExtensionData.reactElement]),\n    wrappers: createExtensionInput([\n      AppRootWrapperBlueprint.dataRefs.component,\n    ]),\n  },\n  output: [coreExtensionData.reactElement],\n  factory({ inputs, apis }) {\n    if (isProtectedApp()) {\n      const identityApi = apis.get(identityApiRef);\n      if (!identityApi) {\n        throw new Error('App requires an Identity API implementation');\n      }\n      const appIdentityProxy = toAppIdentityProxy(identityApi);\n      const discoveryApi = apis.get(discoveryApiRef);\n      const errorApi = apis.get(errorApiRef);\n      const fetchApi = apis.get(fetchApiRef);\n      if (!discoveryApi || !errorApi || !fetchApi) {\n        throw new Error(\n          'App is running in protected mode but missing required APIs',\n        );\n      }\n      appIdentityProxy.enableCookieAuth({\n        discoveryApi,\n        errorApi,\n        fetchApi,\n      });\n    }\n\n    let content: React.ReactNode = inputs.children.get(\n      coreExtensionData.reactElement,\n    );\n\n    for (const wrapper of inputs.wrappers) {\n      const Component = wrapper.get(AppRootWrapperBlueprint.dataRefs.component);\n      content = <Component>{content}</Component>;\n    }\n\n    return [\n      coreExtensionData.reactElement(\n        <AppRouter\n          SignInPageComponent={inputs.signInPage?.get(\n            SignInPageBlueprint.dataRefs.component,\n          )}\n          RouterComponent={inputs.router?.get(\n            RouterBlueprint.dataRefs.component,\n          )}\n          extraElements={inputs.elements?.map(el =>\n            el.get(coreExtensionData.reactElement),\n          )}\n        >\n          {content}\n        </AppRouter>,\n      ),\n    ];\n  },\n});\n\n// This wraps the sign-in page and waits for sign-in to be completed before rendering the app\nfunction SignInPageWrapper({\n  component: Component,\n  appIdentityProxy,\n  children,\n}: {\n  component: ComponentType<SignInPageProps>;\n  appIdentityProxy: AppIdentityProxy;\n  children: ReactNode;\n}) {\n  const [identityApi, setIdentityApi] = useState<IdentityApi>();\n  const configApi = useApi(configApiRef);\n  const basePath = getBasePath(configApi);\n\n  if (!identityApi) {\n    return <Component onSignInSuccess={setIdentityApi} />;\n  }\n\n  appIdentityProxy.setTarget(identityApi, {\n    signOutTargetUrl: basePath || '/',\n  });\n  return <>{children}</>;\n}\n\ntype AppIdentityProxy = IdentityApi & {\n  enableCookieAuth(ctx: {\n    errorApi: ErrorApi;\n    fetchApi: FetchApi;\n    discoveryApi: DiscoveryApi;\n  }): void;\n  setTarget(\n    impl: IdentityApi & /* backwards compat stuff */ {\n      getUserId?(): string;\n      getIdToken?(): Promise<string | undefined>;\n      getProfile?(): ProfileInfo;\n    },\n    options: { signOutTargetUrl: string },\n  ): void;\n};\n\nfunction toAppIdentityProxy(identityApi: IdentityApi): AppIdentityProxy {\n  if (!('enableCookieAuth' in identityApi)) {\n    throw new Error('Unexpected Identity API implementation');\n  }\n  return identityApi as AppIdentityProxy;\n}\n\ntype RouteResolverProxy = {\n  getRouteObjects(): any[];\n};\n\n/**\n * Props for the {@link AppRouter} component.\n * @public\n */\nexport interface AppRouterProps {\n  children?: ReactNode;\n  SignInPageComponent?: ComponentType<SignInPageProps>;\n  RouterComponent?: ComponentType<PropsWithChildren<{}>>;\n  extraElements?: Array<React.JSX.Element>;\n}\n\nfunction DefaultRouter(props: PropsWithChildren<{}>) {\n  const configApi = useApi(configApiRef);\n  const basePath = getBasePath(configApi);\n  return <BrowserRouter basename={basePath}>{props.children}</BrowserRouter>;\n}\n\n/**\n * App router and sign-in page wrapper.\n *\n * @remarks\n *\n * The AppRouter provides the routing context and renders the sign-in page.\n * Until the user has successfully signed in, this component will render\n * the sign-in page. Once the user has signed-in, it will instead render\n * the app, while providing routing and route tracking for the app.\n */\nexport function AppRouter(props: AppRouterProps) {\n  const {\n    children,\n    SignInPageComponent,\n    RouterComponent = DefaultRouter,\n    extraElements = [],\n  } = props;\n\n  const configApi = useApi(configApiRef);\n  const appIdentityProxy = toAppIdentityProxy(useApi(identityApiRef));\n  const routeResolutionsApi = useApi(routeResolutionApiRef);\n  const basePath = getBasePath(configApi);\n\n  // TODO: Private access for now, probably replace with path -> node lookup method on the API\n  if (!('getRouteObjects' in routeResolutionsApi)) {\n    throw new Error('Unexpected route resolution API implementation');\n  }\n  const routeObjects = (\n    routeResolutionsApi as RouteResolverProxy\n  ).getRouteObjects();\n\n  // If the app hasn't configured a sign-in page, we just continue as guest.\n  if (!SignInPageComponent) {\n    appIdentityProxy.setTarget(\n      {\n        getUserId: () => 'guest',\n        getIdToken: async () => undefined,\n        getProfile: () => ({\n          email: 'guest@example.com',\n          displayName: 'Guest',\n        }),\n        getProfileInfo: async () => ({\n          email: 'guest@example.com',\n          displayName: 'Guest',\n        }),\n        getBackstageIdentity: async () => ({\n          type: 'user',\n          userEntityRef: 'user:default/guest',\n          ownershipEntityRefs: ['user:default/guest'],\n        }),\n        getCredentials: async () => ({}),\n        signOut: async () => {},\n      },\n      { signOutTargetUrl: basePath || '/' },\n    );\n\n    return (\n      <RouterComponent>\n        <RouteTracker routeObjects={routeObjects} />\n        {children}\n      </RouterComponent>\n    );\n  }\n\n  return (\n    <RouterComponent>\n      {...extraElements}\n      <RouteTracker routeObjects={routeObjects} />\n      <SignInPageWrapper\n        component={SignInPageComponent}\n        appIdentityProxy={appIdentityProxy}\n      >\n        {children}\n      </SignInPageWrapper>\n    </RouterComponent>\n  );\n}\n"],"names":[],"mappings":";;;;;;;;AAqDO,MAAM,UAAU,eAAgB,CAAA;AAAA,EACrC,IAAM,EAAA,MAAA;AAAA,EACN,QAAU,EAAA,EAAE,EAAI,EAAA,KAAA,EAAO,OAAO,MAAO,EAAA;AAAA,EACrC,MAAQ,EAAA;AAAA,IACN,QAAQ,oBAAqB,CAAA,CAAC,eAAgB,CAAA,QAAA,CAAS,SAAS,CAAG,EAAA;AAAA,MACjE,SAAW,EAAA,IAAA;AAAA,MACX,QAAU,EAAA;AAAA,KACX,CAAA;AAAA,IACD,YAAY,oBAAqB,CAAA,CAAC,mBAAoB,CAAA,QAAA,CAAS,SAAS,CAAG,EAAA;AAAA,MACzE,SAAW,EAAA,IAAA;AAAA,MACX,QAAU,EAAA;AAAA,KACX,CAAA;AAAA,IACD,QAAU,EAAA,oBAAA,CAAqB,CAAC,iBAAA,CAAkB,YAAY,CAAG,EAAA;AAAA,MAC/D,SAAW,EAAA;AAAA,KACZ,CAAA;AAAA,IACD,QAAU,EAAA,oBAAA,CAAqB,CAAC,iBAAA,CAAkB,YAAY,CAAC,CAAA;AAAA,IAC/D,UAAU,oBAAqB,CAAA;AAAA,MAC7B,wBAAwB,QAAS,CAAA;AAAA,KAClC;AAAA,GACH;AAAA,EACA,MAAA,EAAQ,CAAC,iBAAA,CAAkB,YAAY,CAAA;AAAA,EACvC,OAAQ,CAAA,EAAE,MAAQ,EAAA,IAAA,EAAQ,EAAA;AACxB,IAAA,IAAI,gBAAkB,EAAA;AACpB,MAAM,MAAA,WAAA,GAAc,IAAK,CAAA,GAAA,CAAI,cAAc,CAAA;AAC3C,MAAA,IAAI,CAAC,WAAa,EAAA;AAChB,QAAM,MAAA,IAAI,MAAM,6CAA6C,CAAA;AAAA;AAE/D,MAAM,MAAA,gBAAA,GAAmB,mBAAmB,WAAW,CAAA;AACvD,MAAM,MAAA,YAAA,GAAe,IAAK,CAAA,GAAA,CAAI,eAAe,CAAA;AAC7C,MAAM,MAAA,QAAA,GAAW,IAAK,CAAA,GAAA,CAAI,WAAW,CAAA;AACrC,MAAM,MAAA,QAAA,GAAW,IAAK,CAAA,GAAA,CAAI,WAAW,CAAA;AACrC,MAAA,IAAI,CAAC,YAAA,IAAgB,CAAC,QAAA,IAAY,CAAC,QAAU,EAAA;AAC3C,QAAA,MAAM,IAAI,KAAA;AAAA,UACR;AAAA,SACF;AAAA;AAEF,MAAA,gBAAA,CAAiB,gBAAiB,CAAA;AAAA,QAChC,YAAA;AAAA,QACA,QAAA;AAAA,QACA;AAAA,OACD,CAAA;AAAA;AAGH,IAAI,IAAA,OAAA,GAA2B,OAAO,QAAS,CAAA,GAAA;AAAA,MAC7C,iBAAkB,CAAA;AAAA,KACpB;AAEA,IAAW,KAAA,MAAA,OAAA,IAAW,OAAO,QAAU,EAAA;AACrC,MAAA,MAAM,SAAY,GAAA,OAAA,CAAQ,GAAI,CAAA,uBAAA,CAAwB,SAAS,SAAS,CAAA;AACxE,MAAU,OAAA,mBAAA,KAAA,CAAA,aAAA,CAAC,iBAAW,OAAQ,CAAA;AAAA;AAGhC,IAAO,OAAA;AAAA,MACL,iBAAkB,CAAA,YAAA;AAAA,wBAChB,KAAA,CAAA,aAAA;AAAA,UAAC,SAAA;AAAA,UAAA;AAAA,YACC,mBAAA,EAAqB,OAAO,UAAY,EAAA,GAAA;AAAA,cACtC,oBAAoB,QAAS,CAAA;AAAA,aAC/B;AAAA,YACA,eAAA,EAAiB,OAAO,MAAQ,EAAA,GAAA;AAAA,cAC9B,gBAAgB,QAAS,CAAA;AAAA,aAC3B;AAAA,YACA,aAAA,EAAe,OAAO,QAAU,EAAA,GAAA;AAAA,cAAI,CAClC,EAAA,KAAA,EAAA,CAAG,GAAI,CAAA,iBAAA,CAAkB,YAAY;AAAA;AACvC,WAAA;AAAA,UAEC;AAAA;AACH;AACF,KACF;AAAA;AAEJ,CAAC;AAGD,SAAS,iBAAkB,CAAA;AAAA,EACzB,SAAW,EAAA,SAAA;AAAA,EACX,gBAAA;AAAA,EACA;AACF,CAIG,EAAA;AACD,EAAA,MAAM,CAAC,WAAA,EAAa,cAAc,CAAA,GAAI,QAAsB,EAAA;AAC5D,EAAM,MAAA,SAAA,GAAY,OAAO,YAAY,CAAA;AACrC,EAAM,MAAA,QAAA,GAAW,YAAY,SAAS,CAAA;AAEtC,EAAA,IAAI,CAAC,WAAa,EAAA;AAChB,IAAO,uBAAA,KAAA,CAAA,aAAA,CAAC,SAAU,EAAA,EAAA,eAAA,EAAiB,cAAgB,EAAA,CAAA;AAAA;AAGrD,EAAA,gBAAA,CAAiB,UAAU,WAAa,EAAA;AAAA,IACtC,kBAAkB,QAAY,IAAA;AAAA,GAC/B,CAAA;AACD,EAAA,iEAAU,QAAS,CAAA;AACrB;AAkBA,SAAS,mBAAmB,WAA4C,EAAA;AACtE,EAAI,IAAA,EAAE,sBAAsB,WAAc,CAAA,EAAA;AACxC,IAAM,MAAA,IAAI,MAAM,wCAAwC,CAAA;AAAA;AAE1D,EAAO,OAAA,WAAA;AACT;AAiBA,SAAS,cAAc,KAA8B,EAAA;AACnD,EAAM,MAAA,SAAA,GAAY,OAAO,YAAY,CAAA;AACrC,EAAM,MAAA,QAAA,GAAW,YAAY,SAAS,CAAA;AACtC,EAAA,uBAAQ,KAAA,CAAA,aAAA,CAAA,aAAA,EAAA,EAAc,QAAU,EAAA,QAAA,EAAA,EAAW,MAAM,QAAS,CAAA;AAC5D;AAYO,SAAS,UAAU,KAAuB,EAAA;AAC/C,EAAM,MAAA;AAAA,IACJ,QAAA;AAAA,IACA,mBAAA;AAAA,IACA,eAAkB,GAAA,aAAA;AAAA,IAClB,gBAAgB;AAAC,GACf,GAAA,KAAA;AAEJ,EAAM,MAAA,SAAA,GAAY,OAAO,YAAY,CAAA;AACrC,EAAA,MAAM,gBAAmB,GAAA,kBAAA,CAAmB,MAAO,CAAA,cAAc,CAAC,CAAA;AAClE,EAAM,MAAA,mBAAA,GAAsB,OAAO,qBAAqB,CAAA;AACxD,EAAM,MAAA,QAAA,GAAW,YAAY,SAAS,CAAA;AAGtC,EAAI,IAAA,EAAE,qBAAqB,mBAAsB,CAAA,EAAA;AAC/C,IAAM,MAAA,IAAI,MAAM,gDAAgD,CAAA;AAAA;AAElE,EAAM,MAAA,YAAA,GACJ,oBACA,eAAgB,EAAA;AAGlB,EAAA,IAAI,CAAC,mBAAqB,EAAA;AACxB,IAAiB,gBAAA,CAAA,SAAA;AAAA,MACf;AAAA,QACE,WAAW,MAAM,OAAA;AAAA,QACjB,YAAY,YAAY,KAAA,CAAA;AAAA,QACxB,YAAY,OAAO;AAAA,UACjB,KAAO,EAAA,mBAAA;AAAA,UACP,WAAa,EAAA;AAAA,SACf,CAAA;AAAA,QACA,gBAAgB,aAAa;AAAA,UAC3B,KAAO,EAAA,mBAAA;AAAA,UACP,WAAa,EAAA;AAAA,SACf,CAAA;AAAA,QACA,sBAAsB,aAAa;AAAA,UACjC,IAAM,EAAA,MAAA;AAAA,UACN,aAAe,EAAA,oBAAA;AAAA,UACf,mBAAA,EAAqB,CAAC,oBAAoB;AAAA,SAC5C,CAAA;AAAA,QACA,cAAA,EAAgB,aAAa,EAAC,CAAA;AAAA,QAC9B,SAAS,YAAY;AAAA;AAAC,OACxB;AAAA,MACA,EAAE,gBAAkB,EAAA,QAAA,IAAY,GAAI;AAAA,KACtC;AAEA,IAAA,2CACG,eACC,EAAA,IAAA,kBAAA,KAAA,CAAA,aAAA,CAAC,YAAa,EAAA,EAAA,YAAA,EAA4B,GACzC,QACH,CAAA;AAAA;AAIJ,EAAA,2CACG,eACE,EAAA,IAAA,EAAA,GAAG,+BACH,KAAA,CAAA,aAAA,CAAA,YAAA,EAAA,EAAa,cAA4B,CAC1C,kBAAA,KAAA,CAAA,aAAA;AAAA,IAAC,iBAAA;AAAA,IAAA;AAAA,MACC,SAAW,EAAA,mBAAA;AAAA,MACX;AAAA,KAAA;AAAA,IAEC;AAAA,GAEL,CAAA;AAEJ;;;;"}