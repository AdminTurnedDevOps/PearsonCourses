{"version":3,"file":"handleMetaRedirects.esm.js","sources":["../../../src/reader/transformers/handleMetaRedirects.tsx"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Transformer } from './transformer';\nimport { normalizeUrl } from './rewriteDocLinks';\nimport React from 'react';\nimport { renderReactElement } from './renderReactElement';\nimport { TechDocsRedirectNotification } from '../components/TechDocsRedirectNotification';\n\nexport const handleMetaRedirects = (\n  navigate: (to: string) => void,\n  entityName: string,\n): Transformer => {\n  const redirectAfterMs = 3000;\n\n  const determineRedirectURL = (metaUrl: string) => {\n    const normalizedCurrentUrl = normalizeUrl(window.location.href);\n    // When creating URL object, if the metaUrl is relative, it will be resolved with base href. If it is absolute, it will replace the base href.\n    const absoluteRedirectObj = new URL(metaUrl, normalizedCurrentUrl);\n    const isExternalRedirect =\n      absoluteRedirectObj.hostname !== window.location.hostname;\n\n    if (isExternalRedirect) {\n      const currentTechDocPath = window.location.pathname;\n      const indexOfSiteHome = currentTechDocPath.indexOf(entityName);\n      const siteHomePath = currentTechDocPath.slice(\n        0,\n        indexOfSiteHome + entityName.length,\n      );\n      return new URL(siteHomePath, normalizedCurrentUrl).href;\n    }\n    return absoluteRedirectObj.href;\n  };\n\n  return dom => {\n    for (const elem of Array.from(dom.querySelectorAll('meta'))) {\n      if (elem.getAttribute('http-equiv') === 'refresh') {\n        const metaContentParameters = elem\n          .getAttribute('content')\n          ?.split('url=');\n\n        if (!metaContentParameters || metaContentParameters.length < 2) {\n          return dom;\n        }\n\n        const metaUrl = metaContentParameters[1];\n        const redirectURL = determineRedirectURL(metaUrl);\n\n        // If the current URL is the same as the redirect URL, do not proceed with the redirect.\n        if (window.location.href === redirectURL) {\n          return dom;\n        }\n\n        const container = document.createElement('div');\n\n        renderReactElement(\n          <TechDocsRedirectNotification\n            message=\"This TechDocs page is no longer maintained. Will automatically redirect to the designated replacement.\"\n            handleButtonClick={() => navigate(redirectURL)}\n            autoHideDuration={redirectAfterMs}\n          />,\n          container,\n        );\n        document.body.appendChild(container);\n\n        setTimeout(() => {\n          navigate(redirectURL);\n        }, redirectAfterMs);\n\n        return dom;\n      }\n    }\n    return dom;\n  };\n};\n"],"names":[],"mappings":";;;;;AAsBa,MAAA,mBAAA,GAAsB,CACjC,QAAA,EACA,UACgB,KAAA;AAChB,EAAA,MAAM,eAAkB,GAAA,GAAA;AAExB,EAAM,MAAA,oBAAA,GAAuB,CAAC,OAAoB,KAAA;AAChD,IAAA,MAAM,oBAAuB,GAAA,YAAA,CAAa,MAAO,CAAA,QAAA,CAAS,IAAI,CAAA;AAE9D,IAAA,MAAM,mBAAsB,GAAA,IAAI,GAAI,CAAA,OAAA,EAAS,oBAAoB,CAAA;AACjE,IAAA,MAAM,kBACJ,GAAA,mBAAA,CAAoB,QAAa,KAAA,MAAA,CAAO,QAAS,CAAA,QAAA;AAEnD,IAAA,IAAI,kBAAoB,EAAA;AACtB,MAAM,MAAA,kBAAA,GAAqB,OAAO,QAAS,CAAA,QAAA;AAC3C,MAAM,MAAA,eAAA,GAAkB,kBAAmB,CAAA,OAAA,CAAQ,UAAU,CAAA;AAC7D,MAAA,MAAM,eAAe,kBAAmB,CAAA,KAAA;AAAA,QACtC,CAAA;AAAA,QACA,kBAAkB,UAAW,CAAA;AAAA,OAC/B;AACA,MAAA,OAAO,IAAI,GAAA,CAAI,YAAc,EAAA,oBAAoB,CAAE,CAAA,IAAA;AAAA;AAErD,IAAA,OAAO,mBAAoB,CAAA,IAAA;AAAA,GAC7B;AAEA,EAAA,OAAO,CAAO,GAAA,KAAA;AACZ,IAAA,KAAA,MAAW,QAAQ,KAAM,CAAA,IAAA,CAAK,IAAI,gBAAiB,CAAA,MAAM,CAAC,CAAG,EAAA;AAC3D,MAAA,IAAI,IAAK,CAAA,YAAA,CAAa,YAAY,CAAA,KAAM,SAAW,EAAA;AACjD,QAAA,MAAM,wBAAwB,IAC3B,CAAA,YAAA,CAAa,SAAS,CAAA,EACrB,MAAM,MAAM,CAAA;AAEhB,QAAA,IAAI,CAAC,qBAAA,IAAyB,qBAAsB,CAAA,MAAA,GAAS,CAAG,EAAA;AAC9D,UAAO,OAAA,GAAA;AAAA;AAGT,QAAM,MAAA,OAAA,GAAU,sBAAsB,CAAC,CAAA;AACvC,QAAM,MAAA,WAAA,GAAc,qBAAqB,OAAO,CAAA;AAGhD,QAAI,IAAA,MAAA,CAAO,QAAS,CAAA,IAAA,KAAS,WAAa,EAAA;AACxC,UAAO,OAAA,GAAA;AAAA;AAGT,QAAM,MAAA,SAAA,GAAY,QAAS,CAAA,aAAA,CAAc,KAAK,CAAA;AAE9C,QAAA,kBAAA;AAAA,0BACE,KAAA,CAAA,aAAA;AAAA,YAAC,4BAAA;AAAA,YAAA;AAAA,cACC,OAAQ,EAAA,wGAAA;AAAA,cACR,iBAAA,EAAmB,MAAM,QAAA,CAAS,WAAW,CAAA;AAAA,cAC7C,gBAAkB,EAAA;AAAA;AAAA,WACpB;AAAA,UACA;AAAA,SACF;AACA,QAAS,QAAA,CAAA,IAAA,CAAK,YAAY,SAAS,CAAA;AAEnC,QAAA,UAAA,CAAW,MAAM;AACf,UAAA,QAAA,CAAS,WAAW,CAAA;AAAA,WACnB,eAAe,CAAA;AAElB,QAAO,OAAA,GAAA;AAAA;AACT;AAEF,IAAO,OAAA,GAAA;AAAA,GACT;AACF;;;;"}