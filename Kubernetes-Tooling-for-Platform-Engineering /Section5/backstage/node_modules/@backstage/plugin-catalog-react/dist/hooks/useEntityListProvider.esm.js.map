{"version":3,"file":"useEntityListProvider.esm.js","sources":["../../src/hooks/useEntityListProvider.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Entity } from '@backstage/catalog-model';\nimport { compact, isEqual } from 'lodash';\nimport qs from 'qs';\nimport React, {\n  createContext,\n  PropsWithChildren,\n  useCallback,\n  useContext,\n  useMemo,\n  useState,\n} from 'react';\nimport { useLocation } from 'react-router-dom';\nimport useAsyncFn from 'react-use/esm/useAsyncFn';\nimport useDebounce from 'react-use/esm/useDebounce';\nimport useMountedState from 'react-use/esm/useMountedState';\nimport { catalogApiRef } from '../api';\nimport {\n  EntityErrorFilter,\n  EntityKindFilter,\n  EntityLifecycleFilter,\n  EntityNamespaceFilter,\n  EntityOrphanFilter,\n  EntityOwnerFilter,\n  EntityTagFilter,\n  EntityTextFilter,\n  EntityTypeFilter,\n  EntityUserFilter,\n  UserListFilter,\n} from '../filters';\nimport { EntityFilter, EntityListPagination } from '../types';\nimport {\n  reduceBackendCatalogFilters,\n  reduceCatalogFilters,\n  reduceEntityFilters,\n} from '../utils/filters';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { QueryEntitiesResponse } from '@backstage/catalog-client';\n\n/** @public */\nexport type DefaultEntityFilters = {\n  kind?: EntityKindFilter;\n  type?: EntityTypeFilter;\n  user?: UserListFilter | EntityUserFilter;\n  owners?: EntityOwnerFilter;\n  lifecycles?: EntityLifecycleFilter;\n  tags?: EntityTagFilter;\n  text?: EntityTextFilter;\n  orphan?: EntityOrphanFilter;\n  error?: EntityErrorFilter;\n  namespace?: EntityNamespaceFilter;\n};\n\n/** @public */\nexport type PaginationMode = 'cursor' | 'offset' | 'none';\n\n/** @public */\nexport type EntityListContextProps<\n  EntityFilters extends DefaultEntityFilters = DefaultEntityFilters,\n> = {\n  /**\n   * The currently registered filters, adhering to the shape of DefaultEntityFilters or an extension\n   * of that default (to add custom filter types).\n   */\n  filters: EntityFilters;\n\n  /**\n   * The resolved list of catalog entities, after all filters are applied.\n   */\n  entities: Entity[];\n\n  /**\n   * The resolved list of catalog entities, after _only catalog-backend_ filters are applied.\n   */\n  backendEntities: Entity[];\n\n  /**\n   * Update one or more of the registered filters. Optional filters can be set to `undefined` to\n   * reset the filter.\n   */\n  updateFilters: (\n    filters:\n      | Partial<EntityFilters>\n      | ((prevFilters: EntityFilters) => Partial<EntityFilters>),\n  ) => void;\n\n  /**\n   * Filter values from query parameters.\n   */\n  queryParameters: Partial<Record<keyof EntityFilters, string | string[]>>;\n\n  loading: boolean;\n  error?: Error;\n\n  pageInfo?: {\n    next?: () => void;\n    prev?: () => void;\n  };\n  totalItems?: number;\n  limit: number;\n  offset?: number;\n  setLimit: (limit: number) => void;\n  setOffset?: (offset: number) => void;\n  paginationMode: PaginationMode;\n};\n\n/**\n * Creates new context for entity listing and filtering.\n * @public\n */\nexport const EntityListContext = createContext<\n  EntityListContextProps<any> | undefined\n>(undefined);\n\ntype OutputState<EntityFilters extends DefaultEntityFilters> = {\n  appliedFilters: EntityFilters;\n  appliedCursor?: string;\n  entities: Entity[];\n  backendEntities: Entity[];\n  pageInfo?: QueryEntitiesResponse['pageInfo'];\n  totalItems?: number;\n  offset?: number;\n  limit?: number;\n};\n\n/**\n * @public\n */\nexport type EntityListProviderProps = PropsWithChildren<{\n  pagination?: EntityListPagination;\n}>;\n\n/**\n * Provides entities and filters for a catalog listing.\n * @public\n */\nexport const EntityListProvider = <EntityFilters extends DefaultEntityFilters>(\n  props: EntityListProviderProps,\n) => {\n  const isMounted = useMountedState();\n  const catalogApi = useApi(catalogApiRef);\n  const [requestedFilters, setRequestedFilters] = useState<EntityFilters>(\n    {} as EntityFilters,\n  );\n\n  // We use react-router's useLocation hook so updates from external sources trigger an update to\n  // the queryParameters in outputState. Updates from this hook use replaceState below and won't\n  // trigger a useLocation change; this would instead come from an external source, such as a manual\n  // update of the URL or two catalog sidebar links with different catalog filters.\n  const location = useLocation();\n\n  const getPaginationMode = (): PaginationMode => {\n    if (props.pagination === true) {\n      return 'cursor';\n    }\n    return typeof props.pagination === 'object'\n      ? props.pagination.mode ?? 'cursor'\n      : 'none';\n  };\n\n  const paginationMode: PaginationMode = getPaginationMode();\n  const paginationLimit =\n    typeof props.pagination === 'object' ? props.pagination.limit ?? 20 : 20;\n\n  const {\n    queryParameters,\n    cursor: initialCursor,\n    offset: initialOffset,\n    limit: initialLimit,\n  } = useMemo(() => {\n    const parsed = qs.parse(location.search, {\n      ignoreQueryPrefix: true,\n    });\n\n    let limit = paginationLimit;\n    if (typeof parsed.limit === 'string') {\n      const queryLimit = Number.parseInt(parsed.limit, 10);\n      if (!isNaN(queryLimit)) {\n        limit = queryLimit;\n      }\n    }\n\n    const offset =\n      typeof parsed.offset === 'string' && paginationMode === 'offset'\n        ? Number.parseInt(parsed.offset, 10)\n        : undefined;\n\n    return {\n      queryParameters: (parsed.filters ?? {}) as Record<\n        string,\n        string | string[]\n      >,\n      cursor:\n        typeof parsed.cursor === 'string' && paginationMode === 'cursor'\n          ? parsed.cursor\n          : undefined,\n      offset:\n        paginationMode === 'offset' && offset && !isNaN(offset)\n          ? offset\n          : undefined,\n      limit,\n    };\n  }, [paginationMode, location.search, paginationLimit]);\n\n  const [cursor, setCursor] = useState(initialCursor);\n  const [offset, setOffset] = useState<number | undefined>(initialOffset);\n  const [limit, setLimit] = useState(initialLimit);\n\n  const [outputState, setOutputState] = useState<OutputState<EntityFilters>>(\n    () => {\n      return {\n        appliedFilters: {} as EntityFilters,\n        entities: [],\n        backendEntities: [],\n        pageInfo: paginationMode === 'cursor' ? {} : undefined,\n        offset,\n        limit,\n      };\n    },\n  );\n\n  // The main async filter worker. Note that while it has a lot of dependencies\n  // in terms of its implementation, the triggering only happens (debounced)\n  // based on the requested filters changing.\n  const [{ loading, error }, refresh] = useAsyncFn(\n    async () => {\n      const compacted = compact(Object.values(requestedFilters));\n\n      const queryParams = Object.keys(requestedFilters).reduce(\n        (params, key) => {\n          const filter = requestedFilters[key as keyof EntityFilters] as\n            | EntityFilter\n            | undefined;\n          if (filter?.toQueryValue) {\n            params[key] = filter.toQueryValue();\n          }\n          return params;\n        },\n        {} as Record<string, string | string[]>,\n      );\n\n      if (paginationMode !== 'none') {\n        if (cursor) {\n          if (cursor !== outputState.appliedCursor) {\n            const entityFilter = reduceEntityFilters(compacted);\n            const response = await catalogApi.queryEntities({\n              cursor,\n              limit,\n            });\n            setOutputState({\n              appliedFilters: requestedFilters,\n              appliedCursor: cursor,\n              backendEntities: response.items,\n              entities: response.items.filter(entityFilter),\n              pageInfo: response.pageInfo,\n              totalItems: response.totalItems,\n            });\n          }\n        } else {\n          const entityFilter = reduceEntityFilters(compacted);\n          const backendFilter = reduceCatalogFilters(compacted);\n          const previousBackendFilter = reduceCatalogFilters(\n            compact(Object.values(outputState.appliedFilters)),\n          );\n\n          if (\n            paginationMode === 'offset' ||\n            !isEqual(previousBackendFilter, backendFilter)\n          ) {\n            const response = await catalogApi.queryEntities({\n              ...backendFilter,\n              limit,\n              offset,\n              orderFields: [{ field: 'metadata.name', order: 'asc' }],\n            });\n            setOutputState({\n              appliedFilters: requestedFilters,\n              backendEntities: response.items,\n              entities: response.items.filter(entityFilter),\n              pageInfo: response.pageInfo,\n              totalItems: response.totalItems,\n              limit,\n              offset,\n            });\n          }\n        }\n      } else {\n        const entityFilter = reduceEntityFilters(compacted);\n        const backendFilter = reduceBackendCatalogFilters(compacted);\n        const previousBackendFilter = reduceBackendCatalogFilters(\n          compact(Object.values(outputState.appliedFilters)),\n        );\n\n        // TODO(mtlewis): currently entities will never be requested unless\n        // there's at least one filter, we should allow an initial request\n        // to happen with no filters.\n        if (!isEqual(previousBackendFilter, backendFilter)) {\n          // TODO(timbonicus): should limit fields here, but would need filter\n          // fields + table columns\n          const response = await catalogApi.getEntities({\n            filter: backendFilter,\n          });\n          const entities = response.items.filter(entityFilter);\n          setOutputState({\n            appliedFilters: requestedFilters,\n            backendEntities: response.items,\n            entities,\n            totalItems: entities.length,\n          });\n        } else {\n          const entities = outputState.backendEntities.filter(entityFilter);\n          setOutputState({\n            appliedFilters: requestedFilters,\n            backendEntities: outputState.backendEntities,\n            entities,\n            totalItems: entities.length,\n          });\n        }\n      }\n\n      if (isMounted()) {\n        const oldParams = qs.parse(location.search, {\n          ignoreQueryPrefix: true,\n        });\n        const newParams = qs.stringify(\n          { ...oldParams, filters: queryParams, cursor, offset, limit },\n          { addQueryPrefix: true, arrayFormat: 'repeat' },\n        );\n        const newUrl = `${window.location.pathname}${newParams}`;\n        // We use direct history manipulation since useSearchParams and\n        // useNavigate in react-router-dom cause unnecessary extra rerenders.\n        // Also make sure to replace the state rather than pushing, since we\n        // don't want there to be back/forward slots for every single filter\n        // change.\n        window.history?.replaceState(null, document.title, newUrl);\n      }\n    },\n    [\n      catalogApi,\n      queryParameters,\n      requestedFilters,\n      outputState,\n      cursor,\n      paginationMode,\n      limit,\n      offset,\n    ],\n    { loading: true },\n  );\n\n  // Slight debounce on the refresh, since (especially on page load) several\n  // filters will be calling this in rapid succession.\n  useDebounce(refresh, 10, [requestedFilters, cursor, limit, offset]);\n\n  const updateFilters = useCallback(\n    (\n      update:\n        | Partial<EntityFilter>\n        | ((prevFilters: EntityFilters) => Partial<EntityFilters>),\n    ) => {\n      // changing filters will affect pagination, so we need to reset\n      // the cursor and start from the first page.\n      // TODO(vinzscam): this is currently causing issues at page reload\n      // where the state is not kept. Unfortunately we need to rethink\n      // the way filters work in order to fix this.\n      setCursor(undefined);\n      setRequestedFilters(prevFilters => {\n        const newFilters =\n          typeof update === 'function' ? update(prevFilters) : update;\n        return { ...prevFilters, ...newFilters };\n      });\n    },\n    [],\n  );\n\n  const pageInfo = useMemo(() => {\n    if (paginationMode !== 'cursor') {\n      return undefined;\n    }\n\n    const prevCursor = outputState.pageInfo?.prevCursor;\n    const nextCursor = outputState.pageInfo?.nextCursor;\n    return {\n      prev: prevCursor ? () => setCursor(prevCursor) : undefined,\n      next: nextCursor ? () => setCursor(nextCursor) : undefined,\n    };\n  }, [paginationMode, outputState.pageInfo]);\n\n  const value = useMemo(\n    () => ({\n      filters: outputState.appliedFilters,\n      entities: outputState.entities,\n      backendEntities: outputState.backendEntities,\n      updateFilters,\n      queryParameters,\n      loading,\n      error,\n      pageInfo,\n      totalItems: outputState.totalItems,\n      limit,\n      offset,\n      setLimit,\n      setOffset,\n      paginationMode,\n    }),\n    [\n      outputState,\n      updateFilters,\n      queryParameters,\n      loading,\n      error,\n      pageInfo,\n      limit,\n      offset,\n      paginationMode,\n      setLimit,\n      setOffset,\n    ],\n  );\n\n  return (\n    <EntityListContext.Provider value={value}>\n      {props.children}\n    </EntityListContext.Provider>\n  );\n};\n\n/**\n * Hook for interacting with the entity list context provided by the {@link EntityListProvider}.\n * @public\n */\nexport function useEntityList<\n  EntityFilters extends DefaultEntityFilters = DefaultEntityFilters,\n>(): EntityListContextProps<EntityFilters> {\n  const context = useContext(EntityListContext);\n  if (!context)\n    throw new Error('useEntityList must be used within EntityListProvider');\n  return context;\n}\n"],"names":["limit","offset"],"mappings":"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"}