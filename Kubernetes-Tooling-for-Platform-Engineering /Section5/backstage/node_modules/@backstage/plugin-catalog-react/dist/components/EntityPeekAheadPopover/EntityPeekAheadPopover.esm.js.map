{"version":3,"file":"EntityPeekAheadPopover.esm.js","sources":["../../../src/components/EntityPeekAheadPopover/EntityPeekAheadPopover.tsx"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport useAsyncFn from 'react-use/esm/useAsyncFn';\nimport { catalogApiRef } from '../../api';\nimport React, { PropsWithChildren, useEffect, useMemo, useState } from 'react';\nimport HoverPopover from 'material-ui-popup-state/HoverPopover';\nimport {\n  bindHover,\n  bindPopover,\n  usePopupState,\n} from 'material-ui-popup-state/hooks';\nimport Box from '@material-ui/core/Box';\nimport Card from '@material-ui/core/Card';\nimport CardActions from '@material-ui/core/CardActions';\nimport CardContent from '@material-ui/core/CardContent';\nimport Chip from '@material-ui/core/Chip';\nimport Tooltip from '@material-ui/core/Tooltip';\nimport Typography from '@material-ui/core/Typography';\nimport { makeStyles } from '@material-ui/core/styles';\nimport { useApiHolder } from '@backstage/core-plugin-api';\nimport { isGroupEntity, isUserEntity } from '@backstage/catalog-model';\nimport { Progress, ResponseErrorPanel } from '@backstage/core-components';\nimport {\n  EntityCardActions,\n  UserCardActions,\n  GroupCardActions,\n} from './CardActionComponents';\nimport { debounce } from 'lodash';\nimport { catalogReactTranslationRef } from '../../translation';\nimport { useTranslationRef } from '@backstage/core-plugin-api/alpha';\n\n/**\n * Properties for an entity popover on hover of a component.\n *\n * @public\n */\nexport type EntityPeekAheadPopoverProps = PropsWithChildren<{\n  entityRef: string;\n  delayTime?: number;\n}>;\n\nconst useStyles = makeStyles(() => {\n  return {\n    popoverPaper: {\n      width: '30em',\n    },\n    descriptionTypography: {\n      overflow: 'hidden',\n      textOverflow: 'ellipsis',\n      display: '-webkit-box',\n      WebkitLineClamp: 2,\n      WebkitBoxOrient: 'vertical',\n    },\n  };\n});\n\nconst maxTagChips = 4;\n\n/**\n * Shows an entity popover on hover of a component.\n *\n * @public\n */\nexport const EntityPeekAheadPopover = (props: EntityPeekAheadPopoverProps) => {\n  const { entityRef, children, delayTime = 500 } = props;\n  const { t } = useTranslationRef(catalogReactTranslationRef);\n  const classes = useStyles();\n  const apiHolder = useApiHolder();\n  const popupState = usePopupState({\n    variant: 'popover',\n    popupId: 'entity-peek-ahead',\n  });\n  const [isHovered, setIsHovered] = useState(false);\n\n  const debouncedHandleMouseEnter = useMemo(\n    () => debounce(() => setIsHovered(true), delayTime),\n    [delayTime],\n  );\n\n  const [{ loading, error, value: entity }, load] = useAsyncFn(async () => {\n    const catalogApi = apiHolder.get(catalogApiRef);\n    if (catalogApi) {\n      const retrievedEntity = await catalogApi.getEntityByRef(entityRef);\n      if (!retrievedEntity) {\n        throw new Error(`${entityRef} not found`);\n      }\n      return retrievedEntity;\n    }\n    return undefined;\n  }, [apiHolder, entityRef]);\n\n  const handleOnMouseLeave = () => {\n    setIsHovered(false);\n    debouncedHandleMouseEnter.cancel();\n  };\n\n  useEffect(() => {\n    if (popupState.isOpen && !entity && !error && !loading) {\n      load();\n    }\n  }, [popupState.isOpen, load, entity, error, loading]);\n\n  return (\n    <>\n      <Typography component=\"span\" onMouseEnter={debouncedHandleMouseEnter}>\n        <Typography\n          component=\"span\"\n          data-testid=\"trigger\"\n          {...bindHover(popupState)}\n        >\n          {children}\n        </Typography>\n      </Typography>\n      {isHovered && (\n        <HoverPopover\n          PaperProps={{\n            className: classes.popoverPaper,\n          }}\n          {...bindPopover(popupState)}\n          anchorOrigin={{\n            vertical: 'bottom',\n            horizontal: 'center',\n          }}\n          transformOrigin={{\n            vertical: 'top',\n            horizontal: 'center',\n          }}\n          onMouseLeave={handleOnMouseLeave}\n        >\n          <Card>\n            <CardContent>\n              {error && <ResponseErrorPanel error={error} />}\n              {loading && <Progress />}\n              {entity && (\n                <>\n                  <Typography color=\"textSecondary\">\n                    {entity.metadata.namespace}\n                  </Typography>\n                  <Typography variant=\"h5\" component=\"div\">\n                    {entity.metadata.name}\n                  </Typography>\n                  <Typography color=\"textSecondary\" gutterBottom>\n                    {entity.kind}\n                  </Typography>\n                  {entity.metadata.description && (\n                    <Typography\n                      className={classes.descriptionTypography}\n                      paragraph\n                    >\n                      {entity.metadata.description}\n                    </Typography>\n                  )}\n                  <Typography>{entity.spec?.type?.toString()}</Typography>\n                  <Box marginTop=\"0.5em\">\n                    {(entity.metadata.tags || [])\n                      .slice(0, maxTagChips)\n                      .map(tag => {\n                        return <Chip key={tag} size=\"small\" label={tag} />;\n                      })}\n                    {entity.metadata.tags?.length &&\n                      entity.metadata.tags?.length > maxTagChips && (\n                        <Tooltip title={t('entityPeekAheadPopover.title')}>\n                          <Chip key=\"other-tags\" size=\"small\" label=\"...\" />\n                        </Tooltip>\n                      )}\n                  </Box>\n                </>\n              )}\n            </CardContent>\n            {!error && entity && (\n              <CardActions>\n                <>\n                  {isUserEntity(entity) && <UserCardActions entity={entity} />}\n                  {isGroupEntity(entity) && (\n                    <GroupCardActions entity={entity} />\n                  )}\n                  <EntityCardActions entity={entity} />\n                </>\n              </CardActions>\n            )}\n          </Card>\n        </HoverPopover>\n      )}\n    </>\n  );\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AAuDA,MAAM,SAAA,GAAY,WAAW,MAAM;AACjC,EAAO,OAAA;AAAA,IACL,YAAc,EAAA;AAAA,MACZ,KAAO,EAAA;AAAA,KACT;AAAA,IACA,qBAAuB,EAAA;AAAA,MACrB,QAAU,EAAA,QAAA;AAAA,MACV,YAAc,EAAA,UAAA;AAAA,MACd,OAAS,EAAA,aAAA;AAAA,MACT,eAAiB,EAAA,CAAA;AAAA,MACjB,eAAiB,EAAA;AAAA;AACnB,GACF;AACF,CAAC,CAAA;AAED,MAAM,WAAc,GAAA,CAAA;AAOP,MAAA,sBAAA,GAAyB,CAAC,KAAuC,KAAA;AAC5E,EAAA,MAAM,EAAE,SAAA,EAAW,QAAU,EAAA,SAAA,GAAY,KAAQ,GAAA,KAAA;AACjD,EAAA,MAAM,EAAE,CAAA,EAAM,GAAA,iBAAA,CAAkB,0BAA0B,CAAA;AAC1D,EAAA,MAAM,UAAU,SAAU,EAAA;AAC1B,EAAA,MAAM,YAAY,YAAa,EAAA;AAC/B,EAAA,MAAM,aAAa,aAAc,CAAA;AAAA,IAC/B,OAAS,EAAA,SAAA;AAAA,IACT,OAAS,EAAA;AAAA,GACV,CAAA;AACD,EAAA,MAAM,CAAC,SAAA,EAAW,YAAY,CAAA,GAAI,SAAS,KAAK,CAAA;AAEhD,EAAA,MAAM,yBAA4B,GAAA,OAAA;AAAA,IAChC,MAAM,QAAS,CAAA,MAAM,YAAa,CAAA,IAAI,GAAG,SAAS,CAAA;AAAA,IAClD,CAAC,SAAS;AAAA,GACZ;AAEA,EAAM,MAAA,CAAC,EAAE,OAAA,EAAS,KAAO,EAAA,KAAA,EAAO,QAAU,EAAA,IAAI,CAAI,GAAA,UAAA,CAAW,YAAY;AACvE,IAAM,MAAA,UAAA,GAAa,SAAU,CAAA,GAAA,CAAI,aAAa,CAAA;AAC9C,IAAA,IAAI,UAAY,EAAA;AACd,MAAA,MAAM,eAAkB,GAAA,MAAM,UAAW,CAAA,cAAA,CAAe,SAAS,CAAA;AACjE,MAAA,IAAI,CAAC,eAAiB,EAAA;AACpB,QAAA,MAAM,IAAI,KAAA,CAAM,CAAG,EAAA,SAAS,CAAY,UAAA,CAAA,CAAA;AAAA;AAE1C,MAAO,OAAA,eAAA;AAAA;AAET,IAAO,OAAA,KAAA,CAAA;AAAA,GACN,EAAA,CAAC,SAAW,EAAA,SAAS,CAAC,CAAA;AAEzB,EAAA,MAAM,qBAAqB,MAAM;AAC/B,IAAA,YAAA,CAAa,KAAK,CAAA;AAClB,IAAA,yBAAA,CAA0B,MAAO,EAAA;AAAA,GACnC;AAEA,EAAA,SAAA,CAAU,MAAM;AACd,IAAA,IAAI,WAAW,MAAU,IAAA,CAAC,UAAU,CAAC,KAAA,IAAS,CAAC,OAAS,EAAA;AACtD,MAAK,IAAA,EAAA;AAAA;AACP,GACF,EAAG,CAAC,UAAW,CAAA,MAAA,EAAQ,MAAM,MAAQ,EAAA,KAAA,EAAO,OAAO,CAAC,CAAA;AAEpD,EAAA,iFAEK,KAAA,CAAA,aAAA,CAAA,UAAA,EAAA,EAAW,SAAU,EAAA,MAAA,EAAO,cAAc,yBACzC,EAAA,kBAAA,KAAA,CAAA,aAAA;AAAA,IAAC,UAAA;AAAA,IAAA;AAAA,MACC,SAAU,EAAA,MAAA;AAAA,MACV,aAAY,EAAA,SAAA;AAAA,MACX,GAAG,UAAU,UAAU;AAAA,KAAA;AAAA,IAEvB;AAAA,GAEL,GACC,SACC,oBAAA,KAAA,CAAA,aAAA;AAAA,IAAC,YAAA;AAAA,IAAA;AAAA,MACC,UAAY,EAAA;AAAA,QACV,WAAW,OAAQ,CAAA;AAAA,OACrB;AAAA,MACC,GAAG,YAAY,UAAU,CAAA;AAAA,MAC1B,YAAc,EAAA;AAAA,QACZ,QAAU,EAAA,QAAA;AAAA,QACV,UAAY,EAAA;AAAA,OACd;AAAA,MACA,eAAiB,EAAA;AAAA,QACf,QAAU,EAAA,KAAA;AAAA,QACV,UAAY,EAAA;AAAA,OACd;AAAA,MACA,YAAc,EAAA;AAAA,KAAA;AAAA,oBAEd,KAAA,CAAA,aAAA,CAAC,4BACE,KAAA,CAAA,aAAA,CAAA,WAAA,EAAA,IAAA,EACE,yBAAU,KAAA,CAAA,aAAA,CAAA,kBAAA,EAAA,EAAmB,OAAc,CAC3C,EAAA,OAAA,wCAAY,QAAS,EAAA,IAAA,CAAA,EACrB,0BAEG,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,QAAA,EAAA,IAAA,kBAAA,KAAA,CAAA,aAAA,CAAC,cAAW,KAAM,EAAA,eAAA,EAAA,EACf,OAAO,QAAS,CAAA,SACnB,mBACC,KAAA,CAAA,aAAA,CAAA,UAAA,EAAA,EAAW,SAAQ,IAAK,EAAA,SAAA,EAAU,SAChC,MAAO,CAAA,QAAA,CAAS,IACnB,CACA,kBAAA,KAAA,CAAA,aAAA,CAAC,cAAW,KAAM,EAAA,eAAA,EAAgB,cAAY,IAC3C,EAAA,EAAA,MAAA,CAAO,IACV,CACC,EAAA,MAAA,CAAO,SAAS,WACf,oBAAA,KAAA,CAAA,aAAA;AAAA,MAAC,UAAA;AAAA,MAAA;AAAA,QACC,WAAW,OAAQ,CAAA,qBAAA;AAAA,QACnB,SAAS,EAAA;AAAA,OAAA;AAAA,MAER,OAAO,QAAS,CAAA;AAAA,KACnB,sCAED,UAAY,EAAA,IAAA,EAAA,MAAA,CAAO,MAAM,IAAM,EAAA,QAAA,EAAW,CAAA,kBAC1C,KAAA,CAAA,aAAA,CAAA,GAAA,EAAA,EAAI,WAAU,OACX,EAAA,EAAA,CAAA,MAAA,CAAO,QAAS,CAAA,IAAA,IAAQ,EAAC,EACxB,MAAM,CAAG,EAAA,WAAW,CACpB,CAAA,GAAA,CAAI,CAAO,GAAA,KAAA;AACV,MAAA,2CAAQ,IAAK,EAAA,EAAA,GAAA,EAAK,KAAK,IAAK,EAAA,OAAA,EAAQ,OAAO,GAAK,EAAA,CAAA;AAAA,KACjD,CACF,EAAA,MAAA,CAAO,QAAS,CAAA,IAAA,EAAM,UACrB,MAAO,CAAA,QAAA,CAAS,IAAM,EAAA,MAAA,GAAS,WAC7B,oBAAA,KAAA,CAAA,aAAA,CAAC,WAAQ,KAAO,EAAA,CAAA,CAAE,8BAA8B,CAAA,EAAA,kBAC7C,KAAA,CAAA,aAAA,CAAA,IAAA,EAAA,EAAK,GAAI,EAAA,YAAA,EAAa,IAAK,EAAA,OAAA,EAAQ,KAAM,EAAA,KAAA,EAAM,CAClD,CAEN,CACF,CAEJ,CAAA,EACC,CAAC,KAAA,IAAS,MACT,oBAAA,KAAA,CAAA,aAAA,CAAC,WACC,EAAA,IAAA,kBAAA,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,QAAA,EAAA,IAAA,EACG,YAAa,CAAA,MAAM,CAAK,oBAAA,KAAA,CAAA,aAAA,CAAC,eAAgB,EAAA,EAAA,MAAA,EAAgB,GACzD,aAAc,CAAA,MAAM,CACnB,oBAAA,KAAA,CAAA,aAAA,CAAC,gBAAiB,EAAA,EAAA,MAAA,EAAgB,CAEpC,kBAAA,KAAA,CAAA,aAAA,CAAC,iBAAkB,EAAA,EAAA,MAAA,EAAgB,CACrC,CACF,CAEJ;AAAA,GAGN,CAAA;AAEJ;;;;"}