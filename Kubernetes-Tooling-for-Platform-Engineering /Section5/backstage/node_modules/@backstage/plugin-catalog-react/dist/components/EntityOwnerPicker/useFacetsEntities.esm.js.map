{"version":3,"file":"useFacetsEntities.esm.js","sources":["../../../src/components/EntityOwnerPicker/useFacetsEntities.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { useApi } from '@backstage/core-plugin-api';\nimport useAsyncFn from 'react-use/esm/useAsyncFn';\nimport { catalogApiRef } from '../../api';\nimport { useState } from 'react';\nimport { Entity, parseEntityRef } from '@backstage/catalog-model';\n\ntype FacetsCursor = {\n  start: number;\n  text: string;\n};\n\ntype FacetsEntitiesResponse = {\n  items: Entity[];\n  cursor?: string;\n};\n\ntype FacetsInitialRequest = {\n  text: string;\n};\n\n/**\n * This hook asynchronously loads the entity owners using the facets endpoint.\n * EntityOwnerPicker uses this hook when mode=\"owners-only\" is passed as prop.\n * All the owners are kept internally in memory and rendered in batches once requested\n * by the frontend. The values returned by this hook are compatible with `useQueryEntities`\n * hook, which is also used by EntityOwnerPicker.\n * In this mode, the EntityOwnerPicker won't show detailed information of the owners.\n */\nexport function useFacetsEntities({ enabled }: { enabled: boolean }) {\n  const catalogApi = useApi(catalogApiRef);\n\n  const [facetsPromise] = useState(async () => {\n    if (!enabled) {\n      return [];\n    }\n    const facet = 'relations.ownedBy';\n\n    return catalogApi\n      .getEntityFacets({ facets: [facet] })\n      .then(response =>\n        response.facets[facet]\n          .map(e => e.value)\n          .map(ref => {\n            const { kind, name, namespace } = parseEntityRef(ref);\n            return {\n              apiVersion: 'backstage.io/v1beta1',\n              kind,\n              metadata: { name, namespace },\n            };\n          })\n          .sort(\n            (a, b) =>\n              a.kind.localeCompare(b.kind, 'en-US') ||\n              a.metadata.namespace.localeCompare(\n                b.metadata.namespace,\n                'en-US',\n              ) ||\n              a.metadata.name.localeCompare(b.metadata.name, 'en-US'),\n          ),\n      )\n      .catch(() => []);\n  });\n\n  return useAsyncFn<\n    (\n      request: FacetsInitialRequest | FacetsEntitiesResponse,\n      options?: { limit?: number },\n    ) => Promise<FacetsEntitiesResponse>\n  >(\n    async (request, options) => {\n      const facets = await facetsPromise;\n\n      if (!facets) {\n        return {\n          items: [],\n        };\n      }\n\n      const limit = options?.limit ?? 20;\n\n      const { text, start } = decodeCursor(request);\n      const filteredRefs = facets.filter(e => filterEntity(text, e));\n      const end = start + limit;\n      return {\n        items: filteredRefs.slice(0, end),\n        ...encodeCursor({\n          entities: filteredRefs,\n          limit: end,\n          payload: {\n            text,\n            start: end,\n          },\n        }),\n      };\n    },\n    [facetsPromise],\n    { loading: true, value: { items: [] } },\n  );\n}\n\nfunction decodeCursor(\n  request: FacetsInitialRequest | FacetsEntitiesResponse,\n): FacetsCursor {\n  if (isFacetsResponse(request) && request.cursor) {\n    return JSON.parse(atob(request.cursor));\n  }\n  return {\n    text: (request as FacetsInitialRequest).text || '',\n    start: 0,\n  };\n}\n\nfunction isFacetsResponse(\n  request: FacetsInitialRequest | FacetsEntitiesResponse,\n): request is FacetsEntitiesResponse {\n  return !!(request as FacetsEntitiesResponse).cursor;\n}\n\nfunction encodeCursor({\n  entities,\n  limit,\n  payload,\n}: {\n  entities: Entity[];\n  limit: number;\n  payload: { text: string; start: number };\n}) {\n  if (entities.length > limit) {\n    return { cursor: btoa(JSON.stringify(payload)) };\n  }\n  return {};\n}\n\nfunction filterEntity(text: string, entity: Entity) {\n  const normalizedText = text.trim();\n  return (\n    entity.kind.includes(normalizedText) ||\n    entity.metadata.namespace?.includes(normalizedText) ||\n    entity.metadata.name.includes(normalizedText)\n  );\n}\n"],"names":[],"mappings":"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"}