{"version":3,"file":"authenticator.cjs.js","sources":["../src/authenticator.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Strategy as Oauth2Strategy } from 'passport-oauth2';\nimport {\n  createOAuthAuthenticator,\n  PassportOAuthAuthenticatorHelper,\n  PassportOAuthDoneCallback,\n  PassportProfile,\n} from '@backstage/plugin-auth-node';\n\n/** @public */\nexport const oauth2Authenticator = createOAuthAuthenticator({\n  defaultProfileTransform:\n    PassportOAuthAuthenticatorHelper.defaultProfileTransform,\n  initialize({ callbackUrl, config }) {\n    const clientId = config.getString('clientId');\n    const clientSecret = config.getString('clientSecret');\n    const authorizationUrl = config.getString('authorizationUrl');\n    const tokenUrl = config.getString('tokenUrl');\n    const includeBasicAuth = config.getOptionalBoolean('includeBasicAuth');\n\n    if (config.has('scope')) {\n      throw new Error(\n        'The oauth2 provider no longer supports the \"scope\" configuration option. Please use the \"additionalScopes\" option instead.',\n      );\n    }\n\n    return PassportOAuthAuthenticatorHelper.from(\n      new Oauth2Strategy(\n        {\n          clientID: clientId,\n          clientSecret: clientSecret,\n          callbackURL: callbackUrl,\n          authorizationURL: authorizationUrl,\n          tokenURL: tokenUrl,\n          passReqToCallback: false,\n          customHeaders: includeBasicAuth\n            ? {\n                Authorization: `Basic ${encodeClientCredentials(\n                  clientId,\n                  clientSecret,\n                )}`,\n              }\n            : undefined,\n        },\n        (\n          accessToken: any,\n          refreshToken: any,\n          params: any,\n          fullProfile: PassportProfile,\n          done: PassportOAuthDoneCallback,\n        ) => {\n          done(\n            undefined,\n            { fullProfile, params, accessToken },\n            { refreshToken },\n          );\n        },\n      ),\n    );\n  },\n\n  async start(input, helper) {\n    return helper.start(input, {\n      accessType: 'offline',\n      prompt: 'consent',\n    });\n  },\n\n  async authenticate(input, helper) {\n    return helper.authenticate(input);\n  },\n\n  async refresh(input, helper) {\n    return helper.refresh(input);\n  },\n});\n\n/** @private */\nfunction encodeClientCredentials(\n  clientID: string,\n  clientSecret: string,\n): string {\n  return Buffer.from(`${clientID}:${clientSecret}`).toString('base64');\n}\n"],"names":["createOAuthAuthenticator","PassportOAuthAuthenticatorHelper","Oauth2Strategy"],"mappings":";;;;;AAyBO,MAAM,sBAAsBA,uCAAyB,CAAA;AAAA,EAC1D,yBACEC,+CAAiC,CAAA,uBAAA;AAAA,EACnC,UAAW,CAAA,EAAE,WAAa,EAAA,MAAA,EAAU,EAAA;AAClC,IAAM,MAAA,QAAA,GAAW,MAAO,CAAA,SAAA,CAAU,UAAU,CAAA;AAC5C,IAAM,MAAA,YAAA,GAAe,MAAO,CAAA,SAAA,CAAU,cAAc,CAAA;AACpD,IAAM,MAAA,gBAAA,GAAmB,MAAO,CAAA,SAAA,CAAU,kBAAkB,CAAA;AAC5D,IAAM,MAAA,QAAA,GAAW,MAAO,CAAA,SAAA,CAAU,UAAU,CAAA;AAC5C,IAAM,MAAA,gBAAA,GAAmB,MAAO,CAAA,kBAAA,CAAmB,kBAAkB,CAAA;AAErE,IAAI,IAAA,MAAA,CAAO,GAAI,CAAA,OAAO,CAAG,EAAA;AACvB,MAAA,MAAM,IAAI,KAAA;AAAA,QACR;AAAA,OACF;AAAA;AAGF,IAAA,OAAOA,+CAAiC,CAAA,IAAA;AAAA,MACtC,IAAIC,uBAAA;AAAA,QACF;AAAA,UACE,QAAU,EAAA,QAAA;AAAA,UACV,YAAA;AAAA,UACA,WAAa,EAAA,WAAA;AAAA,UACb,gBAAkB,EAAA,gBAAA;AAAA,UAClB,QAAU,EAAA,QAAA;AAAA,UACV,iBAAmB,EAAA,KAAA;AAAA,UACnB,eAAe,gBACX,GAAA;AAAA,YACE,eAAe,CAAS,MAAA,EAAA,uBAAA;AAAA,cACtB,QAAA;AAAA,cACA;AAAA,aACD,CAAA;AAAA,WAEH,GAAA,KAAA;AAAA,SACN;AAAA,QACA,CACE,WAAA,EACA,YACA,EAAA,MAAA,EACA,aACA,IACG,KAAA;AACH,UAAA,IAAA;AAAA,YACE,KAAA,CAAA;AAAA,YACA,EAAE,WAAa,EAAA,MAAA,EAAQ,WAAY,EAAA;AAAA,YACnC,EAAE,YAAa;AAAA,WACjB;AAAA;AACF;AACF,KACF;AAAA,GACF;AAAA,EAEA,MAAM,KAAM,CAAA,KAAA,EAAO,MAAQ,EAAA;AACzB,IAAO,OAAA,MAAA,CAAO,MAAM,KAAO,EAAA;AAAA,MACzB,UAAY,EAAA,SAAA;AAAA,MACZ,MAAQ,EAAA;AAAA,KACT,CAAA;AAAA,GACH;AAAA,EAEA,MAAM,YAAa,CAAA,KAAA,EAAO,MAAQ,EAAA;AAChC,IAAO,OAAA,MAAA,CAAO,aAAa,KAAK,CAAA;AAAA,GAClC;AAAA,EAEA,MAAM,OAAQ,CAAA,KAAA,EAAO,MAAQ,EAAA;AAC3B,IAAO,OAAA,MAAA,CAAO,QAAQ,KAAK,CAAA;AAAA;AAE/B,CAAC;AAGD,SAAS,uBAAA,CACP,UACA,YACQ,EAAA;AACR,EAAO,OAAA,MAAA,CAAO,KAAK,CAAG,EAAA,QAAQ,IAAI,YAAY,CAAA,CAAE,CAAE,CAAA,QAAA,CAAS,QAAQ,CAAA;AACrE;;;;"}