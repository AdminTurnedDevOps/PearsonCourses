import React, { Suspense, lazy, useEffect } from 'react';
import { AnalyticsContext, useAnalytics } from '@backstage/core-plugin-api';
import { ErrorBoundary } from './ErrorBoundary.esm.js';
import { routableExtensionRenderedEvent } from '../core-plugin-api/src/analytics/Tracker.esm.js';
import '../apis/definitions/AppTreeApi.esm.js';
import { useComponentRef } from '../apis/definitions/ComponentsApi.esm.js';
import '../apis/definitions/IconsApi.esm.js';
import '../apis/definitions/RouteResolutionApi.esm.js';
import '../apis/definitions/AnalyticsApi.esm.js';
import { coreComponentRefs } from './coreComponentRefs.esm.js';
import { coreExtensionData } from '../wiring/coreExtensionData.esm.js';
import 'zod';
import 'zod-to-json-schema';

const RouteTracker = (props) => {
  const { disableTracking, children } = props;
  const analytics = useAnalytics();
  useEffect(() => {
    if (disableTracking) return;
    analytics.captureEvent(routableExtensionRenderedEvent, "");
  }, [analytics, disableTracking]);
  return /* @__PURE__ */ React.createElement(React.Fragment, null, children);
};
function ExtensionBoundary(props) {
  const { node, routable, children } = props;
  const doesOutputRoutePath = Boolean(
    node.instance?.getData(coreExtensionData.routePath)
  );
  const plugin = node.spec.source;
  const Progress = useComponentRef(coreComponentRefs.progress);
  const fallback = useComponentRef(coreComponentRefs.errorBoundaryFallback);
  const attributes = {
    extensionId: node.spec.id,
    pluginId: node.spec.source?.id ?? "app"
  };
  return /* @__PURE__ */ React.createElement(Suspense, { fallback: /* @__PURE__ */ React.createElement(Progress, null) }, /* @__PURE__ */ React.createElement(ErrorBoundary, { plugin, Fallback: fallback }, /* @__PURE__ */ React.createElement(AnalyticsContext, { attributes }, /* @__PURE__ */ React.createElement(RouteTracker, { disableTracking: !(routable ?? doesOutputRoutePath) }, children))));
}
((ExtensionBoundary2) => {
  function lazy$1(appNode, lazyElement) {
    const ExtensionComponent = lazy(
      () => lazyElement().then((element) => ({ default: () => element }))
    );
    return /* @__PURE__ */ React.createElement(ExtensionBoundary2, { node: appNode }, /* @__PURE__ */ React.createElement(ExtensionComponent, null));
  }
  ExtensionBoundary2.lazy = lazy$1;
})(ExtensionBoundary || (ExtensionBoundary = {}));

export { ExtensionBoundary };
//# sourceMappingURL=ExtensionBoundary.esm.js.map
