{"version":3,"file":"alpha.esm.js","sources":["../src/alpha.tsx"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from 'react';\n\nimport Grid from '@material-ui/core/Grid';\nimport Paper from '@material-ui/core/Paper';\nimport { makeStyles, Theme } from '@material-ui/core/styles';\nimport SearchIcon from '@material-ui/icons/Search';\n\nimport {\n  CatalogIcon,\n  Content,\n  DocsIcon,\n  Header,\n  Page,\n  useSidebarPinState,\n} from '@backstage/core-components';\nimport {\n  useApi,\n  discoveryApiRef,\n  fetchApiRef,\n  createApiFactory,\n} from '@backstage/core-plugin-api';\n\nimport {\n  createFrontendPlugin,\n  ApiBlueprint,\n  createExtensionInput,\n  PageBlueprint,\n  NavItemBlueprint,\n} from '@backstage/frontend-plugin-api';\n\nimport {\n  catalogApiRef,\n  CATALOG_FILTER_EXISTS,\n} from '@backstage/plugin-catalog-react';\n\nimport {\n  DefaultResultListItem,\n  SearchBar,\n  SearchFilter,\n  SearchPagination,\n  SearchResult as SearchResults,\n  SearchResultPager,\n  useSearch,\n  SearchContextProvider,\n} from '@backstage/plugin-search-react';\nimport { SearchResult } from '@backstage/plugin-search-common';\nimport { searchApiRef } from '@backstage/plugin-search-react';\nimport { SearchResultListItemBlueprint } from '@backstage/plugin-search-react/alpha';\n\nimport { rootRouteRef } from './plugin';\nimport { SearchClient } from './apis';\nimport { SearchType } from './components/SearchType';\nimport { UrlUpdater } from './components/SearchPage/SearchPage';\nimport {\n  compatWrapper,\n  convertLegacyRouteRef,\n  convertLegacyRouteRefs,\n} from '@backstage/core-compat-api';\n\n/** @alpha */\nexport const searchApi = ApiBlueprint.make({\n  params: {\n    factory: createApiFactory({\n      api: searchApiRef,\n      deps: { discoveryApi: discoveryApiRef, fetchApi: fetchApiRef },\n      factory: ({ discoveryApi, fetchApi }) =>\n        new SearchClient({ discoveryApi, fetchApi }),\n    }),\n  },\n});\n\nconst useSearchPageStyles = makeStyles((theme: Theme) => ({\n  filter: {\n    '& + &': {\n      marginTop: theme.spacing(2.5),\n    },\n  },\n  filters: {\n    padding: theme.spacing(2),\n    marginTop: theme.spacing(2),\n  },\n}));\n\n/** @alpha */\nexport const searchPage = PageBlueprint.makeWithOverrides({\n  config: {\n    schema: {\n      noTrack: z => z.boolean().default(false),\n    },\n  },\n  inputs: {\n    items: createExtensionInput([SearchResultListItemBlueprint.dataRefs.item]),\n  },\n  factory(originalFactory, { config, inputs }) {\n    return originalFactory({\n      defaultPath: '/search',\n      routeRef: convertLegacyRouteRef(rootRouteRef),\n      loader: async () => {\n        const getResultItemComponent = (result: SearchResult) => {\n          const value = inputs.items.find(item =>\n            item\n              ?.get(SearchResultListItemBlueprint.dataRefs.item)\n              .predicate?.(result),\n          );\n          return (\n            value?.get(SearchResultListItemBlueprint.dataRefs.item).component ??\n            DefaultResultListItem\n          );\n        };\n\n        const Component = () => {\n          const classes = useSearchPageStyles();\n          const { isMobile } = useSidebarPinState();\n          const { types } = useSearch();\n          const catalogApi = useApi(catalogApiRef);\n\n          return (\n            <Page themeId=\"home\">\n              {!isMobile && <Header title=\"Search\" />}\n              <Content>\n                <Grid container direction=\"row\">\n                  <Grid item xs={12}>\n                    <SearchBar debounceTime={100} />\n                  </Grid>\n                  {!isMobile && (\n                    <Grid item xs={3}>\n                      <SearchType.Accordion\n                        name=\"Result Type\"\n                        defaultValue=\"software-catalog\"\n                        showCounts\n                        types={[\n                          {\n                            value: 'software-catalog',\n                            name: 'Software Catalog',\n                            icon: <CatalogIcon />,\n                          },\n                          {\n                            value: 'techdocs',\n                            name: 'Documentation',\n                            icon: <DocsIcon />,\n                          },\n                        ]}\n                      />\n                      <Paper className={classes.filters}>\n                        {types.includes('techdocs') && (\n                          <SearchFilter.Select\n                            className={classes.filter}\n                            label=\"Entity\"\n                            name=\"name\"\n                            values={async () => {\n                              // Return a list of entities which are documented.\n                              const { items } = await catalogApi.getEntities({\n                                fields: ['metadata.name'],\n                                filter: {\n                                  'metadata.annotations.backstage.io/techdocs-ref':\n                                    CATALOG_FILTER_EXISTS,\n                                },\n                              });\n\n                              const names = items.map(\n                                entity => entity.metadata.name,\n                              );\n                              names.sort();\n                              return names;\n                            }}\n                          />\n                        )}\n                        <SearchFilter.Select\n                          className={classes.filter}\n                          label=\"Kind\"\n                          name=\"kind\"\n                          values={['Component', 'Template']}\n                        />\n                        <SearchFilter.Checkbox\n                          className={classes.filter}\n                          label=\"Lifecycle\"\n                          name=\"lifecycle\"\n                          values={['experimental', 'production']}\n                        />\n                      </Paper>\n                    </Grid>\n                  )}\n                  <Grid item xs>\n                    <SearchPagination />\n                    <SearchResults>\n                      {({ results }) => (\n                        <>\n                          {results.map((result, index) => {\n                            const { noTrack } = config;\n                            const { document, ...rest } = result;\n                            const SearchResultListItem =\n                              getResultItemComponent(result);\n                            return (\n                              <SearchResultListItem\n                                {...rest}\n                                key={index}\n                                result={document}\n                                noTrack={noTrack}\n                              />\n                            );\n                          })}\n                        </>\n                      )}\n                    </SearchResults>\n                    <SearchResultPager />\n                  </Grid>\n                </Grid>\n              </Content>\n            </Page>\n          );\n        };\n\n        return compatWrapper(\n          <SearchContextProvider>\n            <UrlUpdater />\n            <Component />\n          </SearchContextProvider>,\n        );\n      },\n    });\n  },\n});\n\n/** @alpha */\nexport const searchNavItem = NavItemBlueprint.make({\n  params: {\n    routeRef: convertLegacyRouteRef(rootRouteRef),\n    title: 'Search',\n    icon: SearchIcon,\n  },\n});\n\n/** @alpha */\nexport default createFrontendPlugin({\n  id: 'search',\n  extensions: [searchApi, searchPage, searchNavItem],\n  routes: convertLegacyRouteRefs({\n    root: rootRouteRef,\n  }),\n});\n"],"names":["SearchResults"],"mappings":"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"}