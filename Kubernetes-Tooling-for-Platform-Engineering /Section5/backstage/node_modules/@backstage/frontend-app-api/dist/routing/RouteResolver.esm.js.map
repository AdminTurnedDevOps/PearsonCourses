{"version":3,"file":"RouteResolver.esm.js","sources":["../../src/routing/RouteResolver.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { generatePath, matchRoutes } from 'react-router-dom';\nimport {\n  RouteRef,\n  ExternalRouteRef,\n  SubRouteRef,\n  AnyRouteRefParams,\n  RouteFunc,\n  RouteResolutionApiResolveOptions,\n  RouteResolutionApi,\n} from '@backstage/frontend-plugin-api';\nimport mapValues from 'lodash/mapValues';\nimport { AnyRouteRef, BackstageRouteObject } from './types';\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { isRouteRef } from '../../../frontend-plugin-api/src/routing/RouteRef';\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport {\n  isSubRouteRef,\n  toInternalSubRouteRef,\n} from '../../../frontend-plugin-api/src/routing/SubRouteRef';\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { isExternalRouteRef } from '../../../frontend-plugin-api/src/routing/ExternalRouteRef';\n\n// Joins a list of paths together, avoiding trailing and duplicate slashes\nexport function joinPaths(...paths: string[]): string {\n  const normalized = paths.join('/').replace(/\\/\\/+/g, '/');\n  if (normalized !== '/' && normalized.endsWith('/')) {\n    return normalized.slice(0, -1);\n  }\n  return normalized;\n}\n\n/**\n * Resolves the absolute route ref that our target route ref is pointing pointing to, as well\n * as the relative target path.\n *\n * Returns an undefined target ref if one could not be fully resolved.\n */\nfunction resolveTargetRef(\n  anyRouteRef: AnyRouteRef,\n  routePaths: Map<RouteRef, string>,\n  routeBindings: Map<AnyRouteRef, AnyRouteRef | undefined>,\n): readonly [RouteRef | undefined, string] {\n  // First we figure out which absolute route ref we're dealing with, an if there was an sub route path to append.\n  // For sub routes it will be the parent path, while for external routes it will be the bound route.\n  let targetRef: RouteRef;\n  let subRoutePath = '';\n  if (isRouteRef(anyRouteRef)) {\n    targetRef = anyRouteRef;\n  } else if (isSubRouteRef(anyRouteRef)) {\n    const internal = toInternalSubRouteRef(anyRouteRef);\n    targetRef = internal.getParent();\n    subRoutePath = internal.path;\n  } else if (isExternalRouteRef(anyRouteRef)) {\n    const resolvedRoute = routeBindings.get(anyRouteRef);\n    if (!resolvedRoute) {\n      return [undefined, ''];\n    }\n    if (isRouteRef(resolvedRoute)) {\n      targetRef = resolvedRoute;\n    } else if (isSubRouteRef(resolvedRoute)) {\n      const internal = toInternalSubRouteRef(resolvedRoute);\n      targetRef = internal.getParent();\n      subRoutePath = resolvedRoute.path;\n    } else {\n      throw new Error(\n        `ExternalRouteRef was bound to invalid target, ${resolvedRoute}`,\n      );\n    }\n  } else {\n    throw new Error(`Unknown object passed to useRouteRef, got ${anyRouteRef}`);\n  }\n\n  // Bail if no absolute path could be resolved\n  if (!targetRef) {\n    return [undefined, ''];\n  }\n\n  // Find the path that our target route is bound to\n  const resolvedPath = routePaths.get(targetRef);\n  if (resolvedPath === undefined) {\n    return [undefined, ''];\n  }\n\n  // SubRouteRefs join the path from the parent route with its own path\n  const targetPath = joinPaths(resolvedPath, subRoutePath);\n  return [targetRef, targetPath];\n}\n\n/**\n * Resolves the complete base path for navigating to the target RouteRef.\n */\nfunction resolveBasePath(\n  targetRef: RouteRef,\n  sourceLocation: Parameters<typeof matchRoutes>[1],\n  routePaths: Map<RouteRef, string>,\n  routeParents: Map<RouteRef, RouteRef | undefined>,\n  routeObjects: BackstageRouteObject[],\n) {\n  // While traversing the app element tree we build up the routeObjects structure\n  // used here. It is the same kind of structure that react-router creates, with the\n  // addition that associated route refs are stored throughout the tree. This lets\n  // us look up all route refs that can be reached from our source location.\n  // Because of the similar route object structure, we can use `matchRoutes` from\n  // react-router to do the lookup of our current location.\n  const match = matchRoutes(routeObjects, sourceLocation) ?? [];\n\n  // While we search for a common routing root between our current location and\n  // the target route, we build a list of all route refs we find that we need\n  // to traverse to reach the target.\n  const refDiffList = Array<RouteRef>();\n\n  let matchIndex = -1;\n  for (\n    let targetSearchRef: RouteRef | undefined = targetRef;\n    targetSearchRef;\n    targetSearchRef = routeParents.get(targetSearchRef)\n  ) {\n    // The match contains a list of all ancestral route refs present at our current location\n    // Starting at the desired target ref and traversing back through its parents, we search\n    // for a target ref that is present in the match for our current location. When a match\n    // is found it means we have found a common base to resolve the route from.\n    matchIndex = match.findIndex(m =>\n      (m.route as BackstageRouteObject).routeRefs.has(targetSearchRef!),\n    );\n    if (matchIndex !== -1) {\n      break;\n    }\n\n    // Every time we move a step up in the ancestry of the target ref, we add the current ref\n    // to the diff list, which ends up being the list of route refs to traverse form the common base\n    // in order to reach our target.\n    refDiffList.unshift(targetSearchRef);\n  }\n\n  // If our target route is present in the initial match we need to construct the final path\n  // from the parent of the matched route segment. That's to allow the caller of the route\n  // function to supply their own params.\n  if (refDiffList.length === 0) {\n    matchIndex -= 1;\n  }\n\n  // This is the part of the route tree that the target and source locations have in common.\n  // We re-use the existing pathname directly along with all params.\n  const parentPath = matchIndex === -1 ? '' : match[matchIndex].pathname;\n\n  // This constructs the mid section of the path using paths resolved from all route refs\n  // we need to traverse to reach our target except for the very last one. None of these\n  // paths are allowed to require any parameters, as the caller would have no way of knowing\n  // what parameters those are.\n  const diffPaths = refDiffList.slice(0, -1).map(ref => {\n    const path = routePaths.get(ref);\n    if (path === undefined) {\n      throw new Error(`No path for ${ref}`);\n    }\n    if (path.includes(':')) {\n      throw new Error(\n        `Cannot route to ${targetRef} with parent ${ref} as it has parameters`,\n      );\n    }\n    return path;\n  });\n\n  return `${joinPaths(parentPath, ...diffPaths)}/`;\n}\n\nexport class RouteResolver implements RouteResolutionApi {\n  constructor(\n    private readonly routePaths: Map<RouteRef, string>,\n    private readonly routeParents: Map<RouteRef, RouteRef | undefined>,\n    private readonly routeObjects: BackstageRouteObject[],\n    private readonly routeBindings: Map<\n      ExternalRouteRef,\n      RouteRef | SubRouteRef\n    >,\n    private readonly appBasePath: string, // base path without a trailing slash\n  ) {}\n\n  resolve<TParams extends AnyRouteRefParams>(\n    anyRouteRef:\n      | RouteRef<TParams>\n      | SubRouteRef<TParams>\n      | ExternalRouteRef<TParams>,\n    options?: RouteResolutionApiResolveOptions,\n  ): RouteFunc<TParams> | undefined {\n    // First figure out what our target absolute ref is, as well as our target path.\n    const [targetRef, targetPath] = resolveTargetRef(\n      anyRouteRef,\n      this.routePaths,\n      this.routeBindings,\n    );\n    if (!targetRef) {\n      return undefined;\n    }\n\n    // The location that we get passed in uses the full path, so start by trimming off\n    // the app base path prefix in case we're running the app on a sub-path.\n    const relativeSourceLocation = this.trimPath(options?.sourcePath ?? '');\n\n    // Next we figure out the base path, which is the combination of the common parent path\n    // between our current location and our target location, as well as the additional path\n    // that is the difference between the parent path and the base of our target location.\n    const basePath = resolveBasePath(\n      targetRef,\n      relativeSourceLocation,\n      this.routePaths,\n      this.routeParents,\n      this.routeObjects,\n    );\n\n    const routeFunc: RouteFunc<TParams> = (...[params]) => {\n      // We selectively encode some some known-dangerous characters in the\n      // params. The reason that we don't perform a blanket `encodeURIComponent`\n      // here is that this encoding was added defensively long after the initial\n      // release of this code. There's likely to be many users of this code that\n      // already encode their parameters knowing that this code didn't do this\n      // for them in the past. Therefore, we are extra careful NOT to include\n      // the percent character in this set, even though that might seem like a\n      // bad idea.\n      const encodedParams =\n        params &&\n        mapValues(params, value => {\n          if (typeof value === 'string') {\n            return value.replaceAll(/[&?#;\\/]/g, c => encodeURIComponent(c));\n          }\n          return value;\n        });\n      return joinPaths(basePath, generatePath(targetPath, encodedParams));\n    };\n    return routeFunc;\n  }\n\n  private trimPath(targetPath: string) {\n    if (!targetPath) {\n      return targetPath;\n    }\n\n    if (targetPath.startsWith(this.appBasePath)) {\n      return targetPath.slice(this.appBasePath.length);\n    }\n    return targetPath;\n  }\n}\n"],"names":[],"mappings":"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"}