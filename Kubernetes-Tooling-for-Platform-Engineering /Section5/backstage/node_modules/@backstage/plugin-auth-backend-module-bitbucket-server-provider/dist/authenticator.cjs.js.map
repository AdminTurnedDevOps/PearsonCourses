{"version":3,"file":"authenticator.cjs.js","sources":["../src/authenticator.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Strategy as OAuth2Strategy, VerifyCallback } from 'passport-oauth2';\nimport {\n  createOAuthAuthenticator,\n  PassportOAuthAuthenticatorHelper,\n  PassportProfile,\n} from '@backstage/plugin-auth-node';\nimport { fetchProfile } from './helpers';\n\n/** @public */\nexport const bitbucketServerAuthenticator = createOAuthAuthenticator({\n  defaultProfileTransform:\n    PassportOAuthAuthenticatorHelper.defaultProfileTransform,\n  initialize({ callbackUrl, config }) {\n    const clientID = config.getString('clientId');\n    const clientSecret = config.getString('clientSecret');\n    const host = config.getString('host');\n    const callbackURL = config.getOptionalString('callbackUrl') ?? callbackUrl;\n\n    const helper = PassportOAuthAuthenticatorHelper.from(\n      new OAuth2Strategy(\n        {\n          clientID,\n          clientSecret,\n          callbackURL,\n          authorizationURL: `https://${host}/rest/oauth2/latest/authorize`,\n          tokenURL: `https://${host}/rest/oauth2/latest/token`,\n        },\n        (\n          accessToken: string,\n          refreshToken: string,\n          params: any,\n          fullProfile: PassportProfile,\n          done: VerifyCallback,\n        ) => {\n          done(\n            undefined,\n            { fullProfile, params, accessToken },\n            { refreshToken },\n          );\n        },\n      ),\n    );\n\n    return { helper, host };\n  },\n\n  async start(input, { helper }) {\n    return helper.start(input, {\n      accessType: 'offline',\n      prompt: 'consent',\n    });\n  },\n\n  async authenticate(input, { helper, host }) {\n    const result = await helper.authenticate(input);\n\n    // The OAuth2 strategy does not return a user profile, so we fetch it manually\n    const fullProfile = await fetchProfile({\n      host,\n      accessToken: result.session.accessToken,\n    });\n\n    return { ...result, fullProfile };\n  },\n\n  async refresh(input, { helper, host }) {\n    const result = await helper.refresh(input);\n\n    // The OAuth2 strategy does not return a user profile, so we fetch it manually\n    const fullProfile = await fetchProfile({\n      host,\n      accessToken: result.session.accessToken,\n    });\n\n    return { ...result, fullProfile };\n  },\n});\n"],"names":["createOAuthAuthenticator","PassportOAuthAuthenticatorHelper","OAuth2Strategy","fetchProfile"],"mappings":";;;;;;AAyBO,MAAM,+BAA+BA,uCAAyB,CAAA;AAAA,EACnE,yBACEC,+CAAiC,CAAA,uBAAA;AAAA,EACnC,UAAW,CAAA,EAAE,WAAa,EAAA,MAAA,EAAU,EAAA;AAClC,IAAM,MAAA,QAAA,GAAW,MAAO,CAAA,SAAA,CAAU,UAAU,CAAA;AAC5C,IAAM,MAAA,YAAA,GAAe,MAAO,CAAA,SAAA,CAAU,cAAc,CAAA;AACpD,IAAM,MAAA,IAAA,GAAO,MAAO,CAAA,SAAA,CAAU,MAAM,CAAA;AACpC,IAAA,MAAM,WAAc,GAAA,MAAA,CAAO,iBAAkB,CAAA,aAAa,CAAK,IAAA,WAAA;AAE/D,IAAA,MAAM,SAASA,+CAAiC,CAAA,IAAA;AAAA,MAC9C,IAAIC,uBAAA;AAAA,QACF;AAAA,UACE,QAAA;AAAA,UACA,YAAA;AAAA,UACA,WAAA;AAAA,UACA,gBAAA,EAAkB,WAAW,IAAI,CAAA,6BAAA,CAAA;AAAA,UACjC,QAAA,EAAU,WAAW,IAAI,CAAA,yBAAA;AAAA,SAC3B;AAAA,QACA,CACE,WAAA,EACA,YACA,EAAA,MAAA,EACA,aACA,IACG,KAAA;AACH,UAAA,IAAA;AAAA,YACE,KAAA,CAAA;AAAA,YACA,EAAE,WAAa,EAAA,MAAA,EAAQ,WAAY,EAAA;AAAA,YACnC,EAAE,YAAa;AAAA,WACjB;AAAA;AACF;AACF,KACF;AAEA,IAAO,OAAA,EAAE,QAAQ,IAAK,EAAA;AAAA,GACxB;AAAA,EAEA,MAAM,KAAA,CAAM,KAAO,EAAA,EAAE,QAAU,EAAA;AAC7B,IAAO,OAAA,MAAA,CAAO,MAAM,KAAO,EAAA;AAAA,MACzB,UAAY,EAAA,SAAA;AAAA,MACZ,MAAQ,EAAA;AAAA,KACT,CAAA;AAAA,GACH;AAAA,EAEA,MAAM,YAAa,CAAA,KAAA,EAAO,EAAE,MAAA,EAAQ,MAAQ,EAAA;AAC1C,IAAA,MAAM,MAAS,GAAA,MAAM,MAAO,CAAA,YAAA,CAAa,KAAK,CAAA;AAG9C,IAAM,MAAA,WAAA,GAAc,MAAMC,oBAAa,CAAA;AAAA,MACrC,IAAA;AAAA,MACA,WAAA,EAAa,OAAO,OAAQ,CAAA;AAAA,KAC7B,CAAA;AAED,IAAO,OAAA,EAAE,GAAG,MAAA,EAAQ,WAAY,EAAA;AAAA,GAClC;AAAA,EAEA,MAAM,OAAQ,CAAA,KAAA,EAAO,EAAE,MAAA,EAAQ,MAAQ,EAAA;AACrC,IAAA,MAAM,MAAS,GAAA,MAAM,MAAO,CAAA,OAAA,CAAQ,KAAK,CAAA;AAGzC,IAAM,MAAA,WAAA,GAAc,MAAMA,oBAAa,CAAA;AAAA,MACrC,IAAA;AAAA,MACA,WAAA,EAAa,OAAO,OAAQ,CAAA;AAAA,KAC7B,CAAA;AAED,IAAO,OAAA,EAAE,GAAG,MAAA,EAAQ,WAAY,EAAA;AAAA;AAEpC,CAAC;;;;"}