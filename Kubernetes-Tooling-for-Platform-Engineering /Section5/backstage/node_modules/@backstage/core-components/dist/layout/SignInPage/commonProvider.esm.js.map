{"version":3,"file":"commonProvider.esm.js","sources":["../../../src/layout/SignInPage/commonProvider.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from 'react';\nimport Typography from '@material-ui/core/Typography';\nimport Button from '@material-ui/core/Button';\nimport { InfoCard } from '../InfoCard/InfoCard';\nimport {\n  ProviderComponent,\n  ProviderLoader,\n  SignInProvider,\n  SignInProviderConfig,\n} from './types';\nimport { useApi, errorApiRef } from '@backstage/core-plugin-api';\nimport { GridItem } from './styles';\nimport { ForwardedError } from '@backstage/errors';\nimport { UserIdentity } from './UserIdentity';\nimport { coreComponentsTranslationRef } from '../../translation';\nimport { useTranslationRef } from '@backstage/core-plugin-api/alpha';\n\nconst Component: ProviderComponent = ({\n  config,\n  onSignInStarted,\n  onSignInSuccess,\n  onSignInFailure,\n}) => {\n  const { apiRef, title, message } = config as SignInProviderConfig;\n  const authApi = useApi(apiRef);\n  const errorApi = useApi(errorApiRef);\n  const { t } = useTranslationRef(coreComponentsTranslationRef);\n\n  const handleLogin = async () => {\n    try {\n      onSignInStarted();\n      const identityResponse = await authApi.getBackstageIdentity({\n        instantPopup: true,\n      });\n      if (!identityResponse) {\n        onSignInFailure();\n        throw new Error(\n          `The ${title} provider is not configured to support sign-in`,\n        );\n      }\n\n      const profile = await authApi.getProfile();\n\n      onSignInSuccess(\n        UserIdentity.create({\n          identity: identityResponse.identity,\n          profile,\n          authApi,\n        }),\n      );\n    } catch (error) {\n      onSignInFailure();\n      errorApi.post(new ForwardedError(t('signIn.loginFailed'), error));\n    }\n  };\n\n  return (\n    <GridItem>\n      <InfoCard\n        variant=\"fullHeight\"\n        title={title}\n        actions={\n          <Button color=\"primary\" variant=\"outlined\" onClick={handleLogin}>\n            {t('signIn.title')}\n          </Button>\n        }\n      >\n        <Typography variant=\"body1\">{message}</Typography>\n      </InfoCard>\n    </GridItem>\n  );\n};\n\nconst loader: ProviderLoader = async (apis, apiRef) => {\n  const authApi = apis.get(apiRef)!;\n\n  const identityResponse = await authApi.getBackstageIdentity({\n    optional: true,\n  });\n\n  if (!identityResponse) {\n    return undefined;\n  }\n\n  const profile = await authApi.getProfile();\n\n  return UserIdentity.create({\n    identity: identityResponse.identity,\n    profile,\n    authApi,\n  });\n};\n\nexport const commonProvider: SignInProvider = { Component, loader };\n"],"names":["React"],"mappings":";;;;;;;;;;;AAiCA,MAAM,YAA+B,CAAC;AAAA,EACpC,MAAA;AAAA,EACA,eAAA;AAAA,EACA,eAAA;AAAA,EACA;AACF,CAAM,KAAA;AACJ,EAAA,MAAM,EAAE,MAAA,EAAQ,KAAO,EAAA,OAAA,EAAY,GAAA,MAAA;AACnC,EAAM,MAAA,OAAA,GAAU,OAAO,MAAM,CAAA;AAC7B,EAAM,MAAA,QAAA,GAAW,OAAO,WAAW,CAAA;AACnC,EAAA,MAAM,EAAE,CAAA,EAAM,GAAA,iBAAA,CAAkB,4BAA4B,CAAA;AAE5D,EAAA,MAAM,cAAc,YAAY;AAC9B,IAAI,IAAA;AACF,MAAgB,eAAA,EAAA;AAChB,MAAM,MAAA,gBAAA,GAAmB,MAAM,OAAA,CAAQ,oBAAqB,CAAA;AAAA,QAC1D,YAAc,EAAA;AAAA,OACf,CAAA;AACD,MAAA,IAAI,CAAC,gBAAkB,EAAA;AACrB,QAAgB,eAAA,EAAA;AAChB,QAAA,MAAM,IAAI,KAAA;AAAA,UACR,OAAO,KAAK,CAAA,8CAAA;AAAA,SACd;AAAA;AAGF,MAAM,MAAA,OAAA,GAAU,MAAM,OAAA,CAAQ,UAAW,EAAA;AAEzC,MAAA,eAAA;AAAA,QACE,aAAa,MAAO,CAAA;AAAA,UAClB,UAAU,gBAAiB,CAAA,QAAA;AAAA,UAC3B,OAAA;AAAA,UACA;AAAA,SACD;AAAA,OACH;AAAA,aACO,KAAO,EAAA;AACd,MAAgB,eAAA,EAAA;AAChB,MAAA,QAAA,CAAS,KAAK,IAAI,cAAA,CAAe,EAAE,oBAAoB,CAAA,EAAG,KAAK,CAAC,CAAA;AAAA;AAClE,GACF;AAEA,EAAA,oDACG,QACC,EAAA,IAAA,kBAAAA,cAAA,CAAA,aAAA;AAAA,IAAC,QAAA;AAAA,IAAA;AAAA,MACC,OAAQ,EAAA,YAAA;AAAA,MACR,KAAA;AAAA,MACA,OAAA,kBACGA,cAAA,CAAA,aAAA,CAAA,MAAA,EAAA,EAAO,KAAM,EAAA,SAAA,EAAU,OAAQ,EAAA,UAAA,EAAW,OAAS,EAAA,WAAA,EAAA,EACjD,CAAE,CAAA,cAAc,CACnB;AAAA,KAAA;AAAA,oBAGDA,cAAA,CAAA,aAAA,CAAA,UAAA,EAAA,EAAW,OAAQ,EAAA,OAAA,EAAA,EAAS,OAAQ;AAAA,GAEzC,CAAA;AAEJ,CAAA;AAEA,MAAM,MAAA,GAAyB,OAAO,IAAA,EAAM,MAAW,KAAA;AACrD,EAAM,MAAA,OAAA,GAAU,IAAK,CAAA,GAAA,CAAI,MAAM,CAAA;AAE/B,EAAM,MAAA,gBAAA,GAAmB,MAAM,OAAA,CAAQ,oBAAqB,CAAA;AAAA,IAC1D,QAAU,EAAA;AAAA,GACX,CAAA;AAED,EAAA,IAAI,CAAC,gBAAkB,EAAA;AACrB,IAAO,OAAA,KAAA,CAAA;AAAA;AAGT,EAAM,MAAA,OAAA,GAAU,MAAM,OAAA,CAAQ,UAAW,EAAA;AAEzC,EAAA,OAAO,aAAa,MAAO,CAAA;AAAA,IACzB,UAAU,gBAAiB,CAAA,QAAA;AAAA,IAC3B,OAAA;AAAA,IACA;AAAA,GACD,CAAA;AACH,CAAA;AAEa,MAAA,cAAA,GAAiC,EAAE,SAAA,EAAW,MAAO;;;;"}