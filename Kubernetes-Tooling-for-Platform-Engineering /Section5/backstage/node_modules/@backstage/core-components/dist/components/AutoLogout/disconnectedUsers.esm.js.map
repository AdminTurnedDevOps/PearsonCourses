{"version":3,"file":"disconnectedUsers.esm.js","sources":["../../../src/components/AutoLogout/disconnectedUsers.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { IdentityApi } from '@backstage/core-plugin-api';\nimport { useEffect } from 'react';\n\nimport { TimestampStore } from './timestampStore';\n\nexport const LAST_SEEN_ONLINE_STORAGE_KEY =\n  '@backstage/autologout:lastSeenOnline';\n\nexport type UseLogoutDisconnectedUserEffectProps = {\n  enableEffect: boolean;\n  autologoutIsEnabled: boolean;\n  idleTimeoutSeconds: number;\n  lastSeenOnlineStore: TimestampStore;\n  identityApi: IdentityApi;\n};\n\nexport const useLogoutDisconnectedUserEffect = ({\n  enableEffect,\n  autologoutIsEnabled,\n  idleTimeoutSeconds,\n  lastSeenOnlineStore,\n  identityApi,\n}: UseLogoutDisconnectedUserEffectProps) => {\n  useEffect(() => {\n    /**\n     * Considers disconnected users as inactive users.\n     * If all Backstage tabs are closed and idleTimeoutMinutes are passed then logout the user anyway.\n     */\n    if (autologoutIsEnabled && enableEffect) {\n      const lastSeenOnline = lastSeenOnlineStore.get();\n      if (lastSeenOnline) {\n        const now = new Date();\n        const nowSeconds = Math.ceil(now.getTime() / 1000);\n        const lastSeenOnlineSeconds = Math.ceil(\n          lastSeenOnline.getTime() / 1000,\n        );\n        if (nowSeconds - lastSeenOnlineSeconds > idleTimeoutSeconds) {\n          identityApi.signOut();\n        }\n      }\n      /**\n       * save for the first time when app is loaded, so that\n       * if user logs in and does nothing we still have a\n       * lastSeenOnline value in store\n       */\n      lastSeenOnlineStore.save(new Date());\n    } else {\n      lastSeenOnlineStore.delete();\n    }\n  }, [\n    autologoutIsEnabled,\n    enableEffect,\n    identityApi,\n    idleTimeoutSeconds,\n    lastSeenOnlineStore,\n  ]);\n};\n"],"names":[],"mappings":";;AAoBO,MAAM,4BACX,GAAA;AAUK,MAAM,kCAAkC,CAAC;AAAA,EAC9C,YAAA;AAAA,EACA,mBAAA;AAAA,EACA,kBAAA;AAAA,EACA,mBAAA;AAAA,EACA;AACF,CAA4C,KAAA;AAC1C,EAAA,SAAA,CAAU,MAAM;AAKd,IAAA,IAAI,uBAAuB,YAAc,EAAA;AACvC,MAAM,MAAA,cAAA,GAAiB,oBAAoB,GAAI,EAAA;AAC/C,MAAA,IAAI,cAAgB,EAAA;AAClB,QAAM,MAAA,GAAA,uBAAU,IAAK,EAAA;AACrB,QAAA,MAAM,aAAa,IAAK,CAAA,IAAA,CAAK,GAAI,CAAA,OAAA,KAAY,GAAI,CAAA;AACjD,QAAA,MAAM,wBAAwB,IAAK,CAAA,IAAA;AAAA,UACjC,cAAA,CAAe,SAAY,GAAA;AAAA,SAC7B;AACA,QAAI,IAAA,UAAA,GAAa,wBAAwB,kBAAoB,EAAA;AAC3D,UAAA,WAAA,CAAY,OAAQ,EAAA;AAAA;AACtB;AAOF,MAAoB,mBAAA,CAAA,IAAA,iBAAS,IAAA,IAAA,EAAM,CAAA;AAAA,KAC9B,MAAA;AACL,MAAA,mBAAA,CAAoB,MAAO,EAAA;AAAA;AAC7B,GACC,EAAA;AAAA,IACD,mBAAA;AAAA,IACA,YAAA;AAAA,IACA,WAAA;AAAA,IACA,kBAAA;AAAA,IACA;AAAA,GACD,CAAA;AACH;;;;"}