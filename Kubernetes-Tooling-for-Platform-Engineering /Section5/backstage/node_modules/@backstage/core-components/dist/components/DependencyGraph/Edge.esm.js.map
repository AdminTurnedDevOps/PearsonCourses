{"version":3,"file":"Edge.esm.js","sources":["../../../src/components/DependencyGraph/Edge.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from 'react';\nimport * as d3Shape from 'd3-shape';\nimport isFinite from 'lodash/isFinite';\nimport makeStyles from '@material-ui/core/styles/makeStyles';\nimport { DependencyGraphTypes as Types } from './types';\nimport { ARROW_MARKER_ID, EDGE_TEST_ID, LABEL_TEST_ID } from './constants';\nimport { DefaultLabel } from './DefaultLabel';\nimport dagre from 'dagre';\n\n/* Based on: https://github.com/dagrejs/dagre/wiki#configuring-the-layout  */\nexport type EdgeProperties = {\n  label?: string;\n  width?: number;\n  height?: number;\n  labeloffset?: number;\n  labelpos?: Types.LabelPosition;\n  minlen?: number;\n  weight?: number;\n};\nexport type GraphEdge<T> = Types.DependencyEdge<T> &\n  dagre.GraphEdge &\n  EdgeProperties;\n\n/** @public */\nexport type DependencyGraphEdgeClassKey = 'path' | 'label';\n\nconst useStyles = makeStyles(\n  theme => ({\n    path: {\n      strokeWidth: 1.3,\n      stroke: theme.palette.textSubtle,\n      fill: 'none',\n      transition: `${theme.transitions.duration.shortest}ms`,\n    },\n    label: {\n      transition: `${theme.transitions.duration.shortest}ms`,\n    },\n  }),\n  { name: 'BackstageDependencyGraphEdge' },\n);\n\ntype EdgePoint = dagre.GraphEdge['points'][0];\n\n/** @public */\nexport type EdgeComponentProps<T = unknown> = {\n  id: dagre.Edge;\n  edge: GraphEdge<T>;\n  render?: Types.RenderLabelFunction<T>;\n  setEdge: (\n    id: dagre.Edge,\n    edge: Types.DependencyEdge<T>,\n  ) => dagre.graphlib.Graph<{}>;\n  curve: 'curveStepBefore' | 'curveMonotoneX';\n  showArrowHeads?: boolean;\n};\n\nconst renderDefault = (props: Types.RenderLabelProps<unknown>) => (\n  <DefaultLabel {...props} />\n);\n\nexport function Edge<EdgeData>({\n  render = renderDefault,\n  setEdge,\n  id,\n  edge,\n  curve,\n  showArrowHeads,\n}: EdgeComponentProps<EdgeData>) {\n  const { x = 0, y = 0, width, height, points } = edge;\n  const labelProps: Types.DependencyEdge<EdgeData> = edge;\n  const classes = useStyles();\n\n  const labelRef = React.useRef<SVGGElement>(null);\n\n  React.useLayoutEffect(() => {\n    // set the label width to the actual rendered width to properly layout graph\n    if (labelRef.current) {\n      let { height: renderedHeight, width: renderedWidth } =\n        labelRef.current.getBBox();\n      renderedHeight = Math.round(renderedHeight);\n      renderedWidth = Math.round(renderedWidth);\n\n      if (renderedHeight !== height || renderedWidth !== width) {\n        setEdge(id, {\n          ...edge,\n          height: renderedHeight,\n          width: renderedWidth,\n        });\n      }\n    }\n  }, [edge, height, width, setEdge, id]);\n\n  let path: string = '';\n\n  const createPath = React.useMemo(\n    () =>\n      d3Shape\n        .line<EdgePoint>()\n        .x(d => d.x)\n        .y(d => d.y)\n        .curve(d3Shape[curve]),\n    [curve],\n  );\n\n  if (points) {\n    const finitePoints = points.filter(\n      (point: EdgePoint) => isFinite(point.x) && isFinite(point.y),\n    );\n    path = createPath(finitePoints) || '';\n  }\n\n  return (\n    <>\n      {path && (\n        <path\n          data-testid={EDGE_TEST_ID}\n          className={classes.path}\n          markerEnd={showArrowHeads ? `url(#${ARROW_MARKER_ID})` : undefined}\n          d={path}\n        />\n      )}\n      {labelProps.label ? (\n        <g\n          ref={labelRef}\n          data-testid={LABEL_TEST_ID}\n          className={classes.label}\n          transform={`translate(${x},${y})`}\n        >\n          {render({ edge: labelProps })}\n        </g>\n      ) : null}\n    </>\n  );\n}\n"],"names":["React"],"mappings":"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"}