{"version":3,"file":"StepInitAnalyzeUrl.esm.js","sources":["../../../src/components/StepInitAnalyzeUrl/StepInitAnalyzeUrl.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { errorApiRef, useApi } from '@backstage/core-plugin-api';\nimport FormHelperText from '@material-ui/core/FormHelperText';\nimport Grid from '@material-ui/core/Grid';\nimport TextField from '@material-ui/core/TextField';\nimport React, { useCallback, useState } from 'react';\nimport { useForm } from 'react-hook-form';\nimport { AnalyzeResult, catalogImportApiRef } from '../../api';\nimport { NextButton } from '../Buttons';\nimport { asInputRef } from '../helpers';\nimport { ImportFlows, PrepareResult } from '../useImportState';\n\ntype FormData = {\n  url: string;\n};\n\n/**\n * Props for {@link StepInitAnalyzeUrl}.\n *\n * @public\n */\nexport interface StepInitAnalyzeUrlProps {\n  onAnalysis: (\n    flow: ImportFlows,\n    url: string,\n    result: AnalyzeResult,\n    opts?: { prepareResult?: PrepareResult },\n  ) => void;\n  disablePullRequest?: boolean;\n  analysisUrl?: string;\n  exampleLocationUrl?: string;\n}\n\n/**\n * A form that lets the user input a url and analyze it for existing locations or potential entities.\n *\n * @param onAnalysis - is called when the analysis was successful\n * @param analysisUrl - a url that can be used as a default value\n * @param disablePullRequest - if true, repositories without entities will abort the wizard\n * @public\n */\nexport const StepInitAnalyzeUrl = (props: StepInitAnalyzeUrlProps) => {\n  const {\n    onAnalysis,\n    analysisUrl = '',\n    disablePullRequest = false,\n    exampleLocationUrl = 'https://github.com/backstage/backstage/blob/master/catalog-info.yaml',\n  } = props;\n\n  const errorApi = useApi(errorApiRef);\n  const catalogImportApi = useApi(catalogImportApiRef);\n\n  const {\n    register,\n    handleSubmit,\n    formState: { errors },\n    watch,\n  } = useForm<FormData>({\n    mode: 'onTouched',\n    defaultValues: {\n      url: analysisUrl,\n    },\n  });\n\n  const [submitted, setSubmitted] = useState(false);\n  const [error, setError] = useState<string | undefined>(undefined);\n\n  const handleResult = useCallback(\n    async ({ url }: FormData) => {\n      setSubmitted(true);\n\n      try {\n        const analysisResult = await catalogImportApi.analyzeUrl(url);\n\n        switch (analysisResult.type) {\n          case 'repository':\n            if (\n              !disablePullRequest &&\n              analysisResult.generatedEntities.length > 0\n            ) {\n              onAnalysis('no-location', url, analysisResult);\n            } else {\n              setError(\"Couldn't generate entities for your repository\");\n              setSubmitted(false);\n            }\n            break;\n\n          case 'locations': {\n            if (analysisResult.locations.length === 1) {\n              onAnalysis('single-location', url, analysisResult, {\n                prepareResult: analysisResult,\n              });\n            } else if (analysisResult.locations.length > 1) {\n              onAnalysis('multiple-locations', url, analysisResult);\n            } else {\n              setError('There are no entities at this location');\n              setSubmitted(false);\n            }\n            break;\n          }\n\n          default: {\n            const err = `Received unknown analysis result of type ${\n              (analysisResult as any).type\n            }. Please contact the support team.`;\n            setError(err);\n            setSubmitted(false);\n\n            errorApi.post(new Error(err));\n            break;\n          }\n        }\n      } catch (e: any) {\n        setError(e?.data?.error?.message ?? e.message);\n        setSubmitted(false);\n      }\n    },\n    [catalogImportApi, disablePullRequest, errorApi, onAnalysis],\n  );\n\n  return (\n    <form onSubmit={handleSubmit(handleResult)}>\n      <TextField\n        {...asInputRef(\n          register('url', {\n            required: true,\n            validate: {\n              httpsValidator: (value: any) =>\n                (typeof value === 'string' &&\n                  value.match(/^http[s]?:\\/\\//) !== null) ||\n                'Must start with http:// or https://.',\n            },\n          }),\n        )}\n        fullWidth\n        id=\"url\"\n        label=\"URL\"\n        placeholder={exampleLocationUrl}\n        helperText=\"Enter the full path to your entity file to start tracking your component\"\n        margin=\"normal\"\n        variant=\"outlined\"\n        error={Boolean(errors.url)}\n        required\n      />\n\n      {errors.url && (\n        <FormHelperText error>{errors.url.message}</FormHelperText>\n      )}\n\n      {error && <FormHelperText error>{error}</FormHelperText>}\n\n      <Grid container spacing={0}>\n        <NextButton\n          disabled={Boolean(errors.url) || !watch('url')}\n          loading={submitted}\n          type=\"submit\"\n        >\n          Analyze\n        </NextButton>\n      </Grid>\n    </form>\n  );\n};\n"],"names":[],"mappings":"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"}