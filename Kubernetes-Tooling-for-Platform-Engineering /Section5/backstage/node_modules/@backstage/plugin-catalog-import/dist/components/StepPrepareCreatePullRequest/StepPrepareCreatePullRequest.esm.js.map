{"version":3,"file":"StepPrepareCreatePullRequest.esm.js","sources":["../../../src/components/StepPrepareCreatePullRequest/StepPrepareCreatePullRequest.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Entity } from '@backstage/catalog-model';\nimport { errorApiRef, useApi } from '@backstage/core-plugin-api';\nimport { assertError } from '@backstage/errors';\nimport {\n  catalogApiRef,\n  humanizeEntityRef,\n} from '@backstage/plugin-catalog-react';\nimport Box from '@material-ui/core/Box';\nimport FormHelperText from '@material-ui/core/FormHelperText';\nimport Grid from '@material-ui/core/Grid';\nimport Typography from '@material-ui/core/Typography';\nimport { makeStyles } from '@material-ui/core/styles';\nimport React, { useCallback, useEffect, useState } from 'react';\nimport { UnpackNestedValue, UseFormReturn } from 'react-hook-form';\nimport useAsync from 'react-use/esm/useAsync';\nimport YAML from 'yaml';\nimport { AnalyzeResult, catalogImportApiRef } from '../../api';\nimport { useCatalogFilename } from '../../hooks';\nimport { PartialEntity } from '../../types';\nimport { BackButton, NextButton } from '../Buttons';\nimport { PrepareResult } from '../useImportState';\nimport { PreparePullRequestForm } from './PreparePullRequestForm';\nimport { PreviewCatalogInfoComponent } from './PreviewCatalogInfoComponent';\nimport { PreviewPullRequestComponent } from './PreviewPullRequestComponent';\n\nconst useStyles = makeStyles(theme => ({\n  previewCard: {\n    marginTop: theme.spacing(1),\n  },\n  previewCardContent: {\n    paddingTop: 0,\n  },\n}));\n\ntype FormData = {\n  title: string;\n  body: string;\n  componentName: string;\n  owner: string;\n  useCodeowners: boolean;\n};\n\n/**\n * Props for {@link StepPrepareCreatePullRequest}.\n *\n * @public\n */\nexport interface StepPrepareCreatePullRequestProps {\n  analyzeResult: Extract<AnalyzeResult, { type: 'repository' }>;\n  onPrepare: (\n    result: PrepareResult,\n    opts?: { notRepeatable?: boolean },\n  ) => void;\n  onGoBack?: () => void;\n\n  renderFormFields: (\n    props: Pick<\n      UseFormReturn<FormData>,\n      'register' | 'setValue' | 'formState'\n    > & {\n      values: UnpackNestedValue<FormData>;\n      groups: string[];\n      groupsLoading: boolean;\n    },\n  ) => React.ReactNode;\n}\n\nexport function generateEntities(\n  entities: PartialEntity[],\n  componentName: string,\n  owner?: string,\n): Entity[] {\n  return entities.map(e => ({\n    ...e,\n    apiVersion: e.apiVersion!,\n    kind: e.kind!,\n    metadata: {\n      ...e.metadata,\n      name: componentName,\n    },\n    spec: {\n      ...e.spec,\n      ...(owner ? { owner } : {}),\n    },\n  }));\n}\n\n/**\n * Prepares a pull request.\n *\n * @public\n */\nexport const StepPrepareCreatePullRequest = (\n  props: StepPrepareCreatePullRequestProps,\n) => {\n  const { analyzeResult, onPrepare, onGoBack, renderFormFields } = props;\n\n  const classes = useStyles();\n  const catalogApi = useApi(catalogApiRef);\n  const catalogImportApi = useApi(catalogImportApiRef);\n  const errorApi = useApi(errorApiRef);\n\n  const [submitted, setSubmitted] = useState(false);\n  const [error, setError] = useState<string>();\n\n  const catalogFilename = useCatalogFilename();\n\n  const {\n    loading: prDefaultsLoading,\n    value: prDefaults,\n    error: prDefaultsError,\n  } = useAsync(\n    () => catalogImportApi.preparePullRequest!(),\n    [catalogImportApi.preparePullRequest],\n  );\n\n  useEffect(() => {\n    if (prDefaultsError) {\n      errorApi.post(prDefaultsError);\n    }\n  }, [prDefaultsError, errorApi]);\n\n  const { loading: groupsLoading, value: groups } = useAsync(async () => {\n    const groupEntities = await catalogApi.getEntities({\n      filter: { kind: 'group' },\n    });\n\n    return groupEntities.items\n      .map(e => humanizeEntityRef(e, { defaultKind: 'group' }))\n      .sort();\n  });\n\n  const handleResult = useCallback(\n    async (data: FormData) => {\n      setSubmitted(true);\n\n      try {\n        const pr = await catalogImportApi.submitPullRequest({\n          repositoryUrl: analyzeResult.url,\n          title: data.title,\n          body: data.body,\n          fileContent: generateEntities(\n            analyzeResult.generatedEntities,\n            data.componentName,\n            data.owner,\n          )\n            .map(e => YAML.stringify(e))\n            .join('---\\n'),\n        });\n\n        onPrepare(\n          {\n            type: 'repository',\n            url: analyzeResult.url,\n            integrationType: analyzeResult.integrationType,\n            pullRequest: {\n              url: pr.link,\n            },\n            locations: [\n              {\n                target: pr.location,\n                entities: generateEntities(\n                  analyzeResult.generatedEntities,\n                  data.componentName,\n                  data.owner,\n                ).map(e => ({\n                  kind: e.kind,\n                  namespace: e.metadata.namespace!,\n                  name: e.metadata.name,\n                })),\n              },\n            ],\n          },\n          { notRepeatable: true },\n        );\n      } catch (e) {\n        assertError(e);\n        setError(e.message);\n        setSubmitted(false);\n      }\n    },\n    [\n      analyzeResult.generatedEntities,\n      analyzeResult.integrationType,\n      analyzeResult.url,\n      catalogImportApi,\n      onPrepare,\n    ],\n  );\n\n  return (\n    <>\n      <Typography>\n        You entered a link to a {analyzeResult.integrationType} repository but a{' '}\n        <code>{catalogFilename}</code> could not be found. Use this form to open\n        a Pull Request that creates one.\n      </Typography>\n\n      {!prDefaultsLoading && (\n        <PreparePullRequestForm<FormData>\n          onSubmit={handleResult}\n          defaultValues={{\n            title: prDefaults?.title ?? '',\n            body: prDefaults?.body ?? '',\n            owner:\n              (analyzeResult.generatedEntities[0]?.spec?.owner as string) || '',\n            componentName:\n              analyzeResult.generatedEntities[0]?.metadata?.name || '',\n            useCodeowners: false,\n          }}\n          render={({ values, formState, register, setValue }) => (\n            <>\n              {renderFormFields({\n                values,\n                formState,\n                register,\n                setValue,\n                groups: groups ?? [],\n                groupsLoading,\n              })}\n\n              <Box marginTop={2}>\n                <Typography variant=\"h6\">Preview Pull Request</Typography>\n              </Box>\n\n              <PreviewPullRequestComponent\n                title={values.title}\n                description={values.body}\n                classes={{\n                  card: classes.previewCard,\n                  cardContent: classes.previewCardContent,\n                }}\n              />\n\n              <Box marginTop={2} marginBottom={1}>\n                <Typography variant=\"h6\">Preview Entities</Typography>\n              </Box>\n\n              <PreviewCatalogInfoComponent\n                entities={generateEntities(\n                  analyzeResult.generatedEntities,\n                  values.componentName,\n                  values.owner,\n                )}\n                repositoryUrl={analyzeResult.url}\n                classes={{\n                  card: classes.previewCard,\n                  cardContent: classes.previewCardContent,\n                }}\n              />\n\n              {error && <FormHelperText error>{error}</FormHelperText>}\n\n              <Grid container spacing={0}>\n                {onGoBack && (\n                  <BackButton onClick={onGoBack} disabled={submitted} />\n                )}\n                <NextButton\n                  type=\"submit\"\n                  disabled={Boolean(\n                    formState.errors.title ||\n                      formState.errors.body ||\n                      formState.errors.owner,\n                  )}\n                  loading={submitted}\n                >\n                  Create PR\n                </NextButton>\n              </Grid>\n            </>\n          )}\n        />\n      )}\n    </>\n  );\n};\n"],"names":[],"mappings":"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"}