{"version":3,"file":"StepReviewLocation.esm.js","sources":["../../../src/components/StepReviewLocation/StepReviewLocation.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { catalogApiRef } from '@backstage/plugin-catalog-react';\nimport FormHelperText from '@material-ui/core/FormHelperText';\nimport Grid from '@material-ui/core/Grid';\nimport Typography from '@material-ui/core/Typography';\nimport LocationOnIcon from '@material-ui/icons/LocationOn';\nimport React, { useCallback, useState } from 'react';\nimport { BackButton, NextButton } from '../Buttons';\nimport { EntityListComponent } from '../EntityListComponent';\nimport { PrepareResult, ReviewResult } from '../useImportState';\n\nimport { configApiRef, useAnalytics, useApi } from '@backstage/core-plugin-api';\nimport { Link } from '@backstage/core-components';\nimport { stringifyEntityRef } from '@backstage/catalog-model';\nimport { assertError } from '@backstage/errors';\n\ntype Props = {\n  prepareResult: PrepareResult;\n  onReview: (result: ReviewResult) => void;\n  onGoBack?: () => void;\n};\n\nexport const StepReviewLocation = ({\n  prepareResult,\n  onReview,\n  onGoBack,\n}: Props) => {\n  const catalogApi = useApi(catalogApiRef);\n  const configApi = useApi(configApiRef);\n  const analytics = useAnalytics();\n\n  const appTitle = configApi.getOptionalString('app.title') || 'Backstage';\n\n  const [submitted, setSubmitted] = useState(false);\n  const [error, setError] = useState<string>();\n  const exists =\n    prepareResult.type === 'locations' &&\n    prepareResult.locations.some(l => l.exists)\n      ? true\n      : false;\n  const handleClick = useCallback(async () => {\n    setSubmitted(true);\n    analytics.captureEvent('click', 'import entity');\n    try {\n      let refreshed = new Array<{ target: string }>();\n      if (prepareResult.type === 'locations') {\n        refreshed = await Promise.all(\n          prepareResult.locations\n            .filter(l => l.exists)\n            .map(async l => {\n              const ref = stringifyEntityRef(l.entities[0] ?? l);\n              await catalogApi.refreshEntity(ref);\n              return { target: l.target };\n            }),\n        );\n      }\n\n      const locations = await Promise.all(\n        prepareResult.locations\n          .filter((l: unknown) => !(l as { exists?: boolean }).exists)\n          .map(async l => {\n            const result = await catalogApi.addLocation({\n              type: 'url',\n              target: l.target,\n            });\n            return {\n              target: result.location.target,\n              entities: result.entities,\n            };\n          }),\n      );\n\n      onReview({\n        ...prepareResult,\n        ...{ refreshed },\n        locations,\n      });\n    } catch (e) {\n      assertError(e);\n      // TODO: this error should be handled differently. We add it as 'optional' and\n      //       it is not uncommon that a PR has not been merged yet.\n      if (\n        prepareResult.type === 'repository' &&\n        e.message.startsWith(\n          'Location was added but has no entities specified yet',\n        )\n      ) {\n        onReview({\n          ...prepareResult,\n          locations: prepareResult.locations.map(l => ({\n            target: l.target,\n            entities: [],\n          })),\n        });\n      } else {\n        setError(e.message);\n        setSubmitted(false);\n      }\n    }\n  }, [prepareResult, onReview, catalogApi, analytics]);\n\n  return (\n    <>\n      {prepareResult.type === 'repository' && (\n        <>\n          <Typography paragraph>\n            The following Pull Request has been opened:{' '}\n            <Link\n              to={prepareResult.pullRequest.url}\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n            >\n              {prepareResult.pullRequest.url}\n            </Link>\n          </Typography>\n\n          <Typography paragraph>\n            You can already import the location and {appTitle} will fetch the\n            entities as soon as the Pull Request is merged.\n          </Typography>\n        </>\n      )}\n\n      <Typography>\n        {exists\n          ? 'The following locations already exist in the catalog:'\n          : 'The following entities will be added to the catalog:'}\n      </Typography>\n\n      <EntityListComponent\n        locations={prepareResult.locations}\n        locationListItemIcon={() => <LocationOnIcon />}\n      />\n\n      {error && <FormHelperText error>{error}</FormHelperText>}\n\n      <Grid container spacing={0}>\n        {onGoBack && <BackButton onClick={onGoBack} disabled={submitted} />}\n        <NextButton\n          disabled={submitted}\n          loading={submitted}\n          onClick={() => handleClick()}\n        >\n          {exists ? 'Refresh' : 'Import'}\n        </NextButton>\n      </Grid>\n    </>\n  );\n};\n"],"names":[],"mappings":"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"}