{"version":3,"file":"AzureRepoApiClient.esm.js","sources":["../../src/api/AzureRepoApiClient.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport interface AzurePrOptions {\n  tenantUrl: string;\n  title: string;\n  project: string;\n  branchName: string;\n  repository: string;\n  token: string;\n  fileContent: string;\n  fileName: string;\n  description: string;\n}\n\nexport interface CreateAzurePr {\n  sourceRefName: string;\n  targetRefName: string;\n  title: string;\n  description: string;\n}\n\nexport interface AzureRepo {\n  id: string;\n  name: string;\n  defaultBranch: string;\n}\n\nexport interface AzureRef {\n  name: string;\n  objectId: string;\n}\n\ninterface RefQueryResult {\n  value: AzureRef[];\n}\n\nexport interface AzureCommit {\n  comment: string;\n\n  changes: {\n    changeType: string;\n    item: {\n      path: string;\n    };\n    newContent: {\n      content: string;\n      contentType: 'rawtext';\n    };\n  }[];\n}\n\nexport interface AzureRefUpdate {\n  repositoryId: string;\n  name: string;\n  oldObjectId: string;\n  newObjectId: string;\n}\n\nexport interface AzurePushResult {\n  refUpdates: AzureRefUpdate[];\n}\n\nexport interface AzurePush {\n  refUpdates: {\n    name: string;\n    oldObjectId: string;\n  }[];\n  commits: AzureCommit[];\n}\n\nexport interface AzurePrResult {\n  pullRequestId: string;\n  repository: {\n    name: string;\n    webUrl: string;\n  };\n}\n\nconst apiVersions = '6.0';\n\nexport interface RepoApiClientOptions {\n  project: string;\n  tenantUrl: string;\n}\n\nexport interface NewBranchOptions {\n  fileContent: string;\n  fileName: string;\n  title: string;\n  branchName: string;\n  repoName: string;\n  sourceBranch: AzureRef;\n}\n\nexport interface CreatePrOptions {\n  repoName: string;\n  sourceName: string;\n  targetName: string;\n  description: string;\n  title: string;\n}\n\nexport class RepoApiClient {\n  private createEndpoint = (\n    path: string,\n    version: string,\n    queryParams: Record<string, string> | undefined = undefined,\n  ) => {\n    const url = new URL(\n      `${this._options.tenantUrl}/${this._options.project}/_apis/git/repositories`,\n    );\n    url.pathname += path;\n\n    url.searchParams.set('api-version', version);\n    Object.entries(queryParams ?? {}).forEach(([key, value]) =>\n      url.searchParams.set(key, value),\n    );\n    return url.toString();\n  };\n\n  constructor(private _options: RepoApiClientOptions) {}\n\n  private async get<T>(\n    path: string,\n    version: string,\n    queryParams: Record<string, string> | undefined = undefined,\n    token: string,\n  ): Promise<T> {\n    const endpoint = this.createEndpoint(path, version, queryParams);\n    const result = await fetch(endpoint, {\n      headers: {\n        Authorization: `Bearer ${token}`,\n      },\n    });\n    if (!result.ok) {\n      return result.json().then(it => Promise.reject(new Error(it.message)));\n    }\n    return await result.json();\n  }\n\n  private async post<T>(\n    path: string,\n    version: string,\n    payload: unknown,\n    token: string,\n  ): Promise<T> {\n    const endpoint = this.createEndpoint(path, version);\n    const result = await fetch(endpoint, {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${token}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(payload),\n    });\n    if (!result.ok) {\n      return result.json().then(it => Promise.reject(new Error(it.message)));\n    }\n    return await result.json();\n  }\n\n  async getRepository(\n    repositoryName: string,\n    token: string,\n  ): Promise<AzureRepo> {\n    return this.get(`/${repositoryName}`, apiVersions, undefined, token);\n  }\n\n  async getDefaultBranch(repo: AzureRepo, token: string): Promise<AzureRef> {\n    const filter = repo.defaultBranch.replace('refs/', '');\n    const result: RefQueryResult = await this.get(\n      `/${repo.name}/refs`,\n      apiVersions,\n      { filter },\n      token,\n    );\n    if (!result.value?.length) {\n      return Promise.reject(\n        new Error(`The requested ref '${filter}' was not found`),\n      );\n    }\n    return result.value[0];\n  }\n\n  async pushNewBranch(\n    options: NewBranchOptions,\n    token: string,\n  ): Promise<AzureRefUpdate> {\n    const { sourceBranch, repoName } = options;\n    const push: AzurePush = {\n      refUpdates: [\n        {\n          name: `refs/heads/${options.branchName}`,\n          oldObjectId: sourceBranch.objectId,\n        },\n      ],\n      commits: [\n        {\n          comment: options.title,\n          changes: [\n            {\n              changeType: 'add',\n              item: {\n                path: `/${options.fileName}`,\n              },\n              newContent: {\n                content: options.fileContent,\n                contentType: 'rawtext',\n              },\n            },\n          ],\n        },\n      ],\n    };\n    const result = await this.post<AzurePushResult>(\n      `/${repoName}/pushes`,\n      apiVersions,\n      push,\n      token,\n    );\n    return result.refUpdates[0];\n  }\n\n  async createPullRequest(\n    options: CreatePrOptions,\n    token: string,\n  ): Promise<AzurePrResult> {\n    const { repoName, sourceName, targetName } = options;\n    const payload: CreateAzurePr = {\n      title: options.title,\n      description: options.description,\n      sourceRefName: sourceName,\n      targetRefName: targetName,\n    };\n\n    return await this.post<AzurePrResult>(\n      `/${repoName}/pullrequests`,\n      apiVersions,\n      payload,\n      token,\n    );\n  }\n}\n\nexport async function createAzurePullRequest(\n  options: AzurePrOptions,\n  client: RepoApiClient | undefined = undefined,\n): Promise<AzurePrResult> {\n  const {\n    title,\n    repository,\n    token,\n    fileContent,\n    fileName,\n    branchName,\n    description,\n  } = options;\n  const actualClient = client ?? new RepoApiClient(options);\n  const repo = await actualClient.getRepository(repository, token);\n  const defaultBranch = await actualClient.getDefaultBranch(repo, token);\n  const branchOptions: NewBranchOptions = {\n    title: title,\n    repoName: repo.name,\n    sourceBranch: defaultBranch,\n    branchName: branchName,\n    fileContent: fileContent,\n    fileName: fileName,\n  };\n  const refUpdate = await actualClient.pushNewBranch(branchOptions, token);\n  const prOptions: CreatePrOptions = {\n    title,\n    description,\n    repoName: repo.name,\n    sourceName: refUpdate.name,\n    targetName: defaultBranch.name,\n  };\n  return actualClient.createPullRequest(prOptions, token);\n}\n"],"names":[],"mappings":"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"}