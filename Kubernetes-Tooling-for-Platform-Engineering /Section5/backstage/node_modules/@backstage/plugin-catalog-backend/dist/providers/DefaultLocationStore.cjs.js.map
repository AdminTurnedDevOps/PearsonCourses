{"version":3,"file":"DefaultLocationStore.cjs.js","sources":["../../src/providers/DefaultLocationStore.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Location } from '@backstage/catalog-client';\nimport { ConflictError, NotFoundError } from '@backstage/errors';\nimport { Knex } from 'knex';\nimport { v4 as uuid } from 'uuid';\nimport {\n  DbLocationsRow,\n  DbRefreshStateRow,\n  DbSearchRow,\n} from '../database/tables';\nimport { getEntityLocationRef } from '../processing/util';\nimport {\n  EntityProvider,\n  EntityProviderConnection,\n} from '@backstage/plugin-catalog-node';\nimport { locationSpecToLocationEntity } from '../util/conversion';\nimport { LocationInput, LocationStore } from '../service/types';\nimport {\n  ANNOTATION_ORIGIN_LOCATION,\n  CompoundEntityRef,\n  parseLocationRef,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\n\nexport class DefaultLocationStore implements LocationStore, EntityProvider {\n  private _connection: EntityProviderConnection | undefined;\n\n  constructor(private readonly db: Knex) {}\n\n  getProviderName(): string {\n    return 'DefaultLocationStore';\n  }\n\n  async createLocation(input: LocationInput): Promise<Location> {\n    const location = await this.db.transaction(async tx => {\n      // Attempt to find a previous location matching the input\n      const previousLocations = await this.locations(tx);\n      // TODO: when location id's are a compilation of input target we can remove this full\n      // lookup of locations first and just grab the by that instead.\n      const previousLocation = previousLocations.some(\n        l => input.type === l.type && input.target === l.target,\n      );\n      if (previousLocation) {\n        throw new ConflictError(\n          `Location ${input.type}:${input.target} already exists`,\n        );\n      }\n\n      const inner: DbLocationsRow = {\n        id: uuid(),\n        type: input.type,\n        target: input.target,\n      };\n\n      await tx<DbLocationsRow>('locations').insert(inner);\n\n      return inner;\n    });\n    const entity = locationSpecToLocationEntity({ location });\n    await this.connection.applyMutation({\n      type: 'delta',\n      added: [{ entity, locationKey: getEntityLocationRef(entity) }],\n      removed: [],\n    });\n\n    return location;\n  }\n\n  async listLocations(): Promise<Location[]> {\n    return await this.locations();\n  }\n\n  async getLocation(id: string): Promise<Location> {\n    const items = await this.db<DbLocationsRow>('locations')\n      .where({ id })\n      .select();\n\n    if (!items.length) {\n      throw new NotFoundError(`Found no location with ID ${id}`);\n    }\n    return items[0];\n  }\n\n  async deleteLocation(id: string): Promise<void> {\n    if (!this.connection) {\n      throw new Error('location store is not initialized');\n    }\n\n    const deleted = await this.db.transaction(async tx => {\n      const [location] = await tx<DbLocationsRow>('locations')\n        .where({ id })\n        .select();\n\n      if (!location) {\n        throw new NotFoundError(`Found no location with ID ${id}`);\n      }\n\n      await tx<DbLocationsRow>('locations').where({ id }).del();\n      return location;\n    });\n    const entity = locationSpecToLocationEntity({ location: deleted });\n    await this.connection.applyMutation({\n      type: 'delta',\n      added: [],\n      removed: [{ entity, locationKey: getEntityLocationRef(entity) }],\n    });\n  }\n\n  async getLocationByEntity(entityRef: CompoundEntityRef): Promise<Location> {\n    const entityRefString = stringifyEntityRef(entityRef);\n\n    const [entityRow] = await this.db<DbRefreshStateRow>('refresh_state')\n      .where({ entity_ref: entityRefString })\n      .select('entity_id')\n      .limit(1);\n    if (!entityRow) {\n      throw new NotFoundError(`found no entity for ref ${entityRefString}`);\n    }\n\n    const [searchRow] = await this.db<DbSearchRow>('search')\n      .where({\n        entity_id: entityRow.entity_id,\n        key: `metadata.annotations.${ANNOTATION_ORIGIN_LOCATION}`,\n      })\n      .select('value')\n      .limit(1);\n    if (!searchRow?.value) {\n      throw new NotFoundError(\n        `found no origin annotation for ref ${entityRefString}`,\n      );\n    }\n\n    const { type, target } = parseLocationRef(searchRow.value);\n    const [locationRow] = await this.db<DbLocationsRow>('locations')\n      .where({ type, target })\n      .select()\n      .limit(1);\n\n    if (!locationRow) {\n      throw new NotFoundError(\n        `Found no location with type ${type} and target ${target}`,\n      );\n    }\n\n    return locationRow;\n  }\n\n  private get connection(): EntityProviderConnection {\n    if (!this._connection) {\n      throw new Error('location store is not initialized');\n    }\n\n    return this._connection;\n  }\n\n  async connect(connection: EntityProviderConnection): Promise<void> {\n    this._connection = connection;\n\n    const locations = await this.locations();\n\n    const entities = locations.map(location => {\n      const entity = locationSpecToLocationEntity({ location });\n      return { entity, locationKey: getEntityLocationRef(entity) };\n    });\n\n    await this.connection.applyMutation({\n      type: 'full',\n      entities,\n    });\n  }\n\n  private async locations(dbOrTx: Knex.Transaction | Knex = this.db) {\n    const locations = await dbOrTx<DbLocationsRow>('locations').select();\n    return (\n      locations\n        // TODO(blam): We should create a mutation to remove this location for everyone\n        // eventually when it's all done and dusted\n        .filter(({ type }) => type !== 'bootstrap')\n        .map(item => ({\n          id: item.id,\n          target: item.target,\n          type: item.type,\n        }))\n    );\n  }\n}\n"],"names":["ConflictError","uuid","locationSpecToLocationEntity","getEntityLocationRef","NotFoundError","stringifyEntityRef","ANNOTATION_ORIGIN_LOCATION","parseLocationRef"],"mappings":"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"}