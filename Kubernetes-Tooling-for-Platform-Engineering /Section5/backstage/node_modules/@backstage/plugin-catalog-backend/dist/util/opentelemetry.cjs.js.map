{"version":3,"file":"opentelemetry.cjs.js","sources":["../../src/util/opentelemetry.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Span, SpanOptions, SpanStatusCode, Tracer } from '@opentelemetry/api';\nimport { Entity } from '@backstage/catalog-model';\n\nexport const TRACER_ID = 'backstage-plugin-catalog-backend';\n\nfunction setAttributeIfDefined(span: Span, attribute: string, value?: string) {\n  if (value !== null && value !== undefined) {\n    span.setAttribute(attribute, value);\n  }\n}\n\nexport function addEntityAttributes(span: Span, entity: Entity) {\n  setAttributeIfDefined(span, 'backstage.entity.apiVersion', entity.apiVersion);\n  setAttributeIfDefined(span, 'backstage.entity.kind', entity.kind);\n  setAttributeIfDefined(\n    span,\n    'backstage.entity.metadata.namespace',\n    entity.metadata?.namespace,\n  );\n  setAttributeIfDefined(\n    span,\n    'backstage.entity.metadata.name',\n    entity.metadata?.name,\n  );\n}\n\n// Adapted from https://github.com/open-telemetry/opentelemetry-js/blob/359fbcc40a859057a02b14e84599eac399b8dba7/api/src/trace/SugaredTracer.ts\n// While waiting for something like https://github.com/open-telemetry/opentelemetry-js/pull/3317 to land upstream\n\nconst onException = (e: Error, span: Span) => {\n  span.recordException(e);\n  span.setStatus({\n    code: SpanStatusCode.ERROR,\n  });\n};\n\nfunction isPromiseLike<T, S>(obj: PromiseLike<T> | S): obj is PromiseLike<T> {\n  return (\n    !!obj &&\n    (typeof obj === 'object' || typeof obj === 'function') &&\n    'then' in obj &&\n    typeof obj.then === 'function'\n  );\n}\n\nfunction handleFn<F extends (span: Span) => ReturnType<F>>(\n  span: Span,\n  fn: F,\n): ReturnType<F> {\n  try {\n    const ret = fn(span);\n\n    // if fn is an async function attach a recordException and spanEnd callback to the promise\n    if (isPromiseLike(ret)) {\n      ret.then(\n        () => {\n          span.end();\n        },\n        e => {\n          onException(e, span);\n          span.end();\n        },\n      );\n    } else {\n      span.end();\n    }\n\n    return ret;\n  } catch (e) {\n    onException(e, span);\n    span.end();\n    throw e;\n  }\n}\n\nexport function withActiveSpan<F extends (span: Span) => ReturnType<F>>(\n  tracer: Tracer,\n  name: string,\n  fn: F,\n  spanOptions: SpanOptions = {},\n): ReturnType<F> {\n  return tracer.startActiveSpan(name, spanOptions, (span: Span) => {\n    return handleFn(span, fn);\n  });\n}\n"],"names":["SpanStatusCode"],"mappings":";;;;AAmBO,MAAM,SAAY,GAAA;AAEzB,SAAS,qBAAA,CAAsB,IAAY,EAAA,SAAA,EAAmB,KAAgB,EAAA;AAC5E,EAAI,IAAA,KAAA,KAAU,IAAQ,IAAA,KAAA,KAAU,KAAW,CAAA,EAAA;AACzC,IAAK,IAAA,CAAA,YAAA,CAAa,WAAW,KAAK,CAAA;AAAA;AAEtC;AAEgB,SAAA,mBAAA,CAAoB,MAAY,MAAgB,EAAA;AAC9D,EAAsB,qBAAA,CAAA,IAAA,EAAM,6BAA+B,EAAA,MAAA,CAAO,UAAU,CAAA;AAC5E,EAAsB,qBAAA,CAAA,IAAA,EAAM,uBAAyB,EAAA,MAAA,CAAO,IAAI,CAAA;AAChE,EAAA,qBAAA;AAAA,IACE,IAAA;AAAA,IACA,qCAAA;AAAA,IACA,OAAO,QAAU,EAAA;AAAA,GACnB;AACA,EAAA,qBAAA;AAAA,IACE,IAAA;AAAA,IACA,gCAAA;AAAA,IACA,OAAO,QAAU,EAAA;AAAA,GACnB;AACF;AAKA,MAAM,WAAA,GAAc,CAAC,CAAA,EAAU,IAAe,KAAA;AAC5C,EAAA,IAAA,CAAK,gBAAgB,CAAC,CAAA;AACtB,EAAA,IAAA,CAAK,SAAU,CAAA;AAAA,IACb,MAAMA,kBAAe,CAAA;AAAA,GACtB,CAAA;AACH,CAAA;AAEA,SAAS,cAAoB,GAAgD,EAAA;AAC3E,EAAA,OACE,CAAC,CAAC,GACD,KAAA,OAAO,GAAQ,KAAA,QAAA,IAAY,OAAO,GAAA,KAAQ,UAC3C,CAAA,IAAA,MAAA,IAAU,GACV,IAAA,OAAO,IAAI,IAAS,KAAA,UAAA;AAExB;AAEA,SAAS,QAAA,CACP,MACA,EACe,EAAA;AACf,EAAI,IAAA;AACF,IAAM,MAAA,GAAA,GAAM,GAAG,IAAI,CAAA;AAGnB,IAAI,IAAA,aAAA,CAAc,GAAG,CAAG,EAAA;AACtB,MAAI,GAAA,CAAA,IAAA;AAAA,QACF,MAAM;AACJ,UAAA,IAAA,CAAK,GAAI,EAAA;AAAA,SACX;AAAA,QACA,CAAK,CAAA,KAAA;AACH,UAAA,WAAA,CAAY,GAAG,IAAI,CAAA;AACnB,UAAA,IAAA,CAAK,GAAI,EAAA;AAAA;AACX,OACF;AAAA,KACK,MAAA;AACL,MAAA,IAAA,CAAK,GAAI,EAAA;AAAA;AAGX,IAAO,OAAA,GAAA;AAAA,WACA,CAAG,EAAA;AACV,IAAA,WAAA,CAAY,GAAG,IAAI,CAAA;AACnB,IAAA,IAAA,CAAK,GAAI,EAAA;AACT,IAAM,MAAA,CAAA;AAAA;AAEV;AAEO,SAAS,eACd,MACA,EAAA,IAAA,EACA,EACA,EAAA,WAAA,GAA2B,EACZ,EAAA;AACf,EAAA,OAAO,MAAO,CAAA,eAAA,CAAgB,IAAM,EAAA,WAAA,EAAa,CAAC,IAAe,KAAA;AAC/D,IAAO,OAAA,QAAA,CAAS,MAAM,EAAE,CAAA;AAAA,GACzB,CAAA;AACH;;;;;;"}