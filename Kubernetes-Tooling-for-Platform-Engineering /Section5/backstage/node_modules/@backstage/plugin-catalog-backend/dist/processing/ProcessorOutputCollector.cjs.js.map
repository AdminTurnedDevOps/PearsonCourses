{"version":3,"file":"ProcessorOutputCollector.cjs.js","sources":["../../src/processing/ProcessorOutputCollector.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ANNOTATION_LOCATION,\n  ANNOTATION_ORIGIN_LOCATION,\n  Entity,\n  stringifyEntityRef,\n  stringifyLocationRef,\n} from '@backstage/catalog-model';\nimport { assertError } from '@backstage/errors';\nimport {\n  CatalogProcessor,\n  CatalogProcessorResult,\n  DeferredEntity,\n  EntityRelationSpec,\n} from '@backstage/plugin-catalog-node';\nimport { locationSpecToLocationEntity } from '../util/conversion';\nimport {\n  getEntityLocationRef,\n  getEntityOriginLocationRef,\n  validateEntityEnvelope,\n} from './util';\nimport { RefreshKeyData } from './types';\nimport { LoggerService } from '@backstage/backend-plugin-api';\n\n/**\n * Helper class for aggregating all of the emitted data from processors.\n */\nexport class ProcessorOutputCollector {\n  private readonly errors = new Array<Error>();\n  private readonly relations = new Array<EntityRelationSpec>();\n  private readonly deferredEntities = new Array<DeferredEntity>();\n  private readonly refreshKeys = new Array<RefreshKeyData>();\n  private done = false;\n\n  constructor(\n    private readonly logger: LoggerService,\n    private readonly parentEntity: Entity,\n  ) {}\n\n  generic(): (i: CatalogProcessorResult) => void {\n    return i => this.receive(this.logger, i);\n  }\n\n  forProcessor(\n    processor: CatalogProcessor,\n  ): (i: CatalogProcessorResult) => void {\n    const logger = this.logger.child({\n      processor: processor.getProcessorName(),\n    });\n    return i => this.receive(logger, i);\n  }\n\n  results() {\n    this.done = true;\n    return {\n      errors: this.errors,\n      relations: this.relations,\n      refreshKeys: this.refreshKeys,\n      deferredEntities: this.deferredEntities,\n    };\n  }\n\n  private receive(logger: LoggerService, i: CatalogProcessorResult) {\n    if (this.done) {\n      logger.warn(\n        `Item of type \"${\n          i.type\n        }\" was emitted after processing had completed. Stack trace: ${\n          new Error().stack\n        }`,\n      );\n      return;\n    }\n\n    if (i.type === 'entity') {\n      let entity: Entity;\n      const location = stringifyLocationRef(i.location);\n\n      try {\n        entity = validateEntityEnvelope(i.entity);\n      } catch (e) {\n        assertError(e);\n        logger.debug(`Envelope validation failed at ${location}, ${e}`);\n        this.errors.push(e);\n        return;\n      }\n\n      // The processor contract says you should return the \"trunk\" (current)\n      // entity, not emit it. But it happens that this is misunderstood or\n      // accidentally forgotten. This can lead to circular references which at\n      // best is wasteful, so we try to be helpful by ignoring such emitted\n      // entities.\n      const entityRef = stringifyEntityRef(entity);\n      if (entityRef === stringifyEntityRef(this.parentEntity)) {\n        logger.warn(\n          `Ignored emitted entity ${entityRef} whose ref was identical to the one being processed. This commonly indicates mistakenly emitting the input entity instead of returning it.`,\n        );\n        return;\n      }\n\n      // Note that at this point, we have only validated the envelope part of\n      // the entity data. Annotations are not part of that, so we have to be\n      // defensive and report an error if the annotations isn't a valid object, to avoid\n      // hiding errors when adding location annotations.\n      const annotations = entity.metadata.annotations || {};\n      if (typeof annotations !== 'object' || Array.isArray(annotations)) {\n        this.errors.push(\n          new Error('metadata.annotations must be a valid object'),\n        );\n        return;\n      }\n      const originLocation = getEntityOriginLocationRef(this.parentEntity);\n      entity = {\n        ...entity,\n        metadata: {\n          ...entity.metadata,\n          annotations: {\n            ...annotations,\n            [ANNOTATION_ORIGIN_LOCATION]: originLocation,\n            [ANNOTATION_LOCATION]: location,\n          },\n        },\n      };\n\n      this.deferredEntities.push({ entity, locationKey: location });\n    } else if (i.type === 'location') {\n      const entity = locationSpecToLocationEntity({\n        location: i.location,\n        parentEntity: this.parentEntity,\n      });\n      const locationKey = getEntityLocationRef(entity);\n      this.deferredEntities.push({ entity, locationKey });\n    } else if (i.type === 'relation') {\n      this.relations.push(i.relation);\n    } else if (i.type === 'error') {\n      this.errors.push(i.error);\n    } else if (i.type === 'refresh') {\n      this.refreshKeys.push({ key: i.key });\n    }\n  }\n}\n"],"names":["stringifyLocationRef","validateEntityEnvelope","assertError","stringifyEntityRef","getEntityOriginLocationRef","ANNOTATION_ORIGIN_LOCATION","ANNOTATION_LOCATION","locationSpecToLocationEntity","getEntityLocationRef"],"mappings":"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"}