{"version":3,"file":"connectEntityProviders.cjs.js","sources":["../../src/processing/connectEntityProviders.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  Entity,\n  entityEnvelopeSchemaValidator,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport { ProviderDatabase } from '../database/types';\nimport {\n  EntityProvider,\n  EntityProviderConnection,\n  EntityProviderRefreshOptions,\n  EntityProviderMutation,\n} from '@backstage/plugin-catalog-node';\n\nclass Connection implements EntityProviderConnection {\n  readonly validateEntityEnvelope = entityEnvelopeSchemaValidator();\n\n  constructor(\n    private readonly config: {\n      id: string;\n      providerDatabase: ProviderDatabase;\n    },\n  ) {}\n\n  async applyMutation(mutation: EntityProviderMutation): Promise<void> {\n    const db = this.config.providerDatabase;\n\n    if (mutation.type === 'full') {\n      this.check(mutation.entities.map(e => e.entity));\n      await db.transaction(async tx => {\n        await db.replaceUnprocessedEntities(tx, {\n          sourceKey: this.config.id,\n          type: 'full',\n          items: mutation.entities,\n        });\n      });\n    } else if (mutation.type === 'delta') {\n      this.check(mutation.added.map(e => e.entity));\n      this.check(\n        mutation.removed\n          .map(e => ('entity' in e ? e.entity : undefined))\n          .filter((e): e is Entity => Boolean(e)),\n      );\n      await db.transaction(async tx => {\n        await db.replaceUnprocessedEntities(tx, {\n          sourceKey: this.config.id,\n          type: 'delta',\n          added: mutation.added,\n          removed: mutation.removed.map(r =>\n            'entityRef' in r\n              ? r\n              : {\n                  entityRef: stringifyEntityRef(r.entity),\n                  locationKey: r.locationKey,\n                },\n          ),\n        });\n      });\n    }\n  }\n\n  async refresh(options: EntityProviderRefreshOptions): Promise<void> {\n    const db = this.config.providerDatabase;\n\n    await db.transaction(async (tx: any) => {\n      return db.refreshByRefreshKeys(tx, {\n        keys: options.keys,\n      });\n    });\n  }\n\n  private check(entities: Entity[]) {\n    for (const entity of entities) {\n      try {\n        this.validateEntityEnvelope(entity);\n      } catch (e) {\n        throw new TypeError(`Malformed entity envelope, ${e}`);\n      }\n    }\n  }\n}\n\nexport async function connectEntityProviders(\n  db: ProviderDatabase,\n  providers: EntityProvider[],\n) {\n  await Promise.all(\n    providers.map(async provider => {\n      const connection = new Connection({\n        id: provider.getProviderName(),\n        providerDatabase: db,\n      });\n      return provider.connect(connection);\n    }),\n  );\n}\n"],"names":["entityEnvelopeSchemaValidator","stringifyEntityRef"],"mappings":"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"}