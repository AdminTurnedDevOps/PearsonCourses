{"version":3,"file":"createPropertyRule.cjs.js","sources":["../../../src/permissions/rules/createPropertyRule.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { get } from 'lodash';\nimport { RESOURCE_TYPE_CATALOG_ENTITY } from '@backstage/plugin-catalog-common/alpha';\nimport { createCatalogPermissionRule } from './util';\nimport { z } from 'zod';\n\nexport const createPropertyRule = (propertyType: 'metadata' | 'spec') =>\n  createCatalogPermissionRule({\n    name: `HAS_${propertyType.toUpperCase()}`,\n    description: `Allow entities with the specified ${propertyType} subfield`,\n    resourceType: RESOURCE_TYPE_CATALOG_ENTITY,\n    paramsSchema: z.object({\n      key: z\n        .string()\n        .describe(`Property within the entities ${propertyType} to match on`),\n      value: z\n        .string()\n        .optional()\n        .describe(`Value of the given property to match on`),\n    }),\n    apply: (resource, { key, value }) => {\n      const foundValue = get(resource[propertyType], key);\n\n      if (Array.isArray(foundValue)) {\n        if (value !== undefined) {\n          return foundValue.includes(value);\n        }\n        return foundValue.length > 0;\n      }\n      if (value !== undefined) {\n        return value === foundValue;\n      }\n      return !!foundValue;\n    },\n    toQuery: ({ key, value }) => ({\n      key: `${propertyType}.${key}`,\n      ...(value !== undefined && { values: [value] }),\n    }),\n  });\n"],"names":["createCatalogPermissionRule","RESOURCE_TYPE_CATALOG_ENTITY","z","get"],"mappings":";;;;;;;AAqBa,MAAA,kBAAA,GAAqB,CAAC,YAAA,KACjCA,gCAA4B,CAAA;AAAA,EAC1B,IAAM,EAAA,CAAA,IAAA,EAAO,YAAa,CAAA,WAAA,EAAa,CAAA,CAAA;AAAA,EACvC,WAAA,EAAa,qCAAqC,YAAY,CAAA,SAAA,CAAA;AAAA,EAC9D,YAAc,EAAAC,kCAAA;AAAA,EACd,YAAA,EAAcC,MAAE,MAAO,CAAA;AAAA,IACrB,KAAKA,KACF,CAAA,MAAA,GACA,QAAS,CAAA,CAAA,6BAAA,EAAgC,YAAY,CAAc,YAAA,CAAA,CAAA;AAAA,IACtE,OAAOA,KACJ,CAAA,MAAA,GACA,QAAS,EAAA,CACT,SAAS,CAAyC,uCAAA,CAAA;AAAA,GACtD,CAAA;AAAA,EACD,OAAO,CAAC,QAAA,EAAU,EAAE,GAAA,EAAK,OAAY,KAAA;AACnC,IAAA,MAAM,UAAa,GAAAC,UAAA,CAAI,QAAS,CAAA,YAAY,GAAG,GAAG,CAAA;AAElD,IAAI,IAAA,KAAA,CAAM,OAAQ,CAAA,UAAU,CAAG,EAAA;AAC7B,MAAA,IAAI,UAAU,KAAW,CAAA,EAAA;AACvB,QAAO,OAAA,UAAA,CAAW,SAAS,KAAK,CAAA;AAAA;AAElC,MAAA,OAAO,WAAW,MAAS,GAAA,CAAA;AAAA;AAE7B,IAAA,IAAI,UAAU,KAAW,CAAA,EAAA;AACvB,MAAA,OAAO,KAAU,KAAA,UAAA;AAAA;AAEnB,IAAA,OAAO,CAAC,CAAC,UAAA;AAAA,GACX;AAAA,EACA,OAAS,EAAA,CAAC,EAAE,GAAA,EAAK,OAAa,MAAA;AAAA,IAC5B,GAAK,EAAA,CAAA,EAAG,YAAY,CAAA,CAAA,EAAI,GAAG,CAAA,CAAA;AAAA,IAC3B,GAAI,KAAU,KAAA,KAAA,CAAA,IAAa,EAAE,MAAQ,EAAA,CAAC,KAAK,CAAE;AAAA,GAC/C;AACF,CAAC;;;;"}