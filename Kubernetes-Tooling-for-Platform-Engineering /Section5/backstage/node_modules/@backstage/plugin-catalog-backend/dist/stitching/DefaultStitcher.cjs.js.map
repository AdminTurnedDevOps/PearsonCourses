{"version":3,"file":"DefaultStitcher.cjs.js","sources":["../../src/stitching/DefaultStitcher.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport { durationToMilliseconds, HumanDuration } from '@backstage/types';\nimport { Knex } from 'knex';\nimport splitToChunks from 'lodash/chunk';\nimport { DateTime } from 'luxon';\nimport { getDeferredStitchableEntities } from '../database/operations/stitcher/getDeferredStitchableEntities';\nimport { markForStitching } from '../database/operations/stitcher/markForStitching';\nimport { performStitching } from '../database/operations/stitcher/performStitching';\nimport { DbRefreshStateRow } from '../database/tables';\nimport { startTaskPipeline } from '../processing/TaskPipeline';\nimport { progressTracker } from './progressTracker';\nimport {\n  Stitcher,\n  StitchingStrategy,\n  stitchingStrategyFromConfig,\n} from './types';\nimport { LoggerService } from '@backstage/backend-plugin-api';\n\ntype DeferredStitchItem = Awaited<\n  ReturnType<typeof getDeferredStitchableEntities>\n>[0];\n\ntype StitchProgressTracker = ReturnType<typeof progressTracker>;\n\n/**\n * Performs the act of stitching - to take all of the various outputs from the\n * ingestion process, and stitching them together into the final entity JSON\n * shape.\n */\nexport class DefaultStitcher implements Stitcher {\n  private readonly knex: Knex;\n  private readonly logger: LoggerService;\n  private readonly strategy: StitchingStrategy;\n  private readonly tracker: StitchProgressTracker;\n  private stopFunc?: () => void;\n\n  static fromConfig(\n    config: Config,\n    options: {\n      knex: Knex;\n      logger: LoggerService;\n    },\n  ): DefaultStitcher {\n    return new DefaultStitcher({\n      knex: options.knex,\n      logger: options.logger,\n      strategy: stitchingStrategyFromConfig(config),\n    });\n  }\n\n  constructor(options: {\n    knex: Knex;\n    logger: LoggerService;\n    strategy: StitchingStrategy;\n  }) {\n    this.knex = options.knex;\n    this.logger = options.logger;\n    this.strategy = options.strategy;\n    this.tracker = progressTracker(options.knex, options.logger);\n  }\n\n  async stitch(options: {\n    entityRefs?: Iterable<string>;\n    entityIds?: Iterable<string>;\n  }) {\n    const { entityRefs, entityIds } = options;\n\n    if (this.strategy.mode === 'deferred') {\n      await markForStitching({\n        knex: this.knex,\n        strategy: this.strategy,\n        entityRefs,\n        entityIds,\n      });\n      return;\n    }\n\n    if (entityRefs) {\n      for (const entityRef of entityRefs) {\n        await this.#stitchOne({ entityRef });\n      }\n    }\n\n    if (entityIds) {\n      const chunks = splitToChunks(\n        Array.isArray(entityIds) ? entityIds : [...entityIds],\n        100,\n      );\n      for (const chunk of chunks) {\n        const rows = await this.knex<DbRefreshStateRow>('refresh_state')\n          .select('entity_ref')\n          .whereIn('entity_id', chunk);\n        for (const row of rows) {\n          await this.#stitchOne({ entityRef: row.entity_ref });\n        }\n      }\n    }\n  }\n\n  async start() {\n    if (this.strategy.mode === 'deferred') {\n      if (this.stopFunc) {\n        throw new Error('Processing engine is already started');\n      }\n\n      const { pollingInterval, stitchTimeout } = this.strategy;\n\n      const stopPipeline = startTaskPipeline<DeferredStitchItem>({\n        lowWatermark: 2,\n        highWatermark: 5,\n        pollingIntervalMs: durationToMilliseconds(pollingInterval),\n        loadTasks: async count => {\n          return await this.#getStitchableEntities(count, stitchTimeout);\n        },\n        processTask: async item => {\n          return await this.#stitchOne({\n            entityRef: item.entityRef,\n            stitchTicket: item.stitchTicket,\n            stitchRequestedAt: item.stitchRequestedAt,\n          });\n        },\n      });\n\n      this.stopFunc = () => {\n        stopPipeline();\n      };\n    }\n  }\n\n  async stop() {\n    if (this.strategy.mode === 'deferred') {\n      if (this.stopFunc) {\n        this.stopFunc();\n        this.stopFunc = undefined;\n      }\n    }\n  }\n\n  async #getStitchableEntities(count: number, stitchTimeout: HumanDuration) {\n    try {\n      return await getDeferredStitchableEntities({\n        knex: this.knex,\n        batchSize: count,\n        stitchTimeout: stitchTimeout,\n      });\n    } catch (error) {\n      this.logger.warn('Failed to load stitchable entities', error);\n      return [];\n    }\n  }\n\n  async #stitchOne(options: {\n    entityRef: string;\n    stitchTicket?: string;\n    stitchRequestedAt?: DateTime;\n  }) {\n    const track = this.tracker.stitchStart({\n      entityRef: options.entityRef,\n      stitchRequestedAt: options.stitchRequestedAt,\n    });\n\n    try {\n      const result = await performStitching({\n        knex: this.knex,\n        logger: this.logger,\n        strategy: this.strategy,\n        entityRef: options.entityRef,\n        stitchTicket: options.stitchTicket,\n      });\n      track.markComplete(result);\n    } catch (error) {\n      track.markFailed(error);\n    }\n  }\n}\n"],"names":["stitchingStrategyFromConfig","progressTracker","markForStitching","splitToChunks","startTaskPipeline","durationToMilliseconds","getDeferredStitchableEntities","performStitching"],"mappings":"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"}