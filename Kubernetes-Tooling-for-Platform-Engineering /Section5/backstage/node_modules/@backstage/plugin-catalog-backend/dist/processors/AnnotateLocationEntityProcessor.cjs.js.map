{"version":3,"file":"AnnotateLocationEntityProcessor.cjs.js","sources":["../../src/processors/AnnotateLocationEntityProcessor.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ANNOTATION_EDIT_URL,\n  ANNOTATION_LOCATION,\n  ANNOTATION_ORIGIN_LOCATION,\n  ANNOTATION_SOURCE_LOCATION,\n  ANNOTATION_VIEW_URL,\n  Entity,\n  stringifyLocationRef,\n} from '@backstage/catalog-model';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\nimport { identity, merge, pickBy } from 'lodash';\nimport { LocationSpec } from '@backstage/plugin-catalog-common';\nimport {\n  CatalogProcessor,\n  CatalogProcessorEmit,\n} from '@backstage/plugin-catalog-node';\n\nconst commitHashRegExp = /\\b[0-9a-f]{40,}\\b/;\n/** @public */\nexport class AnnotateLocationEntityProcessor implements CatalogProcessor {\n  constructor(\n    private readonly options: {\n      integrations: ScmIntegrationRegistry;\n    },\n  ) {}\n\n  getProcessorName(): string {\n    return 'AnnotateLocationEntityProcessor';\n  }\n\n  async preProcessEntity(\n    entity: Entity,\n    location: LocationSpec,\n    _: CatalogProcessorEmit,\n    originLocation: LocationSpec,\n  ): Promise<Entity> {\n    const { integrations } = this.options;\n    let viewUrl;\n    let editUrl;\n    let sourceLocation;\n\n    if (location.type === 'url') {\n      const scmIntegration = integrations.byUrl(location.target);\n\n      viewUrl = location.target;\n\n      if (!commitHashRegExp.test(location.target)) {\n        editUrl = scmIntegration?.resolveEditUrl(location.target);\n      }\n\n      const sourceUrl = scmIntegration?.resolveUrl({\n        url: './',\n        base: location.target,\n      });\n\n      if (sourceUrl) {\n        sourceLocation = stringifyLocationRef({\n          type: 'url',\n          target: sourceUrl,\n        });\n      }\n    }\n\n    return merge(\n      {\n        metadata: {\n          annotations: pickBy(\n            {\n              [ANNOTATION_LOCATION]: stringifyLocationRef(location),\n              [ANNOTATION_ORIGIN_LOCATION]:\n                stringifyLocationRef(originLocation),\n              [ANNOTATION_VIEW_URL]: viewUrl,\n              [ANNOTATION_EDIT_URL]: editUrl,\n              [ANNOTATION_SOURCE_LOCATION]: sourceLocation,\n            },\n            identity,\n          ),\n        },\n      },\n      entity,\n    );\n  }\n}\n"],"names":["stringifyLocationRef","merge","pickBy","ANNOTATION_LOCATION","ANNOTATION_ORIGIN_LOCATION","ANNOTATION_VIEW_URL","ANNOTATION_EDIT_URL","ANNOTATION_SOURCE_LOCATION","identity"],"mappings":";;;;;AAiCA,MAAM,gBAAmB,GAAA,mBAAA;AAElB,MAAM,+BAA4D,CAAA;AAAA,EACvE,YACmB,OAGjB,EAAA;AAHiB,IAAA,IAAA,CAAA,OAAA,GAAA,OAAA;AAAA;AAGhB,EAEH,gBAA2B,GAAA;AACzB,IAAO,OAAA,iCAAA;AAAA;AACT,EAEA,MAAM,gBAAA,CACJ,MACA,EAAA,QAAA,EACA,GACA,cACiB,EAAA;AACjB,IAAM,MAAA,EAAE,YAAa,EAAA,GAAI,IAAK,CAAA,OAAA;AAC9B,IAAI,IAAA,OAAA;AACJ,IAAI,IAAA,OAAA;AACJ,IAAI,IAAA,cAAA;AAEJ,IAAI,IAAA,QAAA,CAAS,SAAS,KAAO,EAAA;AAC3B,MAAA,MAAM,cAAiB,GAAA,YAAA,CAAa,KAAM,CAAA,QAAA,CAAS,MAAM,CAAA;AAEzD,MAAA,OAAA,GAAU,QAAS,CAAA,MAAA;AAEnB,MAAA,IAAI,CAAC,gBAAA,CAAiB,IAAK,CAAA,QAAA,CAAS,MAAM,CAAG,EAAA;AAC3C,QAAU,OAAA,GAAA,cAAA,EAAgB,cAAe,CAAA,QAAA,CAAS,MAAM,CAAA;AAAA;AAG1D,MAAM,MAAA,SAAA,GAAY,gBAAgB,UAAW,CAAA;AAAA,QAC3C,GAAK,EAAA,IAAA;AAAA,QACL,MAAM,QAAS,CAAA;AAAA,OAChB,CAAA;AAED,MAAA,IAAI,SAAW,EAAA;AACb,QAAA,cAAA,GAAiBA,iCAAqB,CAAA;AAAA,UACpC,IAAM,EAAA,KAAA;AAAA,UACN,MAAQ,EAAA;AAAA,SACT,CAAA;AAAA;AACH;AAGF,IAAO,OAAAC,YAAA;AAAA,MACL;AAAA,QACE,QAAU,EAAA;AAAA,UACR,WAAa,EAAAC,aAAA;AAAA,YACX;AAAA,cACE,CAACC,gCAAmB,GAAGH,iCAAA,CAAqB,QAAQ,CAAA;AAAA,cACpD,CAACI,uCAA0B,GACzBJ,iCAAA,CAAqB,cAAc,CAAA;AAAA,cACrC,CAACK,gCAAmB,GAAG,OAAA;AAAA,cACvB,CAACC,gCAAmB,GAAG,OAAA;AAAA,cACvB,CAACC,uCAA0B,GAAG;AAAA,aAChC;AAAA,YACAC;AAAA;AACF;AACF,OACF;AAAA,MACA;AAAA,KACF;AAAA;AAEJ;;;;"}