{"version":3,"file":"BuiltinKindsEntityProcessor.cjs.js","sources":["../../src/processors/BuiltinKindsEntityProcessor.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ApiEntity,\n  apiEntityV1alpha1Validator,\n  ComponentEntity,\n  componentEntityV1alpha1Validator,\n  DomainEntity,\n  domainEntityV1alpha1Validator,\n  Entity,\n  getCompoundEntityRef,\n  GroupEntity,\n  groupEntityV1alpha1Validator,\n  locationEntityV1alpha1Validator,\n  parseEntityRef,\n  RELATION_API_CONSUMED_BY,\n  RELATION_API_PROVIDED_BY,\n  RELATION_CHILD_OF,\n  RELATION_CONSUMES_API,\n  RELATION_DEPENDENCY_OF,\n  RELATION_DEPENDS_ON,\n  RELATION_HAS_MEMBER,\n  RELATION_HAS_PART,\n  RELATION_MEMBER_OF,\n  RELATION_OWNED_BY,\n  RELATION_OWNER_OF,\n  RELATION_PARENT_OF,\n  RELATION_PART_OF,\n  RELATION_PROVIDES_API,\n  ResourceEntity,\n  resourceEntityV1alpha1Validator,\n  SystemEntity,\n  systemEntityV1alpha1Validator,\n  UserEntity,\n  userEntityV1alpha1Validator,\n} from '@backstage/catalog-model';\nimport { LocationSpec } from '@backstage/plugin-catalog-common';\nimport {\n  CatalogProcessor,\n  CatalogProcessorEmit,\n  processingResult,\n} from '@backstage/plugin-catalog-node';\n\n/** @public */\nexport class BuiltinKindsEntityProcessor implements CatalogProcessor {\n  private readonly validators = [\n    apiEntityV1alpha1Validator,\n    componentEntityV1alpha1Validator,\n    resourceEntityV1alpha1Validator,\n    groupEntityV1alpha1Validator,\n    locationEntityV1alpha1Validator,\n    userEntityV1alpha1Validator,\n    systemEntityV1alpha1Validator,\n    domainEntityV1alpha1Validator,\n  ];\n\n  getProcessorName(): string {\n    return 'BuiltinKindsEntityProcessor';\n  }\n\n  async validateEntityKind(entity: Entity): Promise<boolean> {\n    for (const validator of this.validators) {\n      const results = await validator.check(entity);\n      if (results) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  async postProcessEntity(\n    entity: Entity,\n    _location: LocationSpec,\n    emit: CatalogProcessorEmit,\n  ): Promise<Entity> {\n    const selfRef = getCompoundEntityRef(entity);\n\n    /*\n     * Utilities\n     */\n\n    function doEmit(\n      targets: string | string[] | undefined,\n      context: { defaultKind?: string; defaultNamespace: string },\n      outgoingRelation: string,\n      incomingRelation: string,\n    ): void {\n      if (!targets) {\n        return;\n      }\n      for (const target of [targets].flat()) {\n        const targetRef = parseEntityRef(target, context);\n        emit(\n          processingResult.relation({\n            source: selfRef,\n            type: outgoingRelation,\n            target: {\n              kind: targetRef.kind,\n              namespace: targetRef.namespace,\n              name: targetRef.name,\n            },\n          }),\n        );\n        emit(\n          processingResult.relation({\n            source: {\n              kind: targetRef.kind,\n              namespace: targetRef.namespace,\n              name: targetRef.name,\n            },\n            type: incomingRelation,\n            target: selfRef,\n          }),\n        );\n      }\n    }\n\n    /*\n     * Emit relations for the Component kind\n     */\n\n    if (entity.kind === 'Component') {\n      const component = entity as ComponentEntity;\n      doEmit(\n        component.spec.owner,\n        { defaultKind: 'Group', defaultNamespace: selfRef.namespace },\n        RELATION_OWNED_BY,\n        RELATION_OWNER_OF,\n      );\n      doEmit(\n        component.spec.subcomponentOf,\n        { defaultKind: 'Component', defaultNamespace: selfRef.namespace },\n        RELATION_PART_OF,\n        RELATION_HAS_PART,\n      );\n      doEmit(\n        component.spec.providesApis,\n        { defaultKind: 'API', defaultNamespace: selfRef.namespace },\n        RELATION_PROVIDES_API,\n        RELATION_API_PROVIDED_BY,\n      );\n      doEmit(\n        component.spec.consumesApis,\n        { defaultKind: 'API', defaultNamespace: selfRef.namespace },\n        RELATION_CONSUMES_API,\n        RELATION_API_CONSUMED_BY,\n      );\n      doEmit(\n        component.spec.dependsOn,\n        { defaultNamespace: selfRef.namespace },\n        RELATION_DEPENDS_ON,\n        RELATION_DEPENDENCY_OF,\n      );\n      doEmit(\n        component.spec.dependencyOf,\n        { defaultNamespace: selfRef.namespace },\n        RELATION_DEPENDENCY_OF,\n        RELATION_DEPENDS_ON,\n      );\n      doEmit(\n        component.spec.system,\n        { defaultKind: 'System', defaultNamespace: selfRef.namespace },\n        RELATION_PART_OF,\n        RELATION_HAS_PART,\n      );\n    }\n\n    /*\n     * Emit relations for the API kind\n     */\n\n    if (entity.kind === 'API') {\n      const api = entity as ApiEntity;\n      doEmit(\n        api.spec.owner,\n        { defaultKind: 'Group', defaultNamespace: selfRef.namespace },\n        RELATION_OWNED_BY,\n        RELATION_OWNER_OF,\n      );\n      doEmit(\n        api.spec.system,\n        { defaultKind: 'System', defaultNamespace: selfRef.namespace },\n        RELATION_PART_OF,\n        RELATION_HAS_PART,\n      );\n    }\n\n    /*\n     * Emit relations for the Resource kind\n     */\n\n    if (entity.kind === 'Resource') {\n      const resource = entity as ResourceEntity;\n      doEmit(\n        resource.spec.owner,\n        { defaultKind: 'Group', defaultNamespace: selfRef.namespace },\n        RELATION_OWNED_BY,\n        RELATION_OWNER_OF,\n      );\n      doEmit(\n        resource.spec.dependsOn,\n        { defaultNamespace: selfRef.namespace },\n        RELATION_DEPENDS_ON,\n        RELATION_DEPENDENCY_OF,\n      );\n      doEmit(\n        resource.spec.dependencyOf,\n        { defaultNamespace: selfRef.namespace },\n        RELATION_DEPENDENCY_OF,\n        RELATION_DEPENDS_ON,\n      );\n      doEmit(\n        resource.spec.system,\n        { defaultKind: 'System', defaultNamespace: selfRef.namespace },\n        RELATION_PART_OF,\n        RELATION_HAS_PART,\n      );\n    }\n\n    /*\n     * Emit relations for the User kind\n     */\n\n    if (entity.kind === 'User') {\n      const user = entity as UserEntity;\n      doEmit(\n        user.spec.memberOf,\n        { defaultKind: 'Group', defaultNamespace: selfRef.namespace },\n        RELATION_MEMBER_OF,\n        RELATION_HAS_MEMBER,\n      );\n    }\n\n    /*\n     * Emit relations for the Group kind\n     */\n\n    if (entity.kind === 'Group') {\n      const group = entity as GroupEntity;\n      doEmit(\n        group.spec.parent,\n        { defaultKind: 'Group', defaultNamespace: selfRef.namespace },\n        RELATION_CHILD_OF,\n        RELATION_PARENT_OF,\n      );\n      doEmit(\n        group.spec.children,\n        { defaultKind: 'Group', defaultNamespace: selfRef.namespace },\n        RELATION_PARENT_OF,\n        RELATION_CHILD_OF,\n      );\n      doEmit(\n        group.spec.members,\n        { defaultKind: 'User', defaultNamespace: selfRef.namespace },\n        RELATION_HAS_MEMBER,\n        RELATION_MEMBER_OF,\n      );\n    }\n\n    /*\n     * Emit relations for the System kind\n     */\n\n    if (entity.kind === 'System') {\n      const system = entity as SystemEntity;\n      doEmit(\n        system.spec.owner,\n        { defaultKind: 'Group', defaultNamespace: selfRef.namespace },\n        RELATION_OWNED_BY,\n        RELATION_OWNER_OF,\n      );\n      doEmit(\n        system.spec.domain,\n        { defaultKind: 'Domain', defaultNamespace: selfRef.namespace },\n        RELATION_PART_OF,\n        RELATION_HAS_PART,\n      );\n    }\n\n    /*\n     * Emit relations for the Domain kind\n     */\n\n    if (entity.kind === 'Domain') {\n      const domain = entity as DomainEntity;\n      doEmit(\n        domain.spec.owner,\n        { defaultKind: 'Group', defaultNamespace: selfRef.namespace },\n        RELATION_OWNED_BY,\n        RELATION_OWNER_OF,\n      );\n      doEmit(\n        domain.spec.subdomainOf,\n        { defaultKind: 'Domain', defaultNamespace: selfRef.namespace },\n        RELATION_PART_OF,\n        RELATION_HAS_PART,\n      );\n    }\n\n    return entity;\n  }\n}\n"],"names":["apiEntityV1alpha1Validator","componentEntityV1alpha1Validator","resourceEntityV1alpha1Validator","groupEntityV1alpha1Validator","locationEntityV1alpha1Validator","userEntityV1alpha1Validator","systemEntityV1alpha1Validator","domainEntityV1alpha1Validator","getCompoundEntityRef","parseEntityRef","processingResult","RELATION_OWNED_BY","RELATION_OWNER_OF","RELATION_PART_OF","RELATION_HAS_PART","RELATION_PROVIDES_API","RELATION_API_PROVIDED_BY","RELATION_CONSUMES_API","RELATION_API_CONSUMED_BY","RELATION_DEPENDS_ON","RELATION_DEPENDENCY_OF","RELATION_MEMBER_OF","RELATION_HAS_MEMBER","RELATION_CHILD_OF","RELATION_PARENT_OF"],"mappings":"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"}