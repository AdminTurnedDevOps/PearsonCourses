{"version":3,"file":"LocationEntityProcessor.cjs.js","sources":["../../src/processors/LocationEntityProcessor.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Entity, LocationEntity } from '@backstage/catalog-model';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\nimport path from 'path';\nimport { LocationSpec } from '@backstage/plugin-catalog-common';\nimport {\n  processingResult,\n  CatalogProcessor,\n  CatalogProcessorEmit,\n} from '@backstage/plugin-catalog-node';\n\nexport function toAbsoluteUrl(\n  integrations: ScmIntegrationRegistry,\n  base: LocationSpec,\n  target: string,\n): string {\n  try {\n    if (base.type === 'file') {\n      if (target.startsWith('.')) {\n        return path.join(path.dirname(base.target), target);\n      }\n      return target;\n    }\n    return integrations.resolveUrl({ url: target, base: base.target });\n  } catch (e) {\n    return target;\n  }\n}\n\n/**\n * @public\n * @deprecated This processor should no longer be used\n */\nexport type LocationEntityProcessorOptions = {\n  integrations: ScmIntegrationRegistry;\n};\n\n/**\n * Legacy processor, should not be used.\n *\n * @remarks\n *\n * In the old catalog architecture, this processor translated Location entities\n * into URLs that should be fetched. This is no longer needed since the engine\n * handles this internally.\n *\n * @public\n * @deprecated This processor should no longer be used\n */\nexport class LocationEntityProcessor implements CatalogProcessor {\n  constructor(private readonly options: LocationEntityProcessorOptions) {}\n\n  getProcessorName(): string {\n    return 'LocationEntityProcessor';\n  }\n\n  async postProcessEntity(\n    entity: Entity,\n    location: LocationSpec,\n    emit: CatalogProcessorEmit,\n  ): Promise<Entity> {\n    if (entity.kind === 'Location') {\n      const locationEntity = entity as LocationEntity;\n\n      const type = locationEntity.spec.type || location.type;\n      if (type === 'file' && location.target.endsWith(path.sep)) {\n        emit(\n          processingResult.inputError(\n            location,\n            `LocationEntityProcessor cannot handle ${type} type location with target ${location.target} that ends with a path separator`,\n          ),\n        );\n      }\n\n      const targets = new Array<string>();\n      if (locationEntity.spec.target) {\n        targets.push(locationEntity.spec.target);\n      }\n      if (locationEntity.spec.targets) {\n        targets.push(...locationEntity.spec.targets);\n      }\n\n      for (const maybeRelativeTarget of targets) {\n        const target = toAbsoluteUrl(\n          this.options.integrations,\n          location,\n          maybeRelativeTarget,\n        );\n        emit(processingResult.location({ type, target }));\n      }\n    }\n\n    return entity;\n  }\n}\n"],"names":["path","processingResult"],"mappings":";;;;;;;;;AA0BgB,SAAA,aAAA,CACd,YACA,EAAA,IAAA,EACA,MACQ,EAAA;AACR,EAAI,IAAA;AACF,IAAI,IAAA,IAAA,CAAK,SAAS,MAAQ,EAAA;AACxB,MAAI,IAAA,MAAA,CAAO,UAAW,CAAA,GAAG,CAAG,EAAA;AAC1B,QAAA,OAAOA,sBAAK,IAAK,CAAAA,qBAAA,CAAK,QAAQ,IAAK,CAAA,MAAM,GAAG,MAAM,CAAA;AAAA;AAEpD,MAAO,OAAA,MAAA;AAAA;AAET,IAAO,OAAA,YAAA,CAAa,WAAW,EAAE,GAAA,EAAK,QAAQ,IAAM,EAAA,IAAA,CAAK,QAAQ,CAAA;AAAA,WAC1D,CAAG,EAAA;AACV,IAAO,OAAA,MAAA;AAAA;AAEX;AAsBO,MAAM,uBAAoD,CAAA;AAAA,EAC/D,YAA6B,OAAyC,EAAA;AAAzC,IAAA,IAAA,CAAA,OAAA,GAAA,OAAA;AAAA;AAA0C,EAEvE,gBAA2B,GAAA;AACzB,IAAO,OAAA,yBAAA;AAAA;AACT,EAEA,MAAM,iBAAA,CACJ,MACA,EAAA,QAAA,EACA,IACiB,EAAA;AACjB,IAAI,IAAA,MAAA,CAAO,SAAS,UAAY,EAAA;AAC9B,MAAA,MAAM,cAAiB,GAAA,MAAA;AAEvB,MAAA,MAAM,IAAO,GAAA,cAAA,CAAe,IAAK,CAAA,IAAA,IAAQ,QAAS,CAAA,IAAA;AAClD,MAAA,IAAI,SAAS,MAAU,IAAA,QAAA,CAAS,OAAO,QAAS,CAAAA,qBAAA,CAAK,GAAG,CAAG,EAAA;AACzD,QAAA,IAAA;AAAA,UACEC,kCAAiB,CAAA,UAAA;AAAA,YACf,QAAA;AAAA,YACA,CAAyC,sCAAA,EAAA,IAAI,CAA8B,2BAAA,EAAA,QAAA,CAAS,MAAM,CAAA,gCAAA;AAAA;AAC5F,SACF;AAAA;AAGF,MAAM,MAAA,OAAA,GAAU,IAAI,KAAc,EAAA;AAClC,MAAI,IAAA,cAAA,CAAe,KAAK,MAAQ,EAAA;AAC9B,QAAQ,OAAA,CAAA,IAAA,CAAK,cAAe,CAAA,IAAA,CAAK,MAAM,CAAA;AAAA;AAEzC,MAAI,IAAA,cAAA,CAAe,KAAK,OAAS,EAAA;AAC/B,QAAA,OAAA,CAAQ,IAAK,CAAA,GAAG,cAAe,CAAA,IAAA,CAAK,OAAO,CAAA;AAAA;AAG7C,MAAA,KAAA,MAAW,uBAAuB,OAAS,EAAA;AACzC,QAAA,MAAM,MAAS,GAAA,aAAA;AAAA,UACb,KAAK,OAAQ,CAAA,YAAA;AAAA,UACb,QAAA;AAAA,UACA;AAAA,SACF;AACA,QAAA,IAAA,CAAKA,mCAAiB,QAAS,CAAA,EAAE,IAAM,EAAA,MAAA,EAAQ,CAAC,CAAA;AAAA;AAClD;AAGF,IAAO,OAAA,MAAA;AAAA;AAEX;;;;;"}