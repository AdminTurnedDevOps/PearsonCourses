{"version":3,"file":"parseEntityFilterParams.cjs.js","sources":["../../../src/service/request/parseEntityFilterParams.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { InputError } from '@backstage/errors';\nimport { parseStringsParam } from './common';\nimport {\n  EntitiesSearchFilter,\n  EntityFilter,\n} from '@backstage/plugin-catalog-node';\n\n/**\n * Parses the filtering part of a query, like\n * /entities?filter=metadata.namespace=default,kind=Component\n */\nexport function parseEntityFilterParams(\n  params: Record<string, unknown>,\n): EntityFilter | undefined {\n  // Each filter string is on the form a=b,c=d\n  const filterStrings = parseStringsParam(params.filter, 'filter');\n  if (!filterStrings) {\n    return undefined;\n  }\n\n  // Outer array: \"any of the inner ones\"\n  // Inner arrays: \"all of these must match\"\n  const filters = filterStrings\n    .map(parseEntityFilterString)\n    .filter((r): r is EntitiesSearchFilter[] => Boolean(r));\n  if (!filters.length) {\n    return undefined;\n  }\n\n  const outer = filters.map(inner =>\n    inner.length === 1 ? inner[0] : { allOf: inner },\n  );\n  return outer.length === 1 ? outer[0] : { anyOf: outer };\n}\n\n/**\n * Parses a single filter string as seen in a filter query, for example\n * metadata.namespace=default,kind=Component\n */\nexport function parseEntityFilterString(\n  filterString: string,\n): EntitiesSearchFilter[] | undefined {\n  const statements = filterString\n    .split(',')\n    .map(s => s.trim())\n    .filter(Boolean);\n\n  if (!statements.length) {\n    return undefined;\n  }\n\n  const filtersByKey = new Map<string, EntitiesSearchFilter>();\n\n  for (const statement of statements) {\n    const equalsIndex = statement.indexOf('=');\n\n    const key =\n      equalsIndex === -1\n        ? statement\n        : statement.substring(0, equalsIndex).trim();\n    const value =\n      equalsIndex === -1\n        ? undefined\n        : statement.substring(equalsIndex + 1).trim();\n    if (!key) {\n      throw new InputError(\n        `Invalid filter, '${statement}' is not a valid statement (expected a string on the form a=b or a= or a)`,\n      );\n    }\n\n    let f = filtersByKey.get(key);\n    if (!f) {\n      f = { key };\n      filtersByKey.set(key, f);\n    }\n\n    if (value !== undefined) {\n      f.values = f.values || [];\n      f.values.push(value);\n    }\n  }\n\n  return Array.from(filtersByKey.values());\n}\n"],"names":["parseStringsParam","InputError"],"mappings":";;;;;AA2BO,SAAS,wBACd,MAC0B,EAAA;AAE1B,EAAA,MAAM,aAAgB,GAAAA,wBAAA,CAAkB,MAAO,CAAA,MAAA,EAAQ,QAAQ,CAAA;AAC/D,EAAA,IAAI,CAAC,aAAe,EAAA;AAClB,IAAO,OAAA,KAAA,CAAA;AAAA;AAKT,EAAM,MAAA,OAAA,GAAU,aACb,CAAA,GAAA,CAAI,uBAAuB,CAAA,CAC3B,OAAO,CAAC,CAAA,KAAmC,OAAQ,CAAA,CAAC,CAAC,CAAA;AACxD,EAAI,IAAA,CAAC,QAAQ,MAAQ,EAAA;AACnB,IAAO,OAAA,KAAA,CAAA;AAAA;AAGT,EAAA,MAAM,QAAQ,OAAQ,CAAA,GAAA;AAAA,IAAI,CAAA,KAAA,KACxB,MAAM,MAAW,KAAA,CAAA,GAAI,MAAM,CAAC,CAAA,GAAI,EAAE,KAAA,EAAO,KAAM;AAAA,GACjD;AACA,EAAO,OAAA,KAAA,CAAM,WAAW,CAAI,GAAA,KAAA,CAAM,CAAC,CAAI,GAAA,EAAE,OAAO,KAAM,EAAA;AACxD;AAMO,SAAS,wBACd,YACoC,EAAA;AACpC,EAAA,MAAM,UAAa,GAAA,YAAA,CAChB,KAAM,CAAA,GAAG,CACT,CAAA,GAAA,CAAI,CAAK,CAAA,KAAA,CAAA,CAAE,IAAK,EAAC,CACjB,CAAA,MAAA,CAAO,OAAO,CAAA;AAEjB,EAAI,IAAA,CAAC,WAAW,MAAQ,EAAA;AACtB,IAAO,OAAA,KAAA,CAAA;AAAA;AAGT,EAAM,MAAA,YAAA,uBAAmB,GAAkC,EAAA;AAE3D,EAAA,KAAA,MAAW,aAAa,UAAY,EAAA;AAClC,IAAM,MAAA,WAAA,GAAc,SAAU,CAAA,OAAA,CAAQ,GAAG,CAAA;AAEzC,IAAM,MAAA,GAAA,GACJ,gBAAgB,CACZ,CAAA,GAAA,SAAA,GACA,UAAU,SAAU,CAAA,CAAA,EAAG,WAAW,CAAA,CAAE,IAAK,EAAA;AAC/C,IAAM,MAAA,KAAA,GACJ,gBAAgB,CACZ,CAAA,GAAA,KAAA,CAAA,GACA,UAAU,SAAU,CAAA,WAAA,GAAc,CAAC,CAAA,CAAE,IAAK,EAAA;AAChD,IAAA,IAAI,CAAC,GAAK,EAAA;AACR,MAAA,MAAM,IAAIC,iBAAA;AAAA,QACR,oBAAoB,SAAS,CAAA,yEAAA;AAAA,OAC/B;AAAA;AAGF,IAAI,IAAA,CAAA,GAAI,YAAa,CAAA,GAAA,CAAI,GAAG,CAAA;AAC5B,IAAA,IAAI,CAAC,CAAG,EAAA;AACN,MAAA,CAAA,GAAI,EAAE,GAAI,EAAA;AACV,MAAa,YAAA,CAAA,GAAA,CAAI,KAAK,CAAC,CAAA;AAAA;AAGzB,IAAA,IAAI,UAAU,KAAW,CAAA,EAAA;AACvB,MAAE,CAAA,CAAA,MAAA,GAAS,CAAE,CAAA,MAAA,IAAU,EAAC;AACxB,MAAE,CAAA,CAAA,MAAA,CAAO,KAAK,KAAK,CAAA;AAAA;AACrB;AAGF,EAAA,OAAO,KAAM,CAAA,IAAA,CAAK,YAAa,CAAA,MAAA,EAAQ,CAAA;AACzC;;;;;"}