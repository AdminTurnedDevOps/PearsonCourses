{"version":3,"file":"AuthorizedLocationService.cjs.js","sources":["../../src/service/AuthorizedLocationService.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Location } from '@backstage/catalog-client';\nimport { CompoundEntityRef, Entity } from '@backstage/catalog-model';\nimport { NotAllowedError, NotFoundError } from '@backstage/errors';\nimport {\n  catalogLocationCreatePermission,\n  catalogLocationDeletePermission,\n  catalogLocationReadPermission,\n} from '@backstage/plugin-catalog-common/alpha';\nimport { AuthorizeResult } from '@backstage/plugin-permission-common';\nimport { LocationInput, LocationService } from './types';\nimport {\n  BackstageCredentials,\n  PermissionsService,\n} from '@backstage/backend-plugin-api';\n\nexport class AuthorizedLocationService implements LocationService {\n  constructor(\n    private readonly locationService: LocationService,\n    private readonly permissionApi: PermissionsService,\n  ) {}\n\n  async createLocation(\n    spec: LocationInput,\n    dryRun: boolean,\n    options: {\n      credentials: BackstageCredentials;\n    },\n  ): Promise<{\n    location: Location;\n    entities: Entity[];\n    exists?: boolean | undefined;\n  }> {\n    const authorizationResponse = (\n      await this.permissionApi.authorize(\n        [{ permission: catalogLocationCreatePermission }],\n        { credentials: options.credentials },\n      )\n    )[0];\n\n    if (authorizationResponse.result === AuthorizeResult.DENY) {\n      throw new NotAllowedError();\n    }\n\n    return this.locationService.createLocation(spec, dryRun, options);\n  }\n\n  async listLocations(options: {\n    credentials: BackstageCredentials;\n  }): Promise<Location[]> {\n    const authorizationResponse = (\n      await this.permissionApi.authorize(\n        [{ permission: catalogLocationReadPermission }],\n        { credentials: options.credentials },\n      )\n    )[0];\n\n    if (authorizationResponse.result === AuthorizeResult.DENY) {\n      return [];\n    }\n\n    return this.locationService.listLocations(options);\n  }\n\n  async getLocation(\n    id: string,\n    options: { credentials: BackstageCredentials },\n  ): Promise<Location> {\n    const authorizationResponse = (\n      await this.permissionApi.authorize(\n        [{ permission: catalogLocationReadPermission }],\n        { credentials: options.credentials },\n      )\n    )[0];\n\n    if (authorizationResponse.result === AuthorizeResult.DENY) {\n      throw new NotFoundError(`Found no location with ID ${id}`);\n    }\n\n    return this.locationService.getLocation(id, options);\n  }\n\n  async deleteLocation(\n    id: string,\n    options: { credentials: BackstageCredentials },\n  ): Promise<void> {\n    const authorizationResponse = (\n      await this.permissionApi.authorize(\n        [{ permission: catalogLocationDeletePermission }],\n        { credentials: options.credentials },\n      )\n    )[0];\n\n    if (authorizationResponse.result === AuthorizeResult.DENY) {\n      throw new NotAllowedError();\n    }\n\n    return this.locationService.deleteLocation(id, options);\n  }\n\n  async getLocationByEntity(\n    entityRef: CompoundEntityRef | string,\n    options: { credentials: BackstageCredentials },\n  ): Promise<Location> {\n    const authorizationResponse = (\n      await this.permissionApi.authorize(\n        [{ permission: catalogLocationReadPermission }],\n        { credentials: options.credentials },\n      )\n    )[0];\n\n    if (authorizationResponse.result === AuthorizeResult.DENY) {\n      throw new NotFoundError();\n    }\n    return this.locationService.getLocationByEntity(entityRef, options);\n  }\n}\n"],"names":["catalogLocationCreatePermission","AuthorizeResult","NotAllowedError","catalogLocationReadPermission","NotFoundError","catalogLocationDeletePermission"],"mappings":"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"}