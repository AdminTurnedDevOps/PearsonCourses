{"version":3,"file":"DefaultLocationService.cjs.js","sources":["../../src/service/DefaultLocationService.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  Entity,\n  ANNOTATION_LOCATION,\n  ANNOTATION_ORIGIN_LOCATION,\n  stringifyEntityRef,\n  CompoundEntityRef,\n  parseEntityRef,\n} from '@backstage/catalog-model';\nimport { Location } from '@backstage/catalog-client';\nimport { CatalogProcessingOrchestrator } from '../processing/types';\nimport { LocationInput, LocationService, LocationStore } from './types';\nimport { locationSpecToMetadataName } from '../util/conversion';\nimport { InputError } from '@backstage/errors';\nimport { DeferredEntity } from '@backstage/plugin-catalog-node';\n\nexport type DefaultLocationServiceOptions = {\n  allowedLocationTypes: string[];\n};\n\nexport class DefaultLocationService implements LocationService {\n  constructor(\n    private readonly store: LocationStore,\n    private readonly orchestrator: CatalogProcessingOrchestrator,\n    private readonly options: DefaultLocationServiceOptions = {\n      allowedLocationTypes: ['url'],\n    },\n  ) {}\n\n  async createLocation(\n    input: LocationInput,\n    dryRun: boolean,\n  ): Promise<{ location: Location; entities: Entity[]; exists?: boolean }> {\n    if (!this.options.allowedLocationTypes.includes(input.type)) {\n      throw new InputError(\n        `Registered locations must be of an allowed type ${JSON.stringify(\n          this.options.allowedLocationTypes,\n        )}`,\n      );\n    }\n    if (dryRun) {\n      return this.dryRunCreateLocation(input);\n    }\n    const location = await this.store.createLocation(input);\n    return { location, entities: [] };\n  }\n\n  listLocations(): Promise<Location[]> {\n    return this.store.listLocations();\n  }\n  getLocation(id: string): Promise<Location> {\n    return this.store.getLocation(id);\n  }\n  deleteLocation(id: string): Promise<void> {\n    return this.store.deleteLocation(id);\n  }\n\n  getLocationByEntity(\n    entityRef: CompoundEntityRef | string,\n  ): Promise<Location> {\n    return this.store.getLocationByEntity(parseEntityRef(entityRef));\n  }\n\n  private async processEntities(\n    unprocessedEntities: DeferredEntity[],\n  ): Promise<Entity[]> {\n    const entities: Entity[] = [];\n    while (unprocessedEntities.length) {\n      const currentEntity = unprocessedEntities.pop();\n      if (!currentEntity) {\n        continue;\n      }\n      const processed = await this.orchestrator.process({\n        entity: currentEntity.entity,\n        state: {}, // we process without the existing cache\n      });\n\n      if (processed.ok) {\n        if (\n          entities.some(\n            e =>\n              stringifyEntityRef(e) ===\n              stringifyEntityRef(processed.completedEntity),\n          )\n        ) {\n          throw new InputError(\n            `Duplicate nested entity: ${stringifyEntityRef(\n              processed.completedEntity,\n            )}`,\n          );\n        }\n        unprocessedEntities.push(...processed.deferredEntities);\n        entities.push(processed.completedEntity);\n      } else {\n        throw new InputError(processed.errors.map(String).join(', '));\n      }\n    }\n    return entities;\n  }\n\n  private async dryRunCreateLocation(\n    spec: LocationInput,\n  ): Promise<{ location: Location; entities: Entity[]; exists?: boolean }> {\n    // Run the existence check in parallel with the processing\n    const existsPromise = this.store\n      .listLocations()\n      .then(locations =>\n        locations.some(l => l.type === spec.type && l.target === spec.target),\n      );\n\n    const entity = {\n      apiVersion: 'backstage.io/v1alpha1',\n      kind: 'Location',\n      metadata: {\n        name: locationSpecToMetadataName({\n          type: spec.type,\n          target: spec.target,\n        }),\n        namespace: 'default',\n        annotations: {\n          [ANNOTATION_LOCATION]: `${spec.type}:${spec.target}`,\n          [ANNOTATION_ORIGIN_LOCATION]: `${spec.type}:${spec.target}`,\n        },\n      },\n      spec: {\n        type: spec.type,\n        target: spec.target,\n      },\n    };\n    const unprocessedEntities: DeferredEntity[] = [\n      { entity, locationKey: `${spec.type}:${spec.target}` },\n    ];\n    const entities: Entity[] = await this.processEntities(unprocessedEntities);\n\n    return {\n      exists: await existsPromise,\n      location: { ...spec, id: `${spec.type}:${spec.target}` },\n      entities,\n    };\n  }\n}\n"],"names":["InputError","parseEntityRef","stringifyEntityRef","locationSpecToMetadataName","ANNOTATION_LOCATION","ANNOTATION_ORIGIN_LOCATION"],"mappings":"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"}