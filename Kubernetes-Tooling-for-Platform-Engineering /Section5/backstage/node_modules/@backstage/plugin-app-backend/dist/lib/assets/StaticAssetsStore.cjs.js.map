{"version":3,"file":"StaticAssetsStore.cjs.js","sources":["../../../src/lib/assets/StaticAssetsStore.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { PluginDatabaseManager } from '@backstage/backend-common';\nimport { Knex } from 'knex';\nimport { DateTime } from 'luxon';\nimport partition from 'lodash/partition';\nimport { StaticAsset, StaticAssetInput, StaticAssetProvider } from './types';\nimport {\n  LoggerService,\n  resolvePackagePath,\n} from '@backstage/backend-plugin-api';\n\nconst migrationsDir = resolvePackagePath(\n  '@backstage/plugin-app-backend',\n  'migrations',\n);\n\ninterface StaticAssetRow {\n  path: string;\n  content: Buffer;\n  namespace: string | null;\n  last_modified_at: Date;\n}\n\n/** @internal */\nexport interface StaticAssetsStoreOptions {\n  database: PluginDatabaseManager;\n  logger: LoggerService;\n}\n\n/**\n * A storage for static assets that are assumed to be immutable.\n *\n * @internal\n */\nexport class StaticAssetsStore implements StaticAssetProvider {\n  #db: Knex;\n  #logger: LoggerService;\n  #namespace: string;\n\n  static async create(options: StaticAssetsStoreOptions) {\n    const { database } = options;\n    const client = await database.getClient();\n\n    if (!database.migrations?.skip) {\n      await client.migrate.latest({\n        directory: migrationsDir,\n      });\n    }\n\n    return new StaticAssetsStore(client, options.logger);\n  }\n\n  private constructor(client: Knex, logger: LoggerService, namespace?: string) {\n    this.#db = client;\n    this.#logger = logger;\n    this.#namespace = namespace ?? 'default';\n  }\n\n  /**\n   * Creates a new store with the provided namespace, using the same underlying storage.\n   */\n  withNamespace(namespace: string): StaticAssetsStore {\n    return new StaticAssetsStore(this.#db, this.#logger, namespace);\n  }\n\n  /**\n   * Store the provided assets.\n   *\n   * If an asset for a given path already exists the modification time will be\n   * updated, but the contents will not.\n   */\n  async storeAssets(assets: StaticAssetInput[]) {\n    const existingRows = await this.#db<StaticAssetRow>('static_assets_cache')\n      .where('namespace', this.#namespace)\n      .whereIn(\n        'path',\n        assets.map(a => a.path),\n      );\n    const existingAssetPaths = new Set(existingRows.map(r => r.path));\n\n    const [modified, added] = partition(assets, asset =>\n      existingAssetPaths.has(asset.path),\n    );\n\n    this.#logger.info(\n      `Storing ${modified.length} updated assets and ${added.length} new assets`,\n    );\n\n    await this.#db('static_assets_cache')\n      .update({\n        last_modified_at: this.#db.fn.now(),\n      })\n      .where('namespace', this.#namespace)\n      .whereIn(\n        'path',\n        modified.map(a => a.path),\n      );\n\n    for (const asset of added) {\n      // We ignore conflicts with other nodes, it doesn't matter if someone else\n      // added the same asset just before us.\n      await this.#db('static_assets_cache')\n        .insert({\n          path: asset.path,\n          content: await asset.content(),\n          namespace: this.#namespace,\n        })\n        .onConflict(['namespace', 'path'])\n        .ignore();\n    }\n  }\n\n  /**\n   * Retrieve an asset from the store with the given path.\n   */\n  async getAsset(path: string): Promise<StaticAsset | undefined> {\n    const [row] = await this.#db<StaticAssetRow>('static_assets_cache').where({\n      path,\n      namespace: this.#namespace,\n    });\n    if (!row) {\n      return undefined;\n    }\n    return {\n      path: row.path,\n      content: row.content,\n      lastModifiedAt:\n        typeof row.last_modified_at === 'string'\n          ? DateTime.fromSQL(row.last_modified_at, { zone: 'UTC' }).toJSDate()\n          : row.last_modified_at,\n    };\n  }\n\n  /**\n   * Delete any assets from the store whose modification time is older than the max age.\n   */\n  async trimAssets(options: { maxAgeSeconds: number }) {\n    const { maxAgeSeconds } = options;\n    let lastModifiedInterval = this.#db.raw(\n      `now() + interval '${-maxAgeSeconds} seconds'`,\n    );\n    if (this.#db.client.config.client.includes('mysql')) {\n      lastModifiedInterval = this.#db.raw(\n        `date_sub(now(), interval ${maxAgeSeconds} second)`,\n      );\n    } else if (this.#db.client.config.client.includes('sqlite3')) {\n      lastModifiedInterval = this.#db.raw(`datetime('now', ?)`, [\n        `-${maxAgeSeconds} seconds`,\n      ]);\n    }\n    await this.#db<StaticAssetRow>('static_assets_cache')\n      .where('namespace', this.#namespace)\n      .where('last_modified_at', '<=', lastModifiedInterval)\n      .delete();\n  }\n}\n"],"names":["resolvePackagePath","partition","DateTime"],"mappings":"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"}