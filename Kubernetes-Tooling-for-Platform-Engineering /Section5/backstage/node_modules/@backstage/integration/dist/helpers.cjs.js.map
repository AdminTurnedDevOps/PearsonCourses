{"version":3,"file":"helpers.cjs.js","sources":["../src/helpers.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport parseGitUrl from 'git-url-parse';\nimport { trimEnd } from 'lodash';\nimport { ScmIntegration, ScmIntegrationsGroup } from './types';\n\n/** Checks whether the given argument is a valid URL hostname */\nexport function isValidHost(host: string): boolean {\n  const check = new URL('http://example.com');\n  check.host = host;\n  return check.host === host;\n}\n\n/** Checks whether the given argument is a valid URL */\nexport function isValidUrl(url: string): boolean {\n  try {\n    // eslint-disable-next-line no-new\n    new URL(url);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nexport function basicIntegrations<T extends ScmIntegration>(\n  integrations: T[],\n  getHost: (integration: T) => string,\n): ScmIntegrationsGroup<T> {\n  return {\n    list(): T[] {\n      return integrations;\n    },\n    byUrl(url: string | URL): T | undefined {\n      try {\n        const parsed = typeof url === 'string' ? new URL(url) : url;\n        return integrations.find(i => getHost(i) === parsed.host);\n      } catch {\n        return undefined;\n      }\n    },\n    byHost(host: string): T | undefined {\n      return integrations.find(i => getHost(i) === host);\n    },\n  };\n}\n\n/**\n * Default implementation of {@link ScmIntegration} `resolveUrl`, that only\n * works with URL pathname based providers.\n *\n * @public\n */\nexport function defaultScmResolveUrl(options: {\n  url: string;\n  base: string;\n  lineNumber?: number;\n}): string {\n  const { url, base, lineNumber } = options;\n\n  // If it is a fully qualified URL - then return it verbatim\n  try {\n    // eslint-disable-next-line no-new\n    new URL(url);\n    return url;\n  } catch {\n    // ignore intentionally\n  }\n\n  let updated: URL;\n\n  if (url.startsWith('/')) {\n    // If it is an absolute path, move relative to the repo root\n    const { href, filepath } = parseGitUrl(base);\n\n    updated = new URL(href);\n\n    const repoRootPath = trimEnd(\n      updated.pathname.substring(0, updated.pathname.length - filepath.length),\n      '/',\n    );\n    updated.pathname = `${repoRootPath}${url}`;\n  } else {\n    // For relative URLs, just let the default URL constructor handle the\n    // resolving. Note that this essentially will treat the last segment of the\n    // base as a file - NOT a folder - unless the url ends in a slash.\n    updated = new URL(url, base);\n  }\n\n  updated.search = new URL(base).search;\n  if (lineNumber) {\n    updated.hash = `L${lineNumber}`;\n  }\n  return updated.toString();\n}\n\n/**\n * Sets up handlers for request mocking\n *\n * Copied from test-utils, as that is a frontend-only package\n *\n * @param worker - service worker\n */\nexport function registerMswTestHooks(worker: {\n  listen: (t: any) => void;\n  close: () => void;\n  resetHandlers: () => void;\n}) {\n  beforeAll(() => worker.listen({ onUnhandledRequest: 'error' }));\n  afterAll(() => worker.close());\n  afterEach(() => worker.resetHandlers());\n}\n"],"names":["parseGitUrl","trimEnd"],"mappings":";;;;;;;;;AAqBO,SAAS,YAAY,IAAuB,EAAA;AACjD,EAAM,MAAA,KAAA,GAAQ,IAAI,GAAA,CAAI,oBAAoB,CAAA;AAC1C,EAAA,KAAA,CAAM,IAAO,GAAA,IAAA;AACb,EAAA,OAAO,MAAM,IAAS,KAAA,IAAA;AACxB;AAGO,SAAS,WAAW,GAAsB,EAAA;AAC/C,EAAI,IAAA;AAEF,IAAA,IAAI,IAAI,GAAG,CAAA;AACX,IAAO,OAAA,IAAA;AAAA,GACD,CAAA,MAAA;AACN,IAAO,OAAA,KAAA;AAAA;AAEX;AAEgB,SAAA,iBAAA,CACd,cACA,OACyB,EAAA;AACzB,EAAO,OAAA;AAAA,IACL,IAAY,GAAA;AACV,MAAO,OAAA,YAAA;AAAA,KACT;AAAA,IACA,MAAM,GAAkC,EAAA;AACtC,MAAI,IAAA;AACF,QAAA,MAAM,SAAS,OAAO,GAAA,KAAQ,WAAW,IAAI,GAAA,CAAI,GAAG,CAAI,GAAA,GAAA;AACxD,QAAA,OAAO,aAAa,IAAK,CAAA,CAAA,CAAA,KAAK,QAAQ,CAAC,CAAA,KAAM,OAAO,IAAI,CAAA;AAAA,OAClD,CAAA,MAAA;AACN,QAAO,OAAA,KAAA,CAAA;AAAA;AACT,KACF;AAAA,IACA,OAAO,IAA6B,EAAA;AAClC,MAAA,OAAO,aAAa,IAAK,CAAA,CAAA,CAAA,KAAK,OAAQ,CAAA,CAAC,MAAM,IAAI,CAAA;AAAA;AACnD,GACF;AACF;AAQO,SAAS,qBAAqB,OAI1B,EAAA;AACT,EAAA,MAAM,EAAE,GAAA,EAAK,IAAM,EAAA,UAAA,EAAe,GAAA,OAAA;AAGlC,EAAI,IAAA;AAEF,IAAA,IAAI,IAAI,GAAG,CAAA;AACX,IAAO,OAAA,GAAA;AAAA,GACD,CAAA,MAAA;AAAA;AAIR,EAAI,IAAA,OAAA;AAEJ,EAAI,IAAA,GAAA,CAAI,UAAW,CAAA,GAAG,CAAG,EAAA;AAEvB,IAAA,MAAM,EAAE,IAAA,EAAM,QAAS,EAAA,GAAIA,6BAAY,IAAI,CAAA;AAE3C,IAAU,OAAA,GAAA,IAAI,IAAI,IAAI,CAAA;AAEtB,IAAA,MAAM,YAAe,GAAAC,cAAA;AAAA,MACnB,OAAA,CAAQ,SAAS,SAAU,CAAA,CAAA,EAAG,QAAQ,QAAS,CAAA,MAAA,GAAS,SAAS,MAAM,CAAA;AAAA,MACvE;AAAA,KACF;AACA,IAAA,OAAA,CAAQ,QAAW,GAAA,CAAA,EAAG,YAAY,CAAA,EAAG,GAAG,CAAA,CAAA;AAAA,GACnC,MAAA;AAIL,IAAU,OAAA,GAAA,IAAI,GAAI,CAAA,GAAA,EAAK,IAAI,CAAA;AAAA;AAG7B,EAAA,OAAA,CAAQ,MAAS,GAAA,IAAI,GAAI,CAAA,IAAI,CAAE,CAAA,MAAA;AAC/B,EAAA,IAAI,UAAY,EAAA;AACd,IAAQ,OAAA,CAAA,IAAA,GAAO,IAAI,UAAU,CAAA,CAAA;AAAA;AAE/B,EAAA,OAAO,QAAQ,QAAS,EAAA;AAC1B;;;;;;;"}