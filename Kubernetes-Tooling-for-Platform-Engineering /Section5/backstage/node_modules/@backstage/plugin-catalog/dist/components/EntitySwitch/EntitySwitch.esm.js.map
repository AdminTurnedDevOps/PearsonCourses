{"version":3,"file":"EntitySwitch.esm.js","sources":["../../../src/components/EntitySwitch/EntitySwitch.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Entity } from '@backstage/catalog-model';\nimport { useAsyncEntity } from '@backstage/plugin-catalog-react';\nimport React, { ReactNode, ReactElement } from 'react';\nimport {\n  attachComponentData,\n  useApiHolder,\n  useElementFilter,\n  ApiHolder,\n} from '@backstage/core-plugin-api';\nimport useAsync from 'react-use/esm/useAsync';\n\nconst ENTITY_SWITCH_KEY = 'core.backstage.entitySwitch';\n\n/** @public */\nexport interface EntitySwitchCaseProps {\n  if?: (\n    entity: Entity,\n    context: { apis: ApiHolder },\n  ) => boolean | Promise<boolean>;\n  children: ReactNode;\n}\n\nconst EntitySwitchCaseComponent = (_props: EntitySwitchCaseProps) => null;\n\nattachComponentData(EntitySwitchCaseComponent, ENTITY_SWITCH_KEY, true);\n\ninterface EntitySwitchCase {\n  if?: (\n    entity: Entity,\n    context: { apis: ApiHolder },\n  ) => boolean | Promise<boolean>;\n  children: JSX.Element;\n}\n\ntype SwitchCaseResult = {\n  if?: boolean | Promise<boolean>;\n  children: JSX.Element;\n};\n\n/**\n * Props for the {@link EntitySwitch} component.\n * @public\n */\nexport interface EntitySwitchProps {\n  children: ReactNode;\n  renderMultipleMatches?: 'first' | 'all';\n}\n\n/** @public */\nexport const EntitySwitch = (props: EntitySwitchProps) => {\n  const { entity, loading } = useAsyncEntity();\n  const apis = useApiHolder();\n\n  const results = useElementFilter(\n    props.children,\n    collection =>\n      collection\n        .selectByComponentData({\n          key: ENTITY_SWITCH_KEY,\n          withStrictError: 'Child of EntitySwitch is not an EntitySwitch.Case',\n        })\n        .getElements()\n        .flatMap<SwitchCaseResult>((element: ReactElement) => {\n          if (loading && !entity) {\n            return [];\n          }\n\n          const { if: condition, children: elementsChildren } =\n            element.props as EntitySwitchCase;\n\n          if (!entity) {\n            return [\n              {\n                if: condition === undefined,\n                children: elementsChildren,\n              },\n            ];\n          }\n          return [\n            {\n              if: condition?.(entity, { apis }),\n              children: elementsChildren,\n            },\n          ];\n        }),\n    [apis, entity, loading],\n  );\n\n  const hasAsyncCases = results.some(\n    r => typeof r.if === 'object' && 'then' in r.if,\n  );\n\n  if (hasAsyncCases) {\n    return (\n      <AsyncEntitySwitch\n        results={results}\n        renderMultipleMatches={props.renderMultipleMatches}\n      />\n    );\n  }\n\n  if (props.renderMultipleMatches === 'all') {\n    const children = results.filter(r => r.if).map(r => r.children);\n    if (children.length === 0) {\n      return getDefaultChildren(results);\n    }\n    return <>{children}</>;\n  }\n\n  return results.find(r => r.if)?.children ?? getDefaultChildren(results);\n};\n\nfunction AsyncEntitySwitch({\n  results,\n  renderMultipleMatches,\n}: {\n  results: SwitchCaseResult[];\n  renderMultipleMatches?: 'first' | 'all';\n}) {\n  const { loading, value } = useAsync(async () => {\n    const promises = results.map(\n      async ({ if: condition, children: output }) => {\n        try {\n          if (await condition) {\n            return output;\n          }\n        } catch {\n          /* ignored */\n        }\n        return null;\n      },\n    );\n\n    if (renderMultipleMatches === 'all') {\n      const children = (await Promise.all(promises)).filter(Boolean);\n      if (children.length === 0) {\n        return getDefaultChildren(results);\n      }\n      return <>{children}</>;\n    }\n\n    return (\n      (await Promise.all(promises)).find(Boolean) ?? getDefaultChildren(results)\n    );\n  }, [results]);\n\n  if (loading || !value) {\n    return null;\n  }\n\n  return value;\n}\n\nfunction getDefaultChildren(results: SwitchCaseResult[]) {\n  return results.filter(r => r.if === undefined)[0]?.children ?? null;\n}\n\nEntitySwitch.Case = EntitySwitchCaseComponent;\n"],"names":[],"mappings":"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"}