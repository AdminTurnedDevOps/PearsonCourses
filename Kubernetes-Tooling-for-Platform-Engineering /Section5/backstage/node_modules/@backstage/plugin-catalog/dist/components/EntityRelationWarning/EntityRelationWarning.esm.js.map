{"version":3,"file":"EntityRelationWarning.esm.js","sources":["../../../src/components/EntityRelationWarning/EntityRelationWarning.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Entity } from '@backstage/catalog-model';\nimport {\n  CatalogApi,\n  catalogApiRef,\n  useEntity,\n} from '@backstage/plugin-catalog-react';\nimport Alert from '@material-ui/lab/Alert';\nimport React from 'react';\nimport useAsync from 'react-use/esm/useAsync';\nimport Box from '@material-ui/core/Box';\nimport { ResponseErrorPanel } from '@backstage/core-components';\nimport { useApi, ApiHolder } from '@backstage/core-plugin-api';\nimport { catalogTranslationRef } from '../../alpha/translation';\nimport { useTranslationRef } from '@backstage/core-plugin-api/alpha';\n\nasync function getRelationWarnings(entity: Entity, catalogApi: CatalogApi) {\n  const entityRefRelations = entity.relations?.map(\n    relation => relation.targetRef,\n  );\n  if (\n    !entityRefRelations ||\n    entityRefRelations?.length < 1 ||\n    entityRefRelations.length > 1000\n  ) {\n    return [];\n  }\n\n  const relatedEntities = await catalogApi.getEntitiesByRefs({\n    entityRefs: entityRefRelations,\n    fields: ['kind', 'metadata.name', 'metadata.namespace'],\n  });\n\n  return entityRefRelations.filter(\n    (_, index) => relatedEntities.items[index] === undefined,\n  );\n}\n\n/**\n * Returns true if the given entity has relations to other entities, which\n * don't exist in the catalog\n *\n * @public\n */\nexport async function hasRelationWarnings(\n  entity: Entity,\n  context: { apis: ApiHolder },\n) {\n  const catalogApi = context.apis.get(catalogApiRef);\n  if (!catalogApi) {\n    throw new Error(`No implementation available for ${catalogApiRef}`);\n  }\n\n  const relatedEntitiesMissing = await getRelationWarnings(entity, catalogApi);\n  return relatedEntitiesMissing.length > 0;\n}\n\n/**\n * Displays a warning alert if the entity has relations to other entities, which\n * don't exist in the catalog\n *\n * @public\n */\nexport function EntityRelationWarning() {\n  const { entity } = useEntity();\n  const catalogApi = useApi(catalogApiRef);\n  const { loading, error, value } = useAsync(async () => {\n    return getRelationWarnings(entity, catalogApi);\n  }, [entity, catalogApi]);\n  const { t } = useTranslationRef(catalogTranslationRef);\n\n  if (error) {\n    return (\n      <Box mb={1}>\n        <ResponseErrorPanel error={error} />\n      </Box>\n    );\n  }\n\n  if (loading || !value || value.length === 0) {\n    return null;\n  }\n\n  return (\n    <>\n      <Alert severity=\"warning\" style={{ whiteSpace: 'pre-line' }}>\n        {t('entityRelationWarningDescription')} {value.join(', ')}\n      </Alert>\n    </>\n  );\n}\n"],"names":[],"mappings":";;;;;;;;;;AA+BA,eAAe,mBAAA,CAAoB,QAAgB,UAAwB,EAAA;AACzE,EAAM,MAAA,kBAAA,GAAqB,OAAO,SAAW,EAAA,GAAA;AAAA,IAC3C,cAAY,QAAS,CAAA;AAAA,GACvB;AACA,EAAA,IACE,CAAC,kBACD,IAAA,kBAAA,EAAoB,SAAS,CAC7B,IAAA,kBAAA,CAAmB,SAAS,GAC5B,EAAA;AACA,IAAA,OAAO,EAAC;AAAA;AAGV,EAAM,MAAA,eAAA,GAAkB,MAAM,UAAA,CAAW,iBAAkB,CAAA;AAAA,IACzD,UAAY,EAAA,kBAAA;AAAA,IACZ,MAAQ,EAAA,CAAC,MAAQ,EAAA,eAAA,EAAiB,oBAAoB;AAAA,GACvD,CAAA;AAED,EAAA,OAAO,kBAAmB,CAAA,MAAA;AAAA,IACxB,CAAC,CAAG,EAAA,KAAA,KAAU,eAAgB,CAAA,KAAA,CAAM,KAAK,CAAM,KAAA,KAAA;AAAA,GACjD;AACF;AAQsB,eAAA,mBAAA,CACpB,QACA,OACA,EAAA;AACA,EAAA,MAAM,UAAa,GAAA,OAAA,CAAQ,IAAK,CAAA,GAAA,CAAI,aAAa,CAAA;AACjD,EAAA,IAAI,CAAC,UAAY,EAAA;AACf,IAAA,MAAM,IAAI,KAAA,CAAM,CAAmC,gCAAA,EAAA,aAAa,CAAE,CAAA,CAAA;AAAA;AAGpE,EAAA,MAAM,sBAAyB,GAAA,MAAM,mBAAoB,CAAA,MAAA,EAAQ,UAAU,CAAA;AAC3E,EAAA,OAAO,uBAAuB,MAAS,GAAA,CAAA;AACzC;AAQO,SAAS,qBAAwB,GAAA;AACtC,EAAM,MAAA,EAAE,MAAO,EAAA,GAAI,SAAU,EAAA;AAC7B,EAAM,MAAA,UAAA,GAAa,OAAO,aAAa,CAAA;AACvC,EAAA,MAAM,EAAE,OAAS,EAAA,KAAA,EAAO,KAAM,EAAA,GAAI,SAAS,YAAY;AACrD,IAAO,OAAA,mBAAA,CAAoB,QAAQ,UAAU,CAAA;AAAA,GAC5C,EAAA,CAAC,MAAQ,EAAA,UAAU,CAAC,CAAA;AACvB,EAAA,MAAM,EAAE,CAAA,EAAM,GAAA,iBAAA,CAAkB,qBAAqB,CAAA;AAErD,EAAA,IAAI,KAAO,EAAA;AACT,IAAA,2CACG,GAAI,EAAA,EAAA,EAAA,EAAI,qBACN,KAAA,CAAA,aAAA,CAAA,kBAAA,EAAA,EAAmB,OAAc,CACpC,CAAA;AAAA;AAIJ,EAAA,IAAI,OAAW,IAAA,CAAC,KAAS,IAAA,KAAA,CAAM,WAAW,CAAG,EAAA;AAC3C,IAAO,OAAA,IAAA;AAAA;AAGT,EAAA,iFAEK,KAAA,CAAA,aAAA,CAAA,KAAA,EAAA,EAAM,UAAS,SAAU,EAAA,KAAA,EAAO,EAAE,UAAY,EAAA,UAAA,EAC5C,EAAA,EAAA,CAAA,CAAE,kCAAkC,CAAE,EAAA,GAAA,EAAE,MAAM,IAAK,CAAA,IAAI,CAC1D,CACF,CAAA;AAEJ;;;;"}