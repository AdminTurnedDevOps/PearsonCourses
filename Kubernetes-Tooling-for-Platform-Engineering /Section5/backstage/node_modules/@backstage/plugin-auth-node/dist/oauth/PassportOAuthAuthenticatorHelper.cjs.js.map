{"version":3,"file":"PassportOAuthAuthenticatorHelper.cjs.js","sources":["../../src/oauth/PassportOAuthAuthenticatorHelper.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Strategy } from 'passport';\nimport {\n  PassportDoneCallback,\n  PassportHelpers,\n  PassportProfile,\n} from '../passport';\nimport { ProfileTransform } from '../types';\nimport {\n  OAuthAuthenticatorAuthenticateInput,\n  OAuthAuthenticatorRefreshInput,\n  OAuthAuthenticatorResult,\n  OAuthAuthenticatorStartInput,\n} from './types';\n\n/** @public */\nexport type PassportOAuthResult = {\n  fullProfile: PassportProfile;\n  params: {\n    id_token?: string;\n    scope: string;\n    token_type?: string;\n    expires_in: number;\n  };\n  accessToken: string;\n};\n\n/** @public */\nexport type PassportOAuthPrivateInfo = {\n  refreshToken?: string;\n};\n\n/** @public */\nexport type PassportOAuthDoneCallback = PassportDoneCallback<\n  PassportOAuthResult,\n  PassportOAuthPrivateInfo\n>;\n\n/** @public */\nexport class PassportOAuthAuthenticatorHelper {\n  static defaultProfileTransform: ProfileTransform<\n    OAuthAuthenticatorResult<PassportProfile>\n  > = async input => ({\n    profile: PassportHelpers.transformProfile(\n      input.fullProfile ?? {},\n      input.session.idToken,\n    ),\n  });\n\n  static from(strategy: Strategy) {\n    return new PassportOAuthAuthenticatorHelper(strategy);\n  }\n\n  readonly #strategy: Strategy;\n\n  private constructor(strategy: Strategy) {\n    this.#strategy = strategy;\n  }\n\n  async start(\n    input: OAuthAuthenticatorStartInput,\n    options: Record<string, string>,\n  ): Promise<{ url: string; status?: number }> {\n    return PassportHelpers.executeRedirectStrategy(input.req, this.#strategy, {\n      scope: input.scope,\n      state: input.state,\n      ...options,\n    });\n  }\n\n  async authenticate(\n    input: OAuthAuthenticatorAuthenticateInput,\n    options?: Record<string, string>,\n  ): Promise<OAuthAuthenticatorResult<PassportProfile>> {\n    const { result, privateInfo } =\n      await PassportHelpers.executeFrameHandlerStrategy<\n        PassportOAuthResult,\n        PassportOAuthPrivateInfo\n      >(input.req, this.#strategy, options);\n\n    return {\n      fullProfile: result.fullProfile as PassportProfile,\n      session: {\n        accessToken: result.accessToken,\n        tokenType: result.params.token_type ?? 'bearer',\n        scope: result.params.scope,\n        expiresInSeconds: result.params.expires_in,\n        idToken: result.params.id_token,\n        refreshToken: privateInfo.refreshToken,\n      },\n    };\n  }\n\n  async refresh(\n    input: OAuthAuthenticatorRefreshInput,\n  ): Promise<OAuthAuthenticatorResult<PassportProfile>> {\n    const result = await PassportHelpers.executeRefreshTokenStrategy(\n      this.#strategy,\n      input.refreshToken,\n      input.scope,\n    );\n    const fullProfile = await this.fetchProfile(result.accessToken);\n    return {\n      fullProfile,\n      session: {\n        accessToken: result.accessToken,\n        tokenType: result.params.token_type ?? 'bearer',\n        scope: result.params.scope,\n        expiresInSeconds: result.params.expires_in,\n        idToken: result.params.id_token,\n        refreshToken: result.refreshToken,\n      },\n    };\n  }\n\n  async fetchProfile(accessToken: string): Promise<PassportProfile> {\n    const profile = await PassportHelpers.executeFetchUserProfileStrategy(\n      this.#strategy,\n      accessToken,\n    );\n    return profile;\n  }\n}\n"],"names":["PassportHelpers"],"mappings":";;;;AAsDO,MAAM,gCAAiC,CAAA;AAAA,EAC5C,OAAO,uBAEH,GAAA,OAAM,KAAU,MAAA;AAAA,IAClB,SAASA,+BAAgB,CAAA,gBAAA;AAAA,MACvB,KAAA,CAAM,eAAe,EAAC;AAAA,MACtB,MAAM,OAAQ,CAAA;AAAA;AAChB,GACF,CAAA;AAAA,EAEA,OAAO,KAAK,QAAoB,EAAA;AAC9B,IAAO,OAAA,IAAI,iCAAiC,QAAQ,CAAA;AAAA;AACtD,EAES,SAAA;AAAA,EAED,YAAY,QAAoB,EAAA;AACtC,IAAA,IAAA,CAAK,SAAY,GAAA,QAAA;AAAA;AACnB,EAEA,MAAM,KACJ,CAAA,KAAA,EACA,OAC2C,EAAA;AAC3C,IAAA,OAAOA,+BAAgB,CAAA,uBAAA,CAAwB,KAAM,CAAA,GAAA,EAAK,KAAK,SAAW,EAAA;AAAA,MACxE,OAAO,KAAM,CAAA,KAAA;AAAA,MACb,OAAO,KAAM,CAAA,KAAA;AAAA,MACb,GAAG;AAAA,KACJ,CAAA;AAAA;AACH,EAEA,MAAM,YACJ,CAAA,KAAA,EACA,OACoD,EAAA;AACpD,IAAM,MAAA,EAAE,MAAQ,EAAA,WAAA,EACd,GAAA,MAAMA,+BAAgB,CAAA,2BAAA,CAGpB,KAAM,CAAA,GAAA,EAAK,IAAK,CAAA,SAAA,EAAW,OAAO,CAAA;AAEtC,IAAO,OAAA;AAAA,MACL,aAAa,MAAO,CAAA,WAAA;AAAA,MACpB,OAAS,EAAA;AAAA,QACP,aAAa,MAAO,CAAA,WAAA;AAAA,QACpB,SAAA,EAAW,MAAO,CAAA,MAAA,CAAO,UAAc,IAAA,QAAA;AAAA,QACvC,KAAA,EAAO,OAAO,MAAO,CAAA,KAAA;AAAA,QACrB,gBAAA,EAAkB,OAAO,MAAO,CAAA,UAAA;AAAA,QAChC,OAAA,EAAS,OAAO,MAAO,CAAA,QAAA;AAAA,QACvB,cAAc,WAAY,CAAA;AAAA;AAC5B,KACF;AAAA;AACF,EAEA,MAAM,QACJ,KACoD,EAAA;AACpD,IAAM,MAAA,MAAA,GAAS,MAAMA,+BAAgB,CAAA,2BAAA;AAAA,MACnC,IAAK,CAAA,SAAA;AAAA,MACL,KAAM,CAAA,YAAA;AAAA,MACN,KAAM,CAAA;AAAA,KACR;AACA,IAAA,MAAM,WAAc,GAAA,MAAM,IAAK,CAAA,YAAA,CAAa,OAAO,WAAW,CAAA;AAC9D,IAAO,OAAA;AAAA,MACL,WAAA;AAAA,MACA,OAAS,EAAA;AAAA,QACP,aAAa,MAAO,CAAA,WAAA;AAAA,QACpB,SAAA,EAAW,MAAO,CAAA,MAAA,CAAO,UAAc,IAAA,QAAA;AAAA,QACvC,KAAA,EAAO,OAAO,MAAO,CAAA,KAAA;AAAA,QACrB,gBAAA,EAAkB,OAAO,MAAO,CAAA,UAAA;AAAA,QAChC,OAAA,EAAS,OAAO,MAAO,CAAA,QAAA;AAAA,QACvB,cAAc,MAAO,CAAA;AAAA;AACvB,KACF;AAAA;AACF,EAEA,MAAM,aAAa,WAA+C,EAAA;AAChE,IAAM,MAAA,OAAA,GAAU,MAAMA,+BAAgB,CAAA,+BAAA;AAAA,MACpC,IAAK,CAAA,SAAA;AAAA,MACL;AAAA,KACF;AACA,IAAO,OAAA,OAAA;AAAA;AAEX;;;;"}