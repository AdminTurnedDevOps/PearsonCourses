{"version":3,"file":"PluginTaskSchedulerImpl.cjs.js","sources":["../../../../src/entrypoints/scheduler/lib/PluginTaskSchedulerImpl.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  LoggerService,\n  RootLifecycleService,\n  SchedulerService,\n  SchedulerServiceTaskDescriptor,\n  SchedulerServiceTaskFunction,\n  SchedulerServiceTaskInvocationDefinition,\n  SchedulerServiceTaskRunner,\n  SchedulerServiceTaskScheduleDefinition,\n} from '@backstage/backend-plugin-api';\nimport { Counter, Histogram, Gauge, metrics, trace } from '@opentelemetry/api';\nimport { Knex } from 'knex';\nimport { Duration } from 'luxon';\nimport { LocalTaskWorker } from './LocalTaskWorker';\nimport { TaskWorker } from './TaskWorker';\nimport { TaskSettingsV2 } from './types';\nimport { delegateAbortController, TRACER_ID, validateId } from './util';\n\nconst tracer = trace.getTracer(TRACER_ID);\n\n/**\n * Implements the actual task management.\n */\nexport class PluginTaskSchedulerImpl implements SchedulerService {\n  private readonly localTasksById = new Map<string, LocalTaskWorker>();\n  private readonly allScheduledTasks: SchedulerServiceTaskDescriptor[] = [];\n  private readonly shutdownInitiated: Promise<boolean>;\n\n  private readonly counter: Counter;\n  private readonly duration: Histogram;\n  private readonly lastStarted: Gauge;\n  private readonly lastCompleted: Gauge;\n\n  constructor(\n    private readonly databaseFactory: () => Promise<Knex>,\n    private readonly logger: LoggerService,\n    rootLifecycle?: RootLifecycleService,\n  ) {\n    const meter = metrics.getMeter('default');\n    this.counter = meter.createCounter('backend_tasks.task.runs.count', {\n      description: 'Total number of times a task has been run',\n    });\n    this.duration = meter.createHistogram('backend_tasks.task.runs.duration', {\n      description: 'Histogram of task run durations',\n      unit: 'seconds',\n    });\n    this.lastStarted = meter.createGauge('backend_tasks.task.runs.started', {\n      description: 'Epoch timestamp seconds when the task was last started',\n      unit: 'seconds',\n    });\n    this.lastCompleted = meter.createGauge(\n      'backend_tasks.task.runs.completed',\n      {\n        description: 'Epoch timestamp seconds when the task was last completed',\n        unit: 'seconds',\n      },\n    );\n    this.shutdownInitiated = new Promise(shutdownInitiated => {\n      rootLifecycle?.addShutdownHook(() => shutdownInitiated(true));\n    });\n  }\n\n  async triggerTask(id: string): Promise<void> {\n    const localTask = this.localTasksById.get(id);\n    if (localTask) {\n      localTask.trigger();\n      return;\n    }\n\n    const knex = await this.databaseFactory();\n    await TaskWorker.trigger(knex, id);\n  }\n\n  async scheduleTask(\n    task: SchedulerServiceTaskScheduleDefinition &\n      SchedulerServiceTaskInvocationDefinition,\n  ): Promise<void> {\n    validateId(task.id);\n    const scope = task.scope ?? 'global';\n\n    const settings: TaskSettingsV2 = {\n      version: 2,\n      cadence: parseDuration(task.frequency),\n      initialDelayDuration:\n        task.initialDelay && parseDuration(task.initialDelay),\n      timeoutAfterDuration: parseDuration(task.timeout),\n    };\n\n    // Delegated abort controller that will abort either when the provided\n    // controller aborts, or when a root lifecycle shutdown happens\n    const abortController = delegateAbortController(task.signal);\n    this.shutdownInitiated.then(() => abortController.abort());\n\n    if (scope === 'global') {\n      const knex = await this.databaseFactory();\n      const worker = new TaskWorker(\n        task.id,\n        this.instrumentedFunction(task, scope),\n        knex,\n        this.logger.child({ task: task.id }),\n      );\n      await worker.start(settings, { signal: abortController.signal });\n    } else {\n      const worker = new LocalTaskWorker(\n        task.id,\n        this.instrumentedFunction(task, scope),\n        this.logger.child({ task: task.id }),\n      );\n      worker.start(settings, { signal: abortController.signal });\n      this.localTasksById.set(task.id, worker);\n    }\n\n    this.allScheduledTasks.push({\n      id: task.id,\n      scope: scope,\n      settings: settings,\n    });\n  }\n\n  createScheduledTaskRunner(\n    schedule: SchedulerServiceTaskScheduleDefinition,\n  ): SchedulerServiceTaskRunner {\n    return {\n      run: async task => {\n        await this.scheduleTask({ ...task, ...schedule });\n      },\n    };\n  }\n\n  async getScheduledTasks(): Promise<SchedulerServiceTaskDescriptor[]> {\n    return this.allScheduledTasks;\n  }\n\n  private instrumentedFunction(\n    task: SchedulerServiceTaskInvocationDefinition,\n    scope: string,\n  ): SchedulerServiceTaskFunction {\n    return async abort => {\n      const labels: Record<string, string> = {\n        taskId: task.id,\n        scope,\n      };\n      this.counter.add(1, { ...labels, result: 'started' });\n      this.lastStarted.record(Date.now() / 1000, { taskId: task.id });\n\n      const startTime = process.hrtime();\n\n      try {\n        await tracer.startActiveSpan(`task ${task.id}`, async span => {\n          try {\n            span.setAttributes(labels);\n            await task.fn(abort);\n          } catch (error) {\n            if (error instanceof Error) {\n              span.recordException(error);\n            }\n            throw error;\n          } finally {\n            span.end();\n          }\n        });\n        labels.result = 'completed';\n      } catch (ex) {\n        labels.result = 'failed';\n        throw ex;\n      } finally {\n        const delta = process.hrtime(startTime);\n        const endTime = delta[0] + delta[1] / 1e9;\n        this.counter.add(1, labels);\n        this.duration.record(endTime, labels);\n        this.lastCompleted.record(Date.now() / 1000, labels);\n      }\n    };\n  }\n}\n\nexport function parseDuration(\n  frequency: SchedulerServiceTaskScheduleDefinition['frequency'],\n): string {\n  if (typeof frequency === 'object' && 'cron' in frequency) {\n    return frequency.cron;\n  }\n  if (typeof frequency === 'object' && 'trigger' in frequency) {\n    return frequency.trigger;\n  }\n\n  const parsed = Duration.isDuration(frequency)\n    ? frequency\n    : Duration.fromObject(frequency);\n\n  if (!parsed.isValid) {\n    throw new Error(\n      `Invalid duration, ${parsed.invalidReason}: ${parsed.invalidExplanation}`,\n    );\n  }\n\n  return parsed.toISO()!;\n}\n"],"names":["trace","TRACER_ID","metrics","TaskWorker","validateId","delegateAbortController","LocalTaskWorker","Duration"],"mappings":"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"}