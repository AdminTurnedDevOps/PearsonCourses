{"version":3,"file":"PluginTaskSchedulerJanitor.cjs.js","sources":["../../../../src/entrypoints/scheduler/lib/PluginTaskSchedulerJanitor.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { LoggerService } from '@backstage/backend-plugin-api';\nimport { Knex } from 'knex';\nimport { Duration } from 'luxon';\nimport { DB_TASKS_TABLE, DbTasksRow } from '../database/tables';\nimport { sleep } from './util';\n\n/**\n * Makes sure to auto-expire and clean up things that time out or for other\n * reasons should not be left lingering.\n */\nexport class PluginTaskSchedulerJanitor {\n  private readonly knex: Knex;\n  private readonly waitBetweenRuns: Duration;\n  private readonly logger: LoggerService;\n\n  constructor(options: {\n    knex: Knex;\n    waitBetweenRuns: Duration;\n    logger: LoggerService;\n  }) {\n    this.knex = options.knex;\n    this.waitBetweenRuns = options.waitBetweenRuns;\n    this.logger = options.logger;\n  }\n\n  async start(abortSignal?: AbortSignal) {\n    while (!abortSignal?.aborted) {\n      try {\n        await this.runOnce();\n      } catch (e) {\n        this.logger.warn(`Error while performing janitorial tasks, ${e}`);\n      }\n\n      await sleep(this.waitBetweenRuns, abortSignal);\n    }\n  }\n\n  private async runOnce() {\n    const dbNull = this.knex.raw('null');\n    const configClient = this.knex.client.config.client;\n\n    let tasks: Array<{ id: string }>;\n    if (configClient.includes('sqlite3') || configClient.includes('mysql')) {\n      tasks = await this.knex<DbTasksRow>(DB_TASKS_TABLE)\n        .select('id')\n        .where('current_run_expires_at', '<', this.knex.fn.now());\n      await this.knex<DbTasksRow>(DB_TASKS_TABLE)\n        .whereIn(\n          'id',\n          tasks.map(t => t.id),\n        )\n        .update({\n          current_run_ticket: dbNull,\n          current_run_started_at: dbNull,\n          current_run_expires_at: dbNull,\n        });\n    } else {\n      tasks = await this.knex<DbTasksRow>(DB_TASKS_TABLE)\n        .where('current_run_expires_at', '<', this.knex.fn.now())\n        .update({\n          current_run_ticket: dbNull,\n          current_run_started_at: dbNull,\n          current_run_expires_at: dbNull,\n        })\n        .returning(['id']);\n    }\n\n    // In rare cases, knex drivers may ignore \"returning\", and return the number\n    // of rows changed instead\n    if (typeof tasks === 'number') {\n      if (tasks > 0) {\n        this.logger.warn(`${tasks} tasks timed out and were lost`);\n      }\n    } else {\n      for (const { id } of tasks) {\n        this.logger.warn(`Task timed out and was lost: ${id}`);\n      }\n    }\n  }\n}\n"],"names":["sleep","DB_TASKS_TABLE"],"mappings":";;;;;AA0BO,MAAM,0BAA2B,CAAA;AAAA,EACrB,IAAA;AAAA,EACA,eAAA;AAAA,EACA,MAAA;AAAA,EAEjB,YAAY,OAIT,EAAA;AACD,IAAA,IAAA,CAAK,OAAO,OAAQ,CAAA,IAAA;AACpB,IAAA,IAAA,CAAK,kBAAkB,OAAQ,CAAA,eAAA;AAC/B,IAAA,IAAA,CAAK,SAAS,OAAQ,CAAA,MAAA;AAAA;AACxB,EAEA,MAAM,MAAM,WAA2B,EAAA;AACrC,IAAO,OAAA,CAAC,aAAa,OAAS,EAAA;AAC5B,MAAI,IAAA;AACF,QAAA,MAAM,KAAK,OAAQ,EAAA;AAAA,eACZ,CAAG,EAAA;AACV,QAAA,IAAA,CAAK,MAAO,CAAA,IAAA,CAAK,CAA4C,yCAAA,EAAA,CAAC,CAAE,CAAA,CAAA;AAAA;AAGlE,MAAM,MAAAA,UAAA,CAAM,IAAK,CAAA,eAAA,EAAiB,WAAW,CAAA;AAAA;AAC/C;AACF,EAEA,MAAc,OAAU,GAAA;AACtB,IAAA,MAAM,MAAS,GAAA,IAAA,CAAK,IAAK,CAAA,GAAA,CAAI,MAAM,CAAA;AACnC,IAAA,MAAM,YAAe,GAAA,IAAA,CAAK,IAAK,CAAA,MAAA,CAAO,MAAO,CAAA,MAAA;AAE7C,IAAI,IAAA,KAAA;AACJ,IAAA,IAAI,aAAa,QAAS,CAAA,SAAS,KAAK,YAAa,CAAA,QAAA,CAAS,OAAO,CAAG,EAAA;AACtE,MAAA,KAAA,GAAQ,MAAM,IAAA,CAAK,IAAiB,CAAAC,qBAAc,EAC/C,MAAO,CAAA,IAAI,CACX,CAAA,KAAA,CAAM,0BAA0B,GAAK,EAAA,IAAA,CAAK,IAAK,CAAA,EAAA,CAAG,KAAK,CAAA;AAC1D,MAAM,MAAA,IAAA,CAAK,IAAiB,CAAAA,qBAAc,CACvC,CAAA,OAAA;AAAA,QACC,IAAA;AAAA,QACA,KAAM,CAAA,GAAA,CAAI,CAAK,CAAA,KAAA,CAAA,CAAE,EAAE;AAAA,QAEpB,MAAO,CAAA;AAAA,QACN,kBAAoB,EAAA,MAAA;AAAA,QACpB,sBAAwB,EAAA,MAAA;AAAA,QACxB,sBAAwB,EAAA;AAAA,OACzB,CAAA;AAAA,KACE,MAAA;AACL,MAAA,KAAA,GAAQ,MAAM,IAAA,CAAK,IAAiB,CAAAA,qBAAc,EAC/C,KAAM,CAAA,wBAAA,EAA0B,GAAK,EAAA,IAAA,CAAK,IAAK,CAAA,EAAA,CAAG,GAAI,EAAC,EACvD,MAAO,CAAA;AAAA,QACN,kBAAoB,EAAA,MAAA;AAAA,QACpB,sBAAwB,EAAA,MAAA;AAAA,QACxB,sBAAwB,EAAA;AAAA,OACzB,CAAA,CACA,SAAU,CAAA,CAAC,IAAI,CAAC,CAAA;AAAA;AAKrB,IAAI,IAAA,OAAO,UAAU,QAAU,EAAA;AAC7B,MAAA,IAAI,QAAQ,CAAG,EAAA;AACb,QAAA,IAAA,CAAK,MAAO,CAAA,IAAA,CAAK,CAAG,EAAA,KAAK,CAAgC,8BAAA,CAAA,CAAA;AAAA;AAC3D,KACK,MAAA;AACL,MAAW,KAAA,MAAA,EAAE,EAAG,EAAA,IAAK,KAAO,EAAA;AAC1B,QAAA,IAAA,CAAK,MAAO,CAAA,IAAA,CAAK,CAAgC,6BAAA,EAAA,EAAE,CAAE,CAAA,CAAA;AAAA;AACvD;AACF;AAEJ;;;;"}