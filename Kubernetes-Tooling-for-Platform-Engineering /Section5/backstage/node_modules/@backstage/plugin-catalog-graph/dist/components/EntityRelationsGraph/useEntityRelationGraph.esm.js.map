{"version":3,"file":"useEntityRelationGraph.esm.js","sources":["../../../src/components/EntityRelationsGraph/useEntityRelationGraph.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Entity } from '@backstage/catalog-model';\nimport { useEffect, useMemo } from 'react';\nimport { useEntityStore } from './useEntityStore';\nimport { pickBy } from 'lodash';\n\n/**\n * Discover the graph of entities connected by relations, starting from a set of\n * root entities. Filters are used to select which relations to includes.\n * Returns all discovered entities once they are loaded.\n */\nexport function useEntityRelationGraph({\n  rootEntityRefs,\n  filter: {\n    maxDepth = Number.POSITIVE_INFINITY,\n    relations,\n    kinds,\n    entityFilter,\n  } = {},\n}: {\n  rootEntityRefs: string[];\n  filter?: {\n    maxDepth?: number;\n    relations?: string[];\n    kinds?: string[];\n    entityFilter?: (entity: Entity) => boolean;\n  };\n}): {\n  entities?: { [ref: string]: Entity };\n  loading: boolean;\n  error?: Error;\n} {\n  const { entities, loading, error, requestEntities } = useEntityStore();\n\n  useEffect(() => {\n    const expectedEntities = new Set([...rootEntityRefs]);\n    const processedEntityRefs = new Set<string>();\n\n    let nextDepthRefQueue = [...rootEntityRefs];\n    let depth = 0;\n\n    while (\n      nextDepthRefQueue.length > 0 &&\n      (!isFinite(maxDepth) || depth < maxDepth)\n    ) {\n      const entityRefQueue = nextDepthRefQueue;\n      nextDepthRefQueue = [];\n\n      while (entityRefQueue.length > 0) {\n        const entityRef = entityRefQueue.shift()!;\n        const entity = entities[entityRef];\n\n        processedEntityRefs.add(entityRef);\n\n        if (entity && entity.relations) {\n          // If the entity is filtered out then no need to check any\n          // of its outgoing relationships to other entities\n          if (entityFilter && !entityFilter(entity)) {\n            continue;\n          }\n          for (const rel of entity.relations) {\n            if (\n              (!relations || relations.includes(rel.type)) &&\n              (!kinds ||\n                kinds.some(kind =>\n                  rel.targetRef.startsWith(\n                    `${kind.toLocaleLowerCase('en-US')}:`,\n                  ),\n                ))\n            ) {\n              if (!processedEntityRefs.has(rel.targetRef)) {\n                nextDepthRefQueue.push(rel.targetRef);\n                expectedEntities.add(rel.targetRef);\n              }\n            }\n          }\n        }\n      }\n\n      ++depth;\n    }\n    requestEntities([...expectedEntities]);\n  }, [\n    entities,\n    rootEntityRefs,\n    maxDepth,\n    relations,\n    kinds,\n    entityFilter,\n    requestEntities,\n  ]);\n\n  const filteredEntities = useMemo(\n    () =>\n      entityFilter\n        ? pickBy(entities, (value, _key) => entityFilter(value))\n        : entities,\n    [entities, entityFilter],\n  );\n\n  return {\n    entities: filteredEntities,\n    loading,\n    error,\n  };\n}\n"],"names":[],"mappings":";;;;AAyBO,SAAS,sBAAuB,CAAA;AAAA,EACrC,cAAA;AAAA,EACA,MAAQ,EAAA;AAAA,IACN,WAAW,MAAO,CAAA,iBAAA;AAAA,IAClB,SAAA;AAAA,IACA,KAAA;AAAA,IACA;AAAA,MACE;AACN,CAYE,EAAA;AACA,EAAA,MAAM,EAAE,QAAU,EAAA,OAAA,EAAS,KAAO,EAAA,eAAA,KAAoB,cAAe,EAAA;AAErE,EAAA,SAAA,CAAU,MAAM;AACd,IAAA,MAAM,mCAAuB,IAAA,GAAA,CAAI,CAAC,GAAG,cAAc,CAAC,CAAA;AACpD,IAAM,MAAA,mBAAA,uBAA0B,GAAY,EAAA;AAE5C,IAAI,IAAA,iBAAA,GAAoB,CAAC,GAAG,cAAc,CAAA;AAC1C,IAAA,IAAI,KAAQ,GAAA,CAAA;AAEZ,IACE,OAAA,iBAAA,CAAkB,SAAS,CAC1B,KAAA,CAAC,SAAS,QAAQ,CAAA,IAAK,QAAQ,QAChC,CAAA,EAAA;AACA,MAAA,MAAM,cAAiB,GAAA,iBAAA;AACvB,MAAA,iBAAA,GAAoB,EAAC;AAErB,MAAO,OAAA,cAAA,CAAe,SAAS,CAAG,EAAA;AAChC,QAAM,MAAA,SAAA,GAAY,eAAe,KAAM,EAAA;AACvC,QAAM,MAAA,MAAA,GAAS,SAAS,SAAS,CAAA;AAEjC,QAAA,mBAAA,CAAoB,IAAI,SAAS,CAAA;AAEjC,QAAI,IAAA,MAAA,IAAU,OAAO,SAAW,EAAA;AAG9B,UAAA,IAAI,YAAgB,IAAA,CAAC,YAAa,CAAA,MAAM,CAAG,EAAA;AACzC,YAAA;AAAA;AAEF,UAAW,KAAA,MAAA,GAAA,IAAO,OAAO,SAAW,EAAA;AAClC,YACG,IAAA,CAAA,CAAC,aAAa,SAAU,CAAA,QAAA,CAAS,IAAI,IAAI,CAAA,MACzC,CAAC,KAAA,IACA,KAAM,CAAA,IAAA;AAAA,cAAK,CAAA,IAAA,KACT,IAAI,SAAU,CAAA,UAAA;AAAA,gBACZ,CAAG,EAAA,IAAA,CAAK,iBAAkB,CAAA,OAAO,CAAC,CAAA,CAAA;AAAA;AACpC,aAEJ,CAAA,EAAA;AACA,cAAA,IAAI,CAAC,mBAAA,CAAoB,GAAI,CAAA,GAAA,CAAI,SAAS,CAAG,EAAA;AAC3C,gBAAkB,iBAAA,CAAA,IAAA,CAAK,IAAI,SAAS,CAAA;AACpC,gBAAiB,gBAAA,CAAA,GAAA,CAAI,IAAI,SAAS,CAAA;AAAA;AACpC;AACF;AACF;AACF;AAGF,MAAE,EAAA,KAAA;AAAA;AAEJ,IAAgB,eAAA,CAAA,CAAC,GAAG,gBAAgB,CAAC,CAAA;AAAA,GACpC,EAAA;AAAA,IACD,QAAA;AAAA,IACA,cAAA;AAAA,IACA,QAAA;AAAA,IACA,SAAA;AAAA,IACA,KAAA;AAAA,IACA,YAAA;AAAA,IACA;AAAA,GACD,CAAA;AAED,EAAA,MAAM,gBAAmB,GAAA,OAAA;AAAA,IACvB,MACE,YACI,GAAA,MAAA,CAAO,QAAU,EAAA,CAAC,OAAO,IAAS,KAAA,YAAA,CAAa,KAAK,CAAC,CACrD,GAAA,QAAA;AAAA,IACN,CAAC,UAAU,YAAY;AAAA,GACzB;AAEA,EAAO,OAAA;AAAA,IACL,QAAU,EAAA,gBAAA;AAAA,IACV,OAAA;AAAA,IACA;AAAA,GACF;AACF;;;;"}