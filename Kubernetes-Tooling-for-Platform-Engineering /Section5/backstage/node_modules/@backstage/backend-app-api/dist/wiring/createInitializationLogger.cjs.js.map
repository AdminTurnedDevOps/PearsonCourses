{"version":3,"file":"createInitializationLogger.cjs.js","sources":["../../src/wiring/createInitializationLogger.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { RootLoggerService } from '@backstage/backend-plugin-api';\n\nconst LOGGER_INTERVAL_MAX = 60_000;\n\nfunction joinIds(ids: Iterable<string>): string {\n  return [...ids].map(id => `'${id}'`).join(', ');\n}\n\nexport function createInitializationLogger(\n  pluginIds: string[],\n  rootLogger?: RootLoggerService,\n): {\n  onPluginStarted(pluginId: string): void;\n  onPluginFailed(pluginId: string): void;\n  onAllStarted(): void;\n} {\n  const logger = rootLogger?.child({ type: 'initialization' });\n  const starting = new Set(pluginIds);\n  const started = new Set<string>();\n\n  logger?.info(`Plugin initialization started: ${joinIds(pluginIds)}`);\n\n  const getInitStatus = () => {\n    let status = '';\n    if (started.size > 0) {\n      status = `, newly initialized: ${joinIds(started)}`;\n      started.clear();\n    }\n    if (starting.size > 0) {\n      status += `, still initializing: ${joinIds(starting)}`;\n    }\n    return status;\n  };\n\n  // Periodically log the initialization status with a fibonacci backoff\n  let interval = 1000;\n  let prevInterval = 0;\n  let timeout: NodeJS.Timeout | undefined;\n  const onTimeout = () => {\n    logger?.info(`Plugin initialization in progress${getInitStatus()}`);\n\n    const nextInterval = Math.min(interval + prevInterval, LOGGER_INTERVAL_MAX);\n    prevInterval = interval;\n    interval = nextInterval;\n\n    timeout = setTimeout(onTimeout, nextInterval);\n  };\n  timeout = setTimeout(onTimeout, interval);\n\n  return {\n    onPluginStarted(pluginId: string) {\n      starting.delete(pluginId);\n      started.add(pluginId);\n    },\n    onPluginFailed(pluginId: string) {\n      starting.delete(pluginId);\n      const status =\n        starting.size > 0\n          ? `, waiting for ${starting.size} other plugins to finish before shutting down the process`\n          : '';\n      logger?.error(\n        `Plugin '${pluginId}' thew an error during startup${status}`,\n      );\n    },\n    onAllStarted() {\n      logger?.info(`Plugin initialization complete${getInitStatus()}`);\n\n      if (timeout) {\n        clearTimeout(timeout);\n        timeout = undefined;\n      }\n    },\n  };\n}\n"],"names":[],"mappings":";;AAkBA,MAAM,mBAAsB,GAAA,GAAA;AAE5B,SAAS,QAAQ,GAA+B,EAAA;AAC9C,EAAO,OAAA,CAAC,GAAG,GAAG,CAAE,CAAA,GAAA,CAAI,CAAM,EAAA,KAAA,CAAA,CAAA,EAAI,EAAE,CAAA,CAAA,CAAG,CAAE,CAAA,IAAA,CAAK,IAAI,CAAA;AAChD;AAEgB,SAAA,0BAAA,CACd,WACA,UAKA,EAAA;AACA,EAAA,MAAM,SAAS,UAAY,EAAA,KAAA,CAAM,EAAE,IAAA,EAAM,kBAAkB,CAAA;AAC3D,EAAM,MAAA,QAAA,GAAW,IAAI,GAAA,CAAI,SAAS,CAAA;AAClC,EAAM,MAAA,OAAA,uBAAc,GAAY,EAAA;AAEhC,EAAA,MAAA,EAAQ,IAAK,CAAA,CAAA,+BAAA,EAAkC,OAAQ,CAAA,SAAS,CAAC,CAAE,CAAA,CAAA;AAEnE,EAAA,MAAM,gBAAgB,MAAM;AAC1B,IAAA,IAAI,MAAS,GAAA,EAAA;AACb,IAAI,IAAA,OAAA,CAAQ,OAAO,CAAG,EAAA;AACpB,MAAS,MAAA,GAAA,CAAA,qBAAA,EAAwB,OAAQ,CAAA,OAAO,CAAC,CAAA,CAAA;AACjD,MAAA,OAAA,CAAQ,KAAM,EAAA;AAAA;AAEhB,IAAI,IAAA,QAAA,CAAS,OAAO,CAAG,EAAA;AACrB,MAAU,MAAA,IAAA,CAAA,sBAAA,EAAyB,OAAQ,CAAA,QAAQ,CAAC,CAAA,CAAA;AAAA;AAEtD,IAAO,OAAA,MAAA;AAAA,GACT;AAGA,EAAA,IAAI,QAAW,GAAA,GAAA;AACf,EAAA,IAAI,YAAe,GAAA,CAAA;AACnB,EAAI,IAAA,OAAA;AACJ,EAAA,MAAM,YAAY,MAAM;AACtB,IAAA,MAAA,EAAQ,IAAK,CAAA,CAAA,iCAAA,EAAoC,aAAc,EAAC,CAAE,CAAA,CAAA;AAElE,IAAA,MAAM,YAAe,GAAA,IAAA,CAAK,GAAI,CAAA,QAAA,GAAW,cAAc,mBAAmB,CAAA;AAC1E,IAAe,YAAA,GAAA,QAAA;AACf,IAAW,QAAA,GAAA,YAAA;AAEX,IAAU,OAAA,GAAA,UAAA,CAAW,WAAW,YAAY,CAAA;AAAA,GAC9C;AACA,EAAU,OAAA,GAAA,UAAA,CAAW,WAAW,QAAQ,CAAA;AAExC,EAAO,OAAA;AAAA,IACL,gBAAgB,QAAkB,EAAA;AAChC,MAAA,QAAA,CAAS,OAAO,QAAQ,CAAA;AACxB,MAAA,OAAA,CAAQ,IAAI,QAAQ,CAAA;AAAA,KACtB;AAAA,IACA,eAAe,QAAkB,EAAA;AAC/B,MAAA,QAAA,CAAS,OAAO,QAAQ,CAAA;AACxB,MAAA,MAAM,SACJ,QAAS,CAAA,IAAA,GAAO,IACZ,CAAiB,cAAA,EAAA,QAAA,CAAS,IAAI,CAC9B,yDAAA,CAAA,GAAA,EAAA;AACN,MAAQ,MAAA,EAAA,KAAA;AAAA,QACN,CAAA,QAAA,EAAW,QAAQ,CAAA,8BAAA,EAAiC,MAAM,CAAA;AAAA,OAC5D;AAAA,KACF;AAAA,IACA,YAAe,GAAA;AACb,MAAA,MAAA,EAAQ,IAAK,CAAA,CAAA,8BAAA,EAAiC,aAAc,EAAC,CAAE,CAAA,CAAA;AAE/D,MAAA,IAAI,OAAS,EAAA;AACX,QAAA,YAAA,CAAa,OAAO,CAAA;AACpB,QAAU,OAAA,GAAA,KAAA,CAAA;AAAA;AACZ;AACF,GACF;AACF;;;;"}