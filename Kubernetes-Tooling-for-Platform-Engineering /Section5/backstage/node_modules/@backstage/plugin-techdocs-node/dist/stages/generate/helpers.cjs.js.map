{"version":3,"file":"helpers.cjs.js","sources":["../../../src/stages/generate/helpers.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { isChildPath, LoggerService } from '@backstage/backend-plugin-api';\nimport { Entity } from '@backstage/catalog-model';\nimport { assertError, ForwardedError } from '@backstage/errors';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\nimport { SpawnOptionsWithoutStdio, spawn } from 'child_process';\nimport fs from 'fs-extra';\nimport gitUrlParse from 'git-url-parse';\nimport yaml, { DEFAULT_SCHEMA, Type } from 'js-yaml';\nimport path, { resolve as resolvePath } from 'path';\nimport { PassThrough, Writable } from 'stream';\nimport { ParsedLocationAnnotation } from '../../helpers';\nimport { DefaultMkdocsContent, SupportedGeneratorKey } from './types';\nimport { getFileTreeRecursively } from '../publish/helpers';\n\n// TODO: Implement proper support for more generators.\nexport function getGeneratorKey(entity: Entity): SupportedGeneratorKey {\n  if (!entity) {\n    throw new Error('No entity provided');\n  }\n\n  return 'techdocs';\n}\n\nexport type RunCommandOptions = {\n  /** command to run */\n  command: string;\n  /** arguments to pass the command */\n  args: string[];\n  /** options to pass to spawn */\n  options: SpawnOptionsWithoutStdio;\n  /** stream to capture stdout and stderr output */\n  logStream?: Writable;\n};\n\n/**\n * Run a command in a sub-process, normally a shell command.\n */\nexport const runCommand = async ({\n  command,\n  args,\n  options,\n  logStream = new PassThrough(),\n}: RunCommandOptions) => {\n  await new Promise<void>((resolve, reject) => {\n    const process = spawn(command, args, options);\n\n    process.stdout.on('data', stream => {\n      logStream.write(stream);\n    });\n\n    process.stderr.on('data', stream => {\n      logStream.write(stream);\n    });\n\n    process.on('error', error => {\n      return reject(error);\n    });\n\n    process.on('close', code => {\n      if (code !== 0) {\n        return reject(`Command ${command} failed, exit code: ${code}`);\n      }\n      return resolve();\n    });\n  });\n};\n\n/**\n * Return the source url for MkDocs based on the backstage.io/techdocs-ref annotation.\n * Depending on the type of target, it can either return a repo_url, an edit_uri, both, or none.\n *\n * @param parsedLocationAnnotation - Object with location url and type\n * @param scmIntegrations - the scmIntegration to do url transformations\n * @param docsFolder - the configured docs folder in the mkdocs.yml (defaults to 'docs')\n * @returns the settings for the mkdocs.yml\n */\nexport const getRepoUrlFromLocationAnnotation = (\n  parsedLocationAnnotation: ParsedLocationAnnotation,\n  scmIntegrations: ScmIntegrationRegistry,\n  docsFolder: string = 'docs',\n): { repo_url?: string; edit_uri?: string } => {\n  const { type: locationType, target } = parsedLocationAnnotation;\n\n  if (locationType === 'url') {\n    const integration = scmIntegrations.byUrl(target);\n\n    // We only support it for github, gitlab, bitbucketServer and harness for now as the edit_uri\n    // is not properly supported for others yet.\n    if (\n      integration &&\n      ['github', 'gitlab', 'bitbucketServer', 'harness'].includes(\n        integration.type,\n      )\n    ) {\n      // handle the case where a user manually writes url:https://github.com/backstage/backstage i.e. without /blob/...\n      const { filepathtype } = gitUrlParse(target);\n      if (filepathtype === '') {\n        return { repo_url: target };\n      }\n\n      const sourceFolder = integration.resolveUrl({\n        url: `./${docsFolder}`,\n        base: target.endsWith('/') ? target : `${target}/`,\n      });\n      return {\n        repo_url: target,\n        edit_uri: integration.resolveEditUrl(sourceFolder),\n      };\n    }\n  }\n\n  return {};\n};\n\nclass UnknownTag {\n  constructor(public readonly data: any, public readonly type?: string) {}\n}\n\nexport const MKDOCS_SCHEMA = DEFAULT_SCHEMA.extend([\n  new Type('', {\n    kind: 'scalar',\n    multi: true,\n    representName: o => (o as UnknownTag).type,\n    represent: o => (o as UnknownTag).data ?? '',\n    instanceOf: UnknownTag,\n    construct: (data: string, type?: string) => new UnknownTag(data, type),\n  }),\n  new Type('tag:', {\n    kind: 'mapping',\n    multi: true,\n    representName: o => (o as UnknownTag).type,\n    represent: o => (o as UnknownTag).data ?? '',\n    instanceOf: UnknownTag,\n    construct: (data: string, type?: string) => new UnknownTag(data, type),\n  }),\n  new Type('', {\n    kind: 'sequence',\n    multi: true,\n    representName: o => (o as UnknownTag).type,\n    represent: o => (o as UnknownTag).data ?? '',\n    instanceOf: UnknownTag,\n    construct: (data: string, type?: string) => new UnknownTag(data, type),\n  }),\n]);\n\n/**\n * Generates a mkdocs.yml configuration file\n *\n * @param inputDir - base dir to where the mkdocs.yml file will be created\n * @param siteOptions - options for the site: `name` property will be used in mkdocs.yml for the\n * required `site_name` property, default value is \"Documentation Site\"\n */\nexport const generateMkdocsYml = async (\n  inputDir: string,\n  siteOptions?: { name?: string },\n) => {\n  try {\n    // TODO(awanlin): Use a provided default mkdocs.yml\n    // from config or some specified location. If this is\n    // not provided then fall back to generating bare\n    // minimum mkdocs.yml file\n\n    const mkdocsYmlPath = path.join(inputDir, 'mkdocs.yml');\n    const defaultSiteName = siteOptions?.name ?? 'Documentation Site';\n    const defaultMkdocsContent: DefaultMkdocsContent = {\n      site_name: defaultSiteName,\n      docs_dir: 'docs',\n      plugins: ['techdocs-core'],\n    };\n\n    await fs.writeFile(\n      mkdocsYmlPath,\n      yaml.dump(defaultMkdocsContent, { schema: MKDOCS_SCHEMA }),\n    );\n  } catch (error) {\n    throw new ForwardedError('Could not generate mkdocs.yml file', error);\n  }\n};\n\n/**\n * Finds and loads the contents of an mkdocs.yml, mkdocs.yaml file, a file\n * with a specified name or an ad-hoc created file with minimal config.\n * @public\n *\n * @param inputDir - base dir to be searched for either an mkdocs.yml or mkdocs.yaml file.\n * @param options - name: default mkdocs site_name to be used with a ad hoc file default value is \"Documentation Site\"\n *                  mkdocsConfigFileName (optional): a non-default file name to be used as the config\n */\nexport const getMkdocsYml = async (\n  inputDir: string,\n  options?: { name?: string; mkdocsConfigFileName?: string },\n): Promise<{ path: string; content: string; configIsTemporary: boolean }> => {\n  let mkdocsYmlPath: string;\n  let mkdocsYmlFileString: string;\n  try {\n    if (options?.mkdocsConfigFileName) {\n      mkdocsYmlPath = path.join(inputDir, options.mkdocsConfigFileName);\n      if (!(await fs.pathExists(mkdocsYmlPath))) {\n        throw new Error(`The specified file ${mkdocsYmlPath} does not exist`);\n      }\n\n      mkdocsYmlFileString = await fs.readFile(mkdocsYmlPath, 'utf8');\n      return {\n        path: mkdocsYmlPath,\n        content: mkdocsYmlFileString,\n        configIsTemporary: false,\n      };\n    }\n\n    mkdocsYmlPath = path.join(inputDir, 'mkdocs.yaml');\n    if (await fs.pathExists(mkdocsYmlPath)) {\n      mkdocsYmlFileString = await fs.readFile(mkdocsYmlPath, 'utf8');\n      return {\n        path: mkdocsYmlPath,\n        content: mkdocsYmlFileString,\n        configIsTemporary: false,\n      };\n    }\n\n    mkdocsYmlPath = path.join(inputDir, 'mkdocs.yml');\n    if (await fs.pathExists(mkdocsYmlPath)) {\n      mkdocsYmlFileString = await fs.readFile(mkdocsYmlPath, 'utf8');\n      return {\n        path: mkdocsYmlPath,\n        content: mkdocsYmlFileString,\n        configIsTemporary: false,\n      };\n    }\n\n    // No mkdocs file, generate it\n    await generateMkdocsYml(inputDir, options);\n    mkdocsYmlFileString = await fs.readFile(mkdocsYmlPath, 'utf8');\n  } catch (error) {\n    throw new ForwardedError(\n      'Could not read MkDocs YAML config file mkdocs.yml or mkdocs.yaml or default for validation',\n      error,\n    );\n  }\n\n  return {\n    path: mkdocsYmlPath,\n    content: mkdocsYmlFileString,\n    configIsTemporary: true,\n  };\n};\n\n/**\n * Validating mkdocs config file for incorrect/insecure values\n * Throws on invalid configs\n *\n * @param inputDir - base dir to be used as a docs_dir path validity check\n * @param mkdocsYmlFileString - The string contents of the loaded\n *   mkdocs.yml or equivalent of a docs site\n * @returns the parsed docs_dir or undefined\n */\nexport const validateMkdocsYaml = async (\n  inputDir: string,\n  mkdocsYmlFileString: string,\n): Promise<string | undefined> => {\n  const mkdocsYml = yaml.load(mkdocsYmlFileString, {\n    schema: MKDOCS_SCHEMA,\n  });\n\n  if (mkdocsYml === null || typeof mkdocsYml !== 'object') {\n    return undefined;\n  }\n\n  const parsedMkdocsYml: Record<string, any> = mkdocsYml;\n  if (\n    parsedMkdocsYml.docs_dir &&\n    !isChildPath(inputDir, resolvePath(inputDir, parsedMkdocsYml.docs_dir))\n  ) {\n    throw new Error(\n      `docs_dir configuration value in mkdocs can't be an absolute directory or start with ../ for security reasons.\n       Use relative paths instead which are resolved relative to your mkdocs.yml file location.`,\n    );\n  }\n  return parsedMkdocsYml.docs_dir;\n};\n\n/**\n * Update docs/index.md file before TechDocs generator uses it to generate docs site,\n * falling back to docs/README.md or README.md in case a default docs/index.md\n * is not provided.\n */\nexport const patchIndexPreBuild = async ({\n  inputDir,\n  logger,\n  docsDir = 'docs',\n}: {\n  inputDir: string;\n  logger: LoggerService;\n  docsDir?: string;\n}) => {\n  const docsPath = path.join(inputDir, docsDir);\n  const indexMdPath = path.join(docsPath, 'index.md');\n\n  if (await fs.pathExists(indexMdPath)) {\n    return;\n  }\n  logger.warn(`${path.join(docsDir, 'index.md')} not found.`);\n  const fallbacks = [\n    path.join(docsPath, 'README.md'),\n    path.join(docsPath, 'readme.md'),\n    path.join(inputDir, 'README.md'),\n    path.join(inputDir, 'readme.md'),\n  ];\n\n  await fs.ensureDir(docsPath);\n  for (const filePath of fallbacks) {\n    try {\n      await fs.copyFile(filePath, indexMdPath);\n      return;\n    } catch (error) {\n      logger.warn(`${path.relative(inputDir, filePath)} not found.`);\n    }\n  }\n\n  logger.warn(\n    `Could not find any techdocs' index file. Please make sure at least one of ${[\n      indexMdPath,\n      ...fallbacks,\n    ].join(' ')} exists.`,\n  );\n};\n\n/**\n * Create or update the techdocs_metadata.json. Values initialized/updated are:\n * - The build_timestamp (now)\n * - The list of files generated\n *\n * @param techdocsMetadataPath - File path to techdocs_metadata.json\n */\nexport const createOrUpdateMetadata = async (\n  techdocsMetadataPath: string,\n  logger: LoggerService,\n): Promise<void> => {\n  const techdocsMetadataDir = techdocsMetadataPath\n    .split(path.sep)\n    .slice(0, -1)\n    .join(path.sep);\n  // check if file exists, create if it does not.\n  try {\n    await fs.access(techdocsMetadataPath, fs.constants.F_OK);\n  } catch (err) {\n    // Bootstrap file with empty JSON\n    await fs.writeJson(techdocsMetadataPath, JSON.parse('{}'));\n  }\n  // check if valid Json\n  let json;\n  try {\n    json = await fs.readJson(techdocsMetadataPath);\n  } catch (err) {\n    assertError(err);\n    const message = `Invalid JSON at ${techdocsMetadataPath} with error ${err.message}`;\n    logger.error(message);\n    throw new Error(message);\n  }\n\n  json.build_timestamp = Date.now();\n\n  // Get and write generated files to the metadata JSON. Each file string is in\n  // a form appropriate for invalidating the associated object from cache.\n  try {\n    json.files = (await getFileTreeRecursively(techdocsMetadataDir)).map(file =>\n      file.replace(`${techdocsMetadataDir}${path.sep}`, ''),\n    );\n  } catch (err) {\n    assertError(err);\n    json.files = [];\n    logger.warn(`Unable to add files list to metadata: ${err.message}`);\n  }\n\n  await fs.writeJson(techdocsMetadataPath, json);\n  return;\n};\n\n/**\n * Update the techdocs_metadata.json to add etag of the prepared tree (e.g. commit SHA or actual Etag of the resource).\n * This is helpful to check if a TechDocs site in storage has gone outdated, without maintaining an in-memory build info\n * per Backstage instance.\n *\n * @param techdocsMetadataPath - File path to techdocs_metadata.json\n * @param etag - The ETag to use\n */\nexport const storeEtagMetadata = async (\n  techdocsMetadataPath: string,\n  etag: string,\n): Promise<void> => {\n  const json = await fs.readJson(techdocsMetadataPath);\n  json.etag = etag;\n  await fs.writeJson(techdocsMetadataPath, json);\n};\n"],"names":["PassThrough","spawn","gitUrlParse","DEFAULT_SCHEMA","Type","path","fs","yaml","ForwardedError","isChildPath","resolvePath","assertError","getFileTreeRecursively"],"mappings":"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"}