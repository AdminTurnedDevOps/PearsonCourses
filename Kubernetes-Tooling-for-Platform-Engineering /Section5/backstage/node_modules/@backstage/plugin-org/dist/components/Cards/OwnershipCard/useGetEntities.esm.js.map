{"version":3,"file":"useGetEntities.esm.js","sources":["../../../../src/components/Cards/OwnershipCard/useGetEntities.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  Entity,\n  parseEntityRef,\n  RELATION_MEMBER_OF,\n  RELATION_PARENT_OF,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport {\n  CatalogApi,\n  catalogApiRef,\n  getEntityRelations,\n  humanizeEntityRef,\n} from '@backstage/plugin-catalog-react';\nimport limiterFactory from 'p-limit';\nimport { useApi } from '@backstage/core-plugin-api';\nimport useAsync from 'react-use/esm/useAsync';\nimport qs from 'qs';\nimport { EntityRelationAggregation } from '../types';\nimport { uniq, uniqBy } from 'lodash';\n\nconst limiter = limiterFactory(5);\n\ntype EntityTypeProps = {\n  kind: string;\n  type?: string;\n  count: number;\n};\n\nconst getQueryParams = (\n  ownersEntityRef: string[],\n  selectedEntity: EntityTypeProps,\n): string => {\n  const { kind, type } = selectedEntity;\n  const owners = ownersEntityRef.map(owner =>\n    humanizeEntityRef(parseEntityRef(owner), { defaultKind: 'group' }),\n  );\n  const filters = {\n    kind: kind.toLocaleLowerCase('en-US'),\n    type,\n    owners,\n    user: 'all',\n  };\n  return qs.stringify({ filters }, { arrayFormat: 'repeat' });\n};\n\nconst getMemberOfEntityRefs = (owner: Entity): string[] => {\n  const parentGroups = getEntityRelations(owner, RELATION_MEMBER_OF, {\n    kind: 'Group',\n  });\n\n  const ownerGroupsNames = parentGroups.map(({ kind, namespace, name }) =>\n    stringifyEntityRef({\n      kind,\n      namespace,\n      name,\n    }),\n  );\n\n  return [...ownerGroupsNames, stringifyEntityRef(owner)];\n};\n\nconst isEntity = (entity: Entity | undefined): entity is Entity =>\n  entity !== undefined;\n\nconst getChildOwnershipEntityRefs = async (\n  entity: Entity,\n  catalogApi: CatalogApi,\n  alreadyRetrievedParentRefs: string[] = [],\n): Promise<string[]> => {\n  const childGroups = getEntityRelations(entity, RELATION_PARENT_OF, {\n    kind: 'Group',\n  });\n\n  const hasChildGroups = childGroups.length > 0;\n\n  const entityRef = stringifyEntityRef(entity);\n  if (hasChildGroups) {\n    const entityRefs = childGroups.map(r => stringifyEntityRef(r));\n    const childGroupResponse = await limiter(() =>\n      catalogApi.getEntitiesByRefs({\n        fields: ['kind', 'metadata.namespace', 'metadata.name', 'relations'],\n        entityRefs,\n      }),\n    );\n    const childGroupEntities = childGroupResponse.items.filter(isEntity);\n\n    const unknownChildren = childGroupEntities.filter(\n      childGroupEntity =>\n        !alreadyRetrievedParentRefs.includes(\n          stringifyEntityRef(childGroupEntity),\n        ),\n    );\n    const childrenRefs = (\n      await Promise.all(\n        unknownChildren.map(childGroupEntity =>\n          getChildOwnershipEntityRefs(childGroupEntity, catalogApi, [\n            ...alreadyRetrievedParentRefs,\n            entityRef,\n          ]),\n        ),\n      )\n    ).flatMap(aggregated => aggregated);\n\n    return uniq([...childrenRefs, entityRef]);\n  }\n\n  return [entityRef];\n};\n\nconst getOwners = async (\n  entity: Entity,\n  relationAggregation: EntityRelationAggregation,\n  catalogApi: CatalogApi,\n): Promise<string[]> => {\n  const isGroup = entity.kind === 'Group';\n  const isAggregated = relationAggregation === 'aggregated';\n  const isUserEntity = entity.kind === 'User';\n\n  if (isAggregated && isGroup) {\n    return getChildOwnershipEntityRefs(entity, catalogApi);\n  }\n\n  if (isAggregated && isUserEntity) {\n    return getMemberOfEntityRefs(entity);\n  }\n\n  return [stringifyEntityRef(entity)];\n};\n\nconst delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));\n\nconst batchGetOwnedEntitiesByOwners = async (\n  owners: string[],\n  kinds: string[],\n  catalogApi: CatalogApi,\n  batchSize: number = 100,\n  delayMs: number = 100,\n) => {\n  const results = [];\n\n  for (let i = 0; i < owners.length; i += batchSize) {\n    const batch = owners.slice(i, i + batchSize);\n    const response = await catalogApi.getEntities({\n      filter: [\n        {\n          kind: kinds,\n          'relations.ownedBy': batch,\n        },\n      ],\n      fields: [\n        'kind',\n        'metadata.name',\n        'metadata.namespace',\n        'spec.type',\n        'relations',\n      ],\n    });\n\n    results.push(...response.items);\n\n    if (i + batchSize < owners.length) await delay(delayMs);\n  }\n\n  return uniqBy(results, stringifyEntityRef);\n};\n\nexport function useGetEntities(\n  entity: Entity,\n  relationAggregation: EntityRelationAggregation,\n  entityFilterKind?: string[],\n  entityLimit = 6,\n): {\n  componentsWithCounters:\n    | {\n        counter: number;\n        type: string;\n        kind: string;\n        queryParams: string;\n      }[]\n    | undefined;\n  loading: boolean;\n  error?: Error;\n} {\n  const catalogApi = useApi(catalogApiRef);\n  const kinds = entityFilterKind ?? ['Component', 'API', 'System'];\n\n  const {\n    loading,\n    error,\n    value: componentsWithCounters,\n  } = useAsync(async () => {\n    const owners = await getOwners(entity, relationAggregation, catalogApi);\n\n    const ownedEntitiesList = await batchGetOwnedEntitiesByOwners(\n      owners,\n      kinds,\n      catalogApi,\n    );\n\n    const counts = ownedEntitiesList.reduce(\n      (acc: EntityTypeProps[], ownedEntity) => {\n        const match = acc.find(\n          x => x.kind === ownedEntity.kind && x.type === ownedEntity.spec?.type,\n        );\n        if (match) {\n          match.count += 1;\n        } else {\n          acc.push({\n            kind: ownedEntity.kind,\n            type: ownedEntity.spec?.type?.toString(),\n            count: 1,\n          });\n        }\n        return acc;\n      },\n      [],\n    );\n\n    // Return top N (entityLimit) entities to be displayed in ownership boxes\n    const topN = counts.sort((a, b) => b.count - a.count).slice(0, entityLimit);\n\n    return topN.map(topOwnedEntity => ({\n      counter: topOwnedEntity.count,\n      type: topOwnedEntity.type,\n      kind: topOwnedEntity.kind,\n      queryParams: getQueryParams(owners, topOwnedEntity),\n    })) as Array<{\n      counter: number;\n      type: string;\n      kind: string;\n      queryParams: string;\n    }>;\n  }, [catalogApi, entity, relationAggregation]);\n\n  return {\n    componentsWithCounters,\n    loading,\n    error,\n  };\n}\n"],"names":[],"mappings":"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"}