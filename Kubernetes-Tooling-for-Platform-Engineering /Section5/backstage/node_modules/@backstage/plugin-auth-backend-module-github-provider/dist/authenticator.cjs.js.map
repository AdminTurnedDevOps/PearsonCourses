{"version":3,"file":"authenticator.cjs.js","sources":["../src/authenticator.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Strategy as GithubStrategy } from 'passport-github2';\nimport {\n  createOAuthAuthenticator,\n  PassportOAuthAuthenticatorHelper,\n  PassportOAuthDoneCallback,\n  PassportProfile,\n} from '@backstage/plugin-auth-node';\n\nconst ACCESS_TOKEN_PREFIX = 'access-token.';\n\n/** @public */\nexport const githubAuthenticator = createOAuthAuthenticator({\n  defaultProfileTransform:\n    PassportOAuthAuthenticatorHelper.defaultProfileTransform,\n  scopes: {\n    persist: true,\n    required: ['read:user'],\n  },\n  initialize({ callbackUrl, config }) {\n    const clientId = config.getString('clientId');\n    const clientSecret = config.getString('clientSecret');\n    const enterpriseInstanceUrl = config\n      .getOptionalString('enterpriseInstanceUrl')\n      ?.replace(/\\/$/, '');\n    const authorizationUrl = enterpriseInstanceUrl\n      ? `${enterpriseInstanceUrl}/login/oauth/authorize`\n      : undefined;\n    const tokenUrl = enterpriseInstanceUrl\n      ? `${enterpriseInstanceUrl}/login/oauth/access_token`\n      : undefined;\n    const userProfileUrl = enterpriseInstanceUrl\n      ? `${enterpriseInstanceUrl}/api/v3/user`\n      : undefined;\n\n    return PassportOAuthAuthenticatorHelper.from(\n      new GithubStrategy(\n        {\n          clientID: clientId,\n          clientSecret: clientSecret,\n          callbackURL: callbackUrl,\n          tokenURL: tokenUrl,\n          userProfileURL: userProfileUrl,\n          authorizationURL: authorizationUrl,\n        },\n        (\n          accessToken: string,\n          refreshToken: string,\n          params: any,\n          fullProfile: PassportProfile,\n          done: PassportOAuthDoneCallback,\n        ) => {\n          done(\n            undefined,\n            { fullProfile, params, accessToken },\n            { refreshToken },\n          );\n        },\n      ),\n    );\n  },\n\n  async start(input, helper) {\n    return helper.start(input, {\n      accessType: 'offline',\n      prompt: 'consent',\n    });\n  },\n\n  async authenticate(input, helper) {\n    const { fullProfile, session } = await helper.authenticate(input);\n\n    // If we do not have a real refresh token and we have a non-expiring\n    // access token, then we use that as our refresh token.\n    if (!session.refreshToken && !session.expiresInSeconds) {\n      session.refreshToken = ACCESS_TOKEN_PREFIX + session.accessToken;\n    }\n    return { fullProfile, session };\n  },\n\n  async refresh(input, helper) {\n    // This is the OAuth App flow. A non-expiring access token is stored in the\n    // refresh token cookie. We use that token to fetch the user profile and\n    // refresh the Backstage session when needed.\n    if (input.refreshToken?.startsWith(ACCESS_TOKEN_PREFIX)) {\n      const accessToken = input.refreshToken.slice(ACCESS_TOKEN_PREFIX.length);\n\n      const fullProfile = await helper\n        .fetchProfile(accessToken)\n        .catch(error => {\n          if (error.oauthError?.statusCode === 401) {\n            throw new Error('Invalid access token');\n          }\n          throw error;\n        });\n\n      return {\n        fullProfile,\n        session: {\n          accessToken,\n          tokenType: 'bearer',\n          scope: input.scope,\n          refreshToken: input.refreshToken,\n          // No expiration\n        },\n      };\n    }\n\n    // This is the App flow, which is close to a standard OAuth refresh flow. It has a\n    // pretty long session expiration, and it also ignores the requested scope, instead\n    // just allowing access to whatever is configured as part of the app installation.\n    return helper.refresh(input);\n  },\n});\n"],"names":["createOAuthAuthenticator","PassportOAuthAuthenticatorHelper","GithubStrategy"],"mappings":"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"}