{"version":3,"file":"loginPopup.esm.js","sources":["../../src/lib/loginPopup.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Options used to open a login popup.\n */\nexport type LoginPopupOptions = {\n  /**\n   * The URL that the auth popup should point to\n   */\n  url: string;\n\n  /**\n   * The name of the popup, as in second argument to window.open\n   */\n  name: string;\n\n  /**\n   * The origin of the final popup page that will post a message to this window.\n   */\n  origin: string;\n\n  /**\n   * The width of the popup in pixels, defaults to 500\n   */\n  width?: number;\n\n  /**\n   * The height of the popup in pixels, defaults to 700\n   */\n  height?: number;\n};\n\ntype AuthResult =\n  | {\n      type: 'authorization_response';\n      response: unknown;\n    }\n  | {\n      type: 'authorization_response';\n      error: {\n        name: string;\n        message: string;\n      };\n    };\n\n/**\n * Show a popup pointing to a URL that starts an auth flow. Implementing the receiving\n * end of the postMessage mechanism outlined in https://tools.ietf.org/html/draft-sakimura-oauth-wmrm-00\n *\n * The redirect handler of the flow should use postMessage to communicate back\n * to the app window. The message posted to the app must match the AuthResult type.\n *\n * The returned promise resolves to the response of the message that was posted from the auth popup.\n */\nexport function showLoginPopup(options: LoginPopupOptions): Promise<any> {\n  return new Promise((resolve, reject) => {\n    const width = options.width || 500;\n    const height = options.height || 700;\n    const left = window.screen.width / 2 - width / 2;\n    const top = window.screen.height / 2 - height / 2;\n\n    const popup = window.open(\n      options.url,\n      options.name,\n      `menubar=no,location=no,resizable=no,scrollbars=no,status=no,width=${width},height=${height},top=${top},left=${left}`,\n    );\n\n    let targetOrigin = '';\n\n    if (!popup || typeof popup.closed === 'undefined' || popup.closed) {\n      const error = new Error('Failed to open auth popup.');\n      error.name = 'PopupRejectedError';\n      reject(error);\n      return;\n    }\n\n    const messageListener = (event: MessageEvent) => {\n      if (event.source !== popup) {\n        return;\n      }\n      if (event.origin !== options.origin) {\n        return;\n      }\n      const { data } = event;\n\n      if (data.type === 'config_info') {\n        targetOrigin = data.targetOrigin;\n        return;\n      }\n\n      if (data.type !== 'authorization_response') {\n        return;\n      }\n      const authResult = data as AuthResult;\n\n      if ('error' in authResult) {\n        const error = new Error(authResult.error.message);\n        error.name = authResult.error.name;\n        // TODO: proper error type\n        // error.extra = authResult.error.extra;\n        reject(error);\n      } else {\n        resolve(authResult.response);\n      }\n      done();\n    };\n\n    const intervalId = setInterval(() => {\n      if (popup.closed) {\n        const errMessage = `Login failed, ${\n          targetOrigin && targetOrigin !== window.location.origin\n            ? `Incorrect app origin, expected ${targetOrigin}`\n            : 'popup was closed'\n        }`;\n        const error = new Error(errMessage);\n        error.name = 'PopupClosedError';\n        reject(error);\n        done();\n      }\n    }, 100);\n\n    function done() {\n      window.removeEventListener('message', messageListener);\n      clearInterval(intervalId);\n    }\n\n    window.addEventListener('message', messageListener);\n  });\n}\n"],"names":[],"mappings":"AAoEO,SAAS,eAAe,OAA0C,EAAA;AACvE,EAAA,OAAO,IAAI,OAAA,CAAQ,CAAC,OAAA,EAAS,MAAW,KAAA;AACtC,IAAM,MAAA,KAAA,GAAQ,QAAQ,KAAS,IAAA,GAAA;AAC/B,IAAM,MAAA,MAAA,GAAS,QAAQ,MAAU,IAAA,GAAA;AACjC,IAAA,MAAM,IAAO,GAAA,MAAA,CAAO,MAAO,CAAA,KAAA,GAAQ,IAAI,KAAQ,GAAA,CAAA;AAC/C,IAAA,MAAM,GAAM,GAAA,MAAA,CAAO,MAAO,CAAA,MAAA,GAAS,IAAI,MAAS,GAAA,CAAA;AAEhD,IAAA,MAAM,QAAQ,MAAO,CAAA,IAAA;AAAA,MACnB,OAAQ,CAAA,GAAA;AAAA,MACR,OAAQ,CAAA,IAAA;AAAA,MACR,qEAAqE,KAAK,CAAA,QAAA,EAAW,MAAM,CAAQ,KAAA,EAAA,GAAG,SAAS,IAAI,CAAA;AAAA,KACrH;AAEA,IAAA,IAAI,YAAe,GAAA,EAAA;AAEnB,IAAA,IAAI,CAAC,KAAS,IAAA,OAAO,MAAM,MAAW,KAAA,WAAA,IAAe,MAAM,MAAQ,EAAA;AACjE,MAAM,MAAA,KAAA,GAAQ,IAAI,KAAA,CAAM,4BAA4B,CAAA;AACpD,MAAA,KAAA,CAAM,IAAO,GAAA,oBAAA;AACb,MAAA,MAAA,CAAO,KAAK,CAAA;AACZ,MAAA;AAAA;AAGF,IAAM,MAAA,eAAA,GAAkB,CAAC,KAAwB,KAAA;AAC/C,MAAI,IAAA,KAAA,CAAM,WAAW,KAAO,EAAA;AAC1B,QAAA;AAAA;AAEF,MAAI,IAAA,KAAA,CAAM,MAAW,KAAA,OAAA,CAAQ,MAAQ,EAAA;AACnC,QAAA;AAAA;AAEF,MAAM,MAAA,EAAE,MAAS,GAAA,KAAA;AAEjB,MAAI,IAAA,IAAA,CAAK,SAAS,aAAe,EAAA;AAC/B,QAAA,YAAA,GAAe,IAAK,CAAA,YAAA;AACpB,QAAA;AAAA;AAGF,MAAI,IAAA,IAAA,CAAK,SAAS,wBAA0B,EAAA;AAC1C,QAAA;AAAA;AAEF,MAAA,MAAM,UAAa,GAAA,IAAA;AAEnB,MAAA,IAAI,WAAW,UAAY,EAAA;AACzB,QAAA,MAAM,KAAQ,GAAA,IAAI,KAAM,CAAA,UAAA,CAAW,MAAM,OAAO,CAAA;AAChD,QAAM,KAAA,CAAA,IAAA,GAAO,WAAW,KAAM,CAAA,IAAA;AAG9B,QAAA,MAAA,CAAO,KAAK,CAAA;AAAA,OACP,MAAA;AACL,QAAA,OAAA,CAAQ,WAAW,QAAQ,CAAA;AAAA;AAE7B,MAAK,IAAA,EAAA;AAAA,KACP;AAEA,IAAM,MAAA,UAAA,GAAa,YAAY,MAAM;AACnC,MAAA,IAAI,MAAM,MAAQ,EAAA;AAChB,QAAM,MAAA,UAAA,GAAa,CACjB,cAAA,EAAA,YAAA,IAAgB,YAAiB,KAAA,MAAA,CAAO,SAAS,MAC7C,GAAA,CAAA,+BAAA,EAAkC,YAAY,CAAA,CAAA,GAC9C,kBACN,CAAA,CAAA;AACA,QAAM,MAAA,KAAA,GAAQ,IAAI,KAAA,CAAM,UAAU,CAAA;AAClC,QAAA,KAAA,CAAM,IAAO,GAAA,kBAAA;AACb,QAAA,MAAA,CAAO,KAAK,CAAA;AACZ,QAAK,IAAA,EAAA;AAAA;AACP,OACC,GAAG,CAAA;AAEN,IAAA,SAAS,IAAO,GAAA;AACd,MAAO,MAAA,CAAA,mBAAA,CAAoB,WAAW,eAAe,CAAA;AACrD,MAAA,aAAA,CAAc,UAAU,CAAA;AAAA;AAG1B,IAAO,MAAA,CAAA,gBAAA,CAAiB,WAAW,eAAe,CAAA;AAAA,GACnD,CAAA;AACH;;;;"}