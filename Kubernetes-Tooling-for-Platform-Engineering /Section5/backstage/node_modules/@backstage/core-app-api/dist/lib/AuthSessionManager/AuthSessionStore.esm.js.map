{"version":3,"file":"AuthSessionStore.esm.js","sources":["../../../src/lib/AuthSessionManager/AuthSessionStore.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ZodSchema } from 'zod';\nimport {\n  MutableSessionManager,\n  SessionScopesFunc,\n  SessionShouldRefreshFunc,\n  GetSessionOptions,\n} from './types';\nimport { SessionScopeHelper } from './common';\n\ntype Options<T> = {\n  /** The connector used for acting on the auth session */\n  manager: MutableSessionManager<T>;\n  /** Storage key to use to store sessions */\n  storageKey: string;\n  /** The schema used to validate the stored data */\n  schema: ZodSchema<T>;\n  /** Used to get the scope of the session */\n  sessionScopes?: SessionScopesFunc<T>;\n  /** Used to check if the session needs to be refreshed, defaults to never refresh */\n  sessionShouldRefresh?: SessionShouldRefreshFunc<T>;\n};\n\n/**\n * AuthSessionStore decorates another SessionManager with a functionality\n * to store the session in local storage.\n *\n * Session is serialized to JSON with special support for following types: Set.\n */\nexport class AuthSessionStore<T> implements MutableSessionManager<T> {\n  private readonly manager: MutableSessionManager<T>;\n  private readonly storageKey: string;\n  private readonly schema: ZodSchema<T>;\n  private readonly sessionShouldRefreshFunc: SessionShouldRefreshFunc<T>;\n  private readonly helper: SessionScopeHelper<T>;\n\n  constructor(options: Options<T>) {\n    const {\n      manager,\n      storageKey,\n      schema,\n      sessionScopes,\n      sessionShouldRefresh = () => false,\n    } = options;\n\n    this.manager = manager;\n    this.storageKey = storageKey;\n    this.schema = schema;\n    this.sessionShouldRefreshFunc = sessionShouldRefresh;\n    this.helper = new SessionScopeHelper({\n      sessionScopes,\n      defaultScopes: new Set(),\n    });\n  }\n\n  setSession(session: T | undefined): void {\n    this.manager.setSession(session);\n    this.saveSession(session);\n  }\n\n  async getSession(options: GetSessionOptions): Promise<T | undefined> {\n    const { scopes } = options;\n    const session = this.loadSession();\n\n    if (this.helper.sessionExistsAndHasScope(session, scopes)) {\n      const shouldRefresh = this.sessionShouldRefreshFunc(session!);\n\n      if (!shouldRefresh) {\n        this.manager.setSession(session!);\n        return session!;\n      }\n    }\n\n    const newSession = await this.manager.getSession(options);\n    this.saveSession(newSession);\n    return newSession;\n  }\n\n  async removeSession() {\n    localStorage.removeItem(this.storageKey);\n    await this.manager.removeSession();\n  }\n\n  sessionState$() {\n    return this.manager.sessionState$();\n  }\n\n  private loadSession(): T | undefined {\n    try {\n      const sessionJson = localStorage.getItem(this.storageKey);\n      if (sessionJson) {\n        const session = JSON.parse(sessionJson, (_key, value) => {\n          if (value?.__type === 'Set') {\n            return new Set(value.__value);\n          }\n          return value;\n        });\n\n        try {\n          return this.schema.parse(session);\n        } catch (e) {\n          // eslint-disable-next-line no-console\n          console.log(\n            `Failed to load session from local storage because it did not conform to the expected schema, ${e}`,\n          );\n          throw e;\n        }\n      }\n\n      return undefined;\n    } catch (error) {\n      localStorage.removeItem(this.storageKey);\n      return undefined;\n    }\n  }\n\n  private saveSession(session: T | undefined) {\n    if (session === undefined) {\n      localStorage.removeItem(this.storageKey);\n      return;\n    }\n\n    try {\n      this.schema.parse(session);\n    } catch (e) {\n      // eslint-disable-next-line no-console\n      console.warn(\n        `Failed to save session to local storage because it did not conform to the expected schema, ${e}`,\n      );\n      return;\n    }\n\n    localStorage.setItem(\n      this.storageKey,\n      JSON.stringify(session, (_key, value) => {\n        if (value instanceof Set) {\n          return {\n            __type: 'Set',\n            __value: Array.from(value),\n          };\n        }\n        return value;\n      }),\n    );\n  }\n}\n"],"names":[],"mappings":"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"}