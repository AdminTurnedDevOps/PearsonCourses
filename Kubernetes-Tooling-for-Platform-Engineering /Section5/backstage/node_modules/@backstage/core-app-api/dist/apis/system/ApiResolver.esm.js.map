{"version":3,"file":"ApiResolver.esm.js","sources":["../../../src/apis/system/ApiResolver.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ApiRef,\n  ApiHolder,\n  AnyApiRef,\n  TypesToApiRefs,\n} from '@backstage/core-plugin-api';\nimport { ApiFactoryHolder } from './types';\n\n/**\n * Handles the actual on-demand instantiation and memoization of APIs out of\n * an {@link ApiFactoryHolder}.\n *\n * @public\n */\nexport class ApiResolver implements ApiHolder {\n  /**\n   * Validate factories by making sure that each of the apis can be created\n   * without hitting any circular dependencies.\n   */\n  static validateFactories(\n    factories: ApiFactoryHolder,\n    apis: Iterable<AnyApiRef>,\n  ) {\n    for (const api of apis) {\n      const heap = [api];\n      const allDeps = new Set<AnyApiRef>();\n\n      while (heap.length) {\n        const apiRef = heap.shift()!;\n        const factory = factories.get(apiRef);\n        if (!factory) {\n          continue;\n        }\n\n        for (const dep of Object.values(factory.deps)) {\n          if (dep.id === api.id) {\n            throw new Error(`Circular dependency of api factory for ${api}`);\n          }\n          if (!allDeps.has(dep)) {\n            allDeps.add(dep);\n            heap.push(dep);\n          }\n        }\n      }\n    }\n  }\n\n  private readonly apis = new Map<string, unknown>();\n\n  constructor(private readonly factories: ApiFactoryHolder) {}\n\n  get<T>(ref: ApiRef<T>): T | undefined {\n    return this.load(ref);\n  }\n\n  private load<T>(ref: ApiRef<T>, loading: AnyApiRef[] = []): T | undefined {\n    const impl = this.apis.get(ref.id);\n    if (impl) {\n      return impl as T;\n    }\n\n    const factory = this.factories.get(ref);\n    if (!factory) {\n      return undefined;\n    }\n\n    if (loading.includes(factory.api)) {\n      throw new Error(`Circular dependency of api factory for ${factory.api}`);\n    }\n\n    const deps = this.loadDeps(ref, factory.deps, [...loading, factory.api]);\n    const api = factory.factory(deps);\n    this.apis.set(ref.id, api);\n    return api as T;\n  }\n\n  private loadDeps<T>(\n    dependent: ApiRef<unknown>,\n    apis: TypesToApiRefs<T>,\n    loading: AnyApiRef[],\n  ): T {\n    const impls = {} as T;\n\n    for (const key in apis) {\n      if (apis.hasOwnProperty(key)) {\n        const ref = apis[key];\n\n        const api = this.load(ref, loading);\n        if (!api) {\n          throw new Error(\n            `No API factory available for dependency ${ref} of dependent ${dependent}`,\n          );\n        }\n        impls[key] = api;\n      }\n    }\n\n    return impls;\n  }\n}\n"],"names":[],"mappings":"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"}