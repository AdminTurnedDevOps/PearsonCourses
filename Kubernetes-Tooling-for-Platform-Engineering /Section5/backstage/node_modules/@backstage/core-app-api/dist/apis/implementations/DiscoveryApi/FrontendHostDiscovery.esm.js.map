{"version":3,"file":"FrontendHostDiscovery.esm.js","sources":["../../../../src/apis/implementations/DiscoveryApi/FrontendHostDiscovery.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Config } from '@backstage/config';\nimport { DiscoveryApi } from '@backstage/core-plugin-api';\nimport { UrlPatternDiscovery } from './UrlPatternDiscovery';\n\n/**\n * FrontendHostDiscovery is a config driven DiscoveryApi implementation.\n * It uses the app-config to determine the url for a plugin.\n *\n * @public\n */\nexport class FrontendHostDiscovery implements DiscoveryApi {\n  /**\n   * Creates a new FrontendHostDiscovery discovery instance by reading\n   * the external target URL from the `discovery.endpoints` config section.\n   *\n   * eg.\n   * ```yaml\n   * discovery:\n   *  endpoints:\n   *    - target: https://internal.example.com/internal-catalog\n   *      plugins: [catalog]\n   *    - target: https://internal.example.com/secure/api/{{pluginId}}\n   *      plugins: [auth, permissions]\n   *    - target:\n   *        internal: https://internal.example.com/search\n   *        external: https://example.com/search\n   *      plugins: [search]\n   * ```\n   *\n   * If a plugin is not declared in the config, the discovery will fall back to using the baseUrl with\n   * the provided `pathPattern` appended. The default path pattern is `\"/api/{{ pluginId }}\"`.\n   */\n  static fromConfig(config: Config, options?: { pathPattern?: string }) {\n    const path = options?.pathPattern ?? '/api/{{ pluginId }}';\n    const baseUrl = config.getString('backend.baseUrl');\n\n    const endpoints = config\n      .getOptionalConfigArray('discovery.endpoints')\n      ?.flatMap(e => {\n        const target =\n          typeof e.get('target') === 'object'\n            ? e.getString('target.external')\n            : e.getString('target');\n        const discovery = UrlPatternDiscovery.compile(target);\n        return e\n          .getStringArray('plugins')\n          .map(pluginId => [pluginId, discovery] as const);\n      });\n\n    return new FrontendHostDiscovery(\n      new Map(endpoints),\n      UrlPatternDiscovery.compile(`${baseUrl}${path}`),\n    );\n  }\n\n  private constructor(\n    private readonly endpoints: Map<string, DiscoveryApi>,\n    private readonly defaultEndpoint: DiscoveryApi,\n  ) {}\n\n  async getBaseUrl(pluginId: string): Promise<string> {\n    const endpoint = this.endpoints.get(pluginId);\n    if (endpoint) {\n      return endpoint.getBaseUrl(pluginId);\n    }\n    return this.defaultEndpoint.getBaseUrl(pluginId);\n  }\n}\n"],"names":[],"mappings":";;AAyBO,MAAM,qBAA8C,CAAA;AAAA,EA6CjD,WAAA,CACW,WACA,eACjB,EAAA;AAFiB,IAAA,IAAA,CAAA,SAAA,GAAA,SAAA;AACA,IAAA,IAAA,CAAA,eAAA,GAAA,eAAA;AAAA;AAChB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EA1BH,OAAO,UAAW,CAAA,MAAA,EAAgB,OAAoC,EAAA;AACpE,IAAM,MAAA,IAAA,GAAO,SAAS,WAAe,IAAA,qBAAA;AACrC,IAAM,MAAA,OAAA,GAAU,MAAO,CAAA,SAAA,CAAU,iBAAiB,CAAA;AAElD,IAAA,MAAM,YAAY,MACf,CAAA,sBAAA,CAAuB,qBAAqB,CAAA,EAC3C,QAAQ,CAAK,CAAA,KAAA;AACb,MAAA,MAAM,MACJ,GAAA,OAAO,CAAE,CAAA,GAAA,CAAI,QAAQ,CAAA,KAAM,QACvB,GAAA,CAAA,CAAE,SAAU,CAAA,iBAAiB,CAC7B,GAAA,CAAA,CAAE,UAAU,QAAQ,CAAA;AAC1B,MAAM,MAAA,SAAA,GAAY,mBAAoB,CAAA,OAAA,CAAQ,MAAM,CAAA;AACpD,MAAO,OAAA,CAAA,CACJ,eAAe,SAAS,CAAA,CACxB,IAAI,CAAY,QAAA,KAAA,CAAC,QAAU,EAAA,SAAS,CAAU,CAAA;AAAA,KAClD,CAAA;AAEH,IAAA,OAAO,IAAI,qBAAA;AAAA,MACT,IAAI,IAAI,SAAS,CAAA;AAAA,MACjB,oBAAoB,OAAQ,CAAA,CAAA,EAAG,OAAO,CAAA,EAAG,IAAI,CAAE,CAAA;AAAA,KACjD;AAAA;AACF,EAOA,MAAM,WAAW,QAAmC,EAAA;AAClD,IAAA,MAAM,QAAW,GAAA,IAAA,CAAK,SAAU,CAAA,GAAA,CAAI,QAAQ,CAAA;AAC5C,IAAA,IAAI,QAAU,EAAA;AACZ,MAAO,OAAA,QAAA,CAAS,WAAW,QAAQ,CAAA;AAAA;AAErC,IAAO,OAAA,IAAA,CAAK,eAAgB,CAAA,UAAA,CAAW,QAAQ,CAAA;AAAA;AAEnD;;;;"}