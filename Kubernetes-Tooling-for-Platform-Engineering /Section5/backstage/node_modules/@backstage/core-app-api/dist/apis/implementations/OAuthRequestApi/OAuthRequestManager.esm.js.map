{"version":3,"file":"OAuthRequestManager.esm.js","sources":["../../../../src/apis/implementations/OAuthRequestApi/OAuthRequestManager.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  OAuthRequestApi,\n  PendingOAuthRequest,\n  OAuthRequester,\n  OAuthRequesterOptions,\n} from '@backstage/core-plugin-api';\nimport { Observable } from '@backstage/types';\nimport { OAuthPendingRequests, PendingRequest } from './OAuthPendingRequests';\nimport { BehaviorSubject } from '../../../lib/subjects';\n\n/**\n * The OAuthRequestManager is an implementation of the OAuthRequestApi.\n *\n * The purpose of this class and the API is to read a stream of incoming requests\n * of OAuth access tokens from different providers with varying scope, and funnel\n * them all together into a single request for each OAuth provider.\n *\n * @public\n */\nexport class OAuthRequestManager implements OAuthRequestApi {\n  private readonly subject = new BehaviorSubject<PendingOAuthRequest[]>([]);\n  private currentRequests: PendingOAuthRequest[] = [];\n  private handlerCount = 0;\n\n  createAuthRequester<T>(options: OAuthRequesterOptions<T>): OAuthRequester<T> {\n    const handler = new OAuthPendingRequests<T>();\n\n    const index = this.handlerCount;\n    this.handlerCount++;\n\n    handler.pending().subscribe({\n      next: scopeRequest => {\n        const newRequests = this.currentRequests.slice();\n        const request = this.makeAuthRequest(scopeRequest, options);\n        if (!request) {\n          delete newRequests[index];\n        } else {\n          newRequests[index] = request;\n        }\n        this.currentRequests = newRequests;\n        // Convert from sparse array to array of present items only\n        this.subject.next(newRequests.filter(Boolean));\n      },\n    });\n\n    return scopes => {\n      return handler.request(scopes);\n    };\n  }\n\n  // Converts the pending request and popup options into a popup request that we can forward to subscribers.\n  private makeAuthRequest(\n    request: PendingRequest<any>,\n    options: OAuthRequesterOptions<any>,\n  ): PendingOAuthRequest | undefined {\n    const { scopes } = request;\n    if (!scopes) {\n      return undefined;\n    }\n\n    return {\n      provider: options.provider,\n      trigger: async () => {\n        const result = await options.onAuthRequest(scopes);\n        request.resolve(result);\n      },\n      reject: () => {\n        const error = new Error('Login failed, rejected by user');\n        error.name = 'RejectedError';\n        request.reject(error);\n      },\n    };\n  }\n\n  authRequest$(): Observable<PendingOAuthRequest[]> {\n    return this.subject;\n  }\n}\n"],"names":[],"mappings":";;;AAmCO,MAAM,mBAA+C,CAAA;AAAA,EACzC,OAAU,GAAA,IAAI,eAAuC,CAAA,EAAE,CAAA;AAAA,EAChE,kBAAyC,EAAC;AAAA,EAC1C,YAAe,GAAA,CAAA;AAAA,EAEvB,oBAAuB,OAAsD,EAAA;AAC3E,IAAM,MAAA,OAAA,GAAU,IAAI,oBAAwB,EAAA;AAE5C,IAAA,MAAM,QAAQ,IAAK,CAAA,YAAA;AACnB,IAAK,IAAA,CAAA,YAAA,EAAA;AAEL,IAAQ,OAAA,CAAA,OAAA,GAAU,SAAU,CAAA;AAAA,MAC1B,MAAM,CAAgB,YAAA,KAAA;AACpB,QAAM,MAAA,WAAA,GAAc,IAAK,CAAA,eAAA,CAAgB,KAAM,EAAA;AAC/C,QAAA,MAAM,OAAU,GAAA,IAAA,CAAK,eAAgB,CAAA,YAAA,EAAc,OAAO,CAAA;AAC1D,QAAA,IAAI,CAAC,OAAS,EAAA;AACZ,UAAA,OAAO,YAAY,KAAK,CAAA;AAAA,SACnB,MAAA;AACL,UAAA,WAAA,CAAY,KAAK,CAAI,GAAA,OAAA;AAAA;AAEvB,QAAA,IAAA,CAAK,eAAkB,GAAA,WAAA;AAEvB,QAAA,IAAA,CAAK,OAAQ,CAAA,IAAA,CAAK,WAAY,CAAA,MAAA,CAAO,OAAO,CAAC,CAAA;AAAA;AAC/C,KACD,CAAA;AAED,IAAA,OAAO,CAAU,MAAA,KAAA;AACf,MAAO,OAAA,OAAA,CAAQ,QAAQ,MAAM,CAAA;AAAA,KAC/B;AAAA;AACF;AAAA,EAGQ,eAAA,CACN,SACA,OACiC,EAAA;AACjC,IAAM,MAAA,EAAE,QAAW,GAAA,OAAA;AACnB,IAAA,IAAI,CAAC,MAAQ,EAAA;AACX,MAAO,OAAA,KAAA,CAAA;AAAA;AAGT,IAAO,OAAA;AAAA,MACL,UAAU,OAAQ,CAAA,QAAA;AAAA,MAClB,SAAS,YAAY;AACnB,QAAA,MAAM,MAAS,GAAA,MAAM,OAAQ,CAAA,aAAA,CAAc,MAAM,CAAA;AACjD,QAAA,OAAA,CAAQ,QAAQ,MAAM,CAAA;AAAA,OACxB;AAAA,MACA,QAAQ,MAAM;AACZ,QAAM,MAAA,KAAA,GAAQ,IAAI,KAAA,CAAM,gCAAgC,CAAA;AACxD,QAAA,KAAA,CAAM,IAAO,GAAA,eAAA;AACb,QAAA,OAAA,CAAQ,OAAO,KAAK,CAAA;AAAA;AACtB,KACF;AAAA;AACF,EAEA,YAAkD,GAAA;AAChD,IAAA,OAAO,IAAK,CAAA,OAAA;AAAA;AAEhB;;;;"}