{"version":3,"file":"AppLanguageSelector.esm.js","sources":["../../../../src/apis/implementations/AppLanguageApi/AppLanguageSelector.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Internal import to avoid code duplication, this will lead to duplication in build output\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { AppLanguageApi } from '@backstage/core-plugin-api/alpha';\nimport { Observable } from '@backstage/types';\nimport { BehaviorSubject } from '../../../lib';\n\nconst STORAGE_KEY = 'language';\nexport const DEFAULT_LANGUAGE = 'en';\n\n/** @alpha */\nexport interface AppLanguageSelectorOptions {\n  defaultLanguage?: string;\n  availableLanguages?: string[];\n}\n\n/**\n * Exposes the available languages in the app and allows for switching of the active language.\n *\n * @alpha\n */\nexport class AppLanguageSelector implements AppLanguageApi {\n  static create(options?: AppLanguageSelectorOptions) {\n    const languages = options?.availableLanguages ?? [DEFAULT_LANGUAGE];\n    if (languages.length !== new Set(languages).size) {\n      throw new Error(\n        `Supported languages may not contain duplicates, got '${languages.join(\n          \"', '\",\n        )}'`,\n      );\n    }\n    if (!languages.includes(DEFAULT_LANGUAGE)) {\n      throw new Error(`Supported languages must include '${DEFAULT_LANGUAGE}'`);\n    }\n\n    const initialLanguage = options?.defaultLanguage ?? DEFAULT_LANGUAGE;\n    if (!languages.includes(initialLanguage)) {\n      throw new Error(\n        `Initial language must be one of the supported languages, got '${initialLanguage}'`,\n      );\n    }\n\n    return new AppLanguageSelector(languages, initialLanguage);\n  }\n\n  static createWithStorage(options?: AppLanguageSelectorOptions) {\n    const selector = AppLanguageSelector.create(options);\n\n    if (!window.localStorage) {\n      return selector;\n    }\n\n    const storedLanguage = window.localStorage.getItem(STORAGE_KEY);\n    const { languages } = selector.getAvailableLanguages();\n    if (storedLanguage && languages.includes(storedLanguage)) {\n      selector.setLanguage(storedLanguage);\n    }\n\n    selector.language$().subscribe(({ language }) => {\n      if (language !== window.localStorage.getItem(STORAGE_KEY)) {\n        window.localStorage.setItem(STORAGE_KEY, language);\n      }\n    });\n\n    window.addEventListener('storage', event => {\n      if (event.key === STORAGE_KEY) {\n        const language = localStorage.getItem(STORAGE_KEY) ?? undefined;\n        if (language) {\n          selector.setLanguage(language);\n        }\n      }\n    });\n\n    return selector;\n  }\n\n  #languages: string[];\n  #language: string;\n  #subject: BehaviorSubject<{ language: string }>;\n\n  private constructor(languages: string[], initialLanguage: string) {\n    this.#languages = languages;\n    this.#language = initialLanguage;\n    this.#subject = new BehaviorSubject<{ language: string }>({\n      language: this.#language,\n    });\n  }\n\n  getAvailableLanguages(): { languages: string[] } {\n    return { languages: this.#languages.slice() };\n  }\n\n  setLanguage(language?: string | undefined): void {\n    const lng = language ?? DEFAULT_LANGUAGE;\n    if (lng === this.#language) {\n      return;\n    }\n    if (lng && !this.#languages.includes(lng)) {\n      throw new Error(\n        `Failed to change language to '${lng}', available languages are '${this.#languages.join(\n          \"', '\",\n        )}'`,\n      );\n    }\n    this.#language = lng;\n    this.#subject.next({ language: lng });\n  }\n\n  getLanguage(): { language: string } {\n    return { language: this.#language };\n  }\n\n  language$(): Observable<{ language: string }> {\n    return this.#subject;\n  }\n}\n"],"names":[],"mappings":"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"}