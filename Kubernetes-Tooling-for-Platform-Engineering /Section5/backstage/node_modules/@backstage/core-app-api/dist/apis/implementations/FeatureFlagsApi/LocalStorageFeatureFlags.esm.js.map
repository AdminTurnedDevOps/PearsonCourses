{"version":3,"file":"LocalStorageFeatureFlags.esm.js","sources":["../../../../src/apis/implementations/FeatureFlagsApi/LocalStorageFeatureFlags.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  FeatureFlagState,\n  FeatureFlagsApi,\n  FeatureFlag,\n  FeatureFlagsSaveOptions,\n} from '@backstage/core-plugin-api';\n\nexport function validateFlagName(name: string): void {\n  if (name.length < 3) {\n    throw new Error(\n      `The '${name}' feature flag must have a minimum length of three characters.`,\n    );\n  }\n\n  if (name.length > 150) {\n    throw new Error(\n      `The '${name}' feature flag must not exceed 150 characters.`,\n    );\n  }\n\n  if (!name.match(/^[a-z]+[a-z0-9-]+$/)) {\n    throw new Error(\n      `The '${name}' feature flag must start with a lowercase letter and only contain lowercase letters, numbers and hyphens. ` +\n        'Examples: feature-flag-one, alpha, release-2020',\n    );\n  }\n}\n\n/**\n * A feature flags implementation that stores the flags in the browser's local\n * storage.\n *\n * @public\n */\nexport class LocalStorageFeatureFlags implements FeatureFlagsApi {\n  private registeredFeatureFlags: FeatureFlag[] = [];\n  private flags?: Map<string, FeatureFlagState>;\n\n  registerFlag(flag: FeatureFlag) {\n    validateFlagName(flag.name);\n    this.registeredFeatureFlags.push(flag);\n  }\n\n  getRegisteredFlags(): FeatureFlag[] {\n    return this.registeredFeatureFlags.slice();\n  }\n\n  isActive(name: string): boolean {\n    if (!this.flags) {\n      this.flags = this.load();\n    }\n    return this.flags.get(name) === FeatureFlagState.Active;\n  }\n\n  save(options: FeatureFlagsSaveOptions): void {\n    if (!this.flags) {\n      this.flags = this.load();\n    }\n    if (!options.merge) {\n      this.flags.clear();\n    }\n    for (const [name, state] of Object.entries(options.states)) {\n      this.flags.set(name, state);\n    }\n\n    const enabled = Array.from(this.flags.entries()).filter(\n      ([, state]) => state === FeatureFlagState.Active,\n    );\n    window.localStorage.setItem(\n      'featureFlags',\n      JSON.stringify(Object.fromEntries(enabled)),\n    );\n  }\n\n  private load(): Map<string, FeatureFlagState> {\n    try {\n      const jsonStr = window.localStorage.getItem('featureFlags');\n      if (!jsonStr) {\n        return new Map();\n      }\n      const json = JSON.parse(jsonStr) as unknown;\n      if (typeof json !== 'object' || json === null || Array.isArray(json)) {\n        return new Map();\n      }\n\n      const entries = Object.entries(json).filter(([name, value]) => {\n        validateFlagName(name);\n        return value === FeatureFlagState.Active;\n      });\n\n      return new Map(entries);\n    } catch {\n      return new Map();\n    }\n  }\n}\n"],"names":[],"mappings":"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"}