{"version":3,"file":"AppManager.esm.js","sources":["../../src/app/AppManager.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport React, {\n  ComponentType,\n  PropsWithChildren,\n  Suspense,\n  useMemo,\n  useRef,\n} from 'react';\nimport useAsync from 'react-use/esm/useAsync';\nimport {\n  ApiProvider,\n  AppThemeSelector,\n  ConfigReader,\n  LocalStorageFeatureFlags,\n} from '../apis';\nimport {\n  AnyApiFactory,\n  ApiHolder,\n  IconComponent,\n  AppTheme,\n  appThemeApiRef,\n  configApiRef,\n  AppThemeApi,\n  ConfigApi,\n  featureFlagsApiRef,\n  identityApiRef,\n  BackstagePlugin,\n  FeatureFlag,\n  fetchApiRef,\n  discoveryApiRef,\n  errorApiRef,\n} from '@backstage/core-plugin-api';\nimport {\n  AppLanguageApi,\n  appLanguageApiRef,\n  translationApiRef,\n  TranslationMessages,\n  TranslationResource,\n} from '@backstage/core-plugin-api/alpha';\nimport { ApiFactoryRegistry, ApiResolver } from '../apis/system';\nimport {\n  childDiscoverer,\n  routeElementDiscoverer,\n  traverseElementTree,\n} from '../extensions/traversal';\nimport { pluginCollector } from '../plugins/collectors';\nimport {\n  featureFlagCollector,\n  routingV1Collector,\n  routingV2Collector,\n} from '../routing/collectors';\nimport { RoutingProvider } from '../routing/RoutingProvider';\nimport {\n  validateRouteParameters,\n  validateRouteBindings,\n} from '../routing/validation';\nimport { AppContextProvider } from './AppContext';\nimport { AppIdentityProxy } from '../apis/implementations/IdentityApi/AppIdentityProxy';\nimport {\n  AppComponents,\n  AppConfigLoader,\n  AppContext,\n  AppOptions,\n  BackstageApp,\n} from './types';\nimport { AppThemeProvider } from './AppThemeProvider';\nimport { defaultConfigLoader } from './defaultConfigLoader';\nimport { ApiRegistry } from '../apis/system/ApiRegistry';\nimport { resolveRouteBindings } from './resolveRouteBindings';\nimport { isReactRouterBeta } from './isReactRouterBeta';\nimport { InternalAppContext } from './InternalAppContext';\nimport { AppRouter, getBasePath } from './AppRouter';\nimport { AppLanguageSelector } from '../apis/implementations/AppLanguageApi';\nimport { I18nextTranslationApi } from '../apis/implementations/TranslationApi';\nimport { overrideBaseUrlConfigs } from './overrideBaseUrlConfigs';\nimport { isProtectedApp } from './isProtectedApp';\n\ntype CompatiblePlugin =\n  | BackstagePlugin\n  | (Omit<BackstagePlugin, 'getFeatureFlags'> & {\n      output(): Array<{ type: 'feature-flag'; name: string }>;\n    });\n\nfunction useConfigLoader(\n  configLoader: AppConfigLoader | undefined,\n  components: AppComponents,\n  appThemeApi: AppThemeApi,\n): { api: ConfigApi } | { node: JSX.Element } {\n  // Keeping this synchronous when a config loader isn't set simplifies tests a lot\n  const hasConfig = Boolean(configLoader);\n  const config = useAsync(configLoader || (() => Promise.resolve([])));\n\n  let noConfigNode = undefined;\n\n  if (hasConfig && config.loading) {\n    const { Progress } = components;\n    noConfigNode = <Progress />;\n  } else if (config.error) {\n    const { BootErrorPage } = components;\n    noConfigNode = <BootErrorPage step=\"load-config\" error={config.error} />;\n  }\n\n  const { ThemeProvider = AppThemeProvider } = components;\n\n  // Before the config is loaded we can't use a router, so exit early\n  if (noConfigNode) {\n    return {\n      node: (\n        <ApiProvider apis={ApiRegistry.with(appThemeApiRef, appThemeApi)}>\n          <ThemeProvider>{noConfigNode}</ThemeProvider>\n        </ApiProvider>\n      ),\n    };\n  }\n\n  const configReader = ConfigReader.fromConfigs(\n    config.value?.length ? overrideBaseUrlConfigs(config.value) : [],\n  );\n\n  return { api: configReader };\n}\n\nclass AppContextImpl implements AppContext {\n  constructor(private readonly app: AppManager) {}\n\n  getPlugins(): BackstagePlugin[] {\n    return this.app.getPlugins();\n  }\n\n  getSystemIcon(key: string): IconComponent | undefined {\n    return this.app.getSystemIcon(key);\n  }\n\n  getSystemIcons(): Record<string, IconComponent> {\n    return this.app.getSystemIcons();\n  }\n\n  getComponents(): AppComponents {\n    return this.app.getComponents();\n  }\n}\n\nexport class AppManager implements BackstageApp {\n  private apiHolder?: ApiHolder;\n  private configApi?: ConfigApi;\n\n  private readonly apis: Iterable<AnyApiFactory>;\n  private readonly icons: NonNullable<AppOptions['icons']>;\n  private readonly plugins: Set<CompatiblePlugin>;\n  private readonly featureFlags: (FeatureFlag &\n    Omit<FeatureFlag, 'pluginId'>)[];\n  private readonly components: AppComponents;\n  private readonly themes: AppTheme[];\n  private readonly configLoader?: AppConfigLoader;\n  private readonly defaultApis: Iterable<AnyApiFactory>;\n  private readonly bindRoutes: AppOptions['bindRoutes'];\n  private readonly appLanguageApi: AppLanguageApi;\n  private readonly translationResources: Array<\n    TranslationResource | TranslationMessages\n  >;\n\n  private readonly appIdentityProxy = new AppIdentityProxy();\n  private readonly apiFactoryRegistry: ApiFactoryRegistry;\n\n  constructor(options: AppOptions) {\n    this.apis = options.apis ?? [];\n    this.icons = options.icons;\n    this.plugins = new Set((options.plugins as CompatiblePlugin[]) ?? []);\n    this.featureFlags = options.featureFlags ?? [];\n    this.components = options.components;\n    this.themes = options.themes as AppTheme[];\n    this.configLoader = options.configLoader ?? defaultConfigLoader;\n    this.defaultApis = options.defaultApis ?? [];\n    this.bindRoutes = options.bindRoutes;\n    this.apiFactoryRegistry = new ApiFactoryRegistry();\n    this.appLanguageApi = AppLanguageSelector.createWithStorage({\n      defaultLanguage: options.__experimentalTranslations?.defaultLanguage,\n      availableLanguages:\n        options.__experimentalTranslations?.availableLanguages,\n    });\n    this.translationResources =\n      options.__experimentalTranslations?.resources ?? [];\n  }\n\n  getPlugins(): BackstagePlugin[] {\n    return Array.from(this.plugins) as BackstagePlugin[];\n  }\n\n  getSystemIcon(key: string): IconComponent | undefined {\n    return this.icons[key];\n  }\n\n  getSystemIcons(): Record<string, IconComponent> {\n    return this.icons;\n  }\n\n  getComponents(): AppComponents {\n    return this.components;\n  }\n\n  createRoot(element: JSX.Element): ComponentType<PropsWithChildren<{}>> {\n    const AppProvider = this.getProvider();\n    const AppRoot = () => {\n      return <AppProvider>{element}</AppProvider>;\n    };\n    return AppRoot;\n  }\n\n  #getProviderCalled = false;\n  getProvider(): ComponentType<PropsWithChildren<{}>> {\n    if (this.#getProviderCalled) {\n      throw new Error(\n        'app.getProvider() or app.createRoot() has already been called, and can only be called once',\n      );\n    }\n    this.#getProviderCalled = true;\n\n    const appContext = new AppContextImpl(this);\n\n    // We only bind and validate routes once\n    let routeBindings: ReturnType<typeof resolveRouteBindings>;\n    // Store and keep throwing the same error if we encounter one\n    let routeValidationError: Error | undefined = undefined;\n\n    const Provider = ({ children }: PropsWithChildren<{}>) => {\n      const needsFeatureFlagRegistrationRef = useRef(true);\n      const appThemeApi = useMemo(\n        () => AppThemeSelector.createWithStorage(this.themes),\n        [],\n      );\n\n      const { routing, featureFlags } = useMemo(() => {\n        const usesReactRouterBeta = isReactRouterBeta();\n        if (usesReactRouterBeta) {\n          // eslint-disable-next-line no-console\n          console.warn(`\nDEPRECATION WARNING: React Router Beta is deprecated and support for it will be removed in a future release.\n                     Please migrate to use React Router v6 stable.\n                     See https://backstage.io/docs/tutorials/react-router-stable-migration\n`);\n        }\n\n        const result = traverseElementTree({\n          root: children,\n          discoverers: [childDiscoverer, routeElementDiscoverer],\n          collectors: {\n            routing: usesReactRouterBeta\n              ? routingV1Collector\n              : routingV2Collector,\n            collectedPlugins: pluginCollector,\n            featureFlags: featureFlagCollector,\n          },\n        });\n\n        // TODO(Rugvip): Restructure the public API so that we can get an immediate view of\n        //               the app, rather than having to wait for the provider to render.\n        //               For now we need to push the additional plugins we find during\n        //               collection and then make sure we initialize things afterwards.\n        result.collectedPlugins.forEach(plugin => this.plugins.add(plugin));\n        this.verifyPlugins(this.plugins);\n\n        // Initialize APIs once all plugins are available\n        this.getApiHolder();\n        return result;\n      }, [children]);\n\n      const loadedConfig = useConfigLoader(\n        this.configLoader,\n        this.components,\n        appThemeApi,\n      );\n\n      const hasConfigApi = 'api' in loadedConfig;\n      if (hasConfigApi) {\n        const { api } = loadedConfig as { api: Config };\n        this.configApi = api;\n      }\n\n      if ('node' in loadedConfig) {\n        // Loading or error\n        return loadedConfig.node;\n      }\n\n      if (routeValidationError) {\n        throw routeValidationError;\n      } else if (!routeBindings) {\n        try {\n          routeBindings = resolveRouteBindings(\n            this.bindRoutes,\n            loadedConfig.api,\n            this.plugins,\n          );\n\n          validateRouteParameters(routing.paths, routing.parents);\n          validateRouteBindings(routeBindings, this.plugins);\n        } catch (error) {\n          routeValidationError = error;\n          throw error;\n        }\n      }\n\n      // We can't register feature flags just after the element traversal, because the\n      // config API isn't available yet and implementations frequently depend on it.\n      // Instead we make it happen immediately, to make sure all flags are available\n      // for the first render.\n      if (hasConfigApi && needsFeatureFlagRegistrationRef.current) {\n        needsFeatureFlagRegistrationRef.current = false;\n\n        const featureFlagsApi = this.getApiHolder().get(featureFlagsApiRef)!;\n\n        if (featureFlagsApi) {\n          for (const flag of this.featureFlags) {\n            featureFlagsApi.registerFlag({\n              ...flag,\n              pluginId: '',\n            });\n          }\n          for (const plugin of this.plugins.values()) {\n            if ('getFeatureFlags' in plugin) {\n              for (const flag of plugin.getFeatureFlags()) {\n                featureFlagsApi.registerFlag({\n                  name: flag.name,\n                  pluginId: plugin.getId(),\n                });\n              }\n            } else {\n              for (const output of plugin.output()) {\n                if (output.type === 'feature-flag') {\n                  featureFlagsApi.registerFlag({\n                    name: output.name,\n                    pluginId: plugin.getId(),\n                  });\n                }\n              }\n            }\n          }\n\n          // Go through the featureFlags returned from the traversal and\n          // register those now the configApi has been loaded\n          const registeredFlags = featureFlagsApi.getRegisteredFlags();\n          const flagNames = new Set(registeredFlags.map(f => f.name));\n          for (const name of featureFlags) {\n            // Prevents adding duplicate feature flags\n            if (!flagNames.has(name)) {\n              featureFlagsApi.registerFlag({ name, pluginId: '' });\n            }\n          }\n        }\n      }\n\n      const { ThemeProvider = AppThemeProvider, Progress } = this.components;\n\n      const apis = this.getApiHolder();\n\n      if (isProtectedApp()) {\n        const errorApi = apis.get(errorApiRef);\n        const fetchApi = apis.get(fetchApiRef);\n        const discoveryApi = apis.get(discoveryApiRef);\n        if (!errorApi || !fetchApi || !discoveryApi) {\n          throw new Error(\n            'App is running in protected mode but missing required APIs',\n          );\n        }\n        this.appIdentityProxy.enableCookieAuth({\n          errorApi,\n          fetchApi,\n          discoveryApi,\n        });\n      }\n\n      return (\n        <ApiProvider apis={apis}>\n          <AppContextProvider appContext={appContext}>\n            <ThemeProvider>\n              <RoutingProvider\n                routePaths={routing.paths}\n                routeParents={routing.parents}\n                routeObjects={routing.objects}\n                routeBindings={routeBindings}\n                basePath={getBasePath(loadedConfig.api)}\n              >\n                <InternalAppContext.Provider\n                  value={{\n                    routeObjects: routing.objects,\n                    appIdentityProxy: this.appIdentityProxy,\n                  }}\n                >\n                  <Suspense fallback={<Progress />}>{children}</Suspense>\n                </InternalAppContext.Provider>\n              </RoutingProvider>\n            </ThemeProvider>\n          </AppContextProvider>\n        </ApiProvider>\n      );\n    };\n    return Provider;\n  }\n\n  getRouter(): ComponentType<PropsWithChildren<{}>> {\n    return AppRouter;\n  }\n\n  private getApiHolder(): ApiHolder {\n    if (this.apiHolder) {\n      // Register additional plugins if they have been added.\n      // Routes paths, objects and others are already updated in the provider when children of it change\n      for (const plugin of this.plugins) {\n        for (const factory of plugin.getApis()) {\n          if (!this.apiFactoryRegistry.get(factory.api)) {\n            this.apiFactoryRegistry.register('default', factory);\n          }\n        }\n      }\n      ApiResolver.validateFactories(\n        this.apiFactoryRegistry,\n        this.apiFactoryRegistry.getAllApis(),\n      );\n      return this.apiHolder;\n    }\n    this.apiFactoryRegistry.register('static', {\n      api: appThemeApiRef,\n      deps: {},\n      factory: () => AppThemeSelector.createWithStorage(this.themes),\n    });\n    this.apiFactoryRegistry.register('static', {\n      api: configApiRef,\n      deps: {},\n      factory: () => {\n        if (!this.configApi) {\n          throw new Error(\n            'Tried to access config API before config was loaded',\n          );\n        }\n        return this.configApi;\n      },\n    });\n    this.apiFactoryRegistry.register('static', {\n      api: identityApiRef,\n      deps: {},\n      factory: () => this.appIdentityProxy,\n    });\n    this.apiFactoryRegistry.register('static', {\n      api: appLanguageApiRef,\n      deps: {},\n      factory: () => this.appLanguageApi,\n    });\n\n    // The translation API is registered as a default API so that it can be overridden.\n    // It will be up to the implementer of the new API to register translation resources.\n    this.apiFactoryRegistry.register('default', {\n      api: translationApiRef,\n      deps: { languageApi: appLanguageApiRef },\n      factory: ({ languageApi }) =>\n        I18nextTranslationApi.create({\n          languageApi,\n          resources: this.translationResources,\n        }),\n    });\n\n    // It's possible to replace the feature flag API, but since we must have at least\n    // one implementation we add it here directly instead of through the defaultApis.\n    this.apiFactoryRegistry.register('default', {\n      api: featureFlagsApiRef,\n      deps: {},\n      factory: () => new LocalStorageFeatureFlags(),\n    });\n    for (const factory of this.defaultApis) {\n      this.apiFactoryRegistry.register('default', factory);\n    }\n\n    for (const plugin of this.plugins) {\n      for (const factory of plugin.getApis()) {\n        if (!this.apiFactoryRegistry.register('default', factory)) {\n          throw new Error(\n            `Plugin ${plugin.getId()} tried to register duplicate or forbidden API factory for ${\n              factory.api\n            }`,\n          );\n        }\n      }\n    }\n\n    for (const factory of this.apis) {\n      if (!this.apiFactoryRegistry.register('app', factory)) {\n        throw new Error(\n          `Duplicate or forbidden API factory for ${factory.api} in app`,\n        );\n      }\n    }\n\n    ApiResolver.validateFactories(\n      this.apiFactoryRegistry,\n      this.apiFactoryRegistry.getAllApis(),\n    );\n\n    this.apiHolder = new ApiResolver(this.apiFactoryRegistry);\n    return this.apiHolder;\n  }\n\n  private verifyPlugins(plugins: Iterable<CompatiblePlugin>) {\n    const pluginIds = new Set<string>();\n\n    for (const plugin of plugins) {\n      const id = plugin.getId();\n      if (pluginIds.has(id)) {\n        throw new Error(`Duplicate plugin found '${id}'`);\n      }\n      pluginIds.add(id);\n    }\n  }\n}\n"],"names":[],"mappings":"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"}