{"version":3,"file":"overrideBaseUrlConfigs.esm.js","sources":["../../src/app/overrideBaseUrlConfigs.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AppConfig, ConfigReader } from '@backstage/config';\n\n/**\n * Creates a base URL that uses to the current document origin.\n */\nfunction createLocalBaseUrl(fullUrl: string): string {\n  const url = new URL(fullUrl);\n  url.protocol = document.location.protocol;\n  url.hostname = document.location.hostname;\n  url.port = document.location.port;\n  return url.toString().replace(/\\/$/, '');\n}\n\n/**\n * If we are able to override the app and backend base URLs to values that\n * match the origin of the current location, then this function returns a\n * new array of app configs that contain the overrides.\n *\n * @internal\n */\nexport function overrideBaseUrlConfigs(inputConfigs: AppConfig[]): AppConfig[] {\n  const urlConfigReader = ConfigReader.fromConfigs(inputConfigs);\n\n  // In tests we may not have `app.baseUrl` or `backend.baseUrl`, to keep them optional\n  const appBaseUrl = urlConfigReader.getOptionalString('app.baseUrl');\n  const backendBaseUrl = urlConfigReader.getOptionalString('backend.baseUrl');\n\n  let configs = inputConfigs;\n\n  let newBackendBaseUrl: string | undefined = undefined;\n  let newAppBaseUrl: string | undefined = undefined;\n\n  if (appBaseUrl && backendBaseUrl) {\n    const appOrigin = new URL(appBaseUrl).origin;\n    const backendOrigin = new URL(backendBaseUrl).origin;\n\n    if (appOrigin === backendOrigin) {\n      const maybeNewBackendBaseUrl = createLocalBaseUrl(backendBaseUrl);\n      if (backendBaseUrl !== maybeNewBackendBaseUrl) {\n        newBackendBaseUrl = maybeNewBackendBaseUrl;\n      }\n    }\n  }\n\n  if (appBaseUrl) {\n    const maybeNewAppBaseUrl = createLocalBaseUrl(appBaseUrl);\n    if (appBaseUrl !== maybeNewAppBaseUrl) {\n      newAppBaseUrl = maybeNewAppBaseUrl;\n    }\n  }\n\n  // Only add the relative config if there is actually data to add.\n  if (newAppBaseUrl || newBackendBaseUrl) {\n    configs = configs.concat({\n      data: {\n        app: newAppBaseUrl && {\n          baseUrl: newAppBaseUrl,\n        },\n        backend: newBackendBaseUrl && {\n          baseUrl: newBackendBaseUrl,\n        },\n      },\n      context: 'relative-resolver',\n    });\n  }\n\n  return configs;\n}\n"],"names":[],"mappings":";;AAqBA,SAAS,mBAAmB,OAAyB,EAAA;AACnD,EAAM,MAAA,GAAA,GAAM,IAAI,GAAA,CAAI,OAAO,CAAA;AAC3B,EAAI,GAAA,CAAA,QAAA,GAAW,SAAS,QAAS,CAAA,QAAA;AACjC,EAAI,GAAA,CAAA,QAAA,GAAW,SAAS,QAAS,CAAA,QAAA;AACjC,EAAI,GAAA,CAAA,IAAA,GAAO,SAAS,QAAS,CAAA,IAAA;AAC7B,EAAA,OAAO,GAAI,CAAA,QAAA,EAAW,CAAA,OAAA,CAAQ,OAAO,EAAE,CAAA;AACzC;AASO,SAAS,uBAAuB,YAAwC,EAAA;AAC7E,EAAM,MAAA,eAAA,GAAkB,YAAa,CAAA,WAAA,CAAY,YAAY,CAAA;AAG7D,EAAM,MAAA,UAAA,GAAa,eAAgB,CAAA,iBAAA,CAAkB,aAAa,CAAA;AAClE,EAAM,MAAA,cAAA,GAAiB,eAAgB,CAAA,iBAAA,CAAkB,iBAAiB,CAAA;AAE1E,EAAA,IAAI,OAAU,GAAA,YAAA;AAEd,EAAA,IAAI,iBAAwC,GAAA,KAAA,CAAA;AAC5C,EAAA,IAAI,aAAoC,GAAA,KAAA,CAAA;AAExC,EAAA,IAAI,cAAc,cAAgB,EAAA;AAChC,IAAA,MAAM,SAAY,GAAA,IAAI,GAAI,CAAA,UAAU,CAAE,CAAA,MAAA;AACtC,IAAA,MAAM,aAAgB,GAAA,IAAI,GAAI,CAAA,cAAc,CAAE,CAAA,MAAA;AAE9C,IAAA,IAAI,cAAc,aAAe,EAAA;AAC/B,MAAM,MAAA,sBAAA,GAAyB,mBAAmB,cAAc,CAAA;AAChE,MAAA,IAAI,mBAAmB,sBAAwB,EAAA;AAC7C,QAAoB,iBAAA,GAAA,sBAAA;AAAA;AACtB;AACF;AAGF,EAAA,IAAI,UAAY,EAAA;AACd,IAAM,MAAA,kBAAA,GAAqB,mBAAmB,UAAU,CAAA;AACxD,IAAA,IAAI,eAAe,kBAAoB,EAAA;AACrC,MAAgB,aAAA,GAAA,kBAAA;AAAA;AAClB;AAIF,EAAA,IAAI,iBAAiB,iBAAmB,EAAA;AACtC,IAAA,OAAA,GAAU,QAAQ,MAAO,CAAA;AAAA,MACvB,IAAM,EAAA;AAAA,QACJ,KAAK,aAAiB,IAAA;AAAA,UACpB,OAAS,EAAA;AAAA,SACX;AAAA,QACA,SAAS,iBAAqB,IAAA;AAAA,UAC5B,OAAS,EAAA;AAAA;AACX,OACF;AAAA,MACA,OAAS,EAAA;AAAA,KACV,CAAA;AAAA;AAGH,EAAO,OAAA,OAAA;AACT;;;;"}