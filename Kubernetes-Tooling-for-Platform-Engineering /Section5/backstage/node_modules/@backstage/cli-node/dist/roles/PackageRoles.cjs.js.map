{"version":3,"file":"PackageRoles.cjs.js","sources":["../../src/roles/PackageRoles.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { z } from 'zod';\nimport { PackageRole, PackageRoleInfo } from './types';\n\nconst packageRoleInfos: PackageRoleInfo[] = [\n  {\n    role: 'frontend',\n    platform: 'web',\n    output: ['bundle'],\n  },\n  {\n    role: 'backend',\n    platform: 'node',\n    output: ['bundle'],\n  },\n  {\n    role: 'cli',\n    platform: 'node',\n    output: ['cjs'],\n  },\n  {\n    role: 'web-library',\n    platform: 'web',\n    output: ['types', 'esm'],\n  },\n  {\n    role: 'node-library',\n    platform: 'node',\n    output: ['types', 'cjs'],\n  },\n  {\n    role: 'common-library',\n    platform: 'common',\n    output: ['types', 'esm', 'cjs'],\n  },\n  {\n    role: 'frontend-plugin',\n    platform: 'web',\n    output: ['types', 'esm'],\n  },\n  {\n    role: 'frontend-plugin-module',\n    platform: 'web',\n    output: ['types', 'esm'],\n  },\n  {\n    role: 'frontend-dynamic-container' as PackageRole, // experimental\n    platform: 'web',\n    output: ['bundle'],\n  },\n  {\n    role: 'backend-plugin',\n    platform: 'node',\n    output: ['types', 'cjs'],\n  },\n  {\n    role: 'backend-plugin-module',\n    platform: 'node',\n    output: ['types', 'cjs'],\n  },\n];\n\nconst readSchema = z.object({\n  name: z.string().optional(),\n  backstage: z\n    .object({\n      role: z.string().optional(),\n    })\n    .optional(),\n});\n\nconst detectionSchema = z.object({\n  name: z.string().optional(),\n  scripts: z\n    .object({\n      start: z.string().optional(),\n      build: z.string().optional(),\n    })\n    .optional(),\n  publishConfig: z\n    .object({\n      main: z.string().optional(),\n      types: z.string().optional(),\n      module: z.string().optional(),\n    })\n    .optional(),\n  main: z.string().optional(),\n  types: z.string().optional(),\n  module: z.string().optional(),\n});\n\n/**\n * Utilities for working with Backstage package roles.\n *\n * @public\n */\nexport class PackageRoles {\n  /**\n   * Get the associated info for a package role.\n   */\n  static getRoleInfo(role: string): PackageRoleInfo {\n    const roleInfo = packageRoleInfos.find(r => r.role === role);\n    if (!roleInfo) {\n      throw new Error(`Unknown package role '${role}'`);\n    }\n    return roleInfo;\n  }\n\n  /**\n   * Given package JSON data, get the package role.\n   */\n  static getRoleFromPackage(pkgJson: unknown): PackageRole | undefined {\n    const pkg = readSchema.parse(pkgJson);\n\n    if (pkg.backstage) {\n      const { role } = pkg.backstage;\n      if (!role) {\n        throw new Error(\n          `Package ${pkg.name} must specify a role in the \"backstage\" field`,\n        );\n      }\n\n      return this.getRoleInfo(role).role;\n    }\n\n    return undefined;\n  }\n\n  /**\n   * Attempt to detect the role of a package from its package.json.\n   */\n  static detectRoleFromPackage(pkgJson: unknown): PackageRole | undefined {\n    const pkg = detectionSchema.parse(pkgJson);\n\n    if (pkg.scripts?.start?.includes('app:serve')) {\n      return 'frontend';\n    }\n    if (pkg.scripts?.build?.includes('backend:bundle')) {\n      return 'backend';\n    }\n    if (\n      pkg.name?.includes('plugin-') &&\n      pkg.name?.includes('-backend-module-')\n    ) {\n      return 'backend-plugin-module';\n    }\n    if (pkg.name?.includes('plugin-') && pkg.name?.includes('-module-')) {\n      return 'frontend-plugin-module';\n    }\n    if (pkg.scripts?.start?.includes('plugin:serve')) {\n      return 'frontend-plugin';\n    }\n    if (pkg.scripts?.start?.includes('backend:dev')) {\n      return 'backend-plugin';\n    }\n\n    const mainEntry = pkg.publishConfig?.main || pkg.main;\n    const moduleEntry = pkg.publishConfig?.module || pkg.module;\n    const typesEntry = pkg.publishConfig?.types || pkg.types;\n    if (typesEntry) {\n      if (mainEntry && moduleEntry) {\n        return 'common-library';\n      }\n      if (moduleEntry || mainEntry?.endsWith('.esm.js')) {\n        return 'web-library';\n      }\n      if (mainEntry) {\n        return 'node-library';\n      }\n    } else if (mainEntry) {\n      return 'cli';\n    }\n\n    return undefined;\n  }\n}\n"],"names":["z"],"mappings":"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"}