{"version":3,"file":"GitUtils.cjs.js","sources":["../../src/git/GitUtils.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { assertError, ForwardedError } from '@backstage/errors';\nimport { execFile, paths } from '../util';\n\n/**\n * Run a git command, trimming the output splitting it into lines.\n */\nexport async function runGit(...args: string[]) {\n  try {\n    const { stdout } = await execFile('git', args, {\n      shell: true,\n      cwd: paths.targetRoot,\n    });\n    return stdout.trim().split(/\\r\\n|\\r|\\n/);\n  } catch (error) {\n    assertError(error);\n    if (error.stderr || typeof error.code === 'number') {\n      const stderr = (error.stderr as undefined | Buffer)?.toString('utf8');\n      const msg = stderr?.trim() ?? `with exit code ${error.code}`;\n      throw new Error(`git ${args[0]} failed, ${msg}`);\n    }\n    throw new ForwardedError('Unknown execution error', error);\n  }\n}\n\n/**\n * Utilities for working with git.\n *\n * @public\n */\nexport class GitUtils {\n  /**\n   * Returns a sorted list of all files that have changed since the merge base\n   * of the provided `ref` and HEAD, as well as all files that are not tracked by git.\n   */\n  static async listChangedFiles(ref: string) {\n    if (!ref) {\n      throw new Error('ref is required');\n    }\n\n    let diffRef = ref;\n    try {\n      const [base] = await runGit('merge-base', 'HEAD', ref);\n      diffRef = base;\n    } catch {\n      // silently fall back to using the ref directly if merge base is not available\n    }\n\n    const tracked = await runGit('diff', '--name-only', diffRef);\n    const untracked = await runGit(\n      'ls-files',\n      '--others',\n      '--exclude-standard',\n    );\n\n    return Array.from(new Set([...tracked, ...untracked]));\n  }\n\n  /**\n   * Returns the contents of a file at a specific ref.\n   */\n  static async readFileAtRef(path: string, ref: string) {\n    let showRef = ref;\n    try {\n      const [base] = await runGit('merge-base', 'HEAD', ref);\n      showRef = base;\n    } catch {\n      // silently fall back to using the ref directly if merge base is not available\n    }\n\n    const { stdout } = await execFile('git', ['show', `${showRef}:${path}`], {\n      shell: true,\n      cwd: paths.targetRoot,\n      maxBuffer: 1024 * 1024 * 50,\n    });\n    return stdout;\n  }\n}\n"],"names":["execFile","paths","assertError","ForwardedError"],"mappings":";;;;;AAsBA,eAAsB,UAAU,IAAgB,EAAA;AAC9C,EAAI,IAAA;AACF,IAAA,MAAM,EAAE,MAAO,EAAA,GAAI,MAAMA,aAAA,CAAS,OAAO,IAAM,EAAA;AAAA,MAC7C,KAAO,EAAA,IAAA;AAAA,MACP,KAAKC,UAAM,CAAA;AAAA,KACZ,CAAA;AACD,IAAA,OAAO,MAAO,CAAA,IAAA,EAAO,CAAA,KAAA,CAAM,YAAY,CAAA;AAAA,WAChC,KAAO,EAAA;AACd,IAAAC,kBAAA,CAAY,KAAK,CAAA;AACjB,IAAA,IAAI,KAAM,CAAA,MAAA,IAAU,OAAO,KAAA,CAAM,SAAS,QAAU,EAAA;AAClD,MAAA,MAAM,MAAU,GAAA,KAAA,CAAM,MAA+B,EAAA,QAAA,CAAS,MAAM,CAAA;AACpE,MAAA,MAAM,MAAM,MAAQ,EAAA,IAAA,EAAU,IAAA,CAAA,eAAA,EAAkB,MAAM,IAAI,CAAA,CAAA;AAC1D,MAAM,MAAA,IAAI,MAAM,CAAO,IAAA,EAAA,IAAA,CAAK,CAAC,CAAC,CAAA,SAAA,EAAY,GAAG,CAAE,CAAA,CAAA;AAAA;AAEjD,IAAM,MAAA,IAAIC,qBAAe,CAAA,yBAAA,EAA2B,KAAK,CAAA;AAAA;AAE7D;AAOO,MAAM,QAAS,CAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAKpB,aAAa,iBAAiB,GAAa,EAAA;AACzC,IAAA,IAAI,CAAC,GAAK,EAAA;AACR,MAAM,MAAA,IAAI,MAAM,iBAAiB,CAAA;AAAA;AAGnC,IAAA,IAAI,OAAU,GAAA,GAAA;AACd,IAAI,IAAA;AACF,MAAA,MAAM,CAAC,IAAI,CAAA,GAAI,MAAM,MAAO,CAAA,YAAA,EAAc,QAAQ,GAAG,CAAA;AACrD,MAAU,OAAA,GAAA,IAAA;AAAA,KACJ,CAAA,MAAA;AAAA;AAIR,IAAA,MAAM,OAAU,GAAA,MAAM,MAAO,CAAA,MAAA,EAAQ,eAAe,OAAO,CAAA;AAC3D,IAAA,MAAM,YAAY,MAAM,MAAA;AAAA,MACtB,UAAA;AAAA,MACA,UAAA;AAAA,MACA;AAAA,KACF;AAEA,IAAO,OAAA,KAAA,CAAM,IAAK,iBAAA,IAAI,GAAI,CAAA,CAAC,GAAG,OAAS,EAAA,GAAG,SAAS,CAAC,CAAC,CAAA;AAAA;AACvD;AAAA;AAAA;AAAA,EAKA,aAAa,aAAc,CAAA,IAAA,EAAc,GAAa,EAAA;AACpD,IAAA,IAAI,OAAU,GAAA,GAAA;AACd,IAAI,IAAA;AACF,MAAA,MAAM,CAAC,IAAI,CAAA,GAAI,MAAM,MAAO,CAAA,YAAA,EAAc,QAAQ,GAAG,CAAA;AACrD,MAAU,OAAA,GAAA,IAAA;AAAA,KACJ,CAAA,MAAA;AAAA;AAIR,IAAA,MAAM,EAAE,MAAA,EAAW,GAAA,MAAMH,aAAS,CAAA,KAAA,EAAO,CAAC,MAAA,EAAQ,CAAG,EAAA,OAAO,CAAI,CAAA,EAAA,IAAI,EAAE,CAAG,EAAA;AAAA,MACvE,KAAO,EAAA,IAAA;AAAA,MACP,KAAKC,UAAM,CAAA,UAAA;AAAA,MACX,SAAA,EAAW,OAAO,IAAO,GAAA;AAAA,KAC1B,CAAA;AACD,IAAO,OAAA,MAAA;AAAA;AAEX;;;;;"}