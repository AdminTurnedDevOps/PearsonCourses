{"version":3,"file":"Lockfile.cjs.js","sources":["../../src/monorepo/Lockfile.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { parseSyml } from '@yarnpkg/parsers';\nimport crypto from 'node:crypto';\nimport fs from 'fs-extra';\n\nconst ENTRY_PATTERN = /^((?:@[^/]+\\/)?[^@/]+)@(.+)$/;\n\n/** @internal */\ntype LockfileData = {\n  [entry: string]: {\n    version: string;\n    resolved?: string;\n    integrity?: string /* old */;\n    checksum?: string /* new */;\n    dependencies?: { [name: string]: string };\n    peerDependencies?: { [name: string]: string };\n  };\n};\n\n/** @internal */\ntype LockfileQueryEntry = {\n  range: string;\n  version: string;\n  dataKey: string;\n};\n\n/**\n * An entry for a single difference between two {@link Lockfile}s.\n *\n * @public\n */\nexport type LockfileDiffEntry = {\n  name: string;\n  range: string;\n};\n\n/**\n * Represents the difference between two {@link Lockfile}s.\n *\n * @public\n */\nexport type LockfileDiff = {\n  added: LockfileDiffEntry[];\n  changed: LockfileDiffEntry[];\n  removed: LockfileDiffEntry[];\n};\n\n// these are special top level yarn keys.\n// https://github.com/yarnpkg/berry/blob/9bd61fbffb83d0b8166a9cc26bec3a58743aa453/packages/yarnpkg-parsers/sources/syml.ts#L9\nconst SPECIAL_OBJECT_KEYS = [\n  `__metadata`,\n  `version`,\n  `resolution`,\n  `dependencies`,\n  `peerDependencies`,\n  `dependenciesMeta`,\n  `peerDependenciesMeta`,\n  `binaries`,\n];\n\n/**\n * Represents a package manager lockfile.\n *\n * @public\n */\nexport class Lockfile {\n  /**\n   * Load a {@link Lockfile} from a file path.\n   */\n  static async load(path: string): Promise<Lockfile> {\n    const lockfileContents = await fs.readFile(path, 'utf8');\n    return Lockfile.parse(lockfileContents);\n  }\n\n  /**\n   * Parse lockfile contents into a {@link Lockfile}.\n   *\n   * @public\n   */\n  static parse(content: string): Lockfile {\n    let data: LockfileData;\n    try {\n      data = parseSyml(content);\n    } catch (err) {\n      throw new Error(`Failed yarn.lock parse, ${err}`);\n    }\n\n    const packages = new Map<string, LockfileQueryEntry[]>();\n\n    for (const [key, value] of Object.entries(data)) {\n      if (SPECIAL_OBJECT_KEYS.includes(key)) continue;\n\n      const [, name, ranges] = ENTRY_PATTERN.exec(key) ?? [];\n      if (!name) {\n        throw new Error(`Failed to parse yarn.lock entry '${key}'`);\n      }\n\n      let queries = packages.get(name);\n      if (!queries) {\n        queries = [];\n        packages.set(name, queries);\n      }\n      for (let range of ranges.split(/\\s*,\\s*/)) {\n        if (range.startsWith(`${name}@`)) {\n          range = range.slice(`${name}@`.length);\n        }\n        if (range.startsWith('npm:')) {\n          range = range.slice('npm:'.length);\n        }\n        queries.push({ range, version: value.version, dataKey: key });\n      }\n    }\n\n    return new Lockfile(packages, data);\n  }\n\n  private constructor(\n    private readonly packages: Map<string, LockfileQueryEntry[]>,\n    private readonly data: LockfileData,\n  ) {}\n\n  /**\n   * Creates a simplified dependency graph from the lockfile data, where each\n   * key is a package, and the value is a set of all packages that it depends on\n   * across all versions.\n   */\n  createSimplifiedDependencyGraph(): Map<string, Set<string>> {\n    const graph = new Map<string, Set<string>>();\n\n    for (const [name, entries] of this.packages) {\n      const dependencies = new Set(\n        entries.flatMap(e => {\n          const data = this.data[e.dataKey];\n          return [\n            ...Object.keys(data?.dependencies ?? {}),\n            ...Object.keys(data?.peerDependencies ?? {}),\n          ];\n        }),\n      );\n      graph.set(name, dependencies);\n    }\n\n    return graph;\n  }\n\n  /**\n   * Diff with another lockfile, returning entries that have been\n   * added, changed, and removed compared to the other lockfile.\n   */\n  diff(otherLockfile: Lockfile): LockfileDiff {\n    const diff = {\n      added: new Array<{ name: string; range: string }>(),\n      changed: new Array<{ name: string; range: string }>(),\n      removed: new Array<{ name: string; range: string }>(),\n    };\n\n    // Keeps track of packages that only exist in this lockfile\n    const remainingOldNames = new Set(this.packages.keys());\n\n    for (const [name, otherQueries] of otherLockfile.packages) {\n      remainingOldNames.delete(name);\n\n      const thisQueries = this.packages.get(name);\n      // If the packages doesn't exist in this lockfile, add all entries\n      if (!thisQueries) {\n        diff.removed.push(...otherQueries.map(q => ({ name, range: q.range })));\n        continue;\n      }\n\n      const remainingOldRanges = new Set(thisQueries.map(q => q.range));\n\n      for (const otherQuery of otherQueries) {\n        remainingOldRanges.delete(otherQuery.range);\n\n        const thisQuery = thisQueries.find(q => q.range === otherQuery.range);\n        if (!thisQuery) {\n          diff.removed.push({ name, range: otherQuery.range });\n          continue;\n        }\n\n        const otherPkg = otherLockfile.data[otherQuery.dataKey];\n        const thisPkg = this.data[thisQuery.dataKey];\n        if (otherPkg && thisPkg) {\n          const thisCheck = thisPkg.integrity || thisPkg.checksum;\n          const otherCheck = otherPkg.integrity || otherPkg.checksum;\n          if (thisCheck !== otherCheck) {\n            diff.changed.push({ name, range: otherQuery.range });\n          }\n        }\n      }\n\n      for (const thisRange of remainingOldRanges) {\n        diff.added.push({ name, range: thisRange });\n      }\n    }\n\n    for (const name of remainingOldNames) {\n      const queries = this.packages.get(name) ?? [];\n      diff.added.push(...queries.map(q => ({ name, range: q.range })));\n    }\n\n    return diff;\n  }\n\n  /**\n   * Generates a sha1 hex hash of the dependency graph for a package.\n   */\n  getDependencyTreeHash(startName: string): string {\n    if (!this.packages.has(startName)) {\n      throw new Error(`Package '${startName}' not found in lockfile`);\n    }\n\n    const hash = crypto.createHash('sha1');\n\n    const queue = [startName];\n    const seen = new Set<string>();\n\n    while (queue.length > 0) {\n      const name = queue.pop()!;\n\n      if (seen.has(name)) {\n        continue;\n      }\n      seen.add(name);\n\n      const entries = this.packages.get(name);\n      if (!entries) {\n        continue; // In case of missing optional peer dependencies\n      }\n\n      hash.update(`pkg:${name}`);\n      hash.update('\\0');\n\n      // TODO(Rugvip): This uses the same simplified lookup as createSimplifiedDependencyGraph()\n      //               we could match version queries to make the resulting tree a bit smaller.\n      const deps = new Array<string>();\n      for (const entry of entries) {\n        // We're not being particular about stable ordering here. If the lockfile ordering changes, so will likely hash.\n        hash.update(entry.version);\n\n        const data = this.data[entry.dataKey];\n        if (!data) {\n          continue;\n        }\n\n        const checksum = data.checksum || data.integrity;\n        if (checksum) {\n          hash.update('#');\n          hash.update(checksum);\n        }\n\n        hash.update(' ');\n\n        deps.push(...Object.keys(data.dependencies ?? {}));\n        deps.push(...Object.keys(data.peerDependencies ?? {}));\n      }\n\n      queue.push(...new Set(deps));\n    }\n\n    return hash.digest('hex');\n  }\n}\n"],"names":["fs","parseSyml","crypto"],"mappings":"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"}