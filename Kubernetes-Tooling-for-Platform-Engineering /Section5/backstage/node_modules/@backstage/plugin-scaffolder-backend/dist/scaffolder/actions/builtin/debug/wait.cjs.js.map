{"version":3,"file":"wait.cjs.js","sources":["../../../../../src/scaffolder/actions/builtin/debug/wait.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { createTemplateAction } from '@backstage/plugin-scaffolder-node';\nimport { HumanDuration } from '@backstage/types';\nimport { Duration } from 'luxon';\nimport { examples } from './wait.examples';\n\nconst id = 'debug:wait';\n\nconst MAX_WAIT_TIME_IN_ISO = 'T00:10:00';\n\n/**\n * Waits for a certain period of time.\n *\n * @remarks\n *\n * This task is useful to give some waiting time for manual intervention.\n * Has to be used in a combination with other actions.\n *\n * @public\n */\nexport function createWaitAction(options?: {\n  maxWaitTime?: Duration | HumanDuration;\n}) {\n  const toDuration = (\n    maxWaitTime: Duration | HumanDuration | undefined,\n  ): Duration => {\n    if (maxWaitTime) {\n      if (maxWaitTime instanceof Duration) {\n        return maxWaitTime;\n      }\n      return Duration.fromObject(maxWaitTime);\n    }\n    return Duration.fromISOTime(MAX_WAIT_TIME_IN_ISO);\n  };\n\n  return createTemplateAction<HumanDuration>({\n    id,\n    description: 'Waits for a certain period of time.',\n    examples,\n    schema: {\n      input: {\n        type: 'object',\n        properties: {\n          minutes: {\n            title: 'Waiting period in minutes.',\n            type: 'number',\n          },\n          seconds: {\n            title: 'Waiting period in seconds.',\n            type: 'number',\n          },\n          milliseconds: {\n            title: 'Waiting period in milliseconds.',\n            type: 'number',\n          },\n        },\n      },\n    },\n    async handler(ctx) {\n      const delayTime = Duration.fromObject(ctx.input);\n      const maxWait = toDuration(options?.maxWaitTime);\n\n      if (delayTime.minus(maxWait).toMillis() > 0) {\n        throw new Error(\n          `Waiting duration is longer than the maximum threshold of ${maxWait.toHuman()}`,\n        );\n      }\n\n      await new Promise(resolve => {\n        const controller = new AbortController();\n        const timeoutHandle = setTimeout(abort, delayTime.toMillis());\n        ctx.signal?.addEventListener('abort', abort);\n\n        function abort() {\n          ctx.signal?.removeEventListener('abort', abort);\n          clearTimeout(timeoutHandle!);\n          controller.abort();\n          resolve('finished');\n        }\n      });\n    },\n  });\n}\n"],"names":["Duration","createTemplateAction","examples"],"mappings":";;;;;;AAqBA,MAAM,EAAK,GAAA,YAAA;AAEX,MAAM,oBAAuB,GAAA,WAAA;AAYtB,SAAS,iBAAiB,OAE9B,EAAA;AACD,EAAM,MAAA,UAAA,GAAa,CACjB,WACa,KAAA;AACb,IAAA,IAAI,WAAa,EAAA;AACf,MAAA,IAAI,uBAAuBA,cAAU,EAAA;AACnC,QAAO,OAAA,WAAA;AAAA;AAET,MAAO,OAAAA,cAAA,CAAS,WAAW,WAAW,CAAA;AAAA;AAExC,IAAO,OAAAA,cAAA,CAAS,YAAY,oBAAoB,CAAA;AAAA,GAClD;AAEA,EAAA,OAAOC,yCAAoC,CAAA;AAAA,IACzC,EAAA;AAAA,IACA,WAAa,EAAA,qCAAA;AAAA,cACbC,sBAAA;AAAA,IACA,MAAQ,EAAA;AAAA,MACN,KAAO,EAAA;AAAA,QACL,IAAM,EAAA,QAAA;AAAA,QACN,UAAY,EAAA;AAAA,UACV,OAAS,EAAA;AAAA,YACP,KAAO,EAAA,4BAAA;AAAA,YACP,IAAM,EAAA;AAAA,WACR;AAAA,UACA,OAAS,EAAA;AAAA,YACP,KAAO,EAAA,4BAAA;AAAA,YACP,IAAM,EAAA;AAAA,WACR;AAAA,UACA,YAAc,EAAA;AAAA,YACZ,KAAO,EAAA,iCAAA;AAAA,YACP,IAAM,EAAA;AAAA;AACR;AACF;AACF,KACF;AAAA,IACA,MAAM,QAAQ,GAAK,EAAA;AACjB,MAAA,MAAM,SAAY,GAAAF,cAAA,CAAS,UAAW,CAAA,GAAA,CAAI,KAAK,CAAA;AAC/C,MAAM,MAAA,OAAA,GAAU,UAAW,CAAA,OAAA,EAAS,WAAW,CAAA;AAE/C,MAAA,IAAI,UAAU,KAAM,CAAA,OAAO,CAAE,CAAA,QAAA,KAAa,CAAG,EAAA;AAC3C,QAAA,MAAM,IAAI,KAAA;AAAA,UACR,CAAA,yDAAA,EAA4D,OAAQ,CAAA,OAAA,EAAS,CAAA;AAAA,SAC/E;AAAA;AAGF,MAAM,MAAA,IAAI,QAAQ,CAAW,OAAA,KAAA;AAC3B,QAAM,MAAA,UAAA,GAAa,IAAI,eAAgB,EAAA;AACvC,QAAA,MAAM,aAAgB,GAAA,UAAA,CAAW,KAAO,EAAA,SAAA,CAAU,UAAU,CAAA;AAC5D,QAAI,GAAA,CAAA,MAAA,EAAQ,gBAAiB,CAAA,OAAA,EAAS,KAAK,CAAA;AAE3C,QAAA,SAAS,KAAQ,GAAA;AACf,UAAI,GAAA,CAAA,MAAA,EAAQ,mBAAoB,CAAA,OAAA,EAAS,KAAK,CAAA;AAC9C,UAAA,YAAA,CAAa,aAAc,CAAA;AAC3B,UAAA,UAAA,CAAW,KAAM,EAAA;AACjB,UAAA,OAAA,CAAQ,UAAU,CAAA;AAAA;AACpB,OACD,CAAA;AAAA;AACH,GACD,CAAA;AACH;;;;"}