{"version":3,"file":"rules.cjs.js","sources":["../../src/service/rules.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { makeCreatePermissionRule } from '@backstage/plugin-permission-node';\nimport {\n  RESOURCE_TYPE_SCAFFOLDER_TEMPLATE,\n  RESOURCE_TYPE_SCAFFOLDER_ACTION,\n} from '@backstage/plugin-scaffolder-common/alpha';\n\nimport {\n  TemplateEntityStepV1beta3,\n  TemplateParametersV1beta3,\n} from '@backstage/plugin-scaffolder-common';\n\nimport { z } from 'zod';\nimport { JsonObject, JsonPrimitive } from '@backstage/types';\nimport { get } from 'lodash';\n\nexport const createTemplatePermissionRule = makeCreatePermissionRule<\n  TemplateEntityStepV1beta3 | TemplateParametersV1beta3,\n  {},\n  typeof RESOURCE_TYPE_SCAFFOLDER_TEMPLATE\n>();\n\nexport const hasTag = createTemplatePermissionRule({\n  name: 'HAS_TAG',\n  resourceType: RESOURCE_TYPE_SCAFFOLDER_TEMPLATE,\n  description: `Match parameters or steps with the given tag`,\n  paramsSchema: z.object({\n    tag: z.string().describe('Name of the tag to match on'),\n  }),\n  apply: (resource, { tag }) => {\n    return resource['backstage:permissions']?.tags?.includes(tag) ?? false;\n  },\n  toQuery: () => ({}),\n});\n\nexport const createActionPermissionRule = makeCreatePermissionRule<\n  {\n    action: string;\n    input: JsonObject | undefined;\n  },\n  {},\n  typeof RESOURCE_TYPE_SCAFFOLDER_ACTION\n>();\n\nexport const hasActionId = createActionPermissionRule({\n  name: 'HAS_ACTION_ID',\n  resourceType: RESOURCE_TYPE_SCAFFOLDER_ACTION,\n  description: `Match actions with the given actionId`,\n  paramsSchema: z.object({\n    actionId: z.string().describe('Name of the actionId to match on'),\n  }),\n  apply: (resource, { actionId }) => {\n    return resource.action === actionId;\n  },\n  toQuery: () => ({}),\n});\n\nexport const hasProperty = buildHasProperty({\n  name: 'HAS_PROPERTY',\n  valueSchema: z.union([z.string(), z.number(), z.boolean(), z.null()]),\n  validateProperty: false,\n});\n\nexport const hasBooleanProperty = buildHasProperty({\n  name: 'HAS_BOOLEAN_PROPERTY',\n  valueSchema: z.boolean(),\n});\nexport const hasNumberProperty = buildHasProperty({\n  name: 'HAS_NUMBER_PROPERTY',\n  valueSchema: z.number(),\n});\nexport const hasStringProperty = buildHasProperty({\n  name: 'HAS_STRING_PROPERTY',\n  valueSchema: z.string(),\n});\n\nfunction buildHasProperty<Schema extends z.ZodType<JsonPrimitive>>({\n  name,\n  valueSchema,\n  validateProperty = true,\n}: {\n  name: string;\n  valueSchema: Schema;\n  validateProperty?: boolean;\n}) {\n  return createActionPermissionRule({\n    name,\n    description: `Allow actions with the specified property`,\n    resourceType: RESOURCE_TYPE_SCAFFOLDER_ACTION,\n    paramsSchema: z.object({\n      key: z\n        .string()\n        .describe(`Property within the action parameters to match on`),\n      value: valueSchema\n        .optional()\n        .describe(`Value of the given property to match on`),\n    }) as unknown as z.ZodType<{ key: string; value?: z.infer<Schema> }>,\n    apply: (resource, { key, value }) => {\n      const foundValue = get(resource.input, key);\n\n      if (validateProperty && !valueSchema.safeParse(foundValue).success) {\n        return false;\n      }\n      if (value !== undefined) {\n        if (valueSchema.safeParse(value).success) {\n          return value === foundValue;\n        }\n        return false;\n      }\n\n      return foundValue !== undefined;\n    },\n    toQuery: () => ({}),\n  });\n}\n\nexport const scaffolderTemplateRules = { hasTag };\nexport const scaffolderActionRules = {\n  hasActionId,\n  hasBooleanProperty,\n  hasNumberProperty,\n  hasStringProperty,\n};\n"],"names":["makeCreatePermissionRule","RESOURCE_TYPE_SCAFFOLDER_TEMPLATE","z","RESOURCE_TYPE_SCAFFOLDER_ACTION","get"],"mappings":"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"}