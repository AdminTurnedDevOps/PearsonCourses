{"version":3,"file":"plugin.cjs.js","sources":["../src/plugin.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  coreServices,\n  createBackendPlugin,\n} from '@backstage/backend-plugin-api';\nimport { catalogServiceRef } from '@backstage/plugin-catalog-node/alpha';\n\nimport { KubernetesBuilder } from './service';\n\nimport {\n  type AuthenticationStrategy,\n  kubernetesAuthStrategyExtensionPoint,\n  type KubernetesAuthStrategyExtensionPoint,\n  type KubernetesClustersSupplier,\n  kubernetesClusterSupplierExtensionPoint,\n  type KubernetesClusterSupplierExtensionPoint,\n  type KubernetesFetcher,\n  kubernetesFetcherExtensionPoint,\n  type KubernetesFetcherExtensionPoint,\n  type KubernetesObjectsProvider,\n  kubernetesObjectsProviderExtensionPoint,\n  type KubernetesObjectsProviderExtensionPoint,\n  type KubernetesServiceLocator,\n  kubernetesServiceLocatorExtensionPoint,\n  type KubernetesServiceLocatorExtensionPoint,\n} from '@backstage/plugin-kubernetes-node';\n\nclass ObjectsProvider implements KubernetesObjectsProviderExtensionPoint {\n  private objectsProvider: KubernetesObjectsProvider | undefined;\n\n  getObjectsProvider() {\n    return this.objectsProvider;\n  }\n\n  addObjectsProvider(provider: KubernetesObjectsProvider) {\n    if (this.objectsProvider) {\n      throw new Error(\n        'Multiple Kubernetes objects provider is not supported at this time',\n      );\n    }\n    this.objectsProvider = provider;\n  }\n}\n\nclass ClusterSuplier implements KubernetesClusterSupplierExtensionPoint {\n  private clusterSupplier: KubernetesClustersSupplier | undefined;\n\n  getClusterSupplier() {\n    return this.clusterSupplier;\n  }\n\n  addClusterSupplier(clusterSupplier: KubernetesClustersSupplier) {\n    if (this.clusterSupplier) {\n      throw new Error(\n        'Multiple Kubernetes Cluster Suppliers is not supported at this time',\n      );\n    }\n    this.clusterSupplier = clusterSupplier;\n  }\n}\n\nclass Fetcher implements KubernetesFetcherExtensionPoint {\n  private fetcher: KubernetesFetcher | undefined;\n\n  getFetcher() {\n    return this.fetcher;\n  }\n\n  addFetcher(fetcher: KubernetesFetcher) {\n    if (this.fetcher) {\n      throw new Error(\n        'Multiple Kubernetes Fetchers is not supported at this time',\n      );\n    }\n    this.fetcher = fetcher;\n  }\n}\n\nclass ServiceLocator implements KubernetesServiceLocatorExtensionPoint {\n  private serviceLocator: KubernetesServiceLocator | undefined;\n\n  getServiceLocator() {\n    return this.serviceLocator;\n  }\n\n  addServiceLocator(serviceLocator: KubernetesServiceLocator) {\n    if (this.serviceLocator) {\n      throw new Error(\n        'Multiple Kubernetes Service Locators is not supported at this time',\n      );\n    }\n    this.serviceLocator = serviceLocator;\n  }\n}\n\nclass AuthStrategy implements KubernetesAuthStrategyExtensionPoint {\n  private authStrategies: Array<{\n    key: string;\n    strategy: AuthenticationStrategy;\n  }>;\n\n  constructor() {\n    this.authStrategies = new Array<{\n      key: string;\n      strategy: AuthenticationStrategy;\n    }>();\n  }\n\n  static addAuthStrategiesFromArray(\n    authStrategies: Array<{ key: string; strategy: AuthenticationStrategy }>,\n    builder: KubernetesBuilder,\n  ) {\n    authStrategies.forEach(st => builder.addAuthStrategy(st.key, st.strategy));\n  }\n\n  getAuthenticationStrategies() {\n    return this.authStrategies;\n  }\n\n  addAuthStrategy(key: string, authStrategy: AuthenticationStrategy) {\n    this.authStrategies.push({ key, strategy: authStrategy });\n  }\n}\n\n/**\n * This is the backend plugin that provides the Kubernetes integration.\n * @public\n */\nexport const kubernetesPlugin = createBackendPlugin({\n  pluginId: 'kubernetes',\n  register(env) {\n    const extPointObjectsProvider = new ObjectsProvider();\n    const extPointClusterSuplier = new ClusterSuplier();\n    const extPointAuthStrategy = new AuthStrategy();\n    const extPointFetcher = new Fetcher();\n    const extPointServiceLocator = new ServiceLocator();\n\n    env.registerExtensionPoint(\n      kubernetesObjectsProviderExtensionPoint,\n      extPointObjectsProvider,\n    );\n    env.registerExtensionPoint(\n      kubernetesClusterSupplierExtensionPoint,\n      extPointClusterSuplier,\n    );\n    env.registerExtensionPoint(\n      kubernetesAuthStrategyExtensionPoint,\n      extPointAuthStrategy,\n    );\n    env.registerExtensionPoint(\n      kubernetesFetcherExtensionPoint,\n      extPointFetcher,\n    );\n    env.registerExtensionPoint(\n      kubernetesServiceLocatorExtensionPoint,\n      extPointServiceLocator,\n    );\n\n    env.registerInit({\n      deps: {\n        http: coreServices.httpRouter,\n        logger: coreServices.logger,\n        config: coreServices.rootConfig,\n        discovery: coreServices.discovery,\n        catalogApi: catalogServiceRef,\n        permissions: coreServices.permissions,\n        auth: coreServices.auth,\n        httpAuth: coreServices.httpAuth,\n      },\n      async init({\n        http,\n        logger,\n        config,\n        discovery,\n        catalogApi,\n        permissions,\n        auth,\n        httpAuth,\n      }) {\n        if (config.has('kubernetes')) {\n          // TODO: expose all of the customization & extension points of the builder here\n          const builder: KubernetesBuilder = KubernetesBuilder.createBuilder({\n            logger,\n            config,\n            catalogApi,\n            permissions,\n            discovery,\n            auth,\n            httpAuth,\n          })\n            .setObjectsProvider(extPointObjectsProvider.getObjectsProvider())\n            .setClusterSupplier(extPointClusterSuplier.getClusterSupplier())\n            .setFetcher(extPointFetcher.getFetcher())\n            .setServiceLocator(extPointServiceLocator.getServiceLocator());\n\n          AuthStrategy.addAuthStrategiesFromArray(\n            extPointAuthStrategy.getAuthenticationStrategies(),\n            builder,\n          );\n          const { router } = await builder.build();\n          http.use(router);\n        } else {\n          logger.warn(\n            'Failed to initialize kubernetes backend: valid kubernetes config is missing',\n          );\n        }\n      },\n    });\n  },\n});\n"],"names":["createBackendPlugin","kubernetesObjectsProviderExtensionPoint","kubernetesClusterSupplierExtensionPoint","kubernetesAuthStrategyExtensionPoint","kubernetesFetcherExtensionPoint","kubernetesServiceLocatorExtensionPoint","coreServices","catalogServiceRef","KubernetesBuilder"],"mappings":"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"}