{"version":3,"file":"KubernetesFanOutHandler.cjs.js","sources":["../../src/service/KubernetesFanOutHandler.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Entity } from '@backstage/catalog-model';\nimport {\n  CustomResource,\n  FetchResponseWrapper,\n  KubernetesFetcher,\n  KubernetesObjectsProviderOptions,\n  KubernetesServiceLocator,\n  ObjectsByEntityRequest,\n  ObjectToFetch,\n} from '../types/types';\nimport {\n  ClientContainerStatus,\n  ClientCurrentResourceUsage,\n  ClientPodStatus,\n  ClusterObjects,\n  CustomResourceMatcher,\n  FetchResponse,\n  KubernetesRequestAuth,\n  ObjectsByEntityResponse,\n  PodFetchResponse,\n  PodStatusFetchResponse,\n} from '@backstage/plugin-kubernetes-common';\nimport {\n  ContainerStatus,\n  CurrentResourceUsage,\n  PodStatus,\n} from '@kubernetes/client-node';\nimport {\n  AuthenticationStrategy,\n  ClusterDetails,\n  CustomResourcesByEntity,\n  KubernetesCredential,\n  KubernetesObjectsByEntity,\n  KubernetesObjectsProvider,\n} from '@backstage/plugin-kubernetes-node';\nimport {\n  BackstageCredentials,\n  LoggerService,\n} from '@backstage/backend-plugin-api';\n\n/**\n *\n * @public\n */\nexport const DEFAULT_OBJECTS: ObjectToFetch[] = [\n  {\n    group: '',\n    apiVersion: 'v1',\n    plural: 'pods',\n    objectType: 'pods',\n  },\n  {\n    group: '',\n    apiVersion: 'v1',\n    plural: 'services',\n    objectType: 'services',\n  },\n  {\n    group: '',\n    apiVersion: 'v1',\n    plural: 'configmaps',\n    objectType: 'configmaps',\n  },\n  {\n    group: '',\n    apiVersion: 'v1',\n    plural: 'limitranges',\n    objectType: 'limitranges',\n  },\n  {\n    group: '',\n    apiVersion: 'v1',\n    plural: 'resourcequotas',\n    objectType: 'resourcequotas',\n  },\n  {\n    group: 'apps',\n    apiVersion: 'v1',\n    plural: 'deployments',\n    objectType: 'deployments',\n  },\n  {\n    group: 'apps',\n    apiVersion: 'v1',\n    plural: 'replicasets',\n    objectType: 'replicasets',\n  },\n  {\n    group: 'autoscaling',\n    apiVersion: 'v2',\n    plural: 'horizontalpodautoscalers',\n    objectType: 'horizontalpodautoscalers',\n  },\n  {\n    group: 'batch',\n    apiVersion: 'v1',\n    plural: 'jobs',\n    objectType: 'jobs',\n  },\n  {\n    group: 'batch',\n    apiVersion: 'v1',\n    plural: 'cronjobs',\n    objectType: 'cronjobs',\n  },\n  {\n    group: 'networking.k8s.io',\n    apiVersion: 'v1',\n    plural: 'ingresses',\n    objectType: 'ingresses',\n  },\n  {\n    group: 'apps',\n    apiVersion: 'v1',\n    plural: 'statefulsets',\n    objectType: 'statefulsets',\n  },\n  {\n    group: 'apps',\n    apiVersion: 'v1',\n    plural: 'daemonsets',\n    objectType: 'daemonsets',\n  },\n];\n\nexport interface KubernetesFanOutHandlerOptions\n  extends KubernetesObjectsProviderOptions {\n  authStrategy: AuthenticationStrategy;\n}\n\nexport interface KubernetesRequestBody extends ObjectsByEntityRequest {}\n\nconst isPodFetchResponse = (fr: FetchResponse): fr is PodFetchResponse =>\n  fr.type === 'pods' ||\n  (fr.type === 'customresources' &&\n    fr.resources.length > 0 &&\n    fr.resources[0].apiVersion === 'v1' &&\n    fr.resources[0].kind === 'Pod');\nconst isString = (str: string | undefined): str is string => str !== undefined;\n\nconst numberOrBigIntToNumberOrString = (\n  value: number | BigInt,\n): number | string => {\n  return typeof value === 'bigint' ? value.toString() : (value as number);\n};\n\nconst toClientSafeResource = (\n  current: CurrentResourceUsage,\n): ClientCurrentResourceUsage => {\n  return {\n    currentUsage: numberOrBigIntToNumberOrString(current.CurrentUsage),\n    requestTotal: numberOrBigIntToNumberOrString(current.RequestTotal),\n    limitTotal: numberOrBigIntToNumberOrString(current.LimitTotal),\n  };\n};\n\nconst toClientSafeContainer = (\n  container: ContainerStatus,\n): ClientContainerStatus => {\n  return {\n    container: container.Container,\n    cpuUsage: toClientSafeResource(container.CPUUsage),\n    memoryUsage: toClientSafeResource(container.MemoryUsage),\n  };\n};\n\nconst toClientSafePodMetrics = (\n  podMetrics: PodStatusFetchResponse[],\n): ClientPodStatus[] => {\n  return podMetrics\n    .map(r => r.resources)\n    .flat()\n    .map((pd: PodStatus): ClientPodStatus => {\n      return {\n        pod: pd.Pod,\n        memory: toClientSafeResource(pd.Memory),\n        cpu: toClientSafeResource(pd.CPU),\n        containers: pd.Containers.map(toClientSafeContainer),\n      };\n    });\n};\n\ntype responseWithMetrics = [FetchResponseWrapper, PodStatusFetchResponse[]];\n\nexport class KubernetesFanOutHandler implements KubernetesObjectsProvider {\n  private readonly logger: LoggerService;\n  private readonly fetcher: KubernetesFetcher;\n  private readonly serviceLocator: KubernetesServiceLocator;\n  private readonly customResources: CustomResource[];\n  private readonly objectTypesToFetch: Set<ObjectToFetch>;\n  private readonly authStrategy: AuthenticationStrategy;\n\n  constructor({\n    logger,\n    fetcher,\n    serviceLocator,\n    customResources,\n    objectTypesToFetch = DEFAULT_OBJECTS,\n    authStrategy,\n  }: KubernetesFanOutHandlerOptions) {\n    this.logger = logger;\n    this.fetcher = fetcher;\n    this.serviceLocator = serviceLocator;\n    this.customResources = customResources;\n    this.objectTypesToFetch = new Set(objectTypesToFetch);\n    this.authStrategy = authStrategy;\n  }\n\n  async getCustomResourcesByEntity(\n    { entity, auth, customResources }: CustomResourcesByEntity,\n    options: { credentials: BackstageCredentials },\n  ): Promise<ObjectsByEntityResponse> {\n    // Don't fetch the default object types only the provided custom resources\n    return this.fanOutRequests(\n      entity,\n      auth,\n      { credentials: options.credentials },\n      new Set<ObjectToFetch>(),\n      customResources,\n    );\n  }\n\n  async getKubernetesObjectsByEntity(\n    { entity, auth }: KubernetesObjectsByEntity,\n    options: { credentials: BackstageCredentials },\n  ): Promise<ObjectsByEntityResponse> {\n    return this.fanOutRequests(\n      entity,\n      auth,\n      {\n        credentials: options.credentials,\n      },\n      this.objectTypesToFetch,\n    );\n  }\n\n  private async fanOutRequests(\n    entity: Entity,\n    auth: KubernetesRequestAuth,\n    options: { credentials: BackstageCredentials },\n    objectTypesToFetch: Set<ObjectToFetch>,\n    customResources?: CustomResourceMatcher[],\n  ) {\n    const entityName =\n      entity.metadata?.annotations?.['backstage.io/kubernetes-id'] ||\n      entity.metadata?.name;\n\n    const { clusters } = await this.serviceLocator.getClustersByEntity(entity, {\n      objectTypesToFetch: objectTypesToFetch,\n      customResources: customResources ?? [],\n      credentials: options.credentials,\n    });\n\n    this.logger.info(\n      `entity.metadata.name=${entityName} clusterDetails=[${clusters\n        .map(c => c.name)\n        .join(', ')}]`,\n    );\n\n    const labelSelector: string =\n      entity.metadata?.annotations?.[\n        'backstage.io/kubernetes-label-selector'\n      ] || `backstage.io/kubernetes-id=${entityName}`;\n\n    const namespace =\n      entity.metadata?.annotations?.['backstage.io/kubernetes-namespace'];\n\n    return Promise.all(\n      clusters.map(async clusterDetails => {\n        const credential = await this.authStrategy.getCredential(\n          clusterDetails,\n          auth,\n        );\n        return this.fetcher\n          .fetchObjectsForService({\n            serviceId: entityName,\n            clusterDetails,\n            credential,\n            objectTypesToFetch,\n            labelSelector,\n            customResources: (\n              customResources ||\n              clusterDetails.customResources ||\n              this.customResources\n            ).map(c => ({\n              ...c,\n              objectType: 'customresources',\n            })),\n            namespace,\n          })\n          .then(result =>\n            this.getMetricsForPods(\n              clusterDetails,\n              credential,\n              labelSelector,\n              result,\n            ),\n          )\n          .catch(\n            (e): Promise<responseWithMetrics> =>\n              e.name === 'FetchError'\n                ? Promise.resolve([\n                    {\n                      errors: [\n                        { errorType: 'FETCH_ERROR', message: e.message },\n                      ],\n                      responses: [],\n                    },\n                    [],\n                  ])\n                : Promise.reject(e),\n          )\n          .then(r => this.toClusterObjects(clusterDetails, r));\n      }),\n    ).then(this.toObjectsByEntityResponse);\n  }\n\n  toObjectsByEntityResponse(\n    clusterObjects: ClusterObjects[],\n  ): ObjectsByEntityResponse {\n    return {\n      items: clusterObjects.filter(\n        item =>\n          (item.errors !== undefined && item.errors.length >= 1) ||\n          (item.resources !== undefined &&\n            item.resources.length >= 1 &&\n            item.resources.some(fr => fr.resources?.length >= 1)),\n      ),\n    };\n  }\n\n  toClusterObjects(\n    clusterDetails: ClusterDetails,\n    [result, metrics]: responseWithMetrics,\n  ): ClusterObjects {\n    const objects: ClusterObjects = {\n      cluster: {\n        name: clusterDetails.name,\n        ...(clusterDetails.title && { title: clusterDetails.title }),\n      },\n      podMetrics: toClientSafePodMetrics(metrics),\n      resources: result.responses,\n      errors: result.errors,\n    };\n    if (clusterDetails.dashboardUrl) {\n      objects.cluster.dashboardUrl = clusterDetails.dashboardUrl;\n    }\n    if (clusterDetails.dashboardApp) {\n      objects.cluster.dashboardApp = clusterDetails.dashboardApp;\n    }\n    if (clusterDetails.dashboardParameters) {\n      objects.cluster.dashboardParameters = clusterDetails.dashboardParameters;\n    }\n    return objects;\n  }\n\n  async getMetricsForPods(\n    clusterDetails: ClusterDetails,\n    credential: KubernetesCredential,\n    labelSelector: string,\n    result: FetchResponseWrapper,\n  ): Promise<responseWithMetrics> {\n    if (clusterDetails.skipMetricsLookup) {\n      return [result, []];\n    }\n    const namespaces: Set<string> = new Set<string>(\n      result.responses\n        .filter(isPodFetchResponse)\n        .flatMap(r => r.resources)\n        .map(p => p.metadata?.namespace)\n        .filter(isString),\n    );\n\n    if (namespaces.size === 0) {\n      return [result, []];\n    }\n\n    const podMetrics = await this.fetcher.fetchPodMetricsByNamespaces(\n      clusterDetails,\n      credential,\n      namespaces,\n      labelSelector,\n    );\n\n    result.errors.push(...podMetrics.errors);\n    return [result, podMetrics.responses as PodStatusFetchResponse[]];\n  }\n}\n"],"names":[],"mappings":"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"}