{"version":3,"file":"CatalogClusterLocator.cjs.js","sources":["../../src/cluster-locator/CatalogClusterLocator.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  AuthService,\n  BackstageCredentials,\n} from '@backstage/backend-plugin-api';\nimport { ClusterDetails, KubernetesClustersSupplier } from '../types/types';\nimport { CATALOG_FILTER_EXISTS, CatalogApi } from '@backstage/catalog-client';\nimport {\n  ANNOTATION_KUBERNETES_API_SERVER,\n  ANNOTATION_KUBERNETES_API_SERVER_CA,\n  ANNOTATION_KUBERNETES_AUTH_PROVIDER,\n  ANNOTATION_KUBERNETES_SKIP_METRICS_LOOKUP,\n  ANNOTATION_KUBERNETES_SKIP_TLS_VERIFY,\n  ANNOTATION_KUBERNETES_DASHBOARD_URL,\n  ANNOTATION_KUBERNETES_DASHBOARD_APP,\n  ANNOTATION_KUBERNETES_DASHBOARD_PARAMETERS,\n} from '@backstage/plugin-kubernetes-common';\nimport { JsonObject } from '@backstage/types';\n\nfunction isObject(obj: unknown): obj is JsonObject {\n  return typeof obj === 'object' && obj !== null && !Array.isArray(obj);\n}\n\nexport class CatalogClusterLocator implements KubernetesClustersSupplier {\n  private catalogClient: CatalogApi;\n  private auth: AuthService;\n\n  constructor(catalogClient: CatalogApi, auth: AuthService) {\n    this.catalogClient = catalogClient;\n    this.auth = auth;\n  }\n\n  static fromConfig(\n    catalogApi: CatalogApi,\n    auth: AuthService,\n  ): CatalogClusterLocator {\n    return new CatalogClusterLocator(catalogApi, auth);\n  }\n\n  async getClusters(options?: {\n    credentials: BackstageCredentials;\n  }): Promise<ClusterDetails[]> {\n    const apiServerKey = `metadata.annotations.${ANNOTATION_KUBERNETES_API_SERVER}`;\n    const apiServerCaKey = `metadata.annotations.${ANNOTATION_KUBERNETES_API_SERVER_CA}`;\n    const authProviderKey = `metadata.annotations.${ANNOTATION_KUBERNETES_AUTH_PROVIDER}`;\n\n    const filter: Record<string, symbol | string> = {\n      kind: 'Resource',\n      'spec.type': 'kubernetes-cluster',\n      [apiServerKey]: CATALOG_FILTER_EXISTS,\n      [apiServerCaKey]: CATALOG_FILTER_EXISTS,\n      [authProviderKey]: CATALOG_FILTER_EXISTS,\n    };\n\n    const clusters = await this.catalogClient.getEntities(\n      {\n        filter: [filter],\n      },\n      options?.credentials\n        ? {\n            token: (\n              await this.auth.getPluginRequestToken({\n                onBehalfOf: options.credentials,\n                targetPluginId: 'catalog',\n              })\n            ).token,\n          }\n        : undefined,\n    );\n    return clusters.items.map(entity => {\n      const annotations = entity.metadata.annotations!;\n      const clusterDetails: ClusterDetails = {\n        name: entity.metadata.name,\n        title: entity.metadata.title,\n        url: annotations[ANNOTATION_KUBERNETES_API_SERVER],\n        authMetadata: annotations,\n        caData: annotations[ANNOTATION_KUBERNETES_API_SERVER_CA],\n        skipMetricsLookup:\n          annotations[ANNOTATION_KUBERNETES_SKIP_METRICS_LOOKUP] === 'true',\n        skipTLSVerify:\n          annotations[ANNOTATION_KUBERNETES_SKIP_TLS_VERIFY] === 'true',\n        dashboardUrl: annotations[ANNOTATION_KUBERNETES_DASHBOARD_URL],\n        dashboardApp: annotations[ANNOTATION_KUBERNETES_DASHBOARD_APP],\n        dashboardParameters: this.getDashboardParameters(annotations),\n      };\n\n      return clusterDetails;\n    });\n  }\n\n  private getDashboardParameters(\n    annotations: Record<string, string>,\n  ): JsonObject | undefined {\n    const dashboardParamsString =\n      annotations[ANNOTATION_KUBERNETES_DASHBOARD_PARAMETERS];\n    if (dashboardParamsString) {\n      try {\n        const dashboardParams = JSON.parse(dashboardParamsString);\n        return isObject(dashboardParams) ? dashboardParams : undefined;\n      } catch {\n        return undefined;\n      }\n    }\n    return undefined;\n  }\n}\n"],"names":["ANNOTATION_KUBERNETES_API_SERVER","ANNOTATION_KUBERNETES_API_SERVER_CA","ANNOTATION_KUBERNETES_AUTH_PROVIDER","CATALOG_FILTER_EXISTS","ANNOTATION_KUBERNETES_SKIP_METRICS_LOOKUP","ANNOTATION_KUBERNETES_SKIP_TLS_VERIFY","ANNOTATION_KUBERNETES_DASHBOARD_URL","ANNOTATION_KUBERNETES_DASHBOARD_APP","ANNOTATION_KUBERNETES_DASHBOARD_PARAMETERS"],"mappings":";;;;;AAkCA,SAAS,SAAS,GAAiC,EAAA;AACjD,EAAO,OAAA,OAAO,QAAQ,QAAY,IAAA,GAAA,KAAQ,QAAQ,CAAC,KAAA,CAAM,QAAQ,GAAG,CAAA;AACtE;AAEO,MAAM,qBAA4D,CAAA;AAAA,EAC/D,aAAA;AAAA,EACA,IAAA;AAAA,EAER,WAAA,CAAY,eAA2B,IAAmB,EAAA;AACxD,IAAA,IAAA,CAAK,aAAgB,GAAA,aAAA;AACrB,IAAA,IAAA,CAAK,IAAO,GAAA,IAAA;AAAA;AACd,EAEA,OAAO,UACL,CAAA,UAAA,EACA,IACuB,EAAA;AACvB,IAAO,OAAA,IAAI,qBAAsB,CAAA,UAAA,EAAY,IAAI,CAAA;AAAA;AACnD,EAEA,MAAM,YAAY,OAEY,EAAA;AAC5B,IAAM,MAAA,YAAA,GAAe,wBAAwBA,uDAAgC,CAAA,CAAA;AAC7E,IAAM,MAAA,cAAA,GAAiB,wBAAwBC,0DAAmC,CAAA,CAAA;AAClF,IAAM,MAAA,eAAA,GAAkB,wBAAwBC,0DAAmC,CAAA,CAAA;AAEnF,IAAA,MAAM,MAA0C,GAAA;AAAA,MAC9C,IAAM,EAAA,UAAA;AAAA,MACN,WAAa,EAAA,oBAAA;AAAA,MACb,CAAC,YAAY,GAAGC,mCAAA;AAAA,MAChB,CAAC,cAAc,GAAGA,mCAAA;AAAA,MAClB,CAAC,eAAe,GAAGA;AAAA,KACrB;AAEA,IAAM,MAAA,QAAA,GAAW,MAAM,IAAA,CAAK,aAAc,CAAA,WAAA;AAAA,MACxC;AAAA,QACE,MAAA,EAAQ,CAAC,MAAM;AAAA,OACjB;AAAA,MACA,SAAS,WACL,GAAA;AAAA,QACE,KACE,EAAA,CAAA,MAAM,IAAK,CAAA,IAAA,CAAK,qBAAsB,CAAA;AAAA,UACpC,YAAY,OAAQ,CAAA,WAAA;AAAA,UACpB,cAAgB,EAAA;AAAA,SACjB,CACD,EAAA;AAAA,OAEJ,GAAA,KAAA;AAAA,KACN;AACA,IAAO,OAAA,QAAA,CAAS,KAAM,CAAA,GAAA,CAAI,CAAU,MAAA,KAAA;AAClC,MAAM,MAAA,WAAA,GAAc,OAAO,QAAS,CAAA,WAAA;AACpC,MAAA,MAAM,cAAiC,GAAA;AAAA,QACrC,IAAA,EAAM,OAAO,QAAS,CAAA,IAAA;AAAA,QACtB,KAAA,EAAO,OAAO,QAAS,CAAA,KAAA;AAAA,QACvB,GAAA,EAAK,YAAYH,uDAAgC,CAAA;AAAA,QACjD,YAAc,EAAA,WAAA;AAAA,QACd,MAAA,EAAQ,YAAYC,0DAAmC,CAAA;AAAA,QACvD,iBAAA,EACE,WAAY,CAAAG,gEAAyC,CAAM,KAAA,MAAA;AAAA,QAC7D,aAAA,EACE,WAAY,CAAAC,4DAAqC,CAAM,KAAA,MAAA;AAAA,QACzD,YAAA,EAAc,YAAYC,0DAAmC,CAAA;AAAA,QAC7D,YAAA,EAAc,YAAYC,0DAAmC,CAAA;AAAA,QAC7D,mBAAA,EAAqB,IAAK,CAAA,sBAAA,CAAuB,WAAW;AAAA,OAC9D;AAEA,MAAO,OAAA,cAAA;AAAA,KACR,CAAA;AAAA;AACH,EAEQ,uBACN,WACwB,EAAA;AACxB,IAAM,MAAA,qBAAA,GACJ,YAAYC,iEAA0C,CAAA;AACxD,IAAA,IAAI,qBAAuB,EAAA;AACzB,MAAI,IAAA;AACF,QAAM,MAAA,eAAA,GAAkB,IAAK,CAAA,KAAA,CAAM,qBAAqB,CAAA;AACxD,QAAO,OAAA,QAAA,CAAS,eAAe,CAAA,GAAI,eAAkB,GAAA,KAAA,CAAA;AAAA,OAC/C,CAAA,MAAA;AACN,QAAO,OAAA,KAAA,CAAA;AAAA;AACT;AAEF,IAAO,OAAA,KAAA,CAAA;AAAA;AAEX;;;;"}