{"version":3,"file":"ReviewState.esm.js","sources":["../../../../src/next/components/ReviewState/ReviewState.tsx"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport React from 'react';\nimport { StructuredMetadataTable } from '@backstage/core-components';\nimport { JsonObject, JsonValue } from '@backstage/types';\nimport { Draft07 as JSONSchema } from 'json-schema-library';\nimport { ParsedTemplateSchema } from '../../hooks/useTemplateSchema';\nimport { isJsonObject, formatKey, findSchemaForKey } from './util';\n\n/**\n * The props for the {@link ReviewState} component.\n * @alpha\n */\nexport type ReviewStateProps = {\n  schemas: ParsedTemplateSchema[];\n  formState: JsonObject;\n};\n\nfunction processSchema(\n  key: string,\n  value: JsonValue | undefined,\n  schema: ParsedTemplateSchema,\n  formState: JsonObject,\n): [string, JsonValue | undefined][] {\n  const parsedSchema = new JSONSchema(schema.mergedSchema);\n  const definitionInSchema = parsedSchema.getSchema({\n    pointer: `#/${key}`,\n    data: formState,\n  });\n\n  const name =\n    definitionInSchema?.['ui:backstage']?.review?.name ??\n    definitionInSchema?.title ??\n    key;\n\n  if (definitionInSchema) {\n    const backstageReviewOptions = definitionInSchema['ui:backstage']?.review;\n    if (backstageReviewOptions) {\n      if (backstageReviewOptions.mask) {\n        return [[name, backstageReviewOptions.mask]];\n      }\n      if (backstageReviewOptions.show === false) {\n        return [];\n      }\n    }\n\n    if (\n      definitionInSchema['ui:widget'] === 'password' ||\n      definitionInSchema['ui:field']?.toLocaleLowerCase('en-us') === 'secret'\n    ) {\n      return [[name, '******']];\n    }\n\n    if (definitionInSchema.enum && definitionInSchema.enumNames) {\n      return [\n        [\n          name,\n          definitionInSchema.enumNames[\n            definitionInSchema.enum.indexOf(value)\n          ] || value,\n        ],\n      ];\n    }\n\n    if (backstageReviewOptions?.explode !== false && isJsonObject(value)) {\n      // Recurse nested objects\n      return Object.entries(value).flatMap(([nestedKey, nestedValue]) =>\n        processSchema(`${key}/${nestedKey}`, nestedValue, schema, formState),\n      );\n    }\n  }\n\n  return [[name, value]];\n}\n\n/**\n * The component used by the {@link Stepper} to render the review step.\n * @alpha\n */\nexport const ReviewState = (props: ReviewStateProps) => {\n  const reviewData = Object.fromEntries(\n    Object.entries(props.formState)\n      .flatMap(([key, value]) => {\n        const schema = findSchemaForKey(key, props.schemas, props.formState);\n        return schema\n          ? processSchema(key, value, schema, props.formState)\n          : [[key, value]];\n      })\n      .filter(prop => prop.length > 0),\n  );\n  const options = {\n    titleFormat: formatKey,\n  };\n  return <StructuredMetadataTable metadata={reviewData} options={options} />;\n};\n"],"names":["JSONSchema"],"mappings":";;;;;AA+BA,SAAS,aACP,CAAA,GAAA,EACA,KACA,EAAA,MAAA,EACA,SACmC,EAAA;AACnC,EAAA,MAAM,YAAe,GAAA,IAAIA,OAAW,CAAA,MAAA,CAAO,YAAY,CAAA;AACvD,EAAM,MAAA,kBAAA,GAAqB,aAAa,SAAU,CAAA;AAAA,IAChD,OAAA,EAAS,KAAK,GAAG,CAAA,CAAA;AAAA,IACjB,IAAM,EAAA;AAAA,GACP,CAAA;AAED,EAAA,MAAM,OACJ,kBAAqB,GAAA,cAAc,GAAG,MAAQ,EAAA,IAAA,IAC9C,oBAAoB,KACpB,IAAA,GAAA;AAEF,EAAA,IAAI,kBAAoB,EAAA;AACtB,IAAM,MAAA,sBAAA,GAAyB,kBAAmB,CAAA,cAAc,CAAG,EAAA,MAAA;AACnE,IAAA,IAAI,sBAAwB,EAAA;AAC1B,MAAA,IAAI,uBAAuB,IAAM,EAAA;AAC/B,QAAA,OAAO,CAAC,CAAC,IAAM,EAAA,sBAAA,CAAuB,IAAI,CAAC,CAAA;AAAA;AAE7C,MAAI,IAAA,sBAAA,CAAuB,SAAS,KAAO,EAAA;AACzC,QAAA,OAAO,EAAC;AAAA;AACV;AAGF,IACE,IAAA,kBAAA,CAAmB,WAAW,CAAA,KAAM,UACpC,IAAA,kBAAA,CAAmB,UAAU,CAAG,EAAA,iBAAA,CAAkB,OAAO,CAAA,KAAM,QAC/D,EAAA;AACA,MAAA,OAAO,CAAC,CAAC,IAAM,EAAA,QAAQ,CAAC,CAAA;AAAA;AAG1B,IAAI,IAAA,kBAAA,CAAmB,IAAQ,IAAA,kBAAA,CAAmB,SAAW,EAAA;AAC3D,MAAO,OAAA;AAAA,QACL;AAAA,UACE,IAAA;AAAA,UACA,mBAAmB,SACjB,CAAA,kBAAA,CAAmB,KAAK,OAAQ,CAAA,KAAK,CACvC,CAAK,IAAA;AAAA;AACP,OACF;AAAA;AAGF,IAAA,IAAI,sBAAwB,EAAA,OAAA,KAAY,KAAS,IAAA,YAAA,CAAa,KAAK,CAAG,EAAA;AAEpE,MAAO,OAAA,MAAA,CAAO,OAAQ,CAAA,KAAK,CAAE,CAAA,OAAA;AAAA,QAAQ,CAAC,CAAC,SAAW,EAAA,WAAW,CAC3D,KAAA,aAAA,CAAc,CAAG,EAAA,GAAG,CAAI,CAAA,EAAA,SAAS,CAAI,CAAA,EAAA,WAAA,EAAa,QAAQ,SAAS;AAAA,OACrE;AAAA;AACF;AAGF,EAAA,OAAO,CAAC,CAAC,IAAM,EAAA,KAAK,CAAC,CAAA;AACvB;AAMa,MAAA,WAAA,GAAc,CAAC,KAA4B,KAAA;AACtD,EAAA,MAAM,aAAa,MAAO,CAAA,WAAA;AAAA,IACxB,MAAA,CAAO,OAAQ,CAAA,KAAA,CAAM,SAAS,CAAA,CAC3B,QAAQ,CAAC,CAAC,GAAK,EAAA,KAAK,CAAM,KAAA;AACzB,MAAA,MAAM,SAAS,gBAAiB,CAAA,GAAA,EAAK,KAAM,CAAA,OAAA,EAAS,MAAM,SAAS,CAAA;AACnE,MAAA,OAAO,MACH,GAAA,aAAA,CAAc,GAAK,EAAA,KAAA,EAAO,MAAQ,EAAA,KAAA,CAAM,SAAS,CAAA,GACjD,CAAC,CAAC,GAAK,EAAA,KAAK,CAAC,CAAA;AAAA,KAClB,CACA,CAAA,MAAA,CAAO,CAAQ,IAAA,KAAA,IAAA,CAAK,SAAS,CAAC;AAAA,GACnC;AACA,EAAA,MAAM,OAAU,GAAA;AAAA,IACd,WAAa,EAAA;AAAA,GACf;AACA,EAAA,uBAAQ,KAAA,CAAA,aAAA,CAAA,uBAAA,EAAA,EAAwB,QAAU,EAAA,UAAA,EAAY,OAAkB,EAAA,CAAA;AAC1E;;;;"}