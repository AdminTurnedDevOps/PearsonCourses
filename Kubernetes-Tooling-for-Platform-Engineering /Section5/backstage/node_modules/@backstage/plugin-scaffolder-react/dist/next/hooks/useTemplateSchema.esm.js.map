{"version":3,"file":"useTemplateSchema.esm.js","sources":["../../../src/next/hooks/useTemplateSchema.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { featureFlagsApiRef, useApi } from '@backstage/core-plugin-api';\nimport { TemplatePresentationV1beta3 } from '@backstage/plugin-scaffolder-common';\nimport { JsonObject } from '@backstage/types';\nimport { UiSchema } from '@rjsf/utils';\nimport { TemplateParameterSchema } from '@backstage/plugin-scaffolder-react';\nimport { extractSchemaFromStep } from '../lib';\n\n/**\n * This is the parsed template schema that is returned from the {@link useTemplateSchema} hook.\n * @alpha\n */\nexport interface ParsedTemplateSchema {\n  uiSchema: UiSchema;\n  mergedSchema: JsonObject;\n  schema: JsonObject;\n  title: string;\n  description?: string;\n}\n\n/**\n * This hook will parse the template schema and return the steps with the\n * parsed schema and uiSchema. Filtering out any steps or properties that\n * are not enabled with feature flags.\n * @alpha\n */\nexport const useTemplateSchema = (\n  manifest: TemplateParameterSchema,\n): {\n  steps: ParsedTemplateSchema[];\n  presentation?: TemplatePresentationV1beta3;\n} => {\n  const featureFlags = useApi(featureFlagsApiRef);\n  const steps = manifest.steps.map(({ title, description, schema }) => ({\n    title,\n    description,\n    mergedSchema: schema,\n    ...extractSchemaFromStep(schema),\n  }));\n\n  const returningSteps = steps\n    // Filter out steps that are not enabled with the feature flags\n    .filter(step => {\n      const stepFeatureFlag = step.uiSchema['ui:backstage']?.featureFlag;\n      return stepFeatureFlag ? featureFlags.isActive(stepFeatureFlag) : true;\n    })\n    // Then filter out the properties that are not enabled with feature flag\n    .map(step => {\n      const strippedSchema = {\n        ...step,\n        schema: {\n          ...step.schema,\n          // Title is rendered at the top of the page, so let's ignore this from jsonschemaform\n          title: undefined,\n        },\n      } as ParsedTemplateSchema;\n\n      if (step.schema?.properties || !step.schema?.dependencies) {\n        strippedSchema.schema.properties = Object.fromEntries(\n          Object.entries((step.schema?.properties ?? {}) as JsonObject).filter(\n            ([key]) => {\n              const stepFeatureFlag =\n                step.uiSchema[key]?.['ui:backstage']?.featureFlag;\n              return stepFeatureFlag\n                ? featureFlags.isActive(stepFeatureFlag)\n                : true;\n            },\n          ),\n        );\n      }\n\n      return strippedSchema;\n    });\n\n  return {\n    presentation: manifest.presentation,\n    steps: returningSteps,\n  };\n};\n"],"names":[],"mappings":";;;AAwCa,MAAA,iBAAA,GAAoB,CAC/B,QAIG,KAAA;AACH,EAAM,MAAA,YAAA,GAAe,OAAO,kBAAkB,CAAA;AAC9C,EAAM,MAAA,KAAA,GAAQ,SAAS,KAAM,CAAA,GAAA,CAAI,CAAC,EAAE,KAAA,EAAO,WAAa,EAAA,MAAA,EAAc,MAAA;AAAA,IACpE,KAAA;AAAA,IACA,WAAA;AAAA,IACA,YAAc,EAAA,MAAA;AAAA,IACd,GAAG,sBAAsB,MAAM;AAAA,GAC/B,CAAA,CAAA;AAEF,EAAM,MAAA,cAAA,GAAiB,KAEpB,CAAA,MAAA,CAAO,CAAQ,IAAA,KAAA;AACd,IAAA,MAAM,eAAkB,GAAA,IAAA,CAAK,QAAS,CAAA,cAAc,CAAG,EAAA,WAAA;AACvD,IAAA,OAAO,eAAkB,GAAA,YAAA,CAAa,QAAS,CAAA,eAAe,CAAI,GAAA,IAAA;AAAA,GACnE,CAEA,CAAA,GAAA,CAAI,CAAQ,IAAA,KAAA;AACX,IAAA,MAAM,cAAiB,GAAA;AAAA,MACrB,GAAG,IAAA;AAAA,MACH,MAAQ,EAAA;AAAA,QACN,GAAG,IAAK,CAAA,MAAA;AAAA;AAAA,QAER,KAAO,EAAA,KAAA;AAAA;AACT,KACF;AAEA,IAAA,IAAI,KAAK,MAAQ,EAAA,UAAA,IAAc,CAAC,IAAA,CAAK,QAAQ,YAAc,EAAA;AACzD,MAAe,cAAA,CAAA,MAAA,CAAO,aAAa,MAAO,CAAA,WAAA;AAAA,QACxC,OAAO,OAAS,CAAA,IAAA,CAAK,QAAQ,UAAc,IAAA,EAAiB,CAAE,CAAA,MAAA;AAAA,UAC5D,CAAC,CAAC,GAAG,CAAM,KAAA;AACT,YAAA,MAAM,kBACJ,IAAK,CAAA,QAAA,CAAS,GAAG,CAAA,GAAI,cAAc,CAAG,EAAA,WAAA;AACxC,YAAA,OAAO,eACH,GAAA,YAAA,CAAa,QAAS,CAAA,eAAe,CACrC,GAAA,IAAA;AAAA;AACN;AACF,OACF;AAAA;AAGF,IAAO,OAAA,cAAA;AAAA,GACR,CAAA;AAEH,EAAO,OAAA;AAAA,IACL,cAAc,QAAS,CAAA,YAAA;AAAA,IACvB,KAAO,EAAA;AAAA,GACT;AACF;;;;"}