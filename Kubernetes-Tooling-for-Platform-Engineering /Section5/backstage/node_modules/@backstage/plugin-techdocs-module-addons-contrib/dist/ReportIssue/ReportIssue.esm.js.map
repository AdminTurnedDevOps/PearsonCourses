{"version":3,"file":"ReportIssue.esm.js","sources":["../../src/ReportIssue/ReportIssue.tsx"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { useState, useEffect } from 'react';\n\nimport { makeStyles, Portal, Paper } from '@material-ui/core';\n\nimport { useGitTemplate, useGitRepository } from './hooks';\nimport { ReportIssueTemplateBuilder } from './types';\nimport {\n  PAGE_MAIN_CONTENT_SELECTOR,\n  PAGE_FEEDBACK_LINK_SELECTOR,\n  ADDON_FEEDBACK_CONTAINER_ID,\n  ADDON_FEEDBACK_CONTAINER_SELECTOR,\n} from './constants';\nimport { IssueLink } from './IssueLink';\n\nimport {\n  useShadowRootElements,\n  useShadowRootSelection,\n} from '@backstage/plugin-techdocs-react';\n\nconst useStyles = makeStyles(theme => ({\n  root: {\n    transform: 'translate(-100%, -100%)',\n    position: 'absolute',\n    padding: theme.spacing(1),\n    zIndex: theme.zIndex.tooltip,\n    background: theme.palette.common.white,\n  },\n}));\n\ntype Style = {\n  top: string;\n  left: string;\n};\n\n/**\n * Props customizing the <ReportIssue /> Addon.\n *\n * @public\n */\nexport type ReportIssueProps = {\n  /**\n   * Number of milliseconds after a user highlights some text before the report\n   * issue link appears above the highlighted text. Defaults to 500ms.\n   */\n  debounceTime?: number;\n\n  /**\n   * An optional function defining how a custom issue title and body should be\n   * constructed, given some selected text.\n   */\n  templateBuilder?: ReportIssueTemplateBuilder;\n};\n\n/**\n * Show report issue button when text is highlighted\n */\nexport const ReportIssueAddon = ({\n  debounceTime = 500,\n  templateBuilder: buildTemplate,\n}: ReportIssueProps) => {\n  const classes = useStyles();\n  const [style, setStyle] = useState<Style>();\n\n  const repository = useGitRepository();\n\n  const defaultTemplate = useGitTemplate(debounceTime);\n\n  const selection = useShadowRootSelection(debounceTime);\n\n  const [mainContent, feedbackLink] = useShadowRootElements([\n    PAGE_MAIN_CONTENT_SELECTOR,\n    PAGE_FEEDBACK_LINK_SELECTOR,\n  ]);\n\n  let [feedbackContainer] = useShadowRootElements([\n    ADDON_FEEDBACK_CONTAINER_SELECTOR,\n  ]);\n\n  if (feedbackLink) {\n    feedbackLink.style.display = 'none';\n  }\n\n  // calculates the position of the selected text to be able to set the position of the addon\n  useEffect(() => {\n    if (\n      // todo(backstage/techdocs-core) handle non-repo rendering\n      !repository ||\n      !selection ||\n      !selection.containsNode(mainContent!, true) ||\n      selection?.containsNode(feedbackContainer!, true)\n    ) {\n      return;\n    }\n\n    const mainContentPosition = mainContent!.getBoundingClientRect();\n    const selectionPosition = selection.getRangeAt(0).getBoundingClientRect();\n\n    // Calculating the distance between the selection's top and the main content's top\n    const distanceFromTop = selectionPosition.top - mainContentPosition.top;\n    const minDistanceFromTop = 50;\n\n    // Defining a base value for 'top'\n    let top = distanceFromTop < minDistanceFromTop ? 101 : distanceFromTop - 16;\n\n    // Checking if the main content is off-screen towards the top\n    if (mainContentPosition.top < 0) {\n      const absMainContentTop = Math.abs(mainContentPosition.top);\n\n      // Adjusting 'top' if the selection is close to the top edge and the main content is off-screen\n      if (distanceFromTop - absMainContentTop < minDistanceFromTop) {\n        top += 89;\n      }\n    }\n\n    setStyle({\n      top: `${top}px`,\n      left: `${selectionPosition.left + selectionPosition.width / 2}px`,\n    });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [selection, mainContent, feedbackContainer]);\n\n  if (\n    !selection ||\n    !repository ||\n    !['github', 'gitlab'].includes(repository.type)\n  )\n    return null;\n\n  if (!feedbackContainer) {\n    feedbackContainer = document.createElement('div');\n    feedbackContainer.setAttribute('id', ADDON_FEEDBACK_CONTAINER_ID);\n    mainContent!.prepend(feedbackContainer);\n  }\n\n  return (\n    <Portal container={feedbackContainer}>\n      <Paper\n        data-testid=\"report-issue-addon\"\n        className={classes.root}\n        style={style}\n      >\n        <IssueLink\n          repository={repository}\n          template={\n            buildTemplate ? buildTemplate({ selection }) : defaultTemplate\n          }\n        />\n      </Paper>\n    </Portal>\n  );\n};\n"],"names":[],"mappings":"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"}