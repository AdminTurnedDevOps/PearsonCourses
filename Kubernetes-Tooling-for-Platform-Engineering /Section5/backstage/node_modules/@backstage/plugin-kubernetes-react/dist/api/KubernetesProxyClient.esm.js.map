{"version":3,"file":"KubernetesProxyClient.esm.js","sources":["../../src/api/KubernetesProxyClient.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { KubernetesApi } from './types';\nimport { Event } from 'kubernetes-models/v1';\n\n/**\n * A client for common requests through the proxy endpoint of the kubernetes backend plugin.\n *\n * @public\n */\nexport class KubernetesProxyClient {\n  private readonly kubernetesApi: KubernetesApi;\n\n  constructor(options: { kubernetesApi: KubernetesApi }) {\n    this.kubernetesApi = options.kubernetesApi;\n  }\n\n  private async handleText(response: Response): Promise<string> {\n    if (!response.ok) {\n      const payload = await response.text();\n      let message;\n      switch (response.status) {\n        default:\n          message = `Proxy request failed with ${response.status} ${response.statusText}, ${payload}`;\n      }\n      throw new Error(message);\n    }\n\n    return await response.text();\n  }\n\n  private async handleJson(response: Response): Promise<any> {\n    if (!response.ok) {\n      const payload = await response.text();\n      let message = `Request failed with ${response.status} ${response.statusText}, ${payload}`;\n      switch (response.status) {\n        case 404:\n          message = `Proxy request failed with ${response.status} ${response.statusText}, ${payload}`;\n          break;\n        default:\n          message = `Request failed with ${response.status} ${response.statusText}, ${payload}`;\n      }\n      throw new Error(message);\n    }\n\n    return await response.json();\n  }\n\n  async getEventsByInvolvedObjectName({\n    clusterName,\n    involvedObjectName,\n    namespace,\n  }: {\n    clusterName: string;\n    involvedObjectName: string;\n    namespace: string;\n  }): Promise<Event[]> {\n    return await this.kubernetesApi\n      .proxy({\n        clusterName,\n        path: `/api/v1/namespaces/${namespace}/events?fieldSelector=involvedObject.name=${involvedObjectName}`,\n        init: {\n          method: 'GET',\n        },\n      })\n      .then(response => this.handleJson(response))\n      .then(eventList => eventList.items);\n  }\n\n  async getPodLogs({\n    podName,\n    namespace,\n    clusterName,\n    containerName,\n    previous,\n  }: {\n    podName: string;\n    namespace: string;\n    clusterName: string;\n    containerName: string;\n    previous?: boolean;\n  }): Promise<{ text: string }> {\n    const params = new URLSearchParams({\n      container: containerName,\n    });\n    if (previous) {\n      params.append('previous', '');\n    }\n    return await this.kubernetesApi\n      .proxy({\n        clusterName: clusterName,\n        path: `/api/v1/namespaces/${namespace}/pods/${podName}/log?${params.toString()}`,\n        init: {\n          method: 'GET',\n        },\n      })\n      .then(response => this.handleText(response))\n      .then(text => ({ text }));\n  }\n\n  async deletePod({\n    podName,\n    namespace,\n    clusterName,\n  }: {\n    podName: string;\n    namespace: string;\n    clusterName: string;\n  }): Promise<{ text: string }> {\n    return await this.kubernetesApi\n      .proxy({\n        clusterName: clusterName,\n        path: `/api/v1/namespaces/${namespace}/pods/${podName}`,\n        init: {\n          method: 'DELETE',\n        },\n      })\n      .then(response => this.handleText(response))\n      .then(text => ({ text }));\n  }\n}\n"],"names":[],"mappings":"AAuBO,MAAM,qBAAsB,CAAA;AAAA,EAChB,aAAA;AAAA,EAEjB,YAAY,OAA2C,EAAA;AACrD,IAAA,IAAA,CAAK,gBAAgB,OAAQ,CAAA,aAAA;AAAA;AAC/B,EAEA,MAAc,WAAW,QAAqC,EAAA;AAC5D,IAAI,IAAA,CAAC,SAAS,EAAI,EAAA;AAChB,MAAM,MAAA,OAAA,GAAU,MAAM,QAAA,CAAS,IAAK,EAAA;AACpC,MAAI,IAAA,OAAA;AACJ,MAAA,QAAQ,SAAS,MAAQ;AAAA,QACvB;AACE,UAAA,OAAA,GAAU,6BAA6B,QAAS,CAAA,MAAM,IAAI,QAAS,CAAA,UAAU,KAAK,OAAO,CAAA,CAAA;AAAA;AAE7F,MAAM,MAAA,IAAI,MAAM,OAAO,CAAA;AAAA;AAGzB,IAAO,OAAA,MAAM,SAAS,IAAK,EAAA;AAAA;AAC7B,EAEA,MAAc,WAAW,QAAkC,EAAA;AACzD,IAAI,IAAA,CAAC,SAAS,EAAI,EAAA;AAChB,MAAM,MAAA,OAAA,GAAU,MAAM,QAAA,CAAS,IAAK,EAAA;AACpC,MAAI,IAAA,OAAA,GAAU,uBAAuB,QAAS,CAAA,MAAM,IAAI,QAAS,CAAA,UAAU,KAAK,OAAO,CAAA,CAAA;AACvF,MAAA,QAAQ,SAAS,MAAQ;AAAA,QACvB,KAAK,GAAA;AACH,UAAA,OAAA,GAAU,6BAA6B,QAAS,CAAA,MAAM,IAAI,QAAS,CAAA,UAAU,KAAK,OAAO,CAAA,CAAA;AACzF,UAAA;AAAA,QACF;AACE,UAAA,OAAA,GAAU,uBAAuB,QAAS,CAAA,MAAM,IAAI,QAAS,CAAA,UAAU,KAAK,OAAO,CAAA,CAAA;AAAA;AAEvF,MAAM,MAAA,IAAI,MAAM,OAAO,CAAA;AAAA;AAGzB,IAAO,OAAA,MAAM,SAAS,IAAK,EAAA;AAAA;AAC7B,EAEA,MAAM,6BAA8B,CAAA;AAAA,IAClC,WAAA;AAAA,IACA,kBAAA;AAAA,IACA;AAAA,GAKmB,EAAA;AACnB,IAAO,OAAA,MAAM,IAAK,CAAA,aAAA,CACf,KAAM,CAAA;AAAA,MACL,WAAA;AAAA,MACA,IAAM,EAAA,CAAA,mBAAA,EAAsB,SAAS,CAAA,0CAAA,EAA6C,kBAAkB,CAAA,CAAA;AAAA,MACpG,IAAM,EAAA;AAAA,QACJ,MAAQ,EAAA;AAAA;AACV,KACD,CAAA,CACA,IAAK,CAAA,CAAA,QAAA,KAAY,IAAK,CAAA,UAAA,CAAW,QAAQ,CAAC,CAC1C,CAAA,IAAA,CAAK,CAAa,SAAA,KAAA,SAAA,CAAU,KAAK,CAAA;AAAA;AACtC,EAEA,MAAM,UAAW,CAAA;AAAA,IACf,OAAA;AAAA,IACA,SAAA;AAAA,IACA,WAAA;AAAA,IACA,aAAA;AAAA,IACA;AAAA,GAO4B,EAAA;AAC5B,IAAM,MAAA,MAAA,GAAS,IAAI,eAAgB,CAAA;AAAA,MACjC,SAAW,EAAA;AAAA,KACZ,CAAA;AACD,IAAA,IAAI,QAAU,EAAA;AACZ,MAAO,MAAA,CAAA,MAAA,CAAO,YAAY,EAAE,CAAA;AAAA;AAE9B,IAAO,OAAA,MAAM,IAAK,CAAA,aAAA,CACf,KAAM,CAAA;AAAA,MACL,WAAA;AAAA,MACA,IAAA,EAAM,sBAAsB,SAAS,CAAA,MAAA,EAAS,OAAO,CAAQ,KAAA,EAAA,MAAA,CAAO,UAAU,CAAA,CAAA;AAAA,MAC9E,IAAM,EAAA;AAAA,QACJ,MAAQ,EAAA;AAAA;AACV,KACD,CAAA,CACA,IAAK,CAAA,CAAA,QAAA,KAAY,IAAK,CAAA,UAAA,CAAW,QAAQ,CAAC,CAC1C,CAAA,IAAA,CAAK,CAAS,IAAA,MAAA,EAAE,MAAO,CAAA,CAAA;AAAA;AAC5B,EAEA,MAAM,SAAU,CAAA;AAAA,IACd,OAAA;AAAA,IACA,SAAA;AAAA,IACA;AAAA,GAK4B,EAAA;AAC5B,IAAO,OAAA,MAAM,IAAK,CAAA,aAAA,CACf,KAAM,CAAA;AAAA,MACL,WAAA;AAAA,MACA,IAAM,EAAA,CAAA,mBAAA,EAAsB,SAAS,CAAA,MAAA,EAAS,OAAO,CAAA,CAAA;AAAA,MACrD,IAAM,EAAA;AAAA,QACJ,MAAQ,EAAA;AAAA;AACV,KACD,CAAA,CACA,IAAK,CAAA,CAAA,QAAA,KAAY,IAAK,CAAA,UAAA,CAAW,QAAQ,CAAC,CAC1C,CAAA,IAAA,CAAK,CAAS,IAAA,MAAA,EAAE,MAAO,CAAA,CAAA;AAAA;AAE9B;;;;"}