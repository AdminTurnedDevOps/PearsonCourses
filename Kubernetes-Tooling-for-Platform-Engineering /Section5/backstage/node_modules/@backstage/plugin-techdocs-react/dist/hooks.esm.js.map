{"version":3,"file":"hooks.esm.js","sources":["../src/hooks.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { useEffect, useMemo, useState } from 'react';\nimport debounce from 'lodash/debounce';\nimport { useTechDocsReaderPage } from './context';\n\n/**\n * Hook for use within TechDocs addons that provides access to the underlying\n * shadow root of the current page, allowing the DOM within to be mutated.\n * @public\n */\nexport const useShadowRoot = () => {\n  const { shadowRoot } = useTechDocsReaderPage();\n  return shadowRoot;\n};\n\n/**\n * Convenience hook for use within TechDocs addons that provides access to\n * elements that match a given selector within the shadow root.\n *\n * @public\n */\nexport const useShadowRootElements = <\n  TReturnedElement extends HTMLElement = HTMLElement,\n>(\n  selectors: string[],\n): TReturnedElement[] => {\n  const shadowRoot = useShadowRoot();\n  const [root, setRootNode] = useState(shadowRoot?.firstChild);\n\n  useEffect(() => {\n    let observer: MutationObserver;\n    if (shadowRoot) {\n      observer = new MutationObserver(() => {\n        setRootNode(shadowRoot?.firstChild);\n      });\n      observer.observe(shadowRoot, {\n        attributes: true,\n        characterData: true,\n        childList: true,\n        subtree: true,\n      });\n    }\n    return () => observer?.disconnect();\n  }, [shadowRoot]);\n\n  if (!root || !(root instanceof HTMLElement)) return [];\n\n  return selectors\n    .map(selector => root.querySelectorAll<TReturnedElement>(selector))\n    .filter(nodeList => nodeList.length)\n    .map(nodeList => Array.from(nodeList))\n    .flat();\n};\n\nconst isValidSelection = (newSelection: Selection) => {\n  // Safari sets the selection rect to top zero\n  return (\n    newSelection.toString() &&\n    newSelection.rangeCount &&\n    newSelection.getRangeAt(0).getBoundingClientRect().top\n  );\n};\n\n/**\n * Hook for retrieving a selection within the ShadowRoot.\n * @public\n */\nexport const useShadowRootSelection = (waitMillis: number = 0) => {\n  const shadowRoot = useShadowRoot();\n  const [selection, setSelection] = useState<Selection | null>(null);\n  const handleSelectionChange = useMemo(\n    () =>\n      debounce(() => {\n        const shadowDocument = shadowRoot as ShadowRoot &\n          Pick<Document, 'getSelection'>;\n        // Firefox and Safari don't implement getSelection for Shadow DOM\n        const newSelection = shadowDocument.getSelection\n          ? shadowDocument.getSelection()\n          : document.getSelection();\n\n        if (newSelection && isValidSelection(newSelection)) {\n          setSelection(newSelection);\n        } else {\n          setSelection(null);\n        }\n      }, waitMillis),\n    [shadowRoot, setSelection, waitMillis],\n  );\n\n  useEffect(() => {\n    window.document.addEventListener('selectionchange', handleSelectionChange);\n    return () => {\n      handleSelectionChange.cancel();\n      window.document.removeEventListener(\n        'selectionchange',\n        handleSelectionChange,\n      );\n    };\n  }, [handleSelectionChange]);\n\n  return selection;\n};\n"],"names":[],"mappings":";;;;AAwBO,MAAM,gBAAgB,MAAM;AACjC,EAAM,MAAA,EAAE,UAAW,EAAA,GAAI,qBAAsB,EAAA;AAC7C,EAAO,OAAA,UAAA;AACT;AAQa,MAAA,qBAAA,GAAwB,CAGnC,SACuB,KAAA;AACvB,EAAA,MAAM,aAAa,aAAc,EAAA;AACjC,EAAA,MAAM,CAAC,IAAM,EAAA,WAAW,CAAI,GAAA,QAAA,CAAS,YAAY,UAAU,CAAA;AAE3D,EAAA,SAAA,CAAU,MAAM;AACd,IAAI,IAAA,QAAA;AACJ,IAAA,IAAI,UAAY,EAAA;AACd,MAAW,QAAA,GAAA,IAAI,iBAAiB,MAAM;AACpC,QAAA,WAAA,CAAY,YAAY,UAAU,CAAA;AAAA,OACnC,CAAA;AACD,MAAA,QAAA,CAAS,QAAQ,UAAY,EAAA;AAAA,QAC3B,UAAY,EAAA,IAAA;AAAA,QACZ,aAAe,EAAA,IAAA;AAAA,QACf,SAAW,EAAA,IAAA;AAAA,QACX,OAAS,EAAA;AAAA,OACV,CAAA;AAAA;AAEH,IAAO,OAAA,MAAM,UAAU,UAAW,EAAA;AAAA,GACpC,EAAG,CAAC,UAAU,CAAC,CAAA;AAEf,EAAA,IAAI,CAAC,IAAQ,IAAA,EAAE,IAAgB,YAAA,WAAA,CAAA,SAAqB,EAAC;AAErD,EAAO,OAAA,SAAA,CACJ,IAAI,CAAY,QAAA,KAAA,IAAA,CAAK,iBAAmC,QAAQ,CAAC,EACjE,MAAO,CAAA,CAAA,QAAA,KAAY,SAAS,MAAM,CAAA,CAClC,IAAI,CAAY,QAAA,KAAA,KAAA,CAAM,KAAK,QAAQ,CAAC,EACpC,IAAK,EAAA;AACV;AAEA,MAAM,gBAAA,GAAmB,CAAC,YAA4B,KAAA;AAEpD,EACE,OAAA,YAAA,CAAa,QAAS,EAAA,IACtB,YAAa,CAAA,UAAA,IACb,aAAa,UAAW,CAAA,CAAC,CAAE,CAAA,qBAAA,EAAwB,CAAA,GAAA;AAEvD,CAAA;AAMa,MAAA,sBAAA,GAAyB,CAAC,UAAA,GAAqB,CAAM,KAAA;AAChE,EAAA,MAAM,aAAa,aAAc,EAAA;AACjC,EAAA,MAAM,CAAC,SAAA,EAAW,YAAY,CAAA,GAAI,SAA2B,IAAI,CAAA;AACjE,EAAA,MAAM,qBAAwB,GAAA,OAAA;AAAA,IAC5B,MACE,SAAS,MAAM;AACb,MAAA,MAAM,cAAiB,GAAA,UAAA;AAGvB,MAAA,MAAM,eAAe,cAAe,CAAA,YAAA,GAChC,eAAe,YAAa,EAAA,GAC5B,SAAS,YAAa,EAAA;AAE1B,MAAI,IAAA,YAAA,IAAgB,gBAAiB,CAAA,YAAY,CAAG,EAAA;AAClD,QAAA,YAAA,CAAa,YAAY,CAAA;AAAA,OACpB,MAAA;AACL,QAAA,YAAA,CAAa,IAAI,CAAA;AAAA;AACnB,OACC,UAAU,CAAA;AAAA,IACf,CAAC,UAAY,EAAA,YAAA,EAAc,UAAU;AAAA,GACvC;AAEA,EAAA,SAAA,CAAU,MAAM;AACd,IAAO,MAAA,CAAA,QAAA,CAAS,gBAAiB,CAAA,iBAAA,EAAmB,qBAAqB,CAAA;AACzE,IAAA,OAAO,MAAM;AACX,MAAA,qBAAA,CAAsB,MAAO,EAAA;AAC7B,MAAA,MAAA,CAAO,QAAS,CAAA,mBAAA;AAAA,QACd,iBAAA;AAAA,QACA;AAAA,OACF;AAAA,KACF;AAAA,GACF,EAAG,CAAC,qBAAqB,CAAC,CAAA;AAE1B,EAAO,OAAA,SAAA;AACT;;;;"}