{"version":3,"file":"ForwardsCompatProvider.esm.js","sources":["../../src/compatWrapper/ForwardsCompatProvider.tsx"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ApiHolder,\n  ApiRef,\n  AppContext,\n  useApp,\n} from '@backstage/core-plugin-api';\nimport {\n  AnyRouteRefParams,\n  ComponentRef,\n  ComponentsApi,\n  CoreErrorBoundaryFallbackProps,\n  CoreNotFoundErrorPageProps,\n  CoreProgressProps,\n  ExternalRouteRef,\n  IconComponent,\n  IconsApi,\n  RouteFunc,\n  RouteRef,\n  RouteResolutionApi,\n  RouteResolutionApiResolveOptions,\n  SubRouteRef,\n  componentsApiRef,\n  coreComponentRefs,\n  iconsApiRef,\n  routeResolutionApiRef,\n} from '@backstage/frontend-plugin-api';\nimport React, { ComponentType, useMemo } from 'react';\nimport { ReactNode } from 'react';\nimport { toLegacyPlugin } from './BackwardsCompatProvider';\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { ApiProvider } from '../../../core-app-api/src/apis/system/ApiProvider';\nimport { useVersionedContext } from '@backstage/version-bridge';\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { type RouteResolver } from '../../../core-plugin-api/src/routing/useRouteRef';\nimport { convertLegacyRouteRef } from '../convertLegacyRouteRef';\n\nclass CompatComponentsApi implements ComponentsApi {\n  readonly #Progress: ComponentType<CoreProgressProps>;\n  readonly #NotFoundErrorPage: ComponentType<CoreNotFoundErrorPageProps>;\n  readonly #ErrorBoundaryFallback: ComponentType<CoreErrorBoundaryFallbackProps>;\n\n  constructor(app: AppContext) {\n    const components = app.getComponents();\n    const ErrorBoundaryFallback = (props: CoreErrorBoundaryFallbackProps) => (\n      <components.ErrorBoundaryFallback\n        {...props}\n        plugin={props.plugin && toLegacyPlugin(props.plugin)}\n      />\n    );\n    this.#Progress = components.Progress;\n    this.#NotFoundErrorPage = components.NotFoundErrorPage;\n    this.#ErrorBoundaryFallback = ErrorBoundaryFallback;\n  }\n\n  getComponent<T extends {}>(ref: ComponentRef<T>): ComponentType<T> {\n    switch (ref.id) {\n      case coreComponentRefs.progress.id:\n        return this.#Progress as ComponentType<any>;\n      case coreComponentRefs.notFoundErrorPage.id:\n        return this.#NotFoundErrorPage as ComponentType<any>;\n      case coreComponentRefs.errorBoundaryFallback.id:\n        return this.#ErrorBoundaryFallback as ComponentType<any>;\n      default:\n        throw new Error(\n          `No backwards compatible component is available for ref '${ref.id}'`,\n        );\n    }\n  }\n}\n\nclass CompatIconsApi implements IconsApi {\n  readonly #app: AppContext;\n\n  constructor(app: AppContext) {\n    this.#app = app;\n  }\n\n  getIcon(key: string): IconComponent | undefined {\n    return this.#app.getSystemIcon(key);\n  }\n\n  listIconKeys(): string[] {\n    return Object.keys(this.#app.getSystemIcons());\n  }\n}\n\nclass CompatRouteResolutionApi implements RouteResolutionApi {\n  readonly #routeResolver: RouteResolver;\n\n  constructor(routeResolver: RouteResolver) {\n    this.#routeResolver = routeResolver;\n  }\n\n  resolve<TParams extends AnyRouteRefParams>(\n    anyRouteRef:\n      | RouteRef<TParams>\n      | SubRouteRef<TParams>\n      | ExternalRouteRef<TParams>,\n    options?: RouteResolutionApiResolveOptions | undefined,\n  ): RouteFunc<TParams> | undefined {\n    const legacyRef = convertLegacyRouteRef(anyRouteRef as RouteRef<TParams>);\n    return this.#routeResolver.resolve(legacyRef, options?.sourcePath ?? '/');\n  }\n}\n\nclass ForwardsCompatApis implements ApiHolder {\n  readonly #componentsApi: ComponentsApi;\n  readonly #iconsApi: IconsApi;\n  readonly #routeResolutionApi: RouteResolutionApi;\n\n  constructor(app: AppContext, routeResolver: RouteResolver) {\n    this.#componentsApi = new CompatComponentsApi(app);\n    this.#iconsApi = new CompatIconsApi(app);\n    this.#routeResolutionApi = new CompatRouteResolutionApi(routeResolver);\n  }\n\n  get<T>(ref: ApiRef<any>): T | undefined {\n    if (ref.id === componentsApiRef.id) {\n      return this.#componentsApi as T;\n    } else if (ref.id === iconsApiRef.id) {\n      return this.#iconsApi as T;\n    } else if (ref.id === routeResolutionApiRef.id) {\n      return this.#routeResolutionApi as T;\n    }\n    return undefined;\n  }\n}\n\nfunction NewAppApisProvider(props: { children: ReactNode }) {\n  const app = useApp();\n  const versionedRouteResolverContext = useVersionedContext<{\n    1: RouteResolver;\n  }>('routing-context');\n  if (!versionedRouteResolverContext) {\n    throw new Error('Routing context is not available');\n  }\n  const routeResolver = versionedRouteResolverContext.atVersion(1);\n  if (!routeResolver) {\n    throw new Error('RoutingContext v1 not available');\n  }\n\n  const appFallbackApis = useMemo(\n    () => new ForwardsCompatApis(app, routeResolver),\n    [app, routeResolver],\n  );\n\n  return <ApiProvider apis={appFallbackApis}>{props.children}</ApiProvider>;\n}\n\nexport function ForwardsCompatProvider(props: { children: ReactNode }) {\n  return <NewAppApisProvider>{props.children}</NewAppApisProvider>;\n}\n"],"names":[],"mappings":"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"}