{"version":3,"file":"load.cjs.js","sources":["../../src/schema/load.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { AppConfig } from '@backstage/config';\nimport { JsonObject } from '@backstage/types';\nimport { compileConfigSchemas } from './compile';\nimport { collectConfigSchemas } from './collect';\nimport { filterByVisibility, filterErrorsByVisibility } from './filtering';\nimport {\n  ValidationError,\n  ConfigSchema,\n  ConfigSchemaPackageEntry,\n  CONFIG_VISIBILITIES,\n} from './types';\nimport { normalizeAjvPath } from './utils';\n\n/**\n * Options that control the loading of configuration schema files in the backend.\n *\n * @public\n */\nexport type LoadConfigSchemaOptions =\n  | (\n      | {\n          dependencies: string[];\n          packagePaths?: string[];\n        }\n      | {\n          serialized: JsonObject;\n        }\n    ) & {\n      noUndeclaredProperties?: boolean;\n    };\n\nfunction errorsToError(errors: ValidationError[]): Error {\n  const messages = errors.map(({ instancePath, message, params }) => {\n    const paramStr = Object.entries(params)\n      .map(([name, value]) => `${name}=${value}`)\n      .join(' ');\n    return `Config ${message || ''} { ${paramStr} } at ${normalizeAjvPath(\n      instancePath,\n    )}`;\n  });\n  const error = new Error(`Config validation failed, ${messages.join('; ')}`);\n  (error as any).messages = messages;\n  return error;\n}\n\n/**\n * Loads config schema for a Backstage instance.\n *\n * @public\n */\nexport async function loadConfigSchema(\n  options: LoadConfigSchemaOptions,\n): Promise<ConfigSchema> {\n  let schemas: ConfigSchemaPackageEntry[];\n\n  if ('dependencies' in options) {\n    schemas = await collectConfigSchemas(\n      options.dependencies,\n      options.packagePaths ?? [],\n    );\n  } else {\n    const { serialized } = options;\n    if (serialized?.backstageConfigSchemaVersion !== 1) {\n      throw new Error(\n        'Serialized configuration schema is invalid or has an invalid version number',\n      );\n    }\n    schemas = serialized.schemas as ConfigSchemaPackageEntry[];\n  }\n\n  const validate = compileConfigSchemas(schemas, {\n    noUndeclaredProperties: options.noUndeclaredProperties,\n  });\n\n  return {\n    process(\n      configs: AppConfig[],\n      {\n        visibility,\n        valueTransform,\n        withFilteredKeys,\n        withDeprecatedKeys,\n        ignoreSchemaErrors,\n      } = {},\n    ): AppConfig[] {\n      const result = validate(configs);\n\n      if (!ignoreSchemaErrors) {\n        const visibleErrors = filterErrorsByVisibility(\n          result.errors,\n          visibility,\n          result.visibilityByDataPath,\n          result.visibilityBySchemaPath,\n        );\n        if (visibleErrors.length > 0) {\n          throw errorsToError(visibleErrors);\n        }\n      }\n\n      let processedConfigs = configs;\n\n      if (visibility) {\n        processedConfigs = processedConfigs.map(({ data, context }) => ({\n          context,\n          ...filterByVisibility(\n            data,\n            visibility,\n            result.visibilityByDataPath,\n            result.deepVisibilityByDataPath,\n            result.deprecationByDataPath,\n            valueTransform,\n            withFilteredKeys,\n            withDeprecatedKeys,\n          ),\n        }));\n      } else if (valueTransform) {\n        processedConfigs = processedConfigs.map(({ data, context }) => ({\n          context,\n          ...filterByVisibility(\n            data,\n            Array.from(CONFIG_VISIBILITIES),\n            result.visibilityByDataPath,\n            result.deepVisibilityByDataPath,\n            result.deprecationByDataPath,\n            valueTransform,\n            withFilteredKeys,\n            withDeprecatedKeys,\n          ),\n        }));\n      }\n\n      return processedConfigs;\n    },\n    serialize(): JsonObject {\n      return {\n        schemas,\n        backstageConfigSchemaVersion: 1,\n      };\n    },\n  };\n}\n"],"names":["normalizeAjvPath","collectConfigSchemas","compileConfigSchemas","filterErrorsByVisibility","filterByVisibility","CONFIG_VISIBILITIES"],"mappings":"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"}