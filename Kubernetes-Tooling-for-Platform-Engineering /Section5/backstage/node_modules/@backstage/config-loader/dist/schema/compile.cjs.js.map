{"version":3,"file":"compile.cjs.js","sources":["../../src/schema/compile.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport Ajv from 'ajv';\nimport { JSONSchema7 as JSONSchema } from 'json-schema';\nimport mergeAllOf, { Resolvers } from 'json-schema-merge-allof';\nimport traverse from 'json-schema-traverse';\nimport { ConfigReader } from '@backstage/config';\nimport {\n  ConfigSchemaPackageEntry,\n  ValidationFunc,\n  CONFIG_VISIBILITIES,\n  ConfigVisibility,\n} from './types';\nimport { SchemaObject } from 'json-schema-traverse';\nimport { normalizeAjvPath } from './utils';\n\n// Used to keep track of the internal deepVisibility inherited through the schema.\nconst inheritedVisibility = Symbol('inherited-visibility');\n\n/**\n * This takes a collection of Backstage configuration schemas from various\n * sources and compiles them down into a single schema validation function.\n *\n * It also handles the implementation of the custom \"visibility\" keyword used\n * to specify the scope of different config paths.\n */\nexport function compileConfigSchemas(\n  schemas: ConfigSchemaPackageEntry[],\n  options?: {\n    noUndeclaredProperties?: boolean;\n  },\n): ValidationFunc {\n  // The ajv instance below is stateful and doesn't really allow for additional\n  // output during validation. We work around this by having this extra piece\n  // of state that we reset before each validation.\n  const visibilityByDataPath = new Map<string, ConfigVisibility>();\n  const deepVisibilityByDataPath = new Map<string, ConfigVisibility>();\n  const deprecationByDataPath = new Map<string, string>();\n\n  const ajv = new Ajv({\n    allErrors: true,\n    allowUnionTypes: true,\n    coerceTypes: true,\n    schemas: {\n      'https://backstage.io/schema/config-v1': true,\n    },\n  })\n    .addKeyword({\n      keyword: 'visibility',\n      metaSchema: {\n        type: 'string',\n        enum: CONFIG_VISIBILITIES,\n      },\n      compile(visibility: ConfigVisibility) {\n        return (_data, context) => {\n          if (context?.instancePath === undefined) {\n            return false;\n          }\n          if (visibility && visibility !== 'backend') {\n            const normalizedPath = normalizeAjvPath(context.instancePath);\n            visibilityByDataPath.set(normalizedPath, visibility);\n          }\n          return true;\n        };\n      },\n    })\n    .addKeyword({\n      keyword: 'deepVisibility',\n      metaSchema: {\n        type: 'string',\n        /**\n         * Disallow 'backend' deepVisibility to prevent cases of permission escaping.\n         *\n         * Something like:\n         * - deepVisibility secret -> backend -> frontend.\n         * - deepVisibility secret -> backend -> visibility frontend.\n         */\n        enum: ['frontend', 'secret'],\n      },\n      compile(visibility: 'frontend' | 'secret') {\n        return (_data, context) => {\n          if (context?.instancePath === undefined) {\n            return false;\n          }\n          if (visibility) {\n            const normalizedPath = normalizeAjvPath(context.instancePath);\n            deepVisibilityByDataPath.set(normalizedPath, visibility);\n          }\n          return true;\n        };\n      },\n    })\n    .removeKeyword('deprecated') // remove `deprecated` keyword so that we can implement our own compiler\n    .addKeyword({\n      keyword: 'deprecated',\n      metaSchema: { type: 'string' },\n      compile(deprecationDescription: string) {\n        return (_data, context) => {\n          if (context?.instancePath === undefined) {\n            return false;\n          }\n          const normalizedPath = normalizeAjvPath(context.instancePath);\n          // create mapping of deprecation description and data path of property\n          deprecationByDataPath.set(normalizedPath, deprecationDescription);\n          return true;\n        };\n      },\n    });\n\n  for (const schema of schemas) {\n    try {\n      ajv.compile(schema.value);\n    } catch (error) {\n      throw new Error(`Schema at ${schema.path} is invalid, ${error}`);\n    }\n  }\n\n  const merged = mergeConfigSchemas(schemas.map(_ => _.value));\n\n  traverse(\n    merged,\n    (\n      schema: SchemaObject & { [inheritedVisibility]?: ConfigVisibility },\n      jsonPtr: string,\n      _1: any,\n      _2: any,\n      _3?: any,\n      parentSchema?: SchemaObject & {\n        [inheritedVisibility]?: ConfigVisibility;\n      },\n    ) => {\n      // Inherit parent deepVisibility if we don't define one ourselves.\n      // This is used to detect situations where conflicting deep visibilities are set.\n      schema[inheritedVisibility] ??=\n        schema?.deepVisibility ?? parentSchema?.[inheritedVisibility];\n\n      if (schema[inheritedVisibility]) {\n        // Validate that we're not trying to set a conflicting visibility. This can be done\n        // either by setting a conflicting visibility directly or deep visibility\n        const values = [\n          schema.visibility,\n          schema[inheritedVisibility],\n          parentSchema?.[inheritedVisibility],\n        ];\n        const hasFrontend = values.some(e => e === 'frontend');\n        const hasSecret = values.some(e => e === 'secret');\n        if (hasFrontend && hasSecret) {\n          throw new Error(\n            `Config schema visibility is both 'frontend' and 'secret' for ${jsonPtr}`,\n          );\n        }\n      }\n\n      if (options?.noUndeclaredProperties) {\n        /**\n         * The `additionalProperties` key can only be applied to `type: object` in the JSON\n         *  schema.\n         */\n        if (schema?.type === 'object') {\n          schema.additionalProperties ||= false;\n        }\n      }\n    },\n  );\n\n  const validate = ajv.compile(merged);\n\n  const visibilityBySchemaPath = new Map<string, ConfigVisibility>();\n  traverse(merged, (schema, path) => {\n    if (schema.visibility && schema.visibility !== 'backend') {\n      visibilityBySchemaPath.set(normalizeAjvPath(path), schema.visibility);\n    }\n    if (schema.deepVisibility) {\n      visibilityBySchemaPath.set(normalizeAjvPath(path), schema.deepVisibility);\n    }\n  });\n\n  return configs => {\n    const config = ConfigReader.fromConfigs(configs).getOptional();\n\n    visibilityByDataPath.clear();\n    deepVisibilityByDataPath.clear();\n\n    const valid = validate(config);\n\n    if (!valid) {\n      return {\n        errors: validate.errors ?? [],\n        visibilityByDataPath: new Map(visibilityByDataPath),\n        deepVisibilityByDataPath: new Map(deepVisibilityByDataPath),\n        visibilityBySchemaPath,\n        deprecationByDataPath,\n      };\n    }\n\n    return {\n      visibilityByDataPath: new Map(visibilityByDataPath),\n      deepVisibilityByDataPath: new Map(deepVisibilityByDataPath),\n      visibilityBySchemaPath,\n      deprecationByDataPath,\n    };\n  };\n}\n\n/**\n * Given a list of configuration schemas from packages, merge them\n * into a single json schema.\n *\n * @public\n */\nexport function mergeConfigSchemas(schemas: JSONSchema[]): JSONSchema {\n  const merged = mergeAllOf(\n    { allOf: schemas },\n    {\n      // JSONSchema is typically subtractive, as in it always reduces the set of allowed\n      // inputs through constraints. This changes the object property merging to be additive\n      // rather than subtractive.\n      ignoreAdditionalProperties: true,\n      resolvers: {\n        // This ensures that the visibilities across different schemas are sound, and\n        // selects the most specific visibility for each path.\n        visibility(values: string[], path: string[]) {\n          const hasFrontend = values.some(_ => _ === 'frontend');\n          const hasSecret = values.some(_ => _ === 'secret');\n          if (hasFrontend && hasSecret) {\n            throw new Error(\n              `Config schema visibility is both 'frontend' and 'secret' for ${path.join(\n                '/',\n              )}`,\n            );\n          } else if (hasFrontend) {\n            return 'frontend';\n          } else if (hasSecret) {\n            return 'secret';\n          }\n\n          return 'backend';\n        },\n      } as Partial<Resolvers<JSONSchema>>,\n    },\n  );\n  return merged;\n}\n"],"names":["Ajv","CONFIG_VISIBILITIES","normalizeAjvPath","traverse","config","ConfigReader","mergeAllOf"],"mappings":"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"}