{"version":3,"file":"MutableConfigSource.cjs.js","sources":["../../src/sources/MutableConfigSource.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { DeferredPromise, JsonObject, createDeferred } from '@backstage/types';\nimport {\n  AsyncConfigSourceGenerator,\n  ConfigSource,\n  ReadConfigDataOptions,\n} from './types';\nimport { waitOrAbort } from './utils';\n\n/**\n * Options for {@link MutableConfigSource.create}.\n *\n * @public\n */\nexport interface MutableConfigSourceOptions {\n  data?: JsonObject;\n  context?: string;\n}\n\n/**\n * A config source that can be updated with new data.\n *\n * @public\n */\nexport class MutableConfigSource implements ConfigSource {\n  /**\n   * Creates a new mutable config source.\n   *\n   * @param options - Options for the config source.\n   * @returns A new mutable config source.\n   */\n  static create(options?: MutableConfigSourceOptions): MutableConfigSource {\n    return new MutableConfigSource(\n      options?.context ?? 'mutable-config',\n      options?.data,\n    );\n  }\n\n  #currentData?: JsonObject;\n  #deferred: DeferredPromise<void>;\n  readonly #context: string;\n  readonly #abortController = new AbortController();\n\n  private constructor(context: string, initialData?: JsonObject) {\n    this.#currentData = initialData;\n    this.#context = context;\n    this.#deferred = createDeferred();\n  }\n\n  async *readConfigData(\n    options?: ReadConfigDataOptions | undefined,\n  ): AsyncConfigSourceGenerator {\n    let deferredPromise = this.#deferred;\n\n    if (this.#currentData !== undefined) {\n      yield { configs: [{ data: this.#currentData, context: this.#context }] };\n    }\n\n    for (;;) {\n      const [ok] = await waitOrAbort(deferredPromise, [\n        options?.signal,\n        this.#abortController.signal,\n      ]);\n      if (!ok) {\n        return;\n      }\n      deferredPromise = this.#deferred;\n\n      if (this.#currentData !== undefined) {\n        yield {\n          configs: [{ data: this.#currentData, context: this.#context }],\n        };\n      }\n    }\n  }\n\n  /**\n   * Set the data of the config source.\n   *\n   * @param data - The new data to set\n   */\n  setData(data: JsonObject): void {\n    if (!this.#abortController.signal.aborted) {\n      this.#currentData = data;\n      const oldDeferred = this.#deferred;\n      this.#deferred = createDeferred();\n      oldDeferred.resolve();\n    }\n  }\n\n  /**\n   * Close the config source, preventing any further updates.\n   */\n  close(): void {\n    this.#currentData = undefined;\n    this.#abortController.abort();\n  }\n\n  toString() {\n    return `MutableConfigSource{}`;\n  }\n}\n"],"names":["createDeferred","waitOrAbort"],"mappings":";;;;;AAuCO,MAAM,mBAA4C,CAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOvD,OAAO,OAAO,OAA2D,EAAA;AACvE,IAAA,OAAO,IAAI,mBAAA;AAAA,MACT,SAAS,OAAW,IAAA,gBAAA;AAAA,MACpB,OAAS,EAAA;AAAA,KACX;AAAA;AACF,EAEA,YAAA;AAAA,EACA,SAAA;AAAA,EACS,QAAA;AAAA,EACA,gBAAA,GAAmB,IAAI,eAAgB,EAAA;AAAA,EAExC,WAAA,CAAY,SAAiB,WAA0B,EAAA;AAC7D,IAAA,IAAA,CAAK,YAAe,GAAA,WAAA;AACpB,IAAA,IAAA,CAAK,QAAW,GAAA,OAAA;AAChB,IAAA,IAAA,CAAK,YAAYA,oBAAe,EAAA;AAAA;AAClC,EAEA,OAAO,eACL,OAC4B,EAAA;AAC5B,IAAA,IAAI,kBAAkB,IAAK,CAAA,SAAA;AAE3B,IAAI,IAAA,IAAA,CAAK,iBAAiB,KAAW,CAAA,EAAA;AACnC,MAAM,MAAA,EAAE,OAAS,EAAA,CAAC,EAAE,IAAA,EAAM,IAAK,CAAA,YAAA,EAAc,OAAS,EAAA,IAAA,CAAK,QAAS,EAAC,CAAE,EAAA;AAAA;AAGzE,IAAS,WAAA;AACP,MAAA,MAAM,CAAC,EAAE,CAAI,GAAA,MAAMC,kBAAY,eAAiB,EAAA;AAAA,QAC9C,OAAS,EAAA,MAAA;AAAA,QACT,KAAK,gBAAiB,CAAA;AAAA,OACvB,CAAA;AACD,MAAA,IAAI,CAAC,EAAI,EAAA;AACP,QAAA;AAAA;AAEF,MAAA,eAAA,GAAkB,IAAK,CAAA,SAAA;AAEvB,MAAI,IAAA,IAAA,CAAK,iBAAiB,KAAW,CAAA,EAAA;AACnC,QAAM,MAAA;AAAA,UACJ,OAAA,EAAS,CAAC,EAAE,IAAA,EAAM,KAAK,YAAc,EAAA,OAAA,EAAS,IAAK,CAAA,QAAA,EAAU;AAAA,SAC/D;AAAA;AACF;AACF;AACF;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,QAAQ,IAAwB,EAAA;AAC9B,IAAA,IAAI,CAAC,IAAA,CAAK,gBAAiB,CAAA,MAAA,CAAO,OAAS,EAAA;AACzC,MAAA,IAAA,CAAK,YAAe,GAAA,IAAA;AACpB,MAAA,MAAM,cAAc,IAAK,CAAA,SAAA;AACzB,MAAA,IAAA,CAAK,YAAYD,oBAAe,EAAA;AAChC,MAAA,WAAA,CAAY,OAAQ,EAAA;AAAA;AACtB;AACF;AAAA;AAAA;AAAA,EAKA,KAAc,GAAA;AACZ,IAAA,IAAA,CAAK,YAAe,GAAA,KAAA,CAAA;AACpB,IAAA,IAAA,CAAK,iBAAiB,KAAM,EAAA;AAAA;AAC9B,EAEA,QAAW,GAAA;AACT,IAAO,OAAA,CAAA,qBAAA,CAAA;AAAA;AAEX;;;;"}