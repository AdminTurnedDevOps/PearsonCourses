{"version":3,"file":"ConfigSources.cjs.js","sources":["../../src/sources/ConfigSources.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { resolve as resolvePath } from 'path';\nimport fs from 'fs-extra';\nimport { Config, ConfigReader } from '@backstage/config';\nimport parseArgs from 'minimist';\nimport { EnvConfigSource } from './EnvConfigSource';\nimport { FileConfigSource } from './FileConfigSource';\nimport { MergedConfigSource } from './MergedConfigSource';\nimport {\n  RemoteConfigSource,\n  RemoteConfigSourceOptions,\n} from './RemoteConfigSource';\nimport { ConfigSource, SubstitutionFunc } from './types';\nimport { ObservableConfigProxy } from './ObservableConfigProxy';\nimport { findPaths } from '@backstage/cli-common';\n\n/**\n * A target to read configuration from.\n *\n * @public\n */\nexport type ConfigSourceTarget =\n  | {\n      type: 'path';\n      target: string;\n    }\n  | {\n      type: 'url';\n      target: string;\n    };\n\n/**\n * A config implementation that can be closed.\n *\n * @remarks\n *\n * Closing the configuration instance will stop the reading from the underlying source.\n *\n * @public\n */\nexport interface ClosableConfig extends Config {\n  /**\n   * Closes the configuration instance.\n   *\n   * @remarks\n   *\n   * The configuration instance will still be usable after closing, but it will\n   * no longer be updated with new values from the underlying source.\n   */\n  close(): void;\n}\n\n/**\n * Common options for the default Backstage configuration sources.\n *\n * @public\n */\nexport interface BaseConfigSourcesOptions {\n  watch?: boolean;\n  rootDir?: string;\n  remote?: Pick<RemoteConfigSourceOptions, 'reloadInterval'>;\n  /**\n   * Allow the default app-config.yaml to be missing, in which case the source\n   * will not be created.\n   */\n  allowMissingDefaultConfig?: boolean;\n\n  /**\n   * A custom substitution function that overrides the default one.\n   *\n   * @remarks\n   * The substitution function handles syntax like `${MY_ENV_VAR}` in configuration values.\n   * The default substitution will read the value from the environment and trim whitespace.\n   */\n  substitutionFunc?: SubstitutionFunc;\n}\n\n/**\n * Options for {@link ConfigSources.defaultForTargets}.\n *\n * @public\n */\nexport interface ConfigSourcesDefaultForTargetsOptions\n  extends BaseConfigSourcesOptions {\n  targets: ConfigSourceTarget[];\n}\n\n/**\n * Options for {@link ConfigSources.default}.\n *\n * @public\n */\nexport interface ConfigSourcesDefaultOptions extends BaseConfigSourcesOptions {\n  argv?: string[];\n  env?: Record<string, string | undefined>;\n}\n\n/**\n * A collection of utilities for working with and creating {@link ConfigSource}s.\n *\n * @public\n */\nexport class ConfigSources {\n  /**\n   * Parses command line arguments and returns the config targets.\n   *\n   * @param argv - The command line arguments to parse. Defaults to `process.argv`\n   * @returns A list of config targets\n   */\n  static parseArgs(argv: string[] = process.argv): ConfigSourceTarget[] {\n    const args: string[] = [parseArgs(argv).config].flat().filter(Boolean);\n    return args.map(target => {\n      try {\n        const url = new URL(target);\n\n        // Some file paths are valid relative URLs, so check if the host is empty too\n        if (!url.host) {\n          return { type: 'path', target };\n        }\n        return { type: 'url', target };\n      } catch {\n        return { type: 'path', target };\n      }\n    });\n  }\n\n  /**\n   * Creates the default config sources for the provided targets.\n   *\n   * @remarks\n   *\n   * This will create {@link FileConfigSource}s and {@link RemoteConfigSource}s\n   * for the provided targets, and merge them together to a single source.\n   * If no targets are provided it will fall back to `app-config.yaml` and\n   * `app-config.local.yaml`.\n   *\n   * URL targets are only supported if the `remote` option is provided.\n   *\n   * @param options - Options\n   * @returns A config source for the provided targets\n   */\n  static defaultForTargets(\n    options: ConfigSourcesDefaultForTargetsOptions,\n  ): ConfigSource {\n    const rootDir = options.rootDir ?? findPaths(process.cwd()).targetRoot;\n\n    const argSources = options.targets.map(arg => {\n      if (arg.type === 'url') {\n        if (!options.remote) {\n          throw new Error(\n            `Config argument \"${arg.target}\" looks like a URL but remote configuration is not enabled. Enable it by passing the \\`remote\\` option`,\n          );\n        }\n        return RemoteConfigSource.create({\n          url: arg.target,\n          substitutionFunc: options.substitutionFunc,\n          reloadInterval: options.remote.reloadInterval,\n        });\n      }\n      return FileConfigSource.create({\n        watch: options.watch,\n        path: resolvePath(arg.target),\n        substitutionFunc: options.substitutionFunc,\n      });\n    });\n\n    if (argSources.length === 0) {\n      const defaultPath = resolvePath(rootDir, 'app-config.yaml');\n      const localPath = resolvePath(rootDir, 'app-config.local.yaml');\n      const alwaysIncludeDefaultConfigSource =\n        !options.allowMissingDefaultConfig;\n\n      if (alwaysIncludeDefaultConfigSource || fs.pathExistsSync(defaultPath)) {\n        argSources.push(\n          FileConfigSource.create({\n            watch: options.watch,\n            path: defaultPath,\n            substitutionFunc: options.substitutionFunc,\n          }),\n        );\n      }\n\n      if (fs.pathExistsSync(localPath)) {\n        argSources.push(\n          FileConfigSource.create({\n            watch: options.watch,\n            path: localPath,\n            substitutionFunc: options.substitutionFunc,\n          }),\n        );\n      }\n    }\n\n    return this.merge(argSources);\n  }\n\n  /**\n   * Creates the default config source for Backstage.\n   *\n   * @remarks\n   *\n   * This will read from `app-config.yaml` and `app-config.local.yaml` by\n   * default, as well as environment variables prefixed with `APP_CONFIG_`.\n   * If `--config <path|url>` command line arguments are passed, these will\n   * override the default configuration file paths. URLs are only supported\n   * if the `remote` option is provided.\n   *\n   * @param options - Options\n   * @returns The default Backstage config source\n   */\n  static default(options: ConfigSourcesDefaultOptions): ConfigSource {\n    const argSource = this.defaultForTargets({\n      ...options,\n      targets: this.parseArgs(options.argv),\n    });\n\n    const envSource = EnvConfigSource.create({\n      env: options.env,\n    });\n\n    return this.merge([argSource, envSource]);\n  }\n\n  /**\n   * Merges multiple config sources into a single source that reads from all\n   * sources and concatenates the result.\n   *\n   * @param sources - The config sources to merge\n   * @returns A single config source that concatenates the data from the given sources\n   */\n  static merge(sources: ConfigSource[]): ConfigSource {\n    return MergedConfigSource.from(sources);\n  }\n\n  /**\n   * Creates an observable {@link @backstage/config#Config} implementation from a {@link ConfigSource}.\n   *\n   * @remarks\n   *\n   * If you only want to read the config once you can close the returned config immediately.\n   *\n   * @example\n   *\n   * ```ts\n   * const sources = ConfigSources.default(...)\n   * const config = await ConfigSources.toConfig(source)\n   * config.close()\n   * const example = config.getString(...)\n   * ```\n   *\n   * @param source - The config source to read from\n   * @returns A promise that resolves to a closable config\n   */\n  static toConfig(source: ConfigSource): Promise<ClosableConfig> {\n    return new Promise(async (resolve, reject) => {\n      let config: ObservableConfigProxy | undefined = undefined;\n      try {\n        const abortController = new AbortController();\n        for await (const { configs } of source.readConfigData({\n          signal: abortController.signal,\n        })) {\n          if (config) {\n            config.setConfig(ConfigReader.fromConfigs(configs));\n          } else {\n            config = ObservableConfigProxy.create(abortController);\n            config!.setConfig(ConfigReader.fromConfigs(configs));\n            resolve(config);\n          }\n        }\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n}\n"],"names":["parseArgs","findPaths","RemoteConfigSource","FileConfigSource","resolvePath","fs","EnvConfigSource","MergedConfigSource","config","ConfigReader","ObservableConfigProxy"],"mappings":"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"}